<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ì—”í‹°ì œì»´í¼ë‹ˆ Â· ì‘ì—… ëŒ€ì‹œë³´ë“œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<style>
  :root{
    --bg:#0f0f23; --panel:#1a1a2e; --card:#16213e; --card2:#1f2d47;
    --text:#e4e8f0; --muted:#8b94a8; --border:#2a3551; --chip:#2d3a5c;
    --primary:#6366f1; --primary-light:#818cf8; --green:#22c55e; --red:#ef4444; --amber:#f59e0b;
    --shadow:0 20px 60px rgba(0,0,0,0.5);
    --gradient-1:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  [data-theme="light"]{
    --bg:#f5f7fa; --panel:#ffffff; --card:#ffffff; --card2:#f8fafc;
    --text:#1e293b; --muted:#64748b; --border:#e2e8f0; --chip:#e0e7ff;
    --primary:#6366f1; --primary-light:#818cf8; --green:#16a34a; --red:#dc2626; --amber:#d97706;
    --shadow:0 10px 40px rgba(0,0,0,0.08);
  }

  *{box-sizing:border-box; margin:0; padding:0}
  html,body{max-width:100%; overflow-x:hidden; background:var(--bg); color:var(--text); font-size:15px}
  body{font-family:'Pretendard',-apple-system,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif; line-height:1.7}
  img,canvas,svg,video{max-width:100%; height:auto; display:block}

  .wrap{max-width:1600px; margin:0 auto; padding:28px; display:grid; gap:24px}

  .connection-status{position:fixed; top:24px; right:24px; padding:10px 18px; border-radius:20px; font-size:13px; font-weight:600; z-index:1000; display:flex; align-items:center; gap:10px; box-shadow:var(--shadow)}
  .connection-status.connected{background:var(--green); color:white}
  .connection-status.disconnected{background:var(--red); color:white}
  .connection-status.local{background:var(--amber); color:white}
  .connection-status .indicator{width:9px; height:9px; border-radius:50%; background:white; animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1} 50%{opacity:0.3}}
  @keyframes urgentPulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)} 50%{box-shadow:0 0 0 6px rgba(239,68,68,0)}}
  @keyframes warningGlow{0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,0.4)} 50%{box-shadow:0 0 0 4px rgba(245,158,11,0)}}
  @keyframes gentleGlow{0%,100%{box-shadow:0 0 3px rgba(239,68,68,0.4)} 50%{box-shadow:0 0 8px rgba(239,68,68,0.6)}}
  @keyframes softPulse{0%,100%{opacity:1} 50%{opacity:0.7}}

  header{background:var(--panel); border:1px solid var(--border); border-radius:20px; padding:28px 36px; box-shadow:var(--shadow); display:flex; align-items:center; justify-content:space-between; position:relative; overflow:hidden}
  header::before{content:''; position:absolute; top:0; left:0; right:0; height:4px; background:var(--gradient-1)}
  .brand{display:flex; align-items:center; gap:18px}
  .brand .icon{font-size:40px; filter:drop-shadow(0 4px 8px rgba(99,102,241,0.4))}
  .brand h1{font-size:28px; font-weight:800; background:var(--gradient-1); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  .chip{background:var(--chip); border:1px solid var(--border); color:var(--primary-light); padding:8px 16px; border-radius:999px; font-size:13px; font-weight:600}

  .btn{background:var(--primary); color:#fff; border:none; padding:12px 24px; border-radius:12px; cursor:pointer; font-weight:600; font-size:15px; transition:all .3s; box-shadow:0 4px 12px rgba(99,102,241,.3)}
  .btn:hover{background:var(--primary-light); transform:translateY(-2px); box-shadow:0 6px 16px rgba(99,102,241,.4)}
  .btn.outline{background:transparent; color:var(--text); border:2px solid var(--border); box-shadow:none}
  .btn.outline:hover{border-color:var(--primary); color:var(--primary); background:rgba(99,102,241,.08); box-shadow:0 2px 8px rgba(99,102,241,.15)}
  .btn.outline.reset{border-color:var(--muted); color:var(--muted)}
  .btn.outline.reset:hover{border-color:var(--primary); color:var(--primary)}
  .btn.danger{background:#ef4444}
  .btn.danger:hover{background:#dc2626}
  .btn.small{padding:10px 18px; font-size:14px}
  .btn.mini{padding:6px 12px; font-size:12px}
  .btn.success{background:var(--green)}
  .btn.success:hover{background:#16a34a}
  .btn.warning{background:var(--amber)}
  .btn.warning:hover{background:#d97706}

  .tabs{display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center}
  .tab{padding:14px 28px; background:var(--card); border:2px solid var(--border); border-radius:12px; cursor:pointer; font-weight:600; font-size:15px; transition:all .3s; color:var(--muted)}
  .tab:hover{border-color:var(--primary-light); background:var(--card2); transform:translateY(-2px)}
  .tab.active{background:var(--primary); color:#fff; border-color:var(--primary); box-shadow:0 4px 12px rgba(99,102,241,.3)}

  .place-subtabs{display:none; gap:8px; margin-left:12px}
  .place-subtabs.show{display:flex}
  .subtab{padding:10px 20px; background:var(--card2); border:2px solid var(--border); border-radius:10px; cursor:pointer; font-size:14px; font-weight:600; transition:all .3s; color:var(--muted)}
  .subtab:hover{border-color:var(--primary-light); background:var(--card)}
  .subtab.active{background:var(--primary-light); color:#fff; border-color:var(--primary-light); box-shadow:0 2px 8px rgba(99,102,241,.3)}

  .panel{background:var(--panel); border:1px solid var(--border); border-radius:20px; box-shadow:var(--shadow); overflow:hidden}
  .panel .h{padding:24px 32px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; background:linear-gradient(to right, rgba(99,102,241,.05), transparent)}
  .panel .h strong{font-size:20px; font-weight:700; display:flex; align-items:center; gap:8px}
  .panel .b{padding:28px 32px}
  
  #kpisPanel .b{background:linear-gradient(to bottom, rgba(99,102,241,.02), transparent)}

  .filters{display:grid; gap:14px; align-items:end}
  @media (min-width:1400px){.filters{grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr auto}}
  @media (max-width:1399px){.filters{grid-template-columns:repeat(3, 1fr)}}
  @media (max-width:900px){.filters{grid-template-columns:repeat(2, 1fr)}}
  @media (max-width:600px){.filters{grid-template-columns:1fr}}
  
  .filter-group{display:flex; flex-direction:column; gap:6px}
  .filter-label{font-size:12px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; padding-left:4px; display:flex; align-items:center; gap:4px}
  
  input[type="date"]{position:relative; color-scheme:dark}
  input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer; filter:invert(0.7)}

  input, select, textarea{width:100%; padding:14px 18px; border-radius:12px; border:2px solid var(--border); background:var(--card); color:var(--text); font-size:15px; font-weight:500; transition:all .3s}
  input:focus, select:focus, textarea:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 4px rgba(99,102,241,.15); background:var(--panel)}
  input::placeholder, textarea::placeholder{color:var(--muted); opacity:0.7}
  select{cursor:pointer; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b94a8' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 14px center; padding-right:40px}
  select:hover{border-color:var(--primary-light)}
  select option{padding:10px; background:var(--card); color:var(--text)}

  .toolbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .sep{height:1px; background:var(--border); margin:24px 0}
  .muted{color:var(--muted); font-size:14px; font-weight:500}

  .table-wrap{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch}
  table{width:100%; border-collapse:collapse}
  thead th{position:sticky; top:0; background:linear-gradient(135deg, rgba(99,102,241,.08), rgba(139,92,246,.08)); border-bottom:2px solid var(--primary); padding:18px 14px; font-size:14px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; color:var(--primary-light); white-space:nowrap; text-align:left}
  thead th.num{text-align:right}
  thead th.center{text-align:center}
  tbody tr{transition:all .2s; border-bottom:1px solid var(--border)}
  tbody tr:hover{background:rgba(99,102,241,.08); transform:scale(1.001)}
  td{padding:18px 14px; font-size:14px; vertical-align:middle; text-align:left; line-height:1.6}
  td.num{text-align:right; font-variant-numeric:tabular-nums; font-weight:600}
  td.center{text-align:center}
  td.nowrap{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:280px}

  .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:16px}
  @media (max-width:800px){.kpis{grid-template-columns:repeat(2,1fr)}}
  .kpi{padding:22px; background:var(--card2); border:2px solid var(--border); border-radius:16px; transition:all .3s; position:relative; overflow:hidden}
  .kpi::before{content:''; position:absolute; top:0; left:0; right:0; height:3px; background:var(--gradient-1); opacity:0; transition:opacity .3s}
  .kpi:hover{border-color:var(--primary); transform:translateY(-4px); box-shadow:0 8px 24px rgba(99,102,241,.2)}
  .kpi:hover::before{opacity:1}
  .kpi .muted{font-size:14px; font-weight:600; margin-bottom:8px}
  .kpi .v{font-weight:900; font-size:28px; background:var(--gradient-1); -webkit-background-clip:text; -webkit-text-fill-color:transparent}

  .bars{display:flex; align-items:flex-end; gap:12px; height:200px; padding:16px; border:2px solid var(--border); border-radius:16px; background:var(--card2); overflow-x:auto}
  .bars .col{flex:1; display:flex; flex-direction:column; align-items:center; gap:10px; min-width:70px}
  .bars .bar{width:100%; max-width:55px; background:var(--gradient-1); border:2px solid var(--border); border-radius:12px 12px 6px 6px; height:10%; box-shadow:0 4px 12px rgba(99,102,241,.2); transition:all .3s}
  .bars .col:hover .bar{transform:translateY(-6px); box-shadow:0 6px 16px rgba(99,102,241,.3)}
  .bar-value{font-size:14px; font-weight:700; color:var(--text); margin-bottom:6px}
  .note{font-size:12px; color:var(--muted); font-weight:600}

  .month-item{margin-bottom:10px; padding:10px 14px; background:var(--card2); border-radius:10px; border-left:3px solid var(--primary); cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:all .2s; font-size:14px}
  .month-item:hover{background:var(--card); transform:translateX(6px); box-shadow:0 2px 8px rgba(99,102,241,.15)}
  
  /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
  .drag-handle{cursor:grab; font-size:18px; color:var(--muted); padding:0 8px; display:inline-flex; align-items:center; justify-content:center; transition:color .2s; user-select:none}
  .drag-handle:hover{color:var(--primary-light)}
  .drag-handle:active{cursor:grabbing}
  tbody tr.dragging{opacity:0.3; background:rgba(99,102,241,.2); box-shadow:0 4px 12px rgba(0,0,0,.3)}
  tbody tr.drag-over{border-top:3px solid var(--primary) !important; background:rgba(99,102,241,.15)}
  tbody tr[draggable="true"]{transition:all .2s}
  
  /* ë‚ ì§œ ë²”ìœ„ ì„ íƒê¸° ìŠ¤íƒ€ì¼ - ëª¨ë‹¬ í˜•íƒœ */
  .date-range-modal-back{position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(4px); display:flex; align-items:center; justify-content:center; z-index:2000; padding:20px}
  .date-range-modal{background:var(--panel); border:2px solid var(--border); border-radius:20px; box-shadow:0 30px 80px rgba(0,0,0,.6); width:450px; max-width:100%; padding:28px}
  .date-range-modal-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; padding-bottom:16px; border-bottom:2px solid var(--border)}
  .date-range-modal-header strong{font-size:20px; font-weight:700; color:var(--primary-light)}
  .date-picker-grid{display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px}
  .date-picker-field{display:flex; flex-direction:column; gap:10px}
  .date-picker-field label{font-size:13px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px}
  .date-picker-field input[type="date"]{width:100%; padding:12px 16px; border-radius:10px; border:2px solid var(--border); background:var(--card); color:var(--text); font-size:15px; font-weight:500; transition:all .3s}
  .date-picker-field input[type="date"]:focus{border-color:var(--primary); box-shadow:0 0 0 4px rgba(99,102,241,.15); outline:none}
  .date-picker-actions{display:flex; gap:12px; justify-content:flex-end; padding-top:16px; border-top:2px solid var(--border)}
  .date-picker-actions button{padding:12px 24px; border-radius:10px; border:none; cursor:pointer; font-weight:600; font-size:15px; transition:all .3s}
  .date-picker-actions .btn-apply{background:var(--primary); color:white; box-shadow:0 4px 12px rgba(99,102,241,.3)}
  .date-picker-actions .btn-apply:hover{background:var(--primary-light); transform:translateY(-2px)}
  .date-picker-actions .btn-cancel{background:var(--card2); color:var(--text); border:2px solid var(--border)}
  .date-picker-actions .btn-cancel:hover{background:var(--card); border-color:var(--primary)}

  .bulk-edit-bar{background:linear-gradient(135deg, rgba(99,102,241,.1), rgba(139,92,246,.1)); border:2px solid var(--primary); border-radius:16px; padding:18px 24px; margin-bottom:20px; display:none; align-items:center; gap:18px}
  .bulk-edit-bar.active{display:flex}

  .pagination-wrapper{display:flex; align-items:center; justify-content:space-between; padding:24px 0; gap:18px; flex-wrap:wrap}
  .pagination{display:flex; gap:10px; align-items:center}
  .page-btn{min-width:40px; height:40px; padding:0 14px; border:2px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; cursor:pointer; font-weight:600; font-size:15px; transition:all .3s}
  .page-btn:hover:not(.active):not(:disabled){border-color:var(--primary); background:var(--card2); transform:translateY(-2px)}
  .page-btn.active{background:var(--primary); color:#fff; border-color:var(--primary); box-shadow:0 4px 12px rgba(99,102,241,.3)}
  .page-btn:disabled{opacity:.3; cursor:not-allowed}

  .modal-back{position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; z-index:1000; padding:20px}
  .modal-back.active{display:flex}
  .modal{background:var(--panel); border:2px solid var(--border); border-radius:24px; box-shadow:0 30px 80px rgba(0,0,0,.6); width:900px; max-width:100%; max-height:90vh; overflow:auto}
  .modal .mh{padding:28px 32px; border-bottom:2px solid var(--border); display:flex; align-items:center; justify-content:space-between; background:linear-gradient(to right, rgba(99,102,241,.05), transparent)}
  .modal .mh strong{font-size:22px; font-weight:800}
  .modal .mb{padding:32px}
  .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:18px}
  .form-grid .full{grid-column:1/-1}
  .form-grid label{display:block; font-size:14px; font-weight:600; color:var(--muted); margin-bottom:8px; text-transform:uppercase; letter-spacing:.6px}
  
  /* ë¡œê·¸ì¸ í˜ì´ì§€ ìŠ¤íƒ€ì¼ */
  .login-container{position:fixed; inset:0; background:var(--bg); display:flex; align-items:center; justify-content:center; z-index:9999}
  .login-box{background:var(--panel); border:2px solid var(--border); border-radius:24px; padding:48px; width:450px; max-width:90%; box-shadow:0 30px 80px rgba(0,0,0,.6)}
  .login-box .logo{text-align:center; margin-bottom:32px}
  .login-box .logo .icon{font-size:64px; margin-bottom:16px; filter:drop-shadow(0 4px 12px rgba(99,102,241,0.5))}
  .login-box h1{text-align:center; font-size:28px; font-weight:800; background:var(--gradient-1); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:8px}
  .login-box p{text-align:center; color:var(--muted); font-size:14px; margin-bottom:32px}
  .login-form{display:flex; flex-direction:column; gap:20px}
  .login-input{width:100%; padding:16px 20px; border-radius:12px; border:2px solid var(--border); background:var(--card); color:var(--text); font-size:15px; font-weight:500; transition:all .3s}
  .login-input:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 4px rgba(99,102,241,.15); background:var(--panel)}
  .login-btn{width:100%; padding:16px; background:var(--primary); color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:700; cursor:pointer; transition:all .3s; box-shadow:0 4px 12px rgba(99,102,241,.3)}
  .login-btn:hover{background:var(--primary-light); transform:translateY(-2px); box-shadow:0 6px 16px rgba(99,102,241,.4)}
  .login-btn:disabled{opacity:.5; cursor:not-allowed; transform:none}
  .login-error{background:rgba(239,68,68,.1); border:2px solid var(--red); color:var(--red); padding:12px 16px; border-radius:8px; font-size:14px; font-weight:600; text-align:center}
  .user-info{display:flex; align-items:center; gap:12px; padding:10px 18px; background:var(--card); border-radius:12px; border:2px solid var(--border)}
  .user-email{color:var(--text); font-weight:600; font-size:14px}
  .logout-btn{padding:8px 16px; background:transparent; color:var(--red); border:2px solid var(--red); border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; transition:all .3s}
  .logout-btn:hover{background:var(--red); color:#fff}

  .fin-section{margin-bottom:40px}
  .fin-title{font-weight:700; font-size:18px; margin-bottom:18px; padding:14px 0; border-bottom:2px solid var(--border); color:var(--primary-light)}
  .fin-count{margin-left:10px; padding:4px 12px; background:rgba(99,102,241,0.1); border-radius:8px; font-size:13px}
  .fin-cell{cursor:pointer; padding:12px 14px; border-radius:8px; transition:all .2s; font-size:14px}
  .fin-cell:hover{background:var(--card2); color:var(--primary-light)}
  
  /* ê¸ˆì•¡ ì»¬ëŸ¼ ìŠ¤íƒ€ì¼ë§ */
  .revenue-cell{background:rgba(59,130,246,0.08) !important; border:2px solid rgba(59,130,246,0.3); font-weight:700; color:#3b82f6}
  .revenue-cell:hover{background:rgba(59,130,246,0.15) !important; border-color:#3b82f6}
  
  .cost-cell{background:rgba(249,115,22,0.08) !important; border:2px solid rgba(249,115,22,0.3); font-weight:700; color:#f97316}
  .cost-cell:hover{background:rgba(249,115,22,0.15) !important; border-color:#f97316}
  
  .profit-cell{border:2px solid rgba(34,197,94,0.3); font-weight:700}
  .profit-cell.positive{background:rgba(34,197,94,0.08) !important; color:#22c55e}
  .profit-cell.positive:hover{background:rgba(34,197,94,0.15) !important; border-color:#22c55e}
  .profit-cell.negative{background:rgba(239,68,68,0.08) !important; color:#ef4444; border-color:rgba(239,68,68,0.3)}
  .profit-cell.negative:hover{background:rgba(239,68,68,0.15) !important; border-color:#ef4444}
  
  .rate-cell{background:rgba(168,85,247,0.08) !important; border:2px solid rgba(168,85,247,0.3); font-weight:700; color:#a855f7}
  .rate-cell:hover{background:rgba(168,85,247,0.15) !important; border-color:#a855f7}

  .kpi-summary{display:grid; grid-template-columns:repeat(3,1fr); gap:16px; max-width:900px}
  @media (max-width:768px){.kpi-summary{grid-template-columns:repeat(2,1fr)}}
  
  /* í…Œì´ë¸” ì •ë ¬ ê°œì„  */
  .fin-cell.center{text-align:center}
  .fin-cell.num{text-align:right; font-variant-numeric:tabular-nums}

  .d-day-badge{display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:8px; font-size:12px; font-weight:700; text-transform:uppercase; margin-left:10px}
  .d-day-badge.d-0{background:rgba(239,68,68,0.2); color:var(--red); border:2px solid var(--red); animation:urgentPulse 3s ease-in-out infinite}
  .d-day-badge.d-1{background:rgba(245,158,11,0.2); color:var(--amber); border:2px solid var(--amber); animation:warningGlow 3.5s ease-in-out infinite}
  .d-day-badge.d-3{background:rgba(34,197,94,0.15); color:var(--green); border:1px solid var(--green)}
  .d-day-badge.d-7{background:rgba(99,102,241,0.15); color:var(--primary); border:1px solid var(--primary)}
  
  tr.urgent-row{background:rgba(239,68,68,0.08) !important; border-left:4px solid var(--red)}
  tr.warning-row{background:rgba(245,158,11,0.08) !important; border-left:4px solid var(--amber)}
  
  .deadline-cell{position:relative; transition:all 0.3s}
  .deadline-cell.urgent{animation:gentleGlow 3s ease-in-out infinite; font-weight:700; color:var(--red)}
  .deadline-cell.warning{font-weight:600; color:var(--amber); animation:softPulse 3s ease-in-out infinite}

  .profit-indicator{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:8px; font-weight:700; font-size:14px}
  .profit-indicator.positive{background:rgba(34,197,94,0.15); color:var(--green)}
  .profit-indicator.negative{background:rgba(239,68,68,0.15); color:var(--red)}

  .report-text{background:var(--card2); border:2px solid var(--border); border-radius:12px; padding:24px; font-family:'Courier New', monospace; font-size:14px; line-height:1.9; white-space:pre-wrap; word-break:break-all; max-height:500px; overflow-y:auto; color:var(--text)}

  .calendar-picker{position:relative; display:inline-block; width:100%}
  .calendar-input{cursor:pointer; padding:14px 18px; border-radius:12px; border:2px solid var(--border); background:var(--card); color:var(--text); font-size:15px; font-weight:500; transition:all .3s; display:flex; align-items:center; justify-content:space-between; width:100%}
  .calendar-input:hover{border-color:var(--primary)}
  .calendar-dropdown{position:absolute; top:100%; left:0; margin-top:10px; background:var(--panel); border:2px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:22px; z-index:100; display:none; width:340px}
  .calendar-dropdown.active{display:block}
  
  .calendar-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:18px}
  .calendar-header button{background:transparent; border:none; color:var(--text); padding:10px; cursor:pointer; font-size:18px; font-weight:700; transition:all .3s; border-radius:8px}
  .calendar-header button:hover{background:var(--card2)}
  .calendar-header .month-year{font-weight:700; font-size:16px; display:flex; align-items:center; gap:10px}
  .calendar-header select{background:var(--card); border:2px solid var(--border); color:var(--text); padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; font-size:14px}
  
  .calendar-weekdays{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:10px}
  .calendar-weekday{text-align:center; font-size:13px; font-weight:600; color:var(--muted); padding:10px 4px}
  
  .calendar-days{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:14px}
  .calendar-day{text-align:center; padding:12px 4px; border-radius:8px; cursor:pointer; font-weight:500; font-size:15px; transition:all .2s; border:2px solid transparent}
  .calendar-day:hover:not(.disabled):not(.selected){background:var(--card2)}
  .calendar-day.disabled{color:var(--muted); opacity:0.4; cursor:not-allowed}
  .calendar-day.disabled:hover{background:transparent}
  .calendar-day.selected{background:var(--primary); color:#fff; border-radius:50%; font-weight:700}
  .calendar-day.today{color:var(--primary); font-weight:700}
  
  .calendar-actions{display:flex; gap:10px; padding-top:14px; border-top:2px solid var(--border)}
  .calendar-actions button{flex:1; padding:12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; transition:all .3s; font-size:14px}
  .calendar-actions .clear-btn{background:transparent; color:var(--primary); border:2px solid var(--primary)}
  .calendar-actions .clear-btn:hover{background:var(--primary); color:#fff}
  .calendar-actions .today-btn{background:var(--primary); color:#fff}
  .calendar-actions .today-btn:hover{background:var(--primary-light)}

  .growth-card{display:grid; grid-template-columns:1fr auto; gap:24px; padding:24px; background:var(--card2); border-radius:16px; border:2px solid var(--border); align-items:center}
  .growth-info .label{font-size:14px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:10px}
  .growth-value{display:flex; align-items:center; gap:14px}
  .growth-value .number{font-size:36px; font-weight:900}
  .growth-value .number.positive{color:var(--green)}
  .growth-value .number.negative{color:var(--red)}
  .growth-icon{width:70px; height:70px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:32px}
  .growth-icon.positive{background:rgba(34,197,94,0.15)}
  .growth-icon.negative{background:rgba(239,68,68,0.15)}
</style>
</head>
<body>
<div class="login-container" id="loginContainer">
  <div class="login-box">
    <div class="logo">
      <div class="icon">ğŸ’¼</div>
      <h1>ì—”í‹°ì œì»´í¼ë‹ˆ</h1>
      <p>ê´€ë¦¬ì ë¡œê·¸ì¸</p>
    </div>
    <form class="login-form" id="loginForm">
      <input type="email" class="login-input" id="loginEmail" placeholder="ì´ë©”ì¼" required autocomplete="email">
      <input type="password" class="login-input" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required autocomplete="current-password">
      <div id="loginError" class="login-error" style="display:none"></div>
      <button type="submit" class="login-btn" id="loginBtn">ë¡œê·¸ì¸</button>
    </form>
  </div>
</div>

<div class="connection-status local" id="connectionStatus">
  <span class="indicator"></span>
  <span id="connectionText">ì—°ê²° ì¤‘...</span>
</div>

<div class="wrap" id="app" style="display:none">
  <header>
    <div class="brand">
      <span class="icon">ğŸ’¼</span>
      <div>
        <h1>ì—”í‹°ì œì»´í¼ë‹ˆ</h1>
        <span class="chip" id="modeChip">ì‘ì—… ëŒ€ì‹œë³´ë“œ</span>
      </div>
    </div>
    <div class="toolbar">
      <div class="user-info" id="userInfo" style="display:none">
        <span class="user-email" id="userEmail"></span>
        <button class="logout-btn" id="logoutBtn">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
      <button class="btn outline" id="exportExcelBtn">ğŸ“Š ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn" id="themeBtn">ğŸŒ“ í…Œë§ˆ ì „í™˜</button>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-type="place">ğŸ“ í”Œë ˆì´ìŠ¤ ì‘ì—…</div>
    <div class="place-subtabs" id="placeSubtabs" style="display:flex; gap:8px; margin-left:12px">
      <div class="subtab active" data-subtype="reward">ğŸ ë¦¬ì›Œë“œ</div>
      <div class="subtab" data-subtype="distribution">ğŸ“¦ ë°°í¬</div>
    </div>
    <div class="tab" data-type="blog">ğŸ“ ë¸”ë¡œê·¸ ì‘ì—…</div>
    <div class="tab" data-type="project">ğŸ¯ í”„ë¡œì íŠ¸</div>
    <div class="tab" data-type="finance">ğŸ’° ë§¤ì¶œ/ë§¤ì…</div>
  </div>

  <section class="panel" id="kpisPanel">
    <div class="h">
      <strong>ğŸ” ê²€ìƒ‰ ë° í•„í„°</strong>
      <span class="chip" style="background:rgba(99,102,241,0.1); border:1px solid var(--primary); font-size:11px">ì¡°ê±´ë³„ ê²€ìƒ‰</span>
    </div>
    <div class="b" id="filtersContainer"></div>
  </section>

  <section class="panel" id="tablePanel">
    <div class="h">
      <strong id="listTitle">ğŸ“‹ ì‘ì—… ëª©ë¡</strong>
      <div class="toolbar">
        <span class="muted" id="countInfo">0ê±´</span>
        <button class="btn small outline" id="openSpecialNoteBtn" style="border-color:var(--primary); color:var(--primary)">ğŸ“Œ íŠ¹ì´ì‚¬í•­</button>
        <button class="btn small success" id="openReportModalBtn">ğŸ“± ë¦¬í¬íŠ¸ ë¬¸ì</button>
        <button class="btn small" id="openAddModalBtn">â• ìƒˆ í•­ëª©</button>
        <button class="btn warning small" id="cloneSelectedBtn">ğŸ“‹ ë³µì œ</button>
        <button class="btn danger small" id="removeSelectedBtn">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
      </div>
    </div>
    <div class="b">
      <div class="bulk-edit-bar" id="bulkEditBar">
        <span class="muted" id="selectedCount">0ê°œ ì„ íƒ</span>
        <button class="btn small" id="bulkEditBtn">âœï¸ ì¼ê´„ìˆ˜ì •</button>
      </div>
      <div class="table-wrap">
        <table id="tbl">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="pagination-wrapper">
        <div style="display:flex; align-items:center; gap:10px">
          <span class="muted">í˜ì´ì§€ë‹¹ í‘œì‹œ:</span>
          <select id="perPageSelect" style="width:auto; padding:8px 12px">
            <option value="30">30ê°œ</option>
            <option value="50">50ê°œ</option>
            <option value="100">100ê°œ</option>
          </select>
        </div>
        <div class="pagination" id="pagination"></div>
      </div>
    </div>
  </section>

  <section class="panel" id="kpisSummaryPanel">
    <div class="h"><strong>ğŸ“Š ë°ì´í„° ìš”ì•½</strong></div>
    <div class="b">
      <div class="kpis">
        <div class="kpi"><div class="muted">ì´ ê±´ìˆ˜</div><div class="v" id="kpiCount">0</div></div>
        <div class="kpi"><div class="muted" id="kpiQtyLabel">ì´ ì‘ì—…ëŸ‰</div><div class="v" id="kpiQty">0</div></div>
        <div class="kpi"><div class="muted" id="kpiCostLabel">ì´ ì‘ì—…ë¹„</div><div class="v" id="kpiCost">â‚©0</div></div>
        <div class="kpi"><div class="muted" id="kpiAvgLabel">í‰ê·  ë‹¨ê°€</div><div class="v" id="kpiAvg">â‚©0</div></div>
      </div>
      <div class="sep"></div>
      <div class="toolbar"><strong id="barChartTitle">ğŸ“ˆ ìƒí’ˆë³„ ì´ ì‘ì—…ë¹„</strong></div>
      <div class="bars" id="barsByProduct"></div>
      <div class="sep"></div>
      <div class="toolbar"><strong id="monthChartTitle">ğŸ’° ì›” ì´ ì‘ì—…ë¹„</strong></div>
      <div id="monthlyCost"></div>
    </div>
  </section>

  <section class="panel" id="financePanel" style="display:none">
    <div class="h">
      <strong>ğŸ’¼ ì—…ì²´ë³„ ìˆ˜ìµì •ë¦¬</strong>
      <div class="toolbar">
        <button class="btn small" id="openFinAddModalBtn">â• ìƒˆ í•­ëª©</button>
        <button class="btn success small" id="cloneFinSelectedBtn">ğŸ“‹ ë³µì œ</button>
        <button class="btn danger small" id="removeFinSelectedBtn">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
      </div>
    </div>
    <div class="b">
      <div class="bulk-edit-bar" id="finBulkEditBar">
        <span class="muted" id="finSelectedCount">0ê°œ ì„ íƒ</span>
        <button class="btn small" id="finBulkEditBtn">âœï¸ ì¼ê´„ìˆ˜ì •</button>
      </div>
      
      <div style="margin-bottom:24px">
        <div class="filters" style="grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr">
          <div class="filter-group">
            <label class="filter-label">ğŸ” ì—…ì²´ëª… ê²€ìƒ‰</label>
            <input id="finSearchClient" placeholder="ì—…ì²´ëª… ì…ë ¥..." style="width:100%">
          </div>
          <div class="filter-group">
            <label class="filter-label">ğŸ‘¤ ë‹´ë‹¹ì</label>
            <select id="finFilterManager">
              <option value="">ì „ì²´</option>
              <option value="ì „ë³‘í™©">ì „ë³‘í™©</option>
              <option value="ê°•íƒœìš°">ê°•íƒœìš°</option>
              <option value="ì˜¤ì˜ì€">ì˜¤ì˜ì€</option>
              <option value="ê¹€í•˜ëŠ¬">ê¹€í•˜ëŠ¬</option>
              <option value="ê¹€ìš°í˜„">ê¹€ìš°í˜„</option>
              <option value="ê³µë¯¼ê²½">ê³µë¯¼ê²½</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">ğŸ“‹ ìœ í˜•</label>
            <select id="finFilterType">
              <option value="">ì „ì²´</option>
              <option value="place">ğŸ“ í”Œë ˆì´ìŠ¤</option>
              <option value="blog">ğŸ“ ë¸”ë¡œê·¸</option>
              <option value="project">ğŸ¯ í”„ë¡œì íŠ¸</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">ğŸ“… ì—°ë„</label>
            <select id="finFilterYear">
              <option value="">ì „ì²´</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
              <option value="2027">2027</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">ğŸ”„ ì •ë ¬</label>
            <select id="finSortOrder">
              <option value="order_asc">ğŸ“ ë“±ë¡ìˆœ</option>
              <option value="created_desc">ğŸ“† ë“±ë¡ì¼ â†“</option>
              <option value="created_asc">ğŸ“† ë“±ë¡ì¼ â†‘</option>
              <option value="startdate_desc">ğŸ—“ï¸ ì‹œì‘ì¼ â†“</option>
              <option value="startdate_asc">ğŸ—“ï¸ ì‹œì‘ì¼ â†‘</option>
              <option value="enddate_desc">ğŸ“… ì¢…ë£Œì¼ â†“</option>
              <option value="enddate_asc">ğŸ“… ì¢…ë£Œì¼ â†‘</option>
              <option value="revenue_desc">ğŸ’° ë§¤ì¶œ â†“</option>
              <option value="revenue_asc">ğŸ’° ë§¤ì¶œ â†‘</option>
              <option value="profit_desc">ğŸ’µ ì´ìµ â†“</option>
              <option value="profit_asc">ğŸ’µ ì´ìµ â†‘</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label" style="opacity:0">ì´ˆê¸°í™”</label>
            <button class="btn small outline" id="finResetBtn" style="width:100%">ğŸ”„ ì´ˆê¸°í™”</button>
          </div>
        </div>
      </div>

      <div style="margin-bottom:24px; padding:20px; background:var(--card2); border-radius:12px; border:2px solid var(--border)">
        <div style="display:flex; gap:20px; align-items:flex-end">
          <div>
            <label class="filter-label" style="font-size:14px; margin-bottom:10px; display:block">ğŸ“Š ì›”ë³„ ì¡°íšŒ</label>
            <select id="financeMonth" style="width:220px">
              <option value="">ì „ì²´ ì›”</option>
              <option value="1ì›”">1ì›”</option>
              <option value="2ì›”">2ì›”</option>
              <option value="3ì›”">3ì›”</option>
              <option value="4ì›”">4ì›”</option>
              <option value="5ì›”">5ì›”</option>
              <option value="6ì›”">6ì›”</option>
              <option value="7ì›”">7ì›”</option>
              <option value="8ì›”">8ì›”</option>
              <option value="9ì›”">9ì›”</option>
              <option value="10ì›”">10ì›”</option>
              <option value="11ì›”">11ì›”</option>
              <option value="12ì›”">12ì›”</option>
            </select>
          </div>
          <div>
            <label class="filter-label" style="font-size:14px; margin-bottom:10px; display:block">ğŸ”– ê³„ì•½ ìƒíƒœ</label>
            <select id="contractStatus" style="width:220px">
              <option value="">ì „ì²´</option>
              <option value="ì§„í–‰ì¤‘">ì§„í–‰ì¤‘</option>
              <option value="ëŒ€ê¸°ì¤‘">ëŒ€ê¸°ì¤‘</option>
              <option value="ê³„ì•½ì¢…ë£Œ">ê³„ì•½ì¢…ë£Œ</option>
            </select>
          </div>
        </div>
      </div>

      <div class="fin-section">
        <div class="fin-title">ğŸ“ í”Œë ˆì´ìŠ¤ ì‘ì—… <span class="fin-count" id="finPlaceCount"></span></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th class="center" style="width:40px">â†•</th><th class="center"><input type="checkbox" id="chkAllFinPlace"></th><th class="center">ì›”ë³„</th><th class="center">ë‹´ë‹¹ì</th><th>ì—…ì²´ëª…</th><th>ëŒ€í‘œ</th><th class="num">ë§¤ì¶œ</th><th class="center">ì…ê¸ˆì—¬ë¶€</th><th>ì‘ì—…ê¸°ê°„</th><th class="num">ì‘ì—…ë¹„</th><th class="num">ì˜ì—…ì´ìµ</th><th class="num">ìˆœì´ìµìœ¨</th><th class="center">ê³„ì•½ ìƒíƒœ</th><th>ë©”ëª¨</th><th class="center">ì„¸ê¸ˆ</th></tr></thead>
            <tbody id="finPlace"></tbody>
          </table>
        </div>
        <div class="pagination-wrapper">
          <div style="display:flex; align-items:center; gap:10px">
            <span class="muted">í˜ì´ì§€ë‹¹ í‘œì‹œ:</span>
            <select id="finPlacePerPage" style="width:auto; padding:8px 12px">
              <option value="30">30ê°œ</option>
              <option value="50">50ê°œ</option>
              <option value="100">100ê°œ</option>
            </select>
            <span class="muted" style="margin:0 8px">|</span>
            <span class="muted">ì´ <strong id="finPlaceTotalCount" style="color:var(--primary-light); font-size:16px">0</strong>ê°œ ì—…ì²´</span>
          </div>
          <div class="pagination" id="finPlacePagination"></div>
        </div>
      </div>

      <div class="fin-section">
        <div class="fin-title">ğŸ“ ë¸”ë¡œê·¸ ì‘ì—… <span class="fin-count" id="finBlogCount"></span></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th class="center" style="width:40px">â†•</th><th class="center"><input type="checkbox" id="chkAllFinBlog"></th><th class="center">ì›”ë³„</th><th class="center">ë‹´ë‹¹ì</th><th>ì—…ì²´ëª…</th><th>ëŒ€í‘œ</th><th class="num">ë§¤ì¶œ</th><th class="center">ì…ê¸ˆì—¬ë¶€</th><th>ì‘ì—…ê¸°ê°„</th><th class="num">ì‘ì—…ë¹„</th><th class="num">ì˜ì—…ì´ìµ</th><th class="num">ìˆœì´ìµìœ¨</th><th class="center">ê³„ì•½ ìƒíƒœ</th><th>ë©”ëª¨</th><th class="center">ì„¸ê¸ˆ</th></tr></thead>
            <tbody id="finBlog"></tbody>
          </table>
        </div>
        <div class="pagination-wrapper">
          <div style="display:flex; align-items:center; gap:10px">
            <span class="muted">í˜ì´ì§€ë‹¹ í‘œì‹œ:</span>
            <select id="finBlogPerPage" style="width:auto; padding:8px 12px">
              <option value="30">30ê°œ</option>
              <option value="50">50ê°œ</option>
              <option value="100">100ê°œ</option>
            </select>
            <span class="muted" style="margin:0 8px">|</span>
            <span class="muted">ì´ <strong id="finBlogTotalCount" style="color:var(--primary-light); font-size:16px">0</strong>ê°œ ì—…ì²´</span>
          </div>
          <div class="pagination" id="finBlogPagination"></div>
        </div>
      </div>

      <div class="fin-section">
        <div class="fin-title">ğŸ¯ í”„ë¡œì íŠ¸ <span class="fin-count" id="finProjectCount"></span></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th class="center" style="width:40px">â†•</th><th class="center"><input type="checkbox" id="chkAllFinProject"></th><th class="center">ì›”ë³„</th><th class="center">ë‹´ë‹¹ì</th><th>ì—…ì²´ëª…</th><th>ëŒ€í‘œ</th><th class="num">ë§¤ì¶œ</th><th class="center">ì…ê¸ˆì—¬ë¶€</th><th>ì‘ì—…ê¸°ê°„</th><th class="num">ì‘ì—…ë¹„</th><th class="num">ì˜ì—…ì´ìµ</th><th class="num">ìˆœì´ìµìœ¨</th><th class="center">ê³„ì•½ ìƒíƒœ</th><th>ë©”ëª¨</th><th class="center">ì„¸ê¸ˆ</th></tr></thead>
            <tbody id="finProject"></tbody>
          </table>
        </div>
        <div class="pagination-wrapper">
          <div style="display:flex; align-items:center; gap:10px">
            <span class="muted">í˜ì´ì§€ë‹¹ í‘œì‹œ:</span>
            <select id="finProjectPerPage" style="width:auto; padding:8px 12px">
              <option value="30">30ê°œ</option>
              <option value="50">50ê°œ</option>
              <option value="100">100ê°œ</option>
            </select>
            <span class="muted" style="margin:0 8px">|</span>
            <span class="muted">ì´ <strong id="finProjectTotalCount" style="color:var(--primary-light); font-size:16px">0</strong>ê°œ ì—…ì²´</span>
          </div>
          <div class="pagination" id="finProjectPagination"></div>
        </div>
      </div>

      <div class="sep"></div>
      <div style="font-weight:700; margin-bottom:16px; font-size:16px">ğŸ“Š ì¢…í•© ìš”ì•½ (í•„í„° ì ìš©) <span class="fin-count" id="totalCompanyCount"></span></div>
      <div class="kpi-summary">
        <div class="kpi"><div class="muted">ì´ ë§¤ì¶œ</div><div class="v" id="totalRevenue">â‚©0</div></div>
        <div class="kpi"><div class="muted">ì´ ë§¤ì…(ì‘ì—…ë¹„)</div><div class="v" id="totalCost">â‚©0</div></div>
        <div class="kpi"><div class="muted">ì´ ì˜ì—…ì´ìµ</div><div class="v" id="totalProfit">â‚©0</div></div>
      </div>
      
      <div style="margin-top:20px">
        <div class="growth-card" id="growthCard">
          <div class="growth-info">
            <div class="label">ğŸ“ˆ ì „ì›” ëŒ€ë¹„ ì„±ì¥ë¥ </div>
            <div class="growth-value">
              <span class="number" id="revenueGrowth">0%</span>
            </div>
          </div>
          <div class="growth-icon" id="growthIcon">ğŸ“Š</div>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <div style="margin-bottom:16px">
        <div style="font-weight:700; margin-bottom:16px; font-size:16px; color:var(--primary-light)">ğŸ“Š ì›”ë³„ ë§¤ì¶œ ì¶”ì´ (ìµœê·¼ 6ê°œì›”)</div>
        <canvas id="revenueGrowthChart" width="800" height="300" style="max-width:100%; height:auto"></canvas>
      </div>
    </div>
  </section>
</div>

<div class="modal-back" id="addModalBack">
  <div class="modal">
    <div class="mh">
      <strong id="modalTitle">â• ìƒˆ í•­ëª© ë“±ë¡</strong>
      <button class="btn small outline" id="closeModalBtn">âœ• ë‹«ê¸°</button>
    </div>
    <div class="mb">
      <form id="addForm" class="form-grid"></form>
    </div>
  </div>
</div>

<div class="modal-back" id="memoModalBack">
  <div class="modal" style="max-width:600px">
    <div class="mh">
      <strong>ğŸ“ ë©”ëª¨ í¸ì§‘</strong>
      <button class="btn small outline" id="closeMemoModalBtn">âœ• ë‹«ê¸°</button>
    </div>
    <div class="mb">
      <div style="margin-bottom:16px">
        <label style="display:block; font-size:14px; font-weight:600; color:var(--muted); margin-bottom:8px; text-transform:uppercase; letter-spacing:.6px">ë©”ëª¨ ë‚´ìš©</label>
        <textarea id="memoTextarea" rows="8" style="width:100%; padding:14px 18px; border-radius:12px; border:2px solid var(--border); background:var(--card); color:var(--text); font-size:15px; font-weight:500; resize:vertical; font-family:inherit; line-height:1.6" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
      </div>
      <div style="display:flex; gap:12px; justify-content:flex-end">
        <button class="btn outline" id="cancelMemoBtn">ì·¨ì†Œ</button>
        <button class="btn" id="saveMemoBtn">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-back" id="specialNoteModalBack">
  <div class="modal" style="max-width:700px">
    <div class="mh">
      <strong id="specialNoteModalTitle">ğŸ“Œ íŠ¹ì´ì‚¬í•­</strong>
      <button class="btn small outline" id="closeSpecialNoteModalBtn">âœ• ë‹«ê¸°</button>
    </div>
    <div class="mb">
      <div style="margin-bottom:16px">
        <label style="display:block; font-size:14px; font-weight:600; color:var(--muted); margin-bottom:8px">íŠ¹ì´ì‚¬í•­ ë©”ëª¨</label>
        <textarea id="specialNoteTextarea" rows="10" style="width:100%; padding:14px 18px; border-radius:12px; border:2px solid var(--border); background:var(--card); color:var(--text); font-size:15px; font-weight:500; resize:vertical; font-family:inherit; line-height:1.6" placeholder="ì´ ì‘ì—… ëª©ë¡ì— ëŒ€í•œ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
      </div>
      <div style="display:flex; gap:12px; justify-content:flex-end">
        <button class="btn outline" id="cancelSpecialNoteBtn">ì·¨ì†Œ</button>
        <button class="btn" id="saveSpecialNoteBtn">ğŸ’¾ ì €ì¥</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const USE_FIREBASE = true;
const firebaseConfig = {
  apiKey: "AIzaSyCV9pjrGzHEoc-s4ppz44lMba5BKE53VAs",
  authDomain: "entjcompany.firebaseapp.com",
  databaseURL: "https://entjcompany.firebaseio.com",
  projectId: "entjcompany",
  storageBucket: "entjcompany.firebasestorage.app",
  messagingSenderId: "567861521069",
  appId: "1:567861521069:web:084f0212f2931e2c9fb424",
  measurementId: "G-0F57YWZJPS"
};

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmtMoney = n => 'â‚©' + Math.round(n||0).toLocaleString('ko-KR');
const parseNum = v => { const num = Number(v); return isNaN(num) ? null : num; };
const toISO = d => { if(!d)return''; const z=new Date(d); return new Date(z - z.getTimezoneOffset()*60000).toISOString().slice(0,10); };
const today = () => toISO(new Date());
const getYearMonth = d => { const date=new Date(d); return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`; };

const getDDay = (endDate) => {
  if (!endDate) return null;
  const end = new Date(endDate);
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  end.setHours(0, 0, 0, 0);
  const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
  return diff;
};

const getDDayBadge = (endDate) => {
  const dday = getDDay(endDate);
  if (dday === null) return '';
  
  if (dday < 0) return `<span class="d-day-badge d-0">ì¢…ë£Œ</span>`;
  if (dday === 0) return `<span class="d-day-badge d-0">D-0</span>`;
  if (dday === 1) return `<span class="d-day-badge d-1">D-1</span>`;
  if (dday <= 3) return `<span class="d-day-badge d-3">D-${dday}</span>`;
  if (dday <= 7) return `<span class="d-day-badge d-7">D-${dday}</span>`;
  return '';
};

const getRowClass = (endDate) => {
  const dday = getDDay(endDate);
  if (dday === null) return '';
  if (dday === 0 || dday < 0) return 'urgent-row';
  if (dday === 1) return 'warning-row';
  return '';
};

const MANAGERS = ['ì „ë³‘í™©', 'ê°•íƒœìš°', 'ì˜¤ì˜ì€', 'ê¹€í•˜ëŠ¬', 'ê¹€ìš°í˜„', 'ê³µë¯¼ê²½'];

const state = {
  currentType: 'place',
  placeSubType: 'reward',
  rows: {place: [], blog: [], project: []},
  financeData: {},
  specialNotes: {
    place_reward: '',
    place_distribution: '',
    blog: '',
    project: ''
  },
  filters: {},
  selected: new Set(),
  finSelected: new Set(),
  pagination: {currentPage:1, perPage:30},
  financePagination: {
    place: {currentPage: 1, perPage: 30},
    blog: {currentPage: 1, perPage: 30},
    project: {currentPage: 1, perPage: 30}
  },
  isFirebaseConnected: false,
  useFirebase: USE_FIREBASE
};

let db = null;
let dataRefs = {};

const CONFIGS = {
  place: {
    name: 'í”Œë ˆì´ìŠ¤ ì‘ì—…',
    path: 'place',
    rewardFields: [
      {key:'manager', label:'ë‹´ë‹¹ì', type:'select', options:['ì „ë³‘í™©', 'ê°•íƒœìš°', 'ì˜¤ì˜ì€', 'ê¹€í•˜ëŠ¬', 'ê¹€ìš°í˜„', 'ê³µë¯¼ê²½']},
      {key:'product', label:'ìƒí’ˆ', type:'text'},
      {key:'category', label:'êµ¬ë¶„', type:'select', options:['íŠ¸ë˜í”½','ì €ì¥','ê¸¸ì°¾ê¸°','ì˜ìˆ˜ì¦']},
      {key:'client', label:'ì—…ì²´ëª…', type:'text', required:true},
      {key:'mid', label:'Mid', type:'url'},
      {key:'keywords', label:'í‚¤ì›Œë“œ', type:'text'},
      {key:'startDate', label:'ì‹œì‘ì¼', type:'date', required:true},
      {key:'endDate', label:'ì¢…ë£Œì¼', type:'date'},
      {key:'units', label:'ì¼íƒ€', type:'number'},
      {key:'days', label:'ì¼ìˆ˜', type:'number'},
      {key:'unitPrice', label:'ë‹¨ê°€', type:'number'},
      {key:'totalQty', label:'ì´ëŸ‰', type:'computed'},
      {key:'cost', label:'ì‘ì—…ë¹„', type:'computed'},
      {key:'tax', label:'ì„¸ê¸ˆ', type:'select', options:['ë°œí–‰','ë¯¸ë°œí–‰']},
      {key:'note', label:'ë¹„ê³ ', type:'text'}
    ],
    distributionFields: [
      {key:'manager', label:'ë‹´ë‹¹ì', type:'select', options:['ì „ë³‘í™©', 'ê°•íƒœìš°', 'ì˜¤ì˜ì€', 'ê¹€í•˜ëŠ¬', 'ê¹€ìš°í˜„', 'ê³µë¯¼ê²½']},
      {key:'product', label:'ìƒí’ˆ', type:'text'},
      {key:'client', label:'ì—…ì²´ëª…', type:'text', required:true},
      {key:'url', label:'URL', type:'url'},
      {key:'realName', label:'ì‹¤/ë¹„', type:'select', options:['ì‹¤ëª…','ë¹„ì‹¤ëª…']},
      {key:'category', label:'êµ¬ë¶„', type:'select', options:['ì •ë³´ì„±','í›„ê¸°ì„±']},
      {key:'totalQty', label:'ì´ìˆ˜ëŸ‰', type:'number'},
      {key:'dailyPublish', label:'ì¼ ë°œí–‰', type:'number'},
      {key:'unitPrice', label:'ë‹¨ê°€', type:'number'},
      {key:'keywords', label:'í‚¤ì›Œë“œ', type:'text'},
      {key:'startDate', label:'ì‹œì‘ì¼', type:'date', required:true},
      {key:'endDate', label:'ì¢…ë£Œì¼', type:'date'},
      {key:'cost', label:'ì‘ì—…ë¹„', type:'computed'},
      {key:'tax', label:'ì„¸ê¸ˆ', type:'select', options:['ë°œí–‰','ë¯¸ë°œí–‰']},
      {key:'note', label:'ë¹„ê³ ', type:'text'}
    ],
    get fields() {
      // í˜„ì¬ ì„œë¸Œíƒ€ì…ì— ë”°ë¼ í•„ë“œ ë°˜í™˜
      return state.placeSubType === 'distribution' ? this.distributionFields : this.rewardFields;
    }
  },
  blog: {
    name: 'ë¸”ë¡œê·¸ ì‘ì—…',
    path: 'blog',
    fields: [
      {key:'manager', label:'ë‹´ë‹¹ì', type:'select', options:['ì „ë³‘í™©', 'ê°•íƒœìš°', 'ì˜¤ì˜ì€', 'ê¹€í•˜ëŠ¬', 'ê¹€ìš°í˜„', 'ê³µë¯¼ê²½']},
      {key:'product', label:'ìƒí’ˆ', type:'text'},
      {key:'category', label:'êµ¬ë¶„', type:'select', options:['ë¸”ë¡œê·¸ë¦¬ë·°','ë‹¨ìˆœë°°í¬','ê±´ë°”ì´','ì›”ë³´ì¥','ì¼ë°˜í˜•','í”„ë¦¬ë¯¸ì—„í˜•']},
      {key:'client', label:'ì—…ì²´ëª…', type:'text', required:true},
      {key:'mid', label:'Mid', type:'url'},
      {key:'keywords', label:'í‚¤ì›Œë“œ', type:'text'},
      {key:'startDate', label:'ì‹œì‘ì¼', type:'date', required:true},
      {key:'endDate', label:'ì¢…ë£Œì¼', type:'date'},
      {key:'totalQty', label:'ì´ëŸ‰', type:'number'},
      {key:'unitPrice', label:'ë‹¨ê°€', type:'number'},
      {key:'cost', label:'ì‘ì—…ë¹„', type:'computed'},
      {key:'tax', label:'ì„¸ê¸ˆ', type:'select', options:['ë°œí–‰','ë¯¸ë°œí–‰']},
      {key:'note', label:'ë¹„ê³ ', type:'text'}
    ]
  },
  project: {
    name: 'í”„ë¡œì íŠ¸',
    path: 'project',
    fields: [
      {key:'manager', label:'ë‹´ë‹¹ì', type:'select', options:['ì „ë³‘í™©', 'ê°•íƒœìš°', 'ì˜¤ì˜ì€', 'ê¹€í•˜ëŠ¬', 'ê¹€ìš°í˜„', 'ê³µë¯¼ê²½']},
      {key:'client', label:'ì—…ì²´ëª…', type:'text', required:true},
      {key:'platform', label:'í”Œë«í¼', type:'select', options:['Instagram','Facebook','TikTok','YouTube']},
      {key:'accountName', label:'ê³„ì •ëª…', type:'text'},
      {key:'url', label:'URL', type:'url'},
      {key:'category', label:'ì¹´í…Œê³ ë¦¬', type:'text'},
      {key:'dailyCost', label:'í•˜ë£¨ë¹„ìš©', type:'number'},
      {key:'startDate', label:'ì‹œì‘ì¼', type:'date', required:true},
      {key:'endDate', label:'ì¢…ë£Œì¼', type:'date'},
      {key:'days', label:'ê¸°ê°„(ì¼)', type:'computed'},
      {key:'totalSpent', label:'ì´ ì§€ì¶œë¹„', type:'computed'},
      {key:'note', label:'ë©”ëª¨', type:'text'}
    ]
  }
};

let auth = null;
let currentUser = null;

// ì¸ì¦ ì´ˆê¸°í™”
function initAuth() {
  console.log('Initializing authentication...');
  
  if (typeof firebase === 'undefined') {
    console.error('Firebase not loaded');
    showLogin();
    return;
  }
  
  if (!firebase.apps || firebase.apps.length === 0) {
    console.error('Firebase App not initialized');
    showLogin();
    return;
  }
  
  try {
    auth = firebase.auth();
    console.log('Firebase Auth initialized');
    
    // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
    auth.onAuthStateChanged(user => {
      if (user) {
        console.log('User logged in:', user.email);
        currentUser = user;
        showDashboard();
        updateUserInfo(user.email);
      } else {
        console.log('User not logged in');
        currentUser = null;
        showLogin();
      }
    });
  } catch (error) {
    console.error('Auth initialization error:', error);
    showLogin();
  }
}

// ë¡œê·¸ì¸ ì²˜ë¦¬
async function handleLogin(email, password) {
  console.log('Login attempt for:', email);
  
  const loginBtn = $('#loginBtn');
  const loginError = $('#loginError');
  
  if (loginBtn) loginBtn.disabled = true;
  if (loginError) loginError.style.display = 'none';
  
  if (!auth) {
    console.error('Auth not initialized');
    if (loginError) {
      loginError.textContent = 'Firebase ì¸ì¦ì´ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.';
      loginError.style.display = 'block';
    }
    if (loginBtn) loginBtn.disabled = false;
    return;
  }
  
  try {
    console.log('Attempting to sign in...');
    const result = await auth.signInWithEmailAndPassword(email, password);
    console.log('Login successful:', result.user.email);
    // ë¡œê·¸ì¸ ì„±ê³µ - onAuthStateChangedê°€ ì²˜ë¦¬í•¨
  } catch (error) {
    console.error('ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
    console.error('Error code:', error.code);
    console.error('Error message:', error.message);
    if (loginError) {
      loginError.textContent = getErrorMessage(error.code);
      loginError.style.display = 'block';
    }
    if (loginBtn) loginBtn.disabled = false;
  }
}

// ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
async function handleLogout() {
  try {
    await auth.signOut();
    // ë¡œê·¸ì•„ì›ƒ ì„±ê³µ - onAuthStateChangedê°€ ì²˜ë¦¬í•¨
  } catch (error) {
    console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
    alert('ë¡œê·¸ì•„ì›ƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
}

// ëŒ€ì‹œë³´ë“œ í‘œì‹œ
function showDashboard() {
  const loginContainer = $('#loginContainer');
  const app = $('#app');
  
  if (loginContainer) loginContainer.style.display = 'none';
  if (app) app.style.display = 'block';
}

// ë¡œê·¸ì¸ í˜ì´ì§€ í‘œì‹œ
function showLogin() {
  const loginContainer = $('#loginContainer');
  const app = $('#app');
  
  if (loginContainer) loginContainer.style.display = 'flex';
  if (app) app.style.display = 'none';
}

// ì‚¬ìš©ì ì •ë³´ ì—…ë°ì´íŠ¸
function updateUserInfo(email) {
  const userInfo = $('#userInfo');
  const userEmail = $('#userEmail');
  
  if (userInfo) userInfo.style.display = 'flex';
  if (userEmail) userEmail.textContent = email;
}

// ì—ëŸ¬ ë©”ì‹œì§€ ë³€í™˜
function getErrorMessage(errorCode) {
  const messages = {
    'auth/invalid-email': 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.',
    'auth/user-disabled': 'ë¹„í™œì„±í™”ëœ ê³„ì •ì…ë‹ˆë‹¤.',
    'auth/user-not-found': 'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.',
    'auth/wrong-password': 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
    'auth/invalid-credential': 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
    'auth/too-many-requests': 'ë„ˆë¬´ ë§ì€ ì‹œë„ê°€ ìˆì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
    'auth/network-request-failed': 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.',
  };
  
  return messages[errorCode] || 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
}

function initFirebase() {
  if (!USE_FIREBASE) {
    updateConnectionStatus('local');
    render();
    return;
  }

  try {
    if (typeof firebase !== 'undefined') {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      
      Object.keys(CONFIGS).forEach(key => {
        dataRefs[key] = db.ref(CONFIGS[key].path);
        setupListeners(key);
        loadData(key);
      });
      
            
      // Finance ë°ì´í„° ë¡œë“œ
      ['place', 'blog', 'project'].forEach(type => {
        loadFinanceData(type);
      });
      
      // Special Notes ë¡œë“œ
      loadSpecialNotes();
      
      db.ref('.info/connected').on('value', s => {
        state.isFirebaseConnected = s.val() === true;
        updateConnectionStatus(state.isFirebaseConnected ? 'connected' : 'disconnected');
      });
    }
  } catch(e) {
    console.error('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', e);
    state.useFirebase = false;
    updateConnectionStatus('local');
  }
}

function updateConnectionStatus(s) {
  const el = $('#connectionStatus');
  if(el) {
    el.className = 'connection-status ' + s;
    const txt = $('#connectionText');
    if(txt) txt.textContent = s === 'connected' ? 'ì‹¤ì‹œê°„ ë™ê¸°í™”' : s === 'local' ? 'ë¡œì»¬ ëª¨ë“œ' : 'ì˜¤í”„ë¼ì¸';
  }
}

function mk(p, config) {
  const id = p.id || 'r_'+Math.random().toString(36).slice(2,9);
  const createdAt = p.createdAt || new Date().toISOString();
  const row = {id, createdAt, ...p};
  
  if (config.path === 'place') {
    // ë¦¬ì›Œë“œì¸ ê²½ìš°ì—ë§Œ ê³„ì‚° (ê¸°ë³¸ê°’ì€ reward)
    const subType = row.subType || 'reward';
    if (subType === 'reward') {
      if (row.units !== undefined && row.days !== undefined) {
        row.totalQty = (row.units||0) * (row.days||0);
      }
      if (row.totalQty !== undefined && row.unitPrice !== undefined) {
        row.cost = (row.totalQty||0) * (row.unitPrice||0);
      }
    } else if (subType === 'distribution') {
      // ë°°í¬ëŠ” ì´ìˆ˜ëŸ‰ * ë‹¨ê°€ë¡œ ê³„ì‚°
      if (row.totalQty !== undefined && row.unitPrice !== undefined) {
        row.cost = (row.totalQty||0) * (row.unitPrice||0);
      }
    }
  } else if (config.path === 'blog') {
    if (row.totalQty !== undefined && row.unitPrice !== undefined) {
      row.cost = (row.totalQty||0) * (row.unitPrice||0);
    }
  } else if (config.path === 'project') {
    if (row.startDate && row.endDate) {
      const start = new Date(row.startDate);
      const end = new Date(row.endDate);
      const diffTime = Math.abs(end - start);
      row.days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    } else {
      row.days = 0;
    }
    row.totalSpent = (row.dailyCost || 0) * (row.days || 0);
  }
  
  return row;
}

function setupListeners(key) {
  if (!dataRefs[key]) return;
  
  dataRefs[key].on('child_added', s => {
    const data = s.val();
    if (data && !state.rows[key].find(r => r.id === data.id)) {
      state.rows[key].unshift(mk(data, CONFIGS[key]));
      if (state.currentType === key) render();
    }
  });

  dataRefs[key].on('child_changed', s => {
    const data = s.val();
    if (data) {
      const idx = state.rows[key].findIndex(r => r.id === data.id);
      if (idx !== -1) {
        state.rows[key][idx] = mk(data, CONFIGS[key]);
        if (state.currentType === key) render();
      }
    }
  });

  dataRefs[key].on('child_removed', s => {
    const data = s.val();
    if (data) {
      state.rows[key] = state.rows[key].filter(r => r.id !== data.id);
      if (state.currentType === key) render();
    }
  });
}

function saveData(row, key) {
  if (!state.useFirebase || !dataRefs[key]) return;
  dataRefs[key].child(row.id).set(row);
}

function deleteData(id, key) {
  if (!state.useFirebase || !dataRefs[key]) return;
  dataRefs[key].child(id).remove();
}

function loadData(key) {
  if (!dataRefs[key]) return;
  dataRefs[key].once('value').then(s => {
    const data = s.val();
    if (data) {
      state.rows[key] = Object.values(data).map(d => mk(d, CONFIGS[key]));
      if (state.currentType === key) render();
    }
  });
}

function switchType(type) {
  const placeSubtabs = $('#placeSubtabs');
  
  // í”Œë ˆì´ìŠ¤ íƒ­ í† ê¸€ ì²˜ë¦¬: ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆê³  ì„œë¸Œíƒ­ì´ í‘œì‹œ ì¤‘ì¼ ë•Œ
  if (type === 'place' && state.currentType === 'place') {
    if (placeSubtabs && placeSubtabs.classList.contains('show')) {
      // ì„œë¸Œíƒ­ ìˆ¨ê¹€
      placeSubtabs.classList.remove('show');
      return;
    }
  }
  
  state.currentType = type;
  state.selected.clear();
  state.pagination.currentPage = 1;
  
  $$('.tab').forEach(t => t.classList.remove('active'));
  const activeTab = $(`.tab[data-type="${type}"]`);
  if (activeTab) activeTab.classList.add('active');
  
  // í”Œë ˆì´ìŠ¤ ì„œë¸Œíƒ­ í‘œì‹œ/ìˆ¨ê¹€
  if (placeSubtabs) {
    if (type === 'place') {
      placeSubtabs.classList.add('show');
    } else {
      placeSubtabs.classList.remove('show');
    }
  }
  
  // íŠ¹ì´ì‚¬í•­ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
  const specialNoteBtn = $('#openSpecialNoteBtn');
  if (specialNoteBtn) {
    if (type === 'finance') {
      specialNoteBtn.style.display = 'none';
    } else {
      specialNoteBtn.style.display = 'inline-block';
    }
  }
  
  if (type === 'finance') {
    const kpisPanel = $('#kpisPanel');
    const tablePanel = $('#tablePanel');
    const summaryPanel = $('#kpisSummaryPanel');
    const financePanel = $('#financePanel');
    
    if (kpisPanel) kpisPanel.style.display = 'none';
    if (tablePanel) tablePanel.style.display = 'none';
    if (summaryPanel) summaryPanel.style.display = 'none';
    if (financePanel) financePanel.style.display = 'block';
    
    // Finance íƒ­ ë Œë”ë§
    setTimeout(() => {
      renderFinance();
    }, 0);
  } else {
    $('#kpisPanel').style.display = 'block';
    $('#tablePanel').style.display = 'block';
    $('#kpisSummaryPanel').style.display = 'block';
    $('#financePanel').style.display = 'none';
    
    render();
  }
}

function applyFilters(rows) {
  const f = state.filters[state.currentType] || {};
  let arr = rows.slice();
  
  // í”Œë ˆì´ìŠ¤ ì„œë¸Œíƒ€ì… í•„í„°ë§
  if (state.currentType === 'place' && state.placeSubType) {
    arr = arr.filter(r => (r.subType || 'reward') === state.placeSubType);
  }
  
  if (f.q) {
    const q = f.q.toLowerCase();
    arr = arr.filter(r => {
      const searchFields = [r.client, r.keywords, r.product, r.category, r.accountName, r.manager, r.platform].filter(Boolean).join(' ').toLowerCase();
      return searchFields.includes(q);
    });
  }
  
  const config = CONFIGS[state.currentType];
  const catField = config.fields.find(x => x.key === 'category');
  if (catField && catField.type === 'select') {
    if (f.category && f.category !== 'all') {
      arr = arr.filter(r => r.category === f.category);
    }
  }
  
  // í”Œë«í¼ í•„í„° (í”„ë¡œì íŠ¸ìš©)
  if (f.platform && f.platform !== 'all') {
    arr = arr.filter(r => r.platform === f.platform);
  }
  
  // ë‹´ë‹¹ì í•„í„° (í”„ë¡œì íŠ¸ìš©)
  if (f.manager && f.manager !== 'all') {
    arr = arr.filter(r => r.manager === f.manager);
  }
  
  if (f.tax && f.tax !== 'all') arr = arr.filter(r => (f.tax === 'yes' ? r.tax === 'ë°œí–‰' : r.tax === 'ë¯¸ë°œí–‰'));
  
  if (f.dday) {
    arr = arr.filter(r => {
      if (!r.endDate) return false;
      const dday = getDDay(r.endDate);
      if (dday === null) return false;
      
      if (f.dday === 'd0') return dday <= 0;
      if (f.dday === 'd1') return dday >= 0 && dday <= 1;
      if (f.dday === 'd3') return dday >= 0 && dday <= 3;
      if (f.dday === 'd7') return dday >= 0 && dday <= 7;
      return true;
    });
  }
  
  // ì›”ë³„ í•„í„°
  if (f.month) {
    arr = arr.filter(r => {
      if (!r.startDate) return false;
      const date = new Date(r.startDate);
      const monthName = (date.getMonth() + 1) + 'ì›”';
      return monthName === f.month;
    });
  }
  
  const [sf, dir] = (f.sort || 'order_asc').split('_');
  const mul = dir === 'asc' ? 1 : -1;
  arr.sort((a, b) => {
    if (sf === 'order') {
      // order í•„ë“œê°€ ì—†ìœ¼ë©´ 9999ë¡œ ì„¤ì •í•˜ì—¬ ë’¤ë¡œ ë³´ëƒ„
      const orderA = typeof a.order === 'number' ? a.order : 9999;
      const orderB = typeof b.order === 'number' ? b.order : 9999;
      return (orderA - orderB) * mul;
    }
    if (sf === 'date') return (a.startDate || '').localeCompare(b.startDate || '') * mul;
    if (sf === 'cost') {
      const costA = config.path === 'project' ? (a.totalSpent || 0) : (a.cost || 0);
      const costB = config.path === 'project' ? (b.totalSpent || 0) : (b.cost || 0);
      return (costA - costB) * mul;
    }
    return 0;
  });
  
  return arr;
}

function createCalendarPicker() {
  const picker = document.createElement('div');
  picker.className = 'calendar-picker';
  
  const input = document.createElement('div');
  input.className = 'calendar-input';
  
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth() + 1;
  const day = today.getDate();
  
  input.innerHTML = `
    <div style="display: flex; align-items: center; gap: 6px; width: 100%;">
      <input type="number" id="yearInput" placeholder="ë…„" value="${year}" min="2020" max="2030" 
        style="width: 70px; padding: 8px 4px; text-align: center; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 6px; font-size: 13px;">
      <span style="color: var(--muted);">-</span>
      <input type="number" id="monthInput" placeholder="ì›”" value="${month}" min="1" max="12" 
        style="width: 50px; padding: 8px 4px; text-align: center; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 6px; font-size: 13px;">
      <span style="color: var(--muted);">-</span>
      <input type="number" id="dayInput" placeholder="ì¼" value="${day}" min="1" max="31" 
        style="width: 50px; padding: 8px 4px; text-align: center; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 6px; font-size: 13px;">
    </div>
    <span style="cursor: pointer; font-size:16px; color: var(--muted);" id="calendarToggle">â–¼</span>
  `;
  
  const dropdown = document.createElement('div');
  dropdown.className = 'calendar-dropdown';
  dropdown.id = 'calendarDropdown';
  
  picker.appendChild(input);
  picker.appendChild(dropdown);
  
  const toggleBtn = input.querySelector('#calendarToggle');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    dropdown.classList.toggle('active');
    if (dropdown.classList.contains('active')) {
      renderCalendar();
    }
    });
  }
  
  const yearInput = input.querySelector('#yearInput');
  const monthInput = input.querySelector('#monthInput');
  const dayInput = input.querySelector('#dayInput');
  
  const updateDateFromInputs = () => {
    const y = parseInt(yearInput.value) || year;
    const m = parseInt(monthInput.value) || month;
    const d = parseInt(dayInput.value) || day;
    
    if (m < 1 || m > 12 || d < 1 || d > 31) return;
    
    try {
      const dateStr = toISO(new Date(y, m - 1, d));
      state.calendarState.selectedDate = dateStr;
      if (!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].selectedDate = dateStr;
      state.pagination.currentPage = 1;
      renderTable();
    } catch (e) {
      console.error('Invalid date:', e);
    }
  };
  
  if (yearInput) yearInput.addEventListener('change', updateDateFromInputs);
  if (monthInput) monthInput.addEventListener('change', updateDateFromInputs);
  if (dayInput) dayInput.addEventListener('change', updateDateFromInputs);
  
  document.addEventListener('click', (e) => {
    if (!picker.contains(e.target)) {
      dropdown.classList.remove('active');
    }
  });
  
  return picker;
}

function renderCalendar() {
  const dropdown = $('#calendarDropdown');
  if (!dropdown) return;
  
  const current = state.calendarState.currentMonth;
  const year = current.getFullYear();
  const month = current.getMonth();
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const prevLastDay = new Date(year, month, 0);
  
  const firstDayOfWeek = firstDay.getDay();
  const lastDate = lastDay.getDate();
  const prevLastDate = prevLastDay.getDate();
  
  const todayStr = toISO(new Date());
  const selectedStr = state.calendarState.selectedDate;
  
  let html = `
    <div class="calendar-header">
      <button id="prevMonth">â–²</button>
      <div class="month-year">
        <select id="yearSelect">
          ${[2024, 2025, 2026, 2027].map(y => `<option value="${y}" ${y === year ? 'selected' : ''}>${y}ë…„</option>`).join('')}
        </select>
        <select id="monthSelect">
          ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${m === month + 1 ? 'selected' : ''}>${m}ì›”</option>`).join('')}
        </select>
      </div>
      <button id="nextMonth">â–¼</button>
    </div>
    <div class="calendar-weekdays">
      <div class="calendar-weekday">ì¼</div>
      <div class="calendar-weekday">ì›”</div>
      <div class="calendar-weekday">í™”</div>
      <div class="calendar-weekday">ìˆ˜</div>
      <div class="calendar-weekday">ëª©</div>
      <div class="calendar-weekday">ê¸ˆ</div>
      <div class="calendar-weekday">í† </div>
    </div>
    <div class="calendar-days">
  `;
  
  // ì´ì „ ë‹¬ ë‚ ì§œ
  for (let i = firstDayOfWeek; i > 0; i--) {
    html += `<div class="calendar-day disabled">${prevLastDate - i + 1}</div>`;
  }
  
  // í˜„ì¬ ë‹¬ ë‚ ì§œ
  for (let date = 1; date <= lastDate; date++) {
    const dateStr = toISO(new Date(year, month, date));
    const isToday = dateStr === todayStr;
    const isSelected = dateStr === selectedStr;
    const classes = ['calendar-day'];
    if (isToday) classes.push('today');
    if (isSelected) classes.push('selected');
    
    html += `<div class="${classes.join(' ')}" data-date="${dateStr}">${date}</div>`;
  }
  
  // ë‹¤ìŒ ë‹¬ ë‚ ì§œ
  const totalCells = firstDayOfWeek + lastDate;
  const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  for (let date = 1; date <= remainingCells; date++) {
    html += `<div class="calendar-day disabled">${date}</div>`;
  }
  
  html += `</div>
    <div class="calendar-actions">
      <button class="clear-btn" id="clearDate">ì§€ìš°ê¸°</button>
      <button class="today-btn" id="todayDate">ì˜¤ëŠ˜</button>
    </div>
  `;
  
  dropdown.innerHTML = html;
  
  // ì´ì „/ë‹¤ìŒ ì›” ë²„íŠ¼
  $('#prevMonth')?.addEventListener('click', () => {
    state.calendarState.currentMonth = new Date(year, month - 1);
    renderCalendar();
  });
  
  $('#nextMonth')?.addEventListener('click', () => {
    state.calendarState.currentMonth = new Date(year, month + 1);
    renderCalendar();
  });
  
  // ë…„/ì›” ì„ íƒ
  $('#yearSelect')?.addEventListener('change', (e) => {
    const newYear = parseInt(e.target.value);
    state.calendarState.currentMonth = new Date(newYear, month);
    renderCalendar();
  });
  
  $('#monthSelect')?.addEventListener('change', (e) => {
    const newMonth = parseInt(e.target.value) - 1;
    state.calendarState.currentMonth = new Date(year, newMonth);
    renderCalendar();
  });
  
  // ë‚ ì§œ ì„ íƒ
  dropdown.querySelectorAll('.calendar-day:not(.disabled)').forEach(day => {
    day.addEventListener('click', () => {
      const dateStr = day.dataset.date;
      state.calendarState.selectedDate = dateStr;
      if (!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].selectedDate = dateStr;
      state.pagination.currentPage = 1;
      
      const yearInput = $('#yearInput');
      const monthInput = $('#monthInput');
      const dayInput = $('#dayInput');
      if (yearInput && monthInput && dayInput) {
        const date = new Date(dateStr);
        yearInput.value = date.getFullYear();
        monthInput.value = date.getMonth() + 1;
        dayInput.value = date.getDate();
      }
      
      dropdown.classList.remove('active');
      renderTable();
    });
  });
  
  // ì§€ìš°ê¸° ë²„íŠ¼
  $('#clearDate')?.addEventListener('click', () => {
    state.calendarState.selectedDate = null;
    if (state.filters[state.currentType]) {
      delete state.filters[state.currentType].selectedDate;
    }
    state.pagination.currentPage = 1;
    
    const yearInput = $('#yearInput');
    const monthInput = $('#monthInput');
    const dayInput = $('#dayInput');
    if (yearInput && monthInput && dayInput) {
      const today = new Date();
      yearInput.value = today.getFullYear();
      monthInput.value = today.getMonth() + 1;
      dayInput.value = today.getDate();
    }
    
    dropdown.classList.remove('active');
    renderTable();
  });
  
  // ì˜¤ëŠ˜ ë²„íŠ¼
  $('#todayDate')?.addEventListener('click', () => {
    const dateStr = todayStr;
    state.calendarState.selectedDate = dateStr;
    if (!state.filters[state.currentType]) state.filters[state.currentType] = {};
    state.filters[state.currentType].selectedDate = dateStr;
    state.pagination.currentPage = 1;
    
    const yearInput = $('#yearInput');
      const monthInput = $('#monthInput');
      const dayInput = $('#dayInput');
      if (yearInput && monthInput && dayInput) {
        const date = new Date(dateStr);
        yearInput.value = date.getFullYear();
        monthInput.value = date.getMonth() + 1;
        dayInput.value = date.getDate();
      }
    
    dropdown.classList.remove('active');
    renderTable();
  });
}

function renderFilters() {
  const config = CONFIGS[state.currentType];
  if(!config) return;
  
  const f = state.filters[state.currentType] || {};
  
  // í”„ë¡œì íŠ¸ ì—¬ë¶€ì— ë”°ë¼ ê·¸ë¦¬ë“œ êµ¬ì„±
  const isProject = config.path === 'project';
  
  let html = '<div class="filters" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr auto;">';
  
  // ê²€ìƒ‰ í•„í„°
  html += `
    <div class="filter-group">
      <label class="filter-label">ğŸ” ê²€ìƒ‰</label>
      <input id="q" placeholder="ì—…ì²´ëª…, í‚¤ì›Œë“œ, ë‹´ë‹¹ì ê²€ìƒ‰..." value="${f.q || ''}">
    </div>
  `;
  
  // ì¹´í…Œê³ ë¦¬/í”Œë«í¼ í•„í„°
  const catField = config.fields.find(x => x.key === 'category');
  const platformField = config.fields.find(x => x.key === 'platform');
  
  if (catField && catField.type === 'select') {
    html += `
      <div class="filter-group">
        <label class="filter-label">ğŸ“‚ ì¹´í…Œê³ ë¦¬</label>
        <select id="fcat">
          <option value="all">ì „ì²´</option>
    `;
    catField.options.forEach(o => html += `<option value="${o}" ${f.category === o ? 'selected' : ''}>${o}</option>`);
    html += `</select></div>`;
  } else if (platformField && platformField.type === 'select') {
    // í”„ë¡œì íŠ¸ì˜ ê²½ìš° í”Œë«í¼ í•„í„°
    html += `
      <div class="filter-group">
        <label class="filter-label">ğŸ“± í”Œë«í¼</label>
        <select id="fplatform">
          <option value="all">ì „ì²´</option>
    `;
    platformField.options.forEach(o => html += `<option value="${o}" ${f.platform === o ? 'selected' : ''}>${o}</option>`);
    html += `</select></div>`;
  }
  
  // ë‹´ë‹¹ì í•„í„° (í”„ë¡œì íŠ¸ìš©) ë˜ëŠ” ì„¸ê¸ˆ í•„í„° (í”Œë ˆì´ìŠ¤/ë¸”ë¡œê·¸ìš©)
  if (isProject) {
    const managerField = config.fields.find(x => x.key === 'manager');
    if (managerField && managerField.type === 'select') {
      html += `
        <div class="filter-group">
          <label class="filter-label">ğŸ‘¤ ë‹´ë‹¹ì</label>
          <select id="fmanager">
            <option value="all">ì „ì²´</option>
      `;
      managerField.options.forEach(o => html += `<option value="${o}" ${f.manager === o ? 'selected' : ''}>${o}</option>`);
      html += `</select></div>`;
    }
  } else if (config.path === 'place' || config.path === 'blog') {
    html += `
      <div class="filter-group">
        <label class="filter-label">ğŸ’³ ì„¸ê¸ˆê³„ì‚°ì„œ</label>
        <select id="ftax">
          <option value="all" ${!f.tax||f.tax==='all'?'selected':''}>ì „ì²´</option>
          <option value="completed" ${f.tax==='completed'?'selected':''}>ë°œí–‰ì™„ë£Œ</option>
          <option value="yes" ${f.tax==='yes'?'selected':''}>ë°œí–‰</option>
          <option value="no" ${f.tax==='no'?'selected':''}>ë¯¸ë°œí–‰</option>
        </select>
      </div>
    `;
  }
  
  // ì›”ë³„ ì¡°íšŒ í•„í„°
  html += `
    <div class="filter-group">
      <label class="filter-label">ğŸ“Š ì›”ë³„ ì¡°íšŒ</label>
      <select id="fmonth">
        <option value="">ì „ì²´ ì›”</option>
        <option value="1ì›”" ${f.month==='1ì›”'?'selected':''}>1ì›”</option>
        <option value="2ì›”" ${f.month==='2ì›”'?'selected':''}>2ì›”</option>
        <option value="3ì›”" ${f.month==='3ì›”'?'selected':''}>3ì›”</option>
        <option value="4ì›”" ${f.month==='4ì›”'?'selected':''}>4ì›”</option>
        <option value="5ì›”" ${f.month==='5ì›”'?'selected':''}>5ì›”</option>
        <option value="6ì›”" ${f.month==='6ì›”'?'selected':''}>6ì›”</option>
        <option value="7ì›”" ${f.month==='7ì›”'?'selected':''}>7ì›”</option>
        <option value="8ì›”" ${f.month==='8ì›”'?'selected':''}>8ì›”</option>
        <option value="9ì›”" ${f.month==='9ì›”'?'selected':''}>9ì›”</option>
        <option value="10ì›”" ${f.month==='10ì›”'?'selected':''}>10ì›”</option>
        <option value="11ì›”" ${f.month==='11ì›”'?'selected':''}>11ì›”</option>
        <option value="12ì›”" ${f.month==='12ì›”'?'selected':''}>12ì›”</option>
      </select>
    </div>
  `;
  
  // D-day í•„í„°
  html += `
    <div class="filter-group">
      <label class="filter-label">â° ì¢…ë£Œì¼</label>
      <select id="fdday">
        <option value="" ${!f.dday?'selected':''}>ì „ì²´</option>
        <option value="d0" ${f.dday==='d0'?'selected':''}>âš ï¸ ì¢…ë£Œ/D-0</option>
        <option value="d1" ${f.dday==='d1'?'selected':''}>ğŸ”” D-1 ì´ë‚´</option>
        <option value="d3" ${f.dday==='d3'?'selected':''}>ğŸ“Œ D-3 ì´ë‚´</option>
        <option value="d7" ${f.dday==='d7'?'selected':''}>ğŸ“… D-7 ì´ë‚´</option>
      </select>
    </div>
  `;
  
  // ì •ë ¬ í•„í„°
  const sortLabel = config.path === 'project' ? 'ì§€ì¶œë¹„' : 'ì‘ì—…ë¹„';
  html += `
    <div class="filter-group">
      <label class="filter-label">ğŸ”„ ì •ë ¬</label>
      <select id="fsort">
        <option value="order_asc" ${!f.sort||f.sort==='order_asc'?'selected':''}>ğŸ“ ë“±ë¡ìˆœ</option>
        <option value="date_desc" ${f.sort==='date_desc'?'selected':''}>ğŸ“† ìµœì‹ ìˆœ</option>
        <option value="date_asc" ${f.sort==='date_asc'?'selected':''}>ğŸ“† ì˜¤ë˜ëœìˆœ</option>
        <option value="cost_desc" ${f.sort==='cost_desc'?'selected':''}>ğŸ’° ${sortLabel} ë†’ì€ìˆœ</option>
        <option value="cost_asc" ${f.sort==='cost_asc'?'selected':''}>ğŸ’° ${sortLabel} ë‚®ì€ìˆœ</option>
      </select>
    </div>
  `;
  
  // ì´ˆê¸°í™” ë²„íŠ¼ì„ ê°™ì€ ì¤„ì— ì¶”ê°€
  html += `
    <div class="filter-group">
      <label class="filter-label" style="opacity:0">ì´ˆê¸°í™”</label>
      <button class="btn small outline" id="bresetbtn" style="white-space:nowrap">ğŸ”„ ì´ˆê¸°í™”</button>
    </div>
  `;
  
  html += '</div>';
  
  const container = $('#filtersContainer');
  if(container) container.innerHTML = html;
  
  const qEl = $('#q');
  if(qEl) {
    qEl.addEventListener('input', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].q = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const fcatEl = $('#fcat');
  if(fcatEl) {
    fcatEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].category = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const fplatformEl = $('#fplatform');
  if(fplatformEl) {
    fplatformEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].platform = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const fmanagerEl = $('#fmanager');
  if(fmanagerEl) {
    fmanagerEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].manager = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const ftaxEl = $('#ftax');
  if(ftaxEl) {
    ftaxEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].tax = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const fmonthEl = $('#fmonth');
  if(fmonthEl) {
    fmonthEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].month = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const fddayEl = $('#fdday');
  if(fddayEl) {
    fddayEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].dday = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const fsortEl = $('#fsort');
  if(fsortEl) {
    fsortEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].sort = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const resetBtn = $('#bresetbtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      state.filters[state.currentType] = {};
      state.pagination.currentPage = 1;
      render();
    });
  }
}

function renderTable() {
  const config = CONFIGS[state.currentType];
  if(!config) return;
  
  const rows = state.rows[state.currentType];
  
  const titleEl = $('#listTitle');
  if(titleEl) titleEl.textContent = config.name;
  
  let h = '<tr><th class="center"><input type="checkbox" id="chkAll"></th>';
  config.fields.forEach(f => h += `<th class="${f.type === 'number' || f.type === 'computed' ? 'num' : ''}">${f.label}</th>`);
  h += '</tr>';
  
  const theadEl = $('#thead');
  if(theadEl) theadEl.innerHTML = h;
  
  const tbody = $('#tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  
  const filtered = applyFilters(rows);
  const {perPage, currentPage} = state.pagination;
  const pages = Math.ceil(filtered.length / perPage);
  const start = (currentPage - 1) * perPage;
  const pageRows = filtered.slice(start, start + perPage);
  
  pageRows.forEach((row, rowIndex) => {
    const tr = document.createElement('tr');
    const rowClass = getRowClass(row.endDate);
    if (rowClass) tr.className = rowClass;
    
    
    const td0 = document.createElement('td');
    td0.className = 'center';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = state.selected.has(row.id);
    cb.addEventListener('change', () => {
      if (cb.checked) state.selected.add(row.id);
      else state.selected.delete(row.id);
      
      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
      const chkAll = $('#chkAll');
      if (chkAll) {
        const allCheckboxes = tbody.querySelectorAll('input[type="checkbox"]');
        const allChecked = Array.from(allCheckboxes).every(checkbox => checkbox.checked);
        chkAll.checked = allChecked;
      }
      
      updateBulkEditBar();
    });
    td0.appendChild(cb);
    tr.appendChild(td0);
    
    config.fields.forEach(f => {
      const td = document.createElement('td');
      if (f.type === 'computed') {
        if (f.key === 'totalQty') {
          td.textContent = row.totalQty || '';
          td.className = 'num';
        } else if (f.key === 'cost') {
          td.textContent = fmtMoney(row.cost || 0);
          td.className = 'num';
        } else if (f.key === 'days') {
          td.textContent = row.days || '';
          td.className = 'num';
        } else if (f.key === 'totalSpent') {
          td.textContent = fmtMoney(row.totalSpent || 0);
          td.className = 'num';
        }
      } else if (f.type === 'number') {
        td.textContent = row[f.key] ?? '';
        td.className = 'num';
        td.style.cursor = 'pointer';
        td.addEventListener('click', () => startEdit(td, row, f));
      } else if (f.key === 'mid' || f.key === 'url') {
        const urlValue = row[f.key] || '';
        if (urlValue) {
          const btn = document.createElement('button');
          btn.className = 'btn mini';
          btn.textContent = 'ğŸ”— ì—´ê¸°';
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            let url = urlValue;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
              url = 'https://' + url;
            }
            window.open(url, '_blank');
          });
          td.appendChild(btn);
        } else {
          td.textContent = 'ì…ë ¥ í•„ìš”';
          td.style.cursor = 'pointer';
          td.style.color = 'var(--muted)';
          td.addEventListener('click', () => startEdit(td, row, f));
        }
      } else if (f.key === 'note') {
        const noteValue = row[f.key] || '';
        
        // í”Œë ˆì´ìŠ¤ ì‘ì—…ì¸ì§€ í™•ì¸
        const isPlace = state.currentType === 'place';
        
        if (isPlace) {
          // í”Œë ˆì´ìŠ¤ ì‘ì—…ì€ ë©”ëª¨ ë²„íŠ¼ ì—†ì´ í…ìŠ¤íŠ¸ë§Œ í‘œì‹œ
          td.textContent = noteValue;
          td.style.cursor = 'pointer';
          td.addEventListener('click', () => startEdit(td, row, f));
        } else {
          // ë‹¤ë¥¸ ì‘ì—…ì€ ë©”ëª¨ ë²„íŠ¼ í¬í•¨
          const wrapper = document.createElement('div');
          wrapper.style.display = 'flex';
          wrapper.style.gap = '8px';
          wrapper.style.alignItems = 'center';
          
          const noteSpan = document.createElement('span');
          noteSpan.textContent = noteValue.length > 20 ? noteValue.substring(0, 20) + '...' : (noteValue || '');
          noteSpan.style.flex = '1';
          noteSpan.style.cursor = 'pointer';
          noteSpan.addEventListener('click', () => startEdit(td, row, f));
          
          const memoBtn = document.createElement('button');
          memoBtn.className = 'btn mini';
          memoBtn.textContent = 'ğŸ“ ë©”ëª¨';
          memoBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openMemoModal(row, state.currentType);
          });
          
          wrapper.appendChild(noteSpan);
          wrapper.appendChild(memoBtn);
          td.appendChild(wrapper);
        }
      } else if (f.key === 'endDate') {
        const dateText = row[f.key] || '';
        const badge = getDDayBadge(row.endDate);
        td.innerHTML = `${dateText} ${badge}`;
        td.style.cursor = 'pointer';
        td.addEventListener('click', () => startEdit(td, row, f));
      } else {
        td.textContent = row[f.key] ?? '';
        td.style.cursor = 'pointer';
        td.addEventListener('click', () => startEdit(td, row, f));
      }
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });
  
  const countEl = $('#countInfo');
  if(countEl) countEl.textContent = `${filtered.length}ê±´`;
  
  const chkAll = $('#chkAll');
  if (chkAll) {
    // ì´ˆê¸° ìƒíƒœ ì„¤ì •: í˜„ì¬ í˜ì´ì§€ì˜ ëª¨ë“  í•­ëª©ì´ ì„ íƒë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    const allSelected = pageRows.length > 0 && pageRows.every(row => state.selected.has(row.id));
    chkAll.checked = allSelected;
    
    chkAll.addEventListener('change', () => {
      // í˜„ì¬ í˜ì´ì§€ì˜ ëª¨ë“  ì²´í¬ë°•ìŠ¤ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
      const checkboxes = tbody.querySelectorAll('input[type="checkbox"]');
      
      checkboxes.forEach((cb, index) => {
        const row = pageRows[index];
        if (row) {
          cb.checked = chkAll.checked;
          if (chkAll.checked) {
            state.selected.add(row.id);
          } else {
            state.selected.delete(row.id);
          }
        }
      });
      
      updateBulkEditBar();
    });
  }
  
  updateBulkEditBar();
  renderKpis();
  
  const p = $('#pagination');
  if(!p) return;
  p.innerHTML = '';
  if (pages <= 1) return;
  
  const prev = document.createElement('button');
  prev.className = 'page-btn';
  prev.textContent = 'â€¹';
  prev.disabled = currentPage === 1;
  prev.addEventListener('click', () => {
    state.pagination.currentPage--;
    renderTable();
  });
  p.appendChild(prev);
  
  let s = Math.max(1, currentPage - 3);
  let e = Math.min(pages, s + 6);
  
  for (let i = s; i <= e; i++) {
    const btn = document.createElement('button');
    btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
    btn.textContent = i;
    btn.addEventListener('click', () => {
      state.pagination.currentPage = i;
      renderTable();
    });
    p.appendChild(btn);
  }
  
  const next = document.createElement('button');
  next.className = 'page-btn';
  next.textContent = 'â€º';
  next.disabled = currentPage === pages;
  next.addEventListener('click', () => {
    state.pagination.currentPage++;
    renderTable();
  });
  p.appendChild(next);
  
}


function updateBulkEditBar() {
  const count = state.selected.size;
  const countEl = $('#selectedCount');
  if(countEl) countEl.textContent = `${count}ê°œ ì„ íƒ`;
  
  const barEl = $('#bulkEditBar');
  if(barEl) barEl.classList.toggle('active', count > 0);
}

function cloneSelected() {
  if (!state.selected.size) {
    alert('ë³µì œí•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  if (!confirm(`ì„ íƒí•œ ${state.selected.size}ê°œ í•­ëª©ì„ ë³µì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    return;
  }
  
  const config = CONFIGS[state.currentType];
  const selectedRows = state.rows[state.currentType].filter(r => state.selected.has(r.id));
  
  selectedRows.forEach(row => {
    const clonedData = {...row};
    delete clonedData.id;
    delete clonedData.createdAt;
    
    const newRow = mk(clonedData, config);
    state.rows[state.currentType].unshift(newRow);
    saveData(newRow, state.currentType);
  });
  
  state.selected.clear();
  render();
  alert(`${selectedRows.length}ê°œ í•­ëª©ì´ ë³µì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
}

function openReportModal() {
  if (!state.selected.size) {
    alert('ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const config = CONFIGS[state.currentType];
  const selectedRows = state.rows[state.currentType].filter(r => state.selected.has(r.id));
  
  let reportText = `ğŸ“Š ${config.name} ë¦¬í¬íŠ¸\n`;
  reportText += `ìƒì„±ì¼ì‹œ: ${new Date().toLocaleString('ko-KR')}\n`;
  reportText += `ì´ ${selectedRows.length}ê°œ ì—…ì²´\n`;
  reportText += `${'='.repeat(50)}\n\n`;
  
  selectedRows.forEach((row, idx) => {
    reportText += `[${idx + 1}] ${row.client || 'ì—…ì²´ëª… ì—†ìŒ'}\n`;
    
    if (config.path === 'project') {
      if (row.manager) reportText += `ë‹´ë‹¹ì: ${row.manager}\n`;
      if (row.platform) reportText += `í”Œë«í¼: ${row.platform}\n`;
      if (row.accountName) reportText += `ê³„ì •ëª…: ${row.accountName}\n`;
      if (row.category) reportText += `ì¹´í…Œê³ ë¦¬: ${row.category}\n`;
      
      if (row.startDate) {
        reportText += `ì‹œì‘ì¼: ${row.startDate}`;
        if (row.endDate) {
          const dday = getDDay(row.endDate);
          reportText += ` ~ ${row.endDate}`;
          if (dday !== null) {
            if (dday < 0) reportText += ` (ì¢…ë£Œë¨)`;
            else if (dday === 0) reportText += ` (âš ï¸ ì˜¤ëŠ˜ ì¢…ë£Œ)`;
            else if (dday <= 3) reportText += ` (â° ${dday}ì¼ ë‚¨ìŒ)`;
          }
          reportText += ` (${row.days || 0}ì¼)`;
        }
        reportText += `\n`;
      }
      
      if (row.dailyCost) reportText += `í•˜ë£¨ë¹„ìš©: ${fmtMoney(row.dailyCost)}\n`;
      if (row.totalSpent) reportText += `ğŸ’° ì´ ì§€ì¶œë¹„: ${fmtMoney(row.totalSpent)}\n`;
    } else {
      reportText += `ìƒí’ˆ: ${row.product || '-'}\n`;
      reportText += `êµ¬ë¶„: ${row.category || '-'}\n`;
      
      if (row.startDate) {
        reportText += `ì‹œì‘ì¼: ${row.startDate}`;
        if (row.endDate) {
          const dday = getDDay(row.endDate);
          reportText += ` ~ ${row.endDate}`;
          if (dday !== null) {
            if (dday < 0) reportText += ` (ì¢…ë£Œë¨)`;
            else if (dday === 0) reportText += ` (âš ï¸ ì˜¤ëŠ˜ ì¢…ë£Œ)`;
            else if (dday <= 3) reportText += ` (â° ${dday}ì¼ ë‚¨ìŒ)`;
          }
        }
        reportText += `\n`;
      }
      
      if (config.path === 'place') {
        if (row.units || row.days) {
          reportText += `ì¼íƒ€: ${row.units || 0} | ì¼ìˆ˜: ${row.days || 0} | ì´ëŸ‰: ${row.totalQty || 0}\n`;
        }
      } else if (config.path === 'blog') {
        if (row.totalQty) {
          reportText += `ì´ëŸ‰: ${row.totalQty}\n`;
        }
      }
      
      if (row.unitPrice) {
        reportText += `ë‹¨ê°€: ${fmtMoney(row.unitPrice)}\n`;
      }
      
      if (row.cost) {
        reportText += `ğŸ’° ì‘ì—…ë¹„: ${fmtMoney(row.cost)}\n`;
      }
      
      if (row.tax) {
        reportText += `ì„¸ê¸ˆê³„ì‚°ì„œ: ${row.tax}\n`;
      }
      
      if (row.keywords) {
        reportText += `í‚¤ì›Œë“œ: ${row.keywords}\n`;
      }
    }
    
    if (row.note || row.clientMemo) {
      reportText += `ë©”ëª¨: ${row.note || row.clientMemo || ''}\n`;
    }
    
    reportText += `${'-'.repeat(50)}\n`;
  });
  
  let totalCost = 0;
  let totalQty = 0;
  
  if (config.path === 'project') {
    totalCost = selectedRows.reduce((sum, row) => sum + (row.totalSpent || 0), 0);
    const totalDays = selectedRows.reduce((sum, row) => sum + (row.days || 0), 0);
    
    reportText += `\nğŸ“ˆ ìš”ì•½ ì •ë³´\n`;
    reportText += `${'='.repeat(50)}\n`;
    reportText += `ì´ ì—…ì²´ ìˆ˜: ${selectedRows.length}ê°œ\n`;
    reportText += `ì´ ì§„í–‰ì¼ìˆ˜: ${totalDays}ì¼\n`;
    reportText += `ì´ ì§€ì¶œë¹„: ${fmtMoney(totalCost)}\n`;
  } else {
    totalCost = selectedRows.reduce((sum, row) => sum + (row.cost || 0), 0);
    totalQty = selectedRows.reduce((sum, row) => sum + (row.totalQty || 0), 0);
    
    reportText += `\nğŸ“ˆ ìš”ì•½ ì •ë³´\n`;
    reportText += `${'='.repeat(50)}\n`;
    reportText += `ì´ ì—…ì²´ ìˆ˜: ${selectedRows.length}ê°œ\n`;
    reportText += `ì´ ì‘ì—…ëŸ‰: ${totalQty.toLocaleString('ko-KR')}\n`;
    reportText += `ì´ ì‘ì—…ë¹„: ${fmtMoney(totalCost)}\n`;
    reportText += `í‰ê·  ë‹¨ê°€: ${fmtMoney(totalQty > 0 ? totalCost / totalQty : 0)}\n`;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal-back active';
  
  const content = document.createElement('div');
  content.className = 'modal';
  content.style.maxWidth = '800px';
  
  content.innerHTML = `
    <div class="mh">
      <strong>ğŸ“± ë¦¬í¬íŠ¸ ë°œì†¡ ë¬¸ì</strong>
      <button class="btn small outline" id="closeReportModal">âœ• ë‹«ê¸°</button>
    </div>
    <div class="mb">
      <div style="margin-bottom:16px; padding:12px 16px; background:var(--card2); border-radius:8px; border-left:3px solid var(--primary)">
        <div style="font-size:12px; color:var(--muted); margin-bottom:4px">ì„ íƒëœ í•­ëª©</div>
        <div style="font-weight:700; font-size:16px">${selectedRows.length}ê°œ ì—…ì²´ | ì´ ì‘ì—…ë¹„ ${fmtMoney(totalCost)}</div>
      </div>
      <div class="report-text" id="reportTextContent">${reportText}</div>
      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:16px">
        <button class="btn outline" id="closeReportBtn">ë‹«ê¸°</button>
        <button class="btn success" id="copyReportBtn">ğŸ“‹ ë³µì‚¬í•˜ê¸°</button>
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  
  const closeModal = () => {
    if(document.body.contains(modal)) document.body.removeChild(modal);
  };
  
  content.querySelector('#closeReportModal').addEventListener('click', closeModal);
  content.querySelector('#closeReportBtn').addEventListener('click', closeModal);
  
  content.querySelector('#copyReportBtn').addEventListener('click', () => {
    navigator.clipboard.writeText(reportText).then(() => {
      const btn = content.querySelector('#copyReportBtn');
      const originalText = btn.textContent;
      btn.textContent = 'âœ… ë³µì‚¬ ì™„ë£Œ!';
      btn.style.background = 'var(--green)';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 2000);
    }).catch(() => {
      alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í…ìŠ¤íŠ¸ë¥¼ ì§ì ‘ ì„ íƒí•´ì„œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
    });
  });
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
}

function openMemoModal(row, type) {
  const modal = document.createElement('div');
  modal.className = 'modal-back active';
  
  const content = document.createElement('div');
  content.className = 'modal';
  content.style.maxWidth = '800px';
  
  const currentMemo = row.clientMemo || '';
  
  content.innerHTML = `
    <div class="mh">
      <strong>ğŸ“ ì—…ì²´ ìƒë‹´ ë‚´ìš© ë©”ëª¨</strong>
      <button class="btn small outline" id="closeMemoModal">âœ• ë‹«ê¸°</button>
    </div>
    <div class="mb">
      <div style="margin-bottom:12px">
        <strong style="color:var(--primary-light)">${row.client || 'ì—…ì²´ëª… ì—†ìŒ'}</strong>
        <span style="color:var(--muted); margin-left:8px">${row.product || ''}</span>
      </div>
      <textarea id="memoContent" style="width:100%; min-height:300px; padding:16px; border:2px solid var(--border); border-radius:12px; background:var(--card); color:var(--text); font-size:14px; font-family:inherit; line-height:1.6; resize:vertical">${currentMemo}</textarea>
      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:16px">
        <button class="btn outline" id="cancelMemo">ì·¨ì†Œ</button>
        <button class="btn" id="saveMemo">ì €ì¥</button>
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  
  const textarea = content.querySelector('#memoContent');
  textarea.focus();
  
  const closeModal = () => {
    if(document.body.contains(modal)) document.body.removeChild(modal);
  };
  
  content.querySelector('#closeMemoModal').addEventListener('click', closeModal);
  content.querySelector('#cancelMemo').addEventListener('click', closeModal);
  
  content.querySelector('#saveMemo').addEventListener('click', () => {
    row.clientMemo = textarea.value;
    saveData(row, type);
    closeModal();
    render();
  });
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
}

function openMonthDetailModal(yearMonth, rows) {
  const [year, month] = yearMonth.split('-');
  const monthRows = rows.filter(r => r.startDate && getYearMonth(r.startDate) === yearMonth);
  
  const config = CONFIGS[state.currentType];
  
  const byCategory = {};
  const byClient = {};
  let totalCost = 0;
  
  monthRows.forEach(r => {
    const category = config.path === 'project' ? (r.platform || 'ë¯¸ë¶„ë¥˜') : (r.product || 'ë¯¸ë¶„ë¥˜');
    const client = r.client || 'ì—…ì²´ëª… ì—†ìŒ';
    const cost = config.path === 'project' ? (r.totalSpent || 0) : (r.cost || 0);
    
    byCategory[category] = (byCategory[category] || 0) + cost;
    byClient[client] = (byClient[client] || 0) + cost;
    totalCost += cost;
  });
  
  const categoryData = Object.entries(byCategory).sort((a, b) => b[1] - a[1]);
  const clientData = Object.entries(byClient).sort((a, b) => b[1] - a[1]);
  
  const modal = document.createElement('div');
  modal.className = 'modal-back active';
  
  const content = document.createElement('div');
  content.className = 'modal';
  content.style.maxWidth = '1000px';
  
  const categoryLabel = config.path === 'project' ? 'í”Œë«í¼ë³„' : 'ìƒí’ˆë³„';
  
  const categoryList = categoryData.map(([name, cost]) => {
    const percentage = totalCost > 0 ? ((cost / totalCost) * 100).toFixed(1) : 0;
    return `<div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--card2); border-radius:8px; margin-bottom:8px">
      <div style="flex:1">
        <strong>${name}</strong>
        <div style="font-size:12px; color:var(--muted); margin-top:4px">${percentage}%</div>
      </div>
      <strong style="color:var(--primary-light)">${fmtMoney(cost)}</strong>
    </div>`;
  }).join('');
  
  const clientList = clientData.slice(0, 10).map(([name, cost]) => {
    const percentage = totalCost > 0 ? ((cost / totalCost) * 100).toFixed(1) : 0;
    return `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:var(--card2); border-radius:6px; margin-bottom:6px">
      <span>${name}</span>
      <div style="text-align:right">
        <strong style="color:var(--text)">${fmtMoney(cost)}</strong>
        <div style="font-size:11px; color:var(--muted)">${percentage}%</div>
      </div>
    </div>`;
  }).join('');
  
  const chartId = 'pieChart_' + Math.random().toString(36).slice(2, 9);
  const costLabel = config.path === 'project' ? 'ì§€ì¶œë¹„' : 'ì‘ì—…ë¹„';
  
  content.innerHTML = `
    <div class="mh">
      <strong>ğŸ“Š ${year}ë…„ ${month}ì›” ${costLabel} ìƒì„¸</strong>
      <button class="btn small outline" id="closeMonthModal">âœ• ë‹«ê¸°</button>
    </div>
    <div class="mb">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:24px">
        <div class="kpi" style="grid-column:1/-1">
          <div class="muted">ì´ ${costLabel}</div>
          <div class="v">${fmtMoney(totalCost)}</div>
        </div>
      </div>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px">
        <div>
          <div style="font-weight:700; margin-bottom:16px; color:var(--primary-light)">ğŸ“ˆ ${categoryLabel} ${costLabel}</div>
          <canvas id="${chartId}" width="400" height="300" style="max-height:300px; margin-bottom:20px"></canvas>
        </div>
        
        <div>
          <div style="font-weight:700; margin-bottom:16px; color:var(--primary-light)">ğŸ¢ ì—…ì²´ë³„ ${costLabel} TOP 10</div>
          <div style="max-height:400px; overflow-y:auto">${clientList}</div>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <div>
        <div style="font-weight:700; margin-bottom:16px; color:var(--primary-light)">ğŸ“¦ ${categoryLabel} ìƒì„¸</div>
        ${categoryList}
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  
  const canvas = document.getElementById(chartId);
  if(canvas) {
    const ctx = canvas.getContext('2d');
    
    const colors = [
      '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f59e0b',
      '#10b981', '#14b8a6', '#06b6d4', '#3b82f6', '#6366f1'
    ];
    
    drawPieChart(ctx, categoryData, colors, canvas.width, canvas.height);
  }
  
  const closeModal = () => {
    if(document.body.contains(modal)) document.body.removeChild(modal);
  };
  
  content.querySelector('#closeMonthModal').addEventListener('click', closeModal);
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
}

function drawPieChart(ctx, data, colors, width, height) {
  const total = data.reduce((sum, [_, value]) => sum + value, 0);
  if (total === 0) return;
  
  const centerX = width / 2;
  const centerY = height / 2;
  const radius = Math.min(width, height) / 2 - 20;
  
  let currentAngle = -Math.PI / 2;
  
  data.forEach(([label, value], index) => {
    const sliceAngle = (value / total) * 2 * Math.PI;
    
    ctx.fillStyle = colors[index % colors.length];
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
    ctx.closePath();
    ctx.fill();
    
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    const midAngle = currentAngle + sliceAngle / 2;
    const labelX = centerX + Math.cos(midAngle) * (radius * 0.7);
    const labelY = centerY + Math.sin(midAngle) * (radius * 0.7);
    
    const percentage = ((value / total) * 100).toFixed(1);
    if (percentage > 5) {
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 12px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(`${percentage}%`, labelX, labelY);
    }
    
    currentAngle += sliceAngle;
  });
}

function drawLineChart(ctx, labels, data, width, height) {
  const padding = 60;
  const chartWidth = width - padding * 2;
  const chartHeight = height - padding * 2;
  
  ctx.clearRect(0, 0, width, height);
  
  const maxValue = Math.max(...data, 1);
  const minValue = 0;
  const range = maxValue - minValue;
  
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  ctx.fillStyle = isDark ? '#16213e' : '#f8fafc';
  ctx.fillRect(0, 0, width, height);
  
  ctx.strokeStyle = isDark ? '#2a3551' : '#e2e8f0';
  ctx.lineWidth = 1;
  
  for (let i = 0; i <= 5; i++) {
    const y = padding + (chartHeight / 5) * i;
    ctx.beginPath();
    ctx.moveTo(padding, y);
    ctx.lineTo(width - padding, y);
    ctx.stroke();
    
    const value = maxValue - (range / 5) * i;
    ctx.fillStyle = isDark ? '#8b94a8' : '#64748b';
    ctx.font = '12px Arial';
    ctx.textAlign = 'right';
    ctx.fillText(fmtMoney(value), padding - 10, y + 4);
  }
  
  if (data.length > 0) {
    ctx.beginPath();
    ctx.strokeStyle = '#6366f1';
    ctx.lineWidth = 3;
    
    data.forEach((value, index) => {
      const x = padding + (chartWidth / (data.length - 1 || 1)) * index;
      const y = padding + chartHeight - ((value - minValue) / range) * chartHeight;
      
      if (index === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    });
    
    ctx.stroke();
    
    data.forEach((value, index) => {
      const x = padding + (chartWidth / (data.length - 1 || 1)) * index;
      const y = padding + chartHeight - ((value - minValue) / range) * chartHeight;
      
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, Math.PI * 2);
      ctx.fillStyle = '#6366f1';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      ctx.fillStyle = isDark ? '#e4e8f0' : '#1e293b';
      ctx.font = 'bold 12px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(fmtMoney(value), x, y - 15);
    });
  }
  
  labels.forEach((label, index) => {
    const x = padding + (chartWidth / (labels.length - 1 || 1)) * index;
    const [year, month] = label.split('-');
    ctx.fillStyle = isDark ? '#8b94a8' : '#64748b';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${month}ì›”`, x, height - padding + 20);
  });
}

function openBulkEditModal() {
  if (!state.selected.size) return;
  
  const config = CONFIGS[state.currentType];
  const selectedRows = state.rows[state.currentType].filter(r => state.selected.has(r.id));
  
  const modal = document.createElement('div');
  modal.className = 'modal-back active';
  
  const content = document.createElement('div');
  content.className = 'modal';
  
  const selectedList = selectedRows.map(row => 
    `<div style="padding:8px; background:var(--card2); border-radius:6px; margin-bottom:4px">
      <strong>${row.client || 'ì—…ì²´ëª… ì—†ìŒ'}</strong>
      <span style="color:var(--muted); font-size:12px"> - ${row.product || ''}</span>
    </div>`
  ).join('');
  
  let formFields = '';
  config.fields.forEach(f => {
    if (f.type === 'computed') return;
    
    const full = ['client', 'keywords', 'note'].includes(f.key) ? ' style="grid-column:1/-1"' : '';
    
    formFields += `<div${full}><label>${f.label}</label>`;
    
    if (f.type === 'select') {
      formFields += `<select id="bulk_${f.key}"><option value="">ë³€ê²½ ì•ˆí•¨</option>`;
      f.options.forEach(o => formFields += `<option value="${o}">${o}</option>`);
      formFields += '</select>';
    } else {
      const t = f.type === 'number' ? 'number' : f.type === 'url' ? 'url' : f.type === 'date' ? 'date' : 'text';
      formFields += `<input id="bulk_${f.key}" type="${t}" placeholder="ë³€ê²½ ì•ˆí•¨"${f.type === 'number' ? ' step="any"' : ''}>`;
    }
    formFields += '</div>';
  });
  
  content.innerHTML = `
    <div class="mh">
      <strong>ì¼ê´„ ìˆ˜ì • (${state.selected.size}ê°œ í•­ëª©)</strong>
      <button class="btn small outline" id="closeBulkModal">âœ• ë‹«ê¸°</button>
    </div>
    <div class="mb">
      <div style="margin-bottom:20px; padding:16px; background:var(--card2); border-radius:12px; max-height:200px; overflow-y:auto">
        <div style="font-weight:600; margin-bottom:12px; color:var(--primary-light)">ì„ íƒëœ í•­ëª©:</div>
        ${selectedList}
      </div>
      
      <div class="form-grid">
        ${formFields}
        <div style="grid-column:1/-1; display:flex; gap:12px; justify-content:flex-end; margin-top:8px">
          <button class="btn outline" id="cancelBulk">ì·¨ì†Œ</button>
          <button class="btn" id="confirmBulk">ì ìš©</button>
        </div>
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  
  const closeModal = () => {
    if(document.body.contains(modal)) document.body.removeChild(modal);
  };
  
  content.querySelector('#closeBulkModal').addEventListener('click', closeModal);
  content.querySelector('#cancelBulk').addEventListener('click', closeModal);
  
  content.querySelector('#confirmBulk').addEventListener('click', () => {
    const updates = {};
    config.fields.forEach(f => {
      if (f.type === 'computed') return;
      const el = content.querySelector(`#bulk_${f.key}`);
      if (el && el.value) {
        updates[f.key] = f.type === 'number' ? parseNum(el.value) : el.value;
      }
    });
    
    selectedRows.forEach(row => {
      Object.keys(updates).forEach(key => {
        if (updates[key] !== null && updates[key] !== '') {
          row[key] = updates[key];
        }
      });
      
      const config = CONFIGS[state.currentType];
      
      if (config.path === 'place') {
        if (row.units !== undefined && row.days !== undefined) {
          row.totalQty = (row.units||0) * (row.days||0);
        }
        if (row.totalQty !== undefined && row.unitPrice !== undefined) {
          row.cost = (row.totalQty||0) * (row.unitPrice||0);
        }
      } else if (config.path === 'blog') {
        if (row.totalQty !== undefined && row.unitPrice !== undefined) {
          row.cost = (row.totalQty||0) * (row.unitPrice||0);
        }
      } else if (config.path === 'project') {
        if (row.startDate && row.endDate) {
          const start = new Date(row.startDate);
          const end = new Date(row.endDate);
          const diffTime = Math.abs(end - start);
          row.days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        } else {
          row.days = 0;
        }
        row.totalSpent = (row.dailyCost || 0) * (row.days || 0);
      }
      
      saveData(row, state.currentType);
    });
    
    closeModal();
    render();
  });
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
}

function startEdit(td, row, field) {
  const old = row[field.key] ?? '';
  let el;
  
  if (field.type === 'select') {
    el = document.createElement('select');
    el.innerHTML = field.options.map(v => `<option>${v}</option>`).join('');
    el.value = old;
  } else {
    el = document.createElement('input');
    el.type = field.type === 'number' ? 'number' : field.type === 'date' ? 'date' : 'text';
    el.value = old;
    if (field.type === 'number') el.step = 'any';
  }
  
  el.style.width = '100%';
  td.innerHTML = '';
  td.appendChild(el);
  el.focus();
  
  const commit = () => {
    let v = el.value;
    if (field.type === 'number') v = parseNum(v);
    row[field.key] = v !== null ? v : '';
    
    const config = CONFIGS[state.currentType];
    
    if (config.path === 'place') {
      if (row.units !== undefined && row.days !== undefined) {
        row.totalQty = (row.units||0) * (row.days||0);
      }
      if (row.totalQty !== undefined && row.unitPrice !== undefined) {
        row.cost = (row.totalQty||0) * (row.unitPrice||0);
      }
    } else if (config.path === 'blog') {
      if (row.totalQty !== undefined && row.unitPrice !== undefined) {
        row.cost = (row.totalQty||0) * (row.unitPrice||0);
      }
    } else if (config.path === 'project') {
      if (row.startDate && row.endDate) {
        const start = new Date(row.startDate);
        const end = new Date(row.endDate);
        const diffTime = Math.abs(end - start);
        row.days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
      } else {
        row.days = 0;
      }
      row.totalSpent = (row.dailyCost || 0) * (row.days || 0);
    }
    
    saveData(row, state.currentType);
    render();
  };
  
  el.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); commit(); }
    else if (e.key === 'Escape') { e.preventDefault(); render(); }
  });
  el.addEventListener('blur', commit);
}

function renderKpis() {
  const rows = applyFilters(state.rows[state.currentType]);
  const cnt = rows.length;
  
  let qty = 0;
  let cost = 0;
  
  const config = CONFIGS[state.currentType];
  
  if (config.path === 'project') {
    cost = rows.reduce((s, r) => s + (r.totalSpent || 0), 0);
    const avgDailyCost = cnt > 0 ? cost / cnt : 0;
    
    const countEl = $('#kpiCount');
    const qtyEl = $('#kpiQty');
    const qtyLabelEl = $('#kpiQtyLabel');
    const costEl = $('#kpiCost');
    const costLabelEl = $('#kpiCostLabel');
    const avgEl = $('#kpiAvg');
    const avgLabelEl = $('#kpiAvgLabel');
    
    if(countEl) countEl.textContent = cnt.toLocaleString('ko-KR');
    if(qtyEl) {
      const totalDays = rows.reduce((s, r) => s + (r.days || 0), 0);
      qtyEl.textContent = totalDays.toLocaleString('ko-KR');
    }
    if(qtyLabelEl) qtyLabelEl.textContent = 'ì´ ì§„í–‰ì¼ìˆ˜';
    if(costEl) costEl.textContent = fmtMoney(cost);
    if(costLabelEl) costLabelEl.textContent = 'ì´ ì§€ì¶œë¹„';
    if(avgEl) {
      avgEl.textContent = fmtMoney(avgDailyCost);
      avgEl.style.color = '';
    }
    if(avgLabelEl) avgLabelEl.textContent = 'í‰ê·  í”„ë¡œì íŠ¸ ì§€ì¶œ';
  } else {
    qty = rows.reduce((s, r) => s + (r.totalQty || 0), 0);
    cost = rows.reduce((s, r) => s + (r.cost || 0), 0);
    
    const countEl = $('#kpiCount');
    const qtyEl = $('#kpiQty');
    const qtyLabelEl = $('#kpiQtyLabel');
    const costEl = $('#kpiCost');
    const costLabelEl = $('#kpiCostLabel');
    const avgEl = $('#kpiAvg');
    const avgLabelEl = $('#kpiAvgLabel');
    
    if(countEl) countEl.textContent = cnt.toLocaleString('ko-KR');
    if(qtyEl) qtyEl.textContent = qty.toLocaleString('ko-KR');
    if(qtyLabelEl) qtyLabelEl.textContent = 'ì´ ì‘ì—…ëŸ‰';
    if(costEl) costEl.textContent = fmtMoney(cost);
    if(costLabelEl) costLabelEl.textContent = 'ì´ ì‘ì—…ë¹„';
    if(avgEl) {
      avgEl.textContent = fmtMoney(qty > 0 ? cost / qty : 0);
      avgEl.style.color = '';
    }
    if(avgLabelEl) avgLabelEl.textContent = 'í‰ê·  ë‹¨ê°€';
  }
  
  const byP = {};
  rows.forEach(r => {
    const p = r.client || 'ë¯¸ë¶„ë¥˜';
    const c = config.path === 'project' ? (r.totalSpent || 0) : (r.cost || 0);
    byP[p] = (byP[p] || 0) + c;
  });
  const pData = Object.entries(byP).map(([p, c]) => ({label: p, value: c})).sort((a, b) => b.value - a.value);
  
  const bars = $('#barsByProduct');
  if(bars) {
    bars.innerHTML = '';
    const max = Math.max(1, ...pData.map(d => d.value));
    
    pData.forEach(d => {
      const col = document.createElement('div');
      col.className = 'col';
      const bar = document.createElement('div');
      bar.className = 'bar';
      bar.style.height = Math.round(d.value / max * 100) + '%';
      const val = document.createElement('div');
      val.className = 'bar-value';
      val.textContent = fmtMoney(d.value);
      const lab = document.createElement('div');
      lab.className = 'note';
      lab.textContent = d.label.length > 10 ? d.label.substring(0, 10) + '...' : d.label;
      col.append(bar, val, lab);
      bars.appendChild(col);
    });
  }
  
  const costLabel = config.path === 'project' ? 'ì§€ì¶œë¹„' : 'ì‘ì—…ë¹„';
  const barTitleEl = $('#barChartTitle');
  if(barTitleEl) barTitleEl.textContent = `ğŸ“ˆ ì—…ì²´ë³„ ì´ ${costLabel}`;
  
  const byM = {};
  rows.forEach(r => {
    if (!r.startDate) return;
    const ym = getYearMonth(r.startDate);
    const c = config.path === 'project' ? (r.totalSpent || 0) : (r.cost || 0);
    byM[ym] = (byM[ym] || 0) + c;
  });
  const mData = Object.entries(byM).sort((a, b) => b[0].localeCompare(a[0]));
  const mc = $('#monthlyCost');
  if(mc) {
    mc.innerHTML = mData.map(([ym, c]) => {
      const [y, m] = ym.split('-');
      return `<div class="month-item" data-month="${ym}"><span>${y}ë…„ ${m}ì›”: <strong>${fmtMoney(c)}</strong></span></div>`;
    }).join('') || '<div class="muted">ë°ì´í„° ì—†ìŒ</div>';
    
    mc.querySelectorAll('.month-item').forEach(item => {
      item.addEventListener('click', () => {
        const selectedMonth = item.dataset.month;
        openMonthDetailModal(selectedMonth, rows);
      });
    });
  }
  
  const monthTitleEl = $('#monthChartTitle');
  if(monthTitleEl) monthTitleEl.textContent = `ğŸ’° ì›” ì´ ${costLabel}`;
}

function renderFinance() {
  renderFinanceTable('place');
  renderFinanceTable('blog');
  renderFinanceTable('project');
  calculateFinanceSummary();
  renderMonthlyRevenueChart();
  setupFinanceCheckboxes();
  setupFinanceEventListeners();
}

function renderFinanceTable(type) {
  const tbody = $(`#fin${type.charAt(0).toUpperCase() + type.slice(1)}`);
  if (!tbody) return;
  
  const allRows = getFilteredFinanceRows(type);
  const pagination = state.financePagination[type];
  const { currentPage, perPage } = pagination;
  
  // í˜ì´ì§€ë„¤ì´ì…˜ ì ìš©
  const totalPages = Math.ceil(allRows.length / perPage);
  const startIdx = (currentPage - 1) * perPage;
  const endIdx = startIdx + perPage;
  const rows = allRows.slice(startIdx, endIdx);
  
  // ì—…ì²´ ê°¯ìˆ˜ í‘œì‹œ ì—…ë°ì´íŠ¸
  const countEl = $(`#fin${type.charAt(0).toUpperCase() + type.slice(1)}Count`);
  if (countEl) {
    countEl.textContent = `(${allRows.length}ê°œ ì—…ì²´)`;
    countEl.style.color = 'var(--primary-light)';
    countEl.style.fontSize = '14px';
    countEl.style.fontWeight = '600';
  }
  
  // í˜ì´ì§€ë„¤ì´ì…˜ ì˜ì—­ì˜ ì—…ì²´ ê°¯ìˆ˜ë„ ì—…ë°ì´íŠ¸
  const totalCountEl = $(`#fin${type.charAt(0).toUpperCase() + type.slice(1)}TotalCount`);
  if (totalCountEl) {
    totalCountEl.textContent = allRows.length;
  }
  
  tbody.innerHTML = '';
  
  rows.forEach((row, rowIndex) => {
    const profitClass = (row.profit || 0) >= 0 ? 'positive' : 'negative';
    
    // ì‘ì—…ê¸°ê°„ì—ì„œ ì¢…ë£Œì¼ ì¶”ì¶œ
    let endDate = null;
    let periodDisplay = row.period || '';
    let ddayBadge = '';
    let rowClass = '';
    let periodClass = '';
    
    if (row.period && row.period.includes('~')) {
      const parts = row.period.split('~');
      endDate = parts[1]?.trim();
      
      if (endDate) {
        ddayBadge = getDDayBadge(endDate);
        rowClass = getRowClass(endDate);
        
        const dday = getDDay(endDate);
        if (dday !== null && dday <= 1) {
          periodClass = dday === 0 || dday < 0 ? 'deadline-cell urgent' : 'deadline-cell warning';
        }
      }
    }
    
    const tr = document.createElement('tr');
    if (rowClass) tr.className = rowClass;
    
    // ë“œë˜ê·¸ ê°€ëŠ¥ ì„¤ì •
    tr.draggable = true;
    tr.dataset.rowId = row.id;
    tr.dataset.rowIndex = rowIndex;
    tr.dataset.type = type;
    
    // ìˆœì´ìµìœ¨ ê³„ì‚°
    const profitRate = (row.revenue && row.revenue !== 0) ? ((row.profit || 0) / row.revenue * 100).toFixed(1) : '0.0';
    
    tr.innerHTML = `
      <td class="center" style="width:40px"><span class="drag-handle">â˜°</span></td>
      <td class="center"><input type="checkbox" class="fin-check" data-type="${type}" data-id="${row.id}"></td>
      <td class="fin-cell center" data-type="${type}" data-id="${row.id}" data-field="month">${row.month || ''}</td>
      <td class="fin-cell center" data-type="${type}" data-id="${row.id}" data-field="manager">${row.manager || ''}</td>
      <td class="fin-cell nowrap" data-type="${type}" data-id="${row.id}" data-field="client">${row.client || ''}</td>
      <td class="fin-cell" data-type="${type}" data-id="${row.id}" data-field="owner">${row.owner || ''}</td>
      <td class="fin-cell num revenue-cell" data-type="${type}" data-id="${row.id}" data-field="revenue">${fmtMoney(row.revenue || 0)}</td>
      <td class="fin-cell center" data-type="${type}" data-id="${row.id}" data-field="paid">${row.paid || 'ë¯¸ì…ê¸ˆ'}</td>
      <td class="fin-cell ${periodClass}" data-type="${type}" data-id="${row.id}" data-field="period">${periodDisplay}${ddayBadge}</td>
      <td class="fin-cell num cost-cell" data-type="${type}" data-id="${row.id}" data-field="cost">${fmtMoney(row.cost || 0)}</td>
      <td class="fin-cell num profit-cell ${profitClass}" data-type="${type}" data-id="${row.id}" data-field="profit">${fmtMoney(row.profit || 0)}</td>
      <td class="fin-cell num rate-cell" data-type="${type}" data-id="${row.id}" data-field="profitRate">${profitRate}%</td>
      <td class="center"><select class="contract-status-select" data-type="${type}" data-id="${row.id}" style="padding:8px 12px; font-size:13px; border-radius:8px; border:2px solid var(--border); background:var(--card); color:var(--text); cursor:pointer">
        <option value="ì§„í–‰ì¤‘" ${(row.contractStatus || 'ì§„í–‰ì¤‘') === 'ì§„í–‰ì¤‘' ? 'selected' : ''}>ì§„í–‰ì¤‘</option>
        <option value="ëŒ€ê¸°ì¤‘" ${(row.contractStatus || '') === 'ëŒ€ê¸°ì¤‘' ? 'selected' : ''}>ëŒ€ê¸°ì¤‘</option>
        <option value="ê³„ì•½ì¢…ë£Œ" ${(row.contractStatus || '') === 'ê³„ì•½ì¢…ë£Œ' ? 'selected' : ''}>ê³„ì•½ì¢…ë£Œ</option>
      </select></td>
      <td class="fin-cell center" data-type="${type}" data-id="${row.id}" data-field="memo" title="${row.memo || 'í´ë¦­í•˜ì—¬ ë©”ëª¨ ì‘ì„±'}" style="cursor:pointer; font-size:18px">
        ${row.memo ? 'ğŸ“' : 'â•'}
      </td>
      <td class="fin-cell center" data-type="${type}" data-id="${row.id}" data-field="tax">${row.tax || 'ë¯¸ë°œí–‰'}</td>
    `;
    tbody.appendChild(tr);
  });
  
  tbody.querySelectorAll('.fin-check').forEach(cb => {
    cb.addEventListener('change', () => {
      const key = `${cb.dataset.type}_${cb.dataset.id}`;
      if (cb.checked) {
        state.finSelected.add(key);
      } else {
        state.finSelected.delete(key);
      }
      
      // ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ ìƒíƒœ ì—…ë°ì´íŠ¸
      const checkAllId = `chkAllFin${type.charAt(0).toUpperCase() + type.slice(1)}`;
      const chkAll = $(`#${checkAllId}`);
      if (chkAll) {
        const allCheckboxes = tbody.querySelectorAll('.fin-check');
        const allChecked = Array.from(allCheckboxes).every(checkbox => checkbox.checked);
        chkAll.checked = allChecked;
      }
      
      updateFinBulkEditBar();
    });
  });
  
  tbody.querySelectorAll('.fin-cell').forEach(cell => {
    cell.addEventListener('click', () => {
      startFinEdit(cell, cell.dataset.type, cell.dataset.id, cell.dataset.field);
    });
  });
  
  // ê³„ì•½ ìƒíƒœ select ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  tbody.querySelectorAll('.contract-status-select').forEach(select => {
    select.addEventListener('change', (e) => {
      const type = select.dataset.type;
      const id = select.dataset.id;
      const newStatus = e.target.value;
      
      const row = state.financeData[type].find(r => r.id === id);
      if (row) {
        row.contractStatus = newStatus;
        if (state.useFirebase && state.isFirebaseConnected) {
          saveFinanceData(row, type);
        }
      }
    });
  });
  
  // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì¶”ê°€
  setupFinanceDragAndDrop(type);
  
  // í˜ì´ì§€ë„¤ì´ì…˜ ë Œë”ë§
  renderFinancePagination(type, allRows.length);
}

function setupFinanceDragAndDrop(type) {
  const tbody = $(`#fin${type.charAt(0).toUpperCase() + type.slice(1)}`);
  if (!tbody) return;
  
  let draggedRow = null;
  let draggedData = null;
  
  tbody.querySelectorAll('tr[draggable="true"]').forEach(tr => {
    tr.addEventListener('dragstart', (e) => {
      draggedRow = tr;
      const rowType = tr.dataset.type;
      const rowId = tr.dataset.rowId;
      draggedData = state.financeData[rowType].find(r => r.id === rowId);
      tr.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    
    tr.addEventListener('dragend', (e) => {
      tr.classList.remove('dragging');
      tbody.querySelectorAll('tr').forEach(row => row.classList.remove('drag-over'));
    });
    
    tr.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      const targetRow = e.currentTarget;
      if (draggedRow && targetRow !== draggedRow) {
        tbody.querySelectorAll('tr').forEach(row => row.classList.remove('drag-over'));
        targetRow.classList.add('drag-over');
      }
    });
    
    tr.addEventListener('dragleave', (e) => {
      const targetRow = e.currentTarget;
      targetRow.classList.remove('drag-over');
    });
    
    tr.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const targetRow = e.currentTarget;
      targetRow.classList.remove('drag-over');
      
      if (draggedRow && targetRow !== draggedRow && draggedData) {
        const targetType = targetRow.dataset.type;
        const targetId = targetRow.dataset.rowId;
        const targetData = state.financeData[targetType].find(r => r.id === targetId);
        
        if (targetData && targetType === type) {
          // ë°°ì—´ì—ì„œ ì›ë³¸ ìœ„ì¹˜ ì°¾ê¸°
          const rows = state.financeData[type];
          const draggedIndex = rows.findIndex(r => r.id === draggedData.id);
          const targetIndex = rows.findIndex(r => r.id === targetData.id);
          
          if (draggedIndex === -1 || targetIndex === -1) return;
          
          // ë°°ì—´ ìˆœì„œ ë³€ê²½ - ì˜¬ë°”ë¥¸ ë°©ë²•
          // 1. ë“œë˜ê·¸ëœ í•­ëª© ì œê±°
          const [removed] = rows.splice(draggedIndex, 1);
          
          // 2. íƒ€ê²Ÿ ìœ„ì¹˜ì— ì‚½ì…
          // draggedIndexê°€ targetIndexë³´ë‹¤ ì‘ìœ¼ë©´, ì œê±° í›„ targetIndexê°€ 1 ê°ì†Œí•¨
          const insertIndex = draggedIndex < targetIndex ? targetIndex : targetIndex;
          rows.splice(insertIndex, 0, removed);
          
          // Firebaseì— ìˆœì„œ ì •ë³´ ì €ì¥
          rows.forEach((row, index) => {
            row.order = index;
            if (state.useFirebase && state.isFirebaseConnected) {
              saveFinanceData(row, type);
            }
          });
          
          renderFinance();
        }
      }
    });
  });
}

function getFilteredFinanceRows(type) {
  const rows = state.financeData[type] || [];
  const filters = {
    searchClient: $('#finSearchClient')?.value || '',
    filterManager: $('#finFilterManager')?.value || '',
    filterType: $('#finFilterType')?.value || '',
    filterYear: $('#finFilterYear')?.value || '',
    selectedMonth: $('#financeMonth')?.value || '',
    contractStatus: $('#contractStatus')?.value || '',
    sortOrder: $('#finSortOrder')?.value || 'order_asc'
  };
  
  let filtered = rows.slice();
  
  if (filters.searchClient) {
    filtered = filtered.filter(r => (r.client || '').includes(filters.searchClient));
  }
  
  if (filters.filterManager) {
    filtered = filtered.filter(r => r.manager === filters.filterManager);
  }
  
  if (filters.filterType && filters.filterType !== type) {
    return [];
  }
  
  if (filters.filterYear) {
    filtered = filtered.filter(r => (r.month || '').startsWith(filters.filterYear));
  }
  
  if (filters.contractStatus) {
    filtered = filtered.filter(r => (r.contractStatus || 'ì§„í–‰ì¤‘') === filters.contractStatus);
  }
  
  if (filters.selectedMonth) {
    const monthNum = filters.selectedMonth.replace('ì›”', '');
    filtered = filtered.filter(r => {
      if (!r.month) return false;
      const [y, m] = r.month.split('-');
      return parseInt(m) === parseInt(monthNum);
    });
  }
  
  // ì •ë ¬
  if (filters.sortOrder === 'order_asc') {
    // ë“±ë¡ìˆœ (order í•„ë“œ ê¸°ì¤€)
    filtered.sort((a, b) => {
      const orderA = typeof a.order === 'number' ? a.order : 9999;
      const orderB = typeof b.order === 'number' ? b.order : 9999;
      return orderA - orderB;
    });
  } else if (filters.sortOrder === 'created_desc') {
    filtered.sort((a, b) => (b.month || '').localeCompare(a.month || ''));
  } else if (filters.sortOrder === 'created_asc') {
    filtered.sort((a, b) => (a.month || '').localeCompare(b.month || ''));
  } else if (filters.sortOrder === 'startdate_desc') {
    filtered.sort((a, b) => {
      const getStartDate = (row) => {
        if (!row.period || !row.period.includes('~')) return '';
        return row.period.split('~')[0]?.trim() || '';
      };
      return (getStartDate(b) || '').localeCompare(getStartDate(a) || '');
    });
  } else if (filters.sortOrder === 'startdate_asc') {
    filtered.sort((a, b) => {
      const getStartDate = (row) => {
        if (!row.period || !row.period.includes('~')) return '';
        return row.period.split('~')[0]?.trim() || '';
      };
      return (getStartDate(a) || '').localeCompare(getStartDate(b) || '');
    });
  } else if (filters.sortOrder === 'enddate_desc') {
    filtered.sort((a, b) => {
      const getEndDate = (row) => {
        if (!row.period || !row.period.includes('~')) return '';
        return row.period.split('~')[1]?.trim() || '';
      };
      return (getEndDate(b) || '').localeCompare(getEndDate(a) || '');
    });
  } else if (filters.sortOrder === 'enddate_asc') {
    filtered.sort((a, b) => {
      const getEndDate = (row) => {
        if (!row.period || !row.period.includes('~')) return '';
        return row.period.split('~')[1]?.trim() || '';
      };
      return (getEndDate(a) || '').localeCompare(getEndDate(b) || '');
    });
  } else if (filters.sortOrder === 'revenue_desc') {
    filtered.sort((a, b) => (b.revenue || 0) - (a.revenue || 0));
  } else if (filters.sortOrder === 'revenue_asc') {
    filtered.sort((a, b) => (a.revenue || 0) - (b.revenue || 0));
  } else if (filters.sortOrder === 'profit_desc') {
    filtered.sort((a, b) => (b.profit || 0) - (a.profit || 0));
  } else if (filters.sortOrder === 'profit_asc') {
    filtered.sort((a, b) => (a.profit || 0) - (b.profit || 0));
  }
  
  return filtered;
}

function calculateFinanceSummary() {
  let totalRevenue = 0;
  let totalCost = 0;
  let totalProfit = 0;
  let totalCompanies = 0;
  
  ['place', 'blog', 'project'].forEach(type => {
    const rows = getFilteredFinanceRows(type);
    totalCompanies += rows.length;
    rows.forEach(row => {
      totalRevenue += row.revenue || 0;
      totalCost += row.cost || 0;
      totalProfit += row.profit || 0;
    });
  });
  
  const revenueEl = $('#totalRevenue');
  const costEl = $('#totalCost');
  const profitEl = $('#totalProfit');
  const companyCountEl = $('#totalCompanyCount');
  
  if (revenueEl) revenueEl.textContent = fmtMoney(totalRevenue);
  if (costEl) costEl.textContent = fmtMoney(totalCost);
  if (profitEl) profitEl.textContent = fmtMoney(totalProfit);
  if (companyCountEl) {
    companyCountEl.textContent = `(ì´ ${totalCompanies}ê°œ ì—…ì²´)`;
    companyCountEl.style.color = 'var(--primary-light)';
    companyCountEl.style.fontSize = '14px';
    companyCountEl.style.fontWeight = '600';
  }
}


function renderFinancePagination(type, totalCount) {
  const pagination = state.financePagination[type];
  const { currentPage, perPage } = pagination;
  const totalPages = Math.ceil(totalCount / perPage);
  
  const paginationEl = $(`#fin${type.charAt(0).toUpperCase() + type.slice(1)}Pagination`);
  if (!paginationEl) return;
  
  paginationEl.innerHTML = '';
  
  if (totalPages <= 1) return;
  
  // ì´ì „ ë²„íŠ¼
  const prevBtn = document.createElement('button');
  prevBtn.className = 'page-btn';
  prevBtn.textContent = 'â€¹';
  prevBtn.disabled = currentPage === 1;
  prevBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      state.financePagination[type].currentPage--;
      renderFinanceTable(type);
    }
  });
  paginationEl.appendChild(prevBtn);
  
  // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
  let startPage = Math.max(1, currentPage - 3);
  let endPage = Math.min(totalPages, startPage + 6);
  
  for (let i = startPage; i <= endPage; i++) {
    const btn = document.createElement('button');
    btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
    btn.textContent = i;
    btn.addEventListener('click', () => {
      state.financePagination[type].currentPage = i;
      renderFinanceTable(type);
    });
    paginationEl.appendChild(btn);
  }
  
  // ë‹¤ìŒ ë²„íŠ¼
  const nextBtn = document.createElement('button');
  nextBtn.className = 'page-btn';
  nextBtn.textContent = 'â€º';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.addEventListener('click', () => {
    if (currentPage < totalPages) {
      state.financePagination[type].currentPage++;
      renderFinanceTable(type);
    }
  });
  paginationEl.appendChild(nextBtn);
}

function renderMonthlyRevenueChart() {
  const monthlyData = {};
  
  ['place', 'blog', 'project'].forEach(type => {
    const rows = getFilteredFinanceRows(type);
    rows.forEach(row => {
      if (!row.month) return;
      const revenue = parseNum(row.revenue) || 0;
      monthlyData[row.month] = (monthlyData[row.month] || 0) + revenue;
    });
  });
  
  const sortedMonths = Object.keys(monthlyData).sort((a, b) => b.localeCompare(a)).slice(0, 6).reverse();
  const revenues = sortedMonths.map(month => monthlyData[month]);
  
  if (revenues.length >= 2) {
    const current = revenues[revenues.length - 1];
    const previous = revenues[revenues.length - 2];
    const growth = previous > 0 ? ((current - previous) / previous * 100).toFixed(1) : 0;
    const growthEl = $('#revenueGrowth');
    const growthIcon = $('#growthIcon');
    
    if (growthEl) {
      const isPositive = growth >= 0;
      growthEl.textContent = `${growth > 0 ? '+' : ''}${growth}%`;
      growthEl.className = `number ${isPositive ? 'positive' : 'negative'}`;
      
      if (growthIcon) {
        growthIcon.textContent = isPositive ? 'ğŸ“ˆ' : 'ğŸ“‰';
        growthIcon.className = `growth-icon ${isPositive ? 'positive' : 'negative'}`;
      }
    }
  }
  
  const canvas = $('#revenueGrowthChart');
  if (canvas && sortedMonths.length > 0) {
    const ctx = canvas.getContext('2d');
    drawLineChart(ctx, sortedMonths, revenues, canvas.width, canvas.height);
  }
}

function setupFinanceCheckboxes() {
  const chkAllPlace = $('#chkAllFinPlace');
  if (chkAllPlace) {
    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    const placeChecks = document.querySelectorAll('#finPlace .fin-check');
    const allPlaceChecked = placeChecks.length > 0 && Array.from(placeChecks).every(cb => cb.checked);
    chkAllPlace.checked = allPlaceChecked;
    
    chkAllPlace.addEventListener('change', () => {
      const checks = document.querySelectorAll('#finPlace .fin-check');
      checks.forEach(cb => {
        cb.checked = chkAllPlace.checked;
        const key = `${cb.dataset.type}_${cb.dataset.id}`;
        if (chkAllPlace.checked) state.finSelected.add(key);
        else state.finSelected.delete(key);
      });
      updateFinBulkEditBar();
    });
  }
  
  const chkAllBlog = $('#chkAllFinBlog');
  if (chkAllBlog) {
    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    const blogChecks = document.querySelectorAll('#finBlog .fin-check');
    const allBlogChecked = blogChecks.length > 0 && Array.from(blogChecks).every(cb => cb.checked);
    chkAllBlog.checked = allBlogChecked;
    
    chkAllBlog.addEventListener('change', () => {
      const checks = document.querySelectorAll('#finBlog .fin-check');
      checks.forEach(cb => {
        cb.checked = chkAllBlog.checked;
        const key = `${cb.dataset.type}_${cb.dataset.id}`;
        if (chkAllBlog.checked) state.finSelected.add(key);
        else state.finSelected.delete(key);
      });
      updateFinBulkEditBar();
    });
  }
  
  const chkAllProject = $('#chkAllFinProject');
  if (chkAllProject) {
    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    const projectChecks = document.querySelectorAll('#finProject .fin-check');
    const allProjectChecked = projectChecks.length > 0 && Array.from(projectChecks).every(cb => cb.checked);
    chkAllProject.checked = allProjectChecked;
    
    chkAllProject.addEventListener('change', () => {
      const checks = document.querySelectorAll('#finProject .fin-check');
      checks.forEach(cb => {
        cb.checked = chkAllProject.checked;
        const key = `${cb.dataset.type}_${cb.dataset.id}`;
        if (chkAllProject.checked) state.finSelected.add(key);
        else state.finSelected.delete(key);
      });
      updateFinBulkEditBar();
    });
  }
}

function setupFinanceEventListeners() {
  const finSearchClient = $('#finSearchClient');
  if (finSearchClient) {
    finSearchClient.removeEventListener('input', handleFinSearchInput);
    finSearchClient.addEventListener('input', handleFinSearchInput);
  }
  
  const finFilterManager = $('#finFilterManager');
  if (finFilterManager) {
    finFilterManager.removeEventListener('change', handleFinFilterChange);
    finFilterManager.addEventListener('change', handleFinFilterChange);
  }
  
  const finFilterType = $('#finFilterType');
  if (finFilterType) {
    finFilterType.removeEventListener('change', handleFinFilterChange);
    finFilterType.addEventListener('change', handleFinFilterChange);
  }
  
  const finFilterYear = $('#finFilterYear');
  if (finFilterYear) {
    finFilterYear.removeEventListener('change', handleFinFilterChange);
    finFilterYear.addEventListener('change', handleFinFilterChange);
  }
  
  const financeMonth = $('#financeMonth');
  if (financeMonth) {
    financeMonth.removeEventListener('change', handleFinFilterChange);
    financeMonth.addEventListener('change', handleFinFilterChange);
  }
  
  const contractStatus = $('#contractStatus');
  if (contractStatus) {
    contractStatus.removeEventListener('change', handleFinFilterChange);
    contractStatus.addEventListener('change', handleFinFilterChange);
  }
  
  const finSortOrder = $('#finSortOrder');
  if (finSortOrder) {
    finSortOrder.removeEventListener('change', handleFinFilterChange);
    finSortOrder.addEventListener('change', handleFinFilterChange);
  }
  
  const finResetBtn = $('#finResetBtn');
  if (finResetBtn) {
    finResetBtn.removeEventListener('click', handleFinReset);
    finResetBtn.addEventListener('click', handleFinReset);
  }

  // í˜ì´ì§€ë‹¹ í‘œì‹œ ê°œìˆ˜ ë³€ê²½ ì´ë²¤íŠ¸
  const finPlacePerPage = $('#finPlacePerPage');
  if (finPlacePerPage) {
    finPlacePerPage.addEventListener('change', (e) => {
      state.financePagination.place.perPage = parseInt(e.target.value);
      state.financePagination.place.currentPage = 1;
      renderFinanceTable('place');
    });
  }
  
  const finBlogPerPage = $('#finBlogPerPage');
  if (finBlogPerPage) {
    finBlogPerPage.addEventListener('change', (e) => {
      state.financePagination.blog.perPage = parseInt(e.target.value);
      state.financePagination.blog.currentPage = 1;
      renderFinanceTable('blog');
    });
  }
  
  const finProjectPerPage = $('#finProjectPerPage');
  if (finProjectPerPage) {
    finProjectPerPage.addEventListener('change', (e) => {
      state.financePagination.project.perPage = parseInt(e.target.value);
      state.financePagination.project.currentPage = 1;
      renderFinanceTable('project');
    });
  }
}

function handleFinSearchInput() {
  if (state.currentType === 'finance') renderFinance();
}

function handleFinFilterChange() {
  if (state.currentType === 'finance') renderFinance();
}

function handleFinReset() {
  const finSearchClient = $('#finSearchClient');
  const finFilterManager = $('#finFilterManager');
  const finFilterType = $('#finFilterType');
  const finFilterYear = $('#finFilterYear');
  const financeMonth = $('#financeMonth');
  const contractStatus = $('#contractStatus');
  const finSortOrder = $('#finSortOrder');
  
  if (finSearchClient) finSearchClient.value = '';
  if (finFilterManager) finFilterManager.value = '';
  if (finFilterType) finFilterType.value = '';
  if (finFilterYear) finFilterYear.value = '';
  if (financeMonth) financeMonth.value = '';
  if (contractStatus) contractStatus.value = '';
  if (finSortOrder) finSortOrder.value = '';
  
  if (state.currentType === 'finance') renderFinance();
}



function updateFinBulkEditBar() {
  const bar = $('#finBulkEditBar');
  const count = $('#finSelectedCount');
  if (bar && count) {
    count.textContent = `${state.finSelected.size}ê°œ ì„ íƒ`;
    if (state.finSelected.size > 0) {
      bar.classList.add('active');
    } else {
      bar.classList.remove('active');
    }
  }
}


function openFinBulkEditModal() {
  if (!state.finSelected.size) {
    alert('ì¼ê´„ìˆ˜ì •í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal-back active';
  modal.id = 'finBulkEditModal';
  
  const content_div = document.createElement('div');
  content_div.className = 'modal';
  
  content_div.innerHTML = `
    <div class="mh">
      <strong>âœï¸ ì¼ê´„ìˆ˜ì • (${state.finSelected.size}ê°œ í•­ëª©)</strong>
      <button class="btn small outline" id="closeBulkEditModal">âœ• ë‹«ê¸°</button>
    </div>
    <div class="mb">
      <div style="padding: 16px; background: rgba(99,102,241,0.1); border: 2px solid var(--primary); border-radius: 12px; margin-bottom: 20px">
        <p style="font-size: 14px; color: var(--text); line-height: 1.6">
          â„¹ï¸ ì„ íƒí•œ ${state.finSelected.size}ê°œ í•­ëª©ì˜ ê³µí†µ í•„ë“œë¥¼ ì¼ê´„ ìˆ˜ì •í•©ë‹ˆë‹¤.<br>
          ë¹„ì–´ìˆëŠ” í•„ë“œëŠ” ìˆ˜ì •ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
      </div>
      <form id="finBulkEditForm" class="form-grid">
        <div>
          <label>ë‹´ë‹¹ì</label>
          <select id="bulkManager">
            <option value="">ë³€ê²½ ì•ˆ í•¨</option>
            <option value="ì „ë³‘í™©">ì „ë³‘í™©</option>
            <option value="ê°•íƒœìš°">ê°•íƒœìš°</option>
            <option value="ì˜¤ì˜ì€">ì˜¤ì˜ì€</option>
            <option value="ê¹€í•˜ëŠ¬">ê¹€í•˜ëŠ¬</option>
            <option value="ê¹€ìš°í˜„">ê¹€ìš°í˜„</option>
            <option value="ê³µë¯¼ê²½">ê³µë¯¼ê²½</option>
          </select>
        </div>
        <div>
          <label>ì…ê¸ˆì—¬ë¶€</label>
          <select id="bulkPaid">
            <option value="">ë³€ê²½ ì•ˆ í•¨</option>
            <option value="ë¯¸ì…ê¸ˆ">ë¯¸ì…ê¸ˆ</option>
            <option value="ì…ê¸ˆì™„ë£Œ">ì…ê¸ˆì™„ë£Œ</option>
            <option value="ì¼ë¶€ì…ê¸ˆ">ì¼ë¶€ì…ê¸ˆ</option>
          </select>
        </div>
        <div>
          <label>ì„¸ê¸ˆ</label>
          <select id="bulkTax">
            <option value="">ë³€ê²½ ì•ˆ í•¨</option>
            <option value="ë¯¸ë°œí–‰">ë¯¸ë°œí–‰</option>
            <option value="ë°œí–‰">ë°œí–‰</option>
          </select>
        </div>
        <div>
          <label>ì›”ë³„</label>
          <input type="month" id="bulkMonth">
          <small style="color: var(--muted); font-size: 12px">ë¹„ì–´ìˆìœ¼ë©´ ë³€ê²½ ì•ˆ í•¨</small>
        </div>
        <div style="grid-column: 1/-1">
          <label>ë©”ëª¨ ì¶”ê°€ (ê¸°ì¡´ ë©”ëª¨ì— ì¶”ê°€ë©ë‹ˆë‹¤)</label>
          <input type="text" id="bulkMemoAppend" placeholder="ì¶”ê°€í•  ë©”ëª¨ ë‚´ìš©">
        </div>
        <div style="grid-column: 1/-1; display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px">
          <button type="button" class="btn outline" id="cancelBulkEdit">ì·¨ì†Œ</button>
          <button type="submit" class="btn">ì¼ê´„ ì ìš©</button>
        </div>
      </form>
    </div>
  `;
  
  modal.appendChild(content_div);
  document.body.appendChild(modal);
  
  // ì·¨ì†Œ ë²„íŠ¼
  $('#closeBulkEditModal')?.addEventListener('click', () => {
    modal.remove();
  });
  
  $('#cancelBulkEdit')?.addEventListener('click', () => {
    modal.remove();
  });
  
  // ì¼ê´„ ì ìš©
  $('#finBulkEditForm')?.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const bulkManager = $('#bulkManager')?.value;
    const bulkPaid = $('#bulkPaid')?.value;
    const bulkTax = $('#bulkTax')?.value;
    const bulkMonth = $('#bulkMonth')?.value;
    const bulkMemoAppend = $('#bulkMemoAppend')?.value;
    
    if (!bulkManager && !bulkPaid && !bulkTax && !bulkMonth && !bulkMemoAppend) {
      alert('ë³€ê²½í•  í•­ëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
      return;
    }
    
    if (!confirm(`ì„ íƒí•œ ${state.finSelected.size}ê°œ í•­ëª©ì„ ì¼ê´„ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
      return;
    }
    
    let updatedCount = 0;
    
    state.finSelected.forEach(key => {
      const parts = key.split('_');
      const type = parts[0];
      const id = parts.slice(1).join('_');
      
      const row = state.financeData[type].find(r => r.id === id);
      if (row) {
        // ë³€ê²½ì‚¬í•­ ì ìš©
        if (bulkManager) row.manager = bulkManager;
        if (bulkPaid) row.paid = bulkPaid;
        if (bulkTax) row.tax = bulkTax;
        if (bulkMonth) row.month = bulkMonth;
        if (bulkMemoAppend) {
          row.memo = (row.memo || '') + (row.memo ? ' / ' : '') + bulkMemoAppend;
        }
        
        // ì €ì¥
        saveFinanceData(row, type);
        updatedCount++;
      }
    });
    
    if (updatedCount > 0) {
      alert(`${updatedCount}ê°œ í•­ëª©ì´ ì¼ê´„ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      state.finSelected.clear();
      renderFinance();
      modal.remove();
    }
  });
  
  // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

function openDateRangeModal(inputElement) {
  // ê¸°ì¡´ ê°’ íŒŒì‹±
  let startDate = '';
  let endDate = '';
  const currentValue = inputElement.value;
  if (currentValue && currentValue.includes('~')) {
    const parts = currentValue.split('~');
    startDate = parts[0]?.trim() || '';
    endDate = parts[1]?.trim() || '';
  }
  
  // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
  const existingModal = document.querySelector('.date-range-modal-back');
  if (existingModal) {
    document.body.removeChild(existingModal);
  }
  
  // ëª¨ë‹¬ ìƒì„±
  const modalBack = document.createElement('div');
  modalBack.className = 'date-range-modal-back';
  
  const modal = document.createElement('div');
  modal.className = 'date-range-modal';
  modal.innerHTML = `
    <div class="date-range-modal-header">
      <strong>ğŸ“… ì‘ì—…ê¸°ê°„ ì„¤ì •</strong>
      <button class="btn mini outline" id="closeDateModal">âœ•</button>
    </div>
    <div class="date-picker-grid">
      <div class="date-picker-field">
        <label>ì‹œì‘ì¼</label>
        <input type="date" id="modalStartDate" value="${startDate}">
      </div>
      <div class="date-picker-field">
        <label>ì¢…ë£Œì¼</label>
        <input type="date" id="modalEndDate" value="${endDate}">
      </div>
    </div>
    <div class="date-picker-actions">
      <button class="btn-cancel" id="cancelDateModal">ì·¨ì†Œ</button>
      <button class="btn-apply" id="applyDateModal">ì ìš©</button>
    </div>
  `;
  
  modalBack.appendChild(modal);
  document.body.appendChild(modalBack);
  
  const startInput = modal.querySelector('#modalStartDate');
  const endInput = modal.querySelector('#modalEndDate');
  
  const closeModal = () => {
    if (document.body.contains(modalBack)) {
      document.body.removeChild(modalBack);
    }
  };
  
  const applyDates = () => {
    const start = startInput.value;
    const end = endInput.value;
    if (start && end) {
      inputElement.value = `${start}~${end}`;
    } else if (start) {
      inputElement.value = start;
    } else {
      inputElement.value = '';
    }
    closeModal();
  };
  
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  modal.querySelector('#applyDateModal').addEventListener('click', (e) => {
    e.stopPropagation();
    applyDates();
  });
  
  modal.querySelector('#cancelDateModal').addEventListener('click', (e) => {
    e.stopPropagation();
    closeModal();
  });
  
  modal.querySelector('#closeDateModal').addEventListener('click', (e) => {
    e.stopPropagation();
    closeModal();
  });
  
  // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  modalBack.addEventListener('click', (e) => {
    if (e.target === modalBack) {
      closeModal();
    }
  });
  
  // ESC í‚¤ë¡œ ë‹«ê¸°
  const handleEsc = (e) => {
    if (e.key === 'Escape') {
      closeModal();
      document.removeEventListener('keydown', handleEsc);
    }
  };
  document.addEventListener('keydown', handleEsc);
  
  // ëª¨ë‹¬ ë‚´ë¶€ í´ë¦­ì€ ì „íŒŒ ì¤‘ì§€
  modal.addEventListener('click', (e) => {
    e.stopPropagation();
  });
}

function openFinAddModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-back active';
  
  const content_div = document.createElement('div');
  content_div.className = 'modal';
  
  content_div.innerHTML = `
    <div class="mh">
      <strong>â• ì—…ì²´ë³„ ìˆ˜ìµì •ë¦¬ ë“±ë¡</strong>
      <button class="btn small outline" id="closeFinAddModal">âœ• ë‹«ê¸°</button>
    </div>
    <div class="mb">
      <form id="finAddForm" class="form-grid">
        <div>
          <label>ìœ í˜• *</label>
          <select id="finType" required>
            <option value="">ì„ íƒ</option>
            <option value="place">í”Œë ˆì´ìŠ¤</option>
            <option value="blog">ë¸”ë¡œê·¸</option>
            <option value="project">í”„ë¡œì íŠ¸</option>
          </select>
        </div>
        <div>
          <label>ì›”ë³„ *</label>
          <input type="month" id="finMonth" required>
        </div>
        <div>
          <label>ë‹´ë‹¹ì *</label>
          <select id="finManager" required>
            <option value="">ì„ íƒ</option>
            <option value="ì „ë³‘í™©">ì „ë³‘í™©</option>
            <option value="ê°•íƒœìš°">ê°•íƒœìš°</option>
            <option value="ì˜¤ì˜ì€">ì˜¤ì˜ì€</option>
            <option value="ê¹€í•˜ëŠ¬">ê¹€í•˜ëŠ¬</option>
            <option value="ê¹€ìš°í˜„">ê¹€ìš°í˜„</option>
            <option value="ê³µë¯¼ê²½">ê³µë¯¼ê²½</option>
          </select>
        </div>
        <div style="grid-column: 1/-1">
          <label>ì—…ì²´ëª… *</label>
          <input type="text" id="finClient" required>
        </div>
        <div>
          <label>ëŒ€í‘œ</label>
          <input type="text" id="finOwner">
        </div>
        <div>
          <label>ë§¤ì¶œ *</label>
          <input type="number" id="finRevenue" step="any" required value="0">
        </div>
        <div>
          <label>ì…ê¸ˆì—¬ë¶€</label>
          <select id="finPaid">
            <option value="ë¯¸ì…ê¸ˆ">ë¯¸ì…ê¸ˆ</option>
            <option value="ì…ê¸ˆì™„ë£Œ">ì…ê¸ˆì™„ë£Œ</option>
            <option value="ì¼ë¶€ì…ê¸ˆ">ì¼ë¶€ì…ê¸ˆ</option>
          </select>
        </div>
        <div>
          <label>ì‘ì—…ê¸°ê°„</label>
          <input type="text" id="finPeriod" placeholder="ğŸ“… í´ë¦­í•˜ì—¬ ë‚ ì§œ ì„ íƒ" readonly style="cursor:pointer; background:var(--card2)">
        </div>
        <div>
          <label>ì‘ì—…ë¹„(ë§¤ì…)</label>
          <input type="number" id="finCost" step="any" value="0">
        </div>
        <div>
          <label>ë§ˆì§„</label>
          <input type="number" id="finMargin" step="any" readonly>
        </div>
        <div>
          <label>ì˜ì—…ì´ìµ</label>
          <input type="number" id="finProfit" step="any" readonly>
        </div>
        <div>
          <label>ì„¸ê¸ˆ</label>
          <select id="finTax">
            <option value="ë¯¸ë°œí–‰">ë¯¸ë°œí–‰</option>
            <option value="ë°œí–‰">ë°œí–‰</option>
          </select>
        </div>
        <div style="grid-column: 1/-1">
          <label>ë©”ëª¨</label>
          <input type="text" id="finMemo">
        </div>
        <div style="grid-column: 1/-1; display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px">
          <button type="button" class="btn outline" id="finResetFormBtn">ì´ˆê¸°í™”</button>
          <button type="submit" class="btn">ë“±ë¡</button>
        </div>
      </form>
    </div>
  `;
  
  modal.appendChild(content_div);
  document.body.appendChild(modal);
  
  const now = new Date();
  const monthInput = $('#finMonth');
  if (monthInput) {
    monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  }
  
  const revenueInput = $('#finRevenue');
  const costInput = $('#finCost');
  const marginInput = $('#finMargin');
  const profitInput = $('#finProfit');
  
  const autoCalculate = () => {
    const revenue = parseNum(revenueInput?.value) || 0;
    const cost = parseNum(costInput?.value) || 0;
    const margin = revenue - cost;
    if (marginInput) marginInput.value = margin;
    if (profitInput) profitInput.value = margin;
  };
  
  revenueInput?.addEventListener('input', autoCalculate);
  costInput?.addEventListener('input', autoCalculate);
  autoCalculate();
  
  // ì‘ì—…ê¸°ê°„ ë‹¬ë ¥ ì„ íƒê¸°
  const periodInput = $('#finPeriod');
  if (periodInput) {
    periodInput.addEventListener('click', () => {
      openDateRangeModal(periodInput);
    });
  }
  
  const closeModal = () => {
    if (document.body.contains(modal)) document.body.removeChild(modal);
  };
  
  content_div.querySelector('#closeFinAddModal')?.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  
  content_div.querySelector('#finResetFormBtn')?.addEventListener('click', () => {
    const form = $('#finAddForm');
    if (form) form.reset();
    if (monthInput) monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    autoCalculate();
  });
  
  const form = $('#finAddForm');
  if (form) {
    form.onsubmit = (e) => {
      e.preventDefault();
      
      const type = $('#finType')?.value;
      if (!type) return alert('ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”');
      
      const monthVal = $('#finMonth')?.value || '';
      const data = {
        id: 'fin_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9),
        createdAt: new Date().toISOString(),
        month: monthVal,
        manager: $('#finManager')?.value || '',
        client: $('#finClient')?.value || '',
        owner: $('#finOwner')?.value || '',
        revenue: parseNum($('#finRevenue')?.value) || 0,
        paid: $('#finPaid')?.value || 'ë¯¸ì…ê¸ˆ',
        period: $('#finPeriod')?.value || '',
        cost: parseNum($('#finCost')?.value) || 0,
        margin: parseNum($('#finMargin')?.value) || 0,
        profit: parseNum($('#finProfit')?.value) || 0,
        tax: $('#finTax')?.value || 'ë¯¸ë°œí–‰',
        memo: $('#finMemo')?.value || ''
      };
      
      if (!state.financeData[type]) state.financeData[type] = [];
      state.financeData[type].unshift(data);
      
      saveFinanceData(data, type);
      closeModal();
      renderFinance();
    };
  }
}

function startFinEdit(cell, type, id, field) {
  const finData = state.financeData[type] || [];
  const row = finData.find(r => r.id === id);
  if (!row) return;
  
  // ë©”ëª¨ í•„ë“œëŠ” ëª¨ë‹¬ë¡œ ì²˜ë¦¬
  if (field === 'memo') {
    openMemoModal(row, type);
    return;
  }
  
  const oldValue = row[field];
  let input;
  
  const isNumber = ['revenue', 'cost', 'margin', 'profit'].includes(field);
  
  if (field === 'manager') {
    input = document.createElement('select');
    input.innerHTML = `
      <option value="">ì„ íƒ</option>
      <option value="ì „ë³‘í™©">ì „ë³‘í™©</option>
      <option value="ê°•íƒœìš°">ê°•íƒœìš°</option>
      <option value="ì˜¤ì˜ì€">ì˜¤ì˜ì€</option>
      <option value="ê¹€í•˜ëŠ¬">ê¹€í•˜ëŠ¬</option>
      <option value="ê¹€ìš°í˜„">ê¹€ìš°í˜„</option>
      <option value="ê³µë¯¼ê²½">ê³µë¯¼ê²½</option>
    `;
    input.value = oldValue || '';
  } else if (field === 'paid') {
    input = document.createElement('select');
    input.innerHTML = `
      <option value="ë¯¸ì…ê¸ˆ">ë¯¸ì…ê¸ˆ</option>
      <option value="ì…ê¸ˆì™„ë£Œ">ì…ê¸ˆì™„ë£Œ</option>
      <option value="ì¼ë¶€ì…ê¸ˆ">ì¼ë¶€ì…ê¸ˆ</option>
    `;
    input.value = oldValue || 'ë¯¸ì…ê¸ˆ';
  } else if (field === 'tax') {
    input = document.createElement('select');
    input.innerHTML = `
      <option value="ë¯¸ë°œí–‰">ë¯¸ë°œí–‰</option>
      <option value="ë°œí–‰">ë°œí–‰</option>
    `;
    input.value = oldValue || 'ë¯¸ë°œí–‰';
  } else if (field === 'month') {
    input = document.createElement('input');
    input.type = 'month';
    input.value = oldValue || '';
  } else if (field === 'period') {
    // ì‘ì—…ê¸°ê°„ì„ ëª¨ë‹¬ ë‹¬ë ¥ ì„ íƒê¸°ë¡œ í‘œì‹œ
    
    // ê¸°ì¡´ ê°’ íŒŒì‹±
    let startDate = '';
    let endDate = '';
    if (oldValue && oldValue.includes('~')) {
      const parts = oldValue.split('~');
      startDate = parts[0]?.trim() || '';
      endDate = parts[1]?.trim() || '';
    }
    
    // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ì œê±°
    const existingModal = document.querySelector('.date-range-modal-back');
    if (existingModal) {
      document.body.removeChild(existingModal);
    }
    
    // ëª¨ë‹¬ ìƒì„±
    const modalBack = document.createElement('div');
    modalBack.className = 'date-range-modal-back';
    
    const modal = document.createElement('div');
    modal.className = 'date-range-modal';
    modal.innerHTML = `
      <div class="date-range-modal-header">
        <strong>ğŸ“… ì‘ì—…ê¸°ê°„ ì„¤ì •</strong>
        <button class="btn mini outline" id="closeDateModal">âœ•</button>
      </div>
      <div class="date-picker-grid">
        <div class="date-picker-field">
          <label>ì‹œì‘ì¼</label>
          <input type="date" id="periodStartDate" value="${startDate}">
        </div>
        <div class="date-picker-field">
          <label>ì¢…ë£Œì¼</label>
          <input type="date" id="periodEndDate" value="${endDate}">
        </div>
      </div>
      <div class="date-picker-actions">
        <button class="btn-cancel" id="cancelDatePicker">ì·¨ì†Œ</button>
        <button class="btn-apply" id="applyDatePicker">ì ìš©</button>
      </div>
    `;
    
    modalBack.appendChild(modal);
    document.body.appendChild(modalBack);
    
    const startInput = modal.querySelector('#periodStartDate');
    const endInput = modal.querySelector('#periodEndDate');
    
    const closeModal = () => {
      if (document.body.contains(modalBack)) {
        document.body.removeChild(modalBack);
      }
      renderFinance();
    };
    
    const commit = () => {
      const start = startInput.value;
      const end = endInput.value;
      if (start && end) {
        row[field] = `${start}~${end}`;
      } else if (start) {
        row[field] = start;
      } else {
        row[field] = '';
      }
      saveFinanceData(row, type);
      closeModal();
    };
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    modal.querySelector('#applyDatePicker').addEventListener('click', (e) => {
      e.stopPropagation();
      commit();
    });
    
    modal.querySelector('#cancelDatePicker').addEventListener('click', (e) => {
      e.stopPropagation();
      closeModal();
    });
    
    modal.querySelector('#closeDateModal').addEventListener('click', (e) => {
      e.stopPropagation();
      closeModal();
    });
    
    // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
    modalBack.addEventListener('click', (e) => {
      if (e.target === modalBack) {
        closeModal();
      }
    });
    
    // ESC í‚¤ë¡œ ë‹«ê¸°
    const handleEsc = (e) => {
      if (e.key === 'Escape') {
        closeModal();
        document.removeEventListener('keydown', handleEsc);
      }
    };
    document.addEventListener('keydown', handleEsc);
    
    // ëª¨ë‹¬ ë‚´ë¶€ í´ë¦­ì€ ì „íŒŒ ì¤‘ì§€
    modal.addEventListener('click', (e) => {
      e.stopPropagation();
    });
    
    return;
  } else {
    input = document.createElement('input');
    input.type = isNumber ? 'number' : 'text';
    if (isNumber) {
      input.step = 'any';
      input.value = oldValue || '';
    } else {
      input.value = oldValue || '';
    }
  }
  
  input.style.width = '100%';
  input.style.padding = '8px';
  input.style.background = 'var(--card)';
  input.style.color = 'var(--text)';
  input.style.border = '2px solid var(--primary)';
  input.style.borderRadius = '6px';
  
  cell.innerHTML = '';
  cell.appendChild(input);
  input.focus();
  
  const commit = () => {
    let value = input.value;
    if (isNumber) value = parseNum(value) || 0;
    row[field] = value;
    
    if (['revenue', 'cost'].includes(field)) {
      row.margin = (row.revenue || 0) - (row.cost || 0);
      row.profit = row.margin;
    }
    
    saveFinanceData(row, type);
    renderFinance();
  };
  
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      commit();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      renderFinance();
    }
  });
  
  input.addEventListener('blur', commit);
}

function saveFinanceData(data, type) {
  if (!state.useFirebase || !db) return;
  
  try {
    const ref = db.ref(`finance/${type}/${data.id}`);
    ref.set(data);
  } catch (e) {
    console.error('Firebase ì €ì¥ ì‹¤íŒ¨:', e);
  }
}

function openMemoModal(row, type) {
  const modal = $('#memoModalBack');
  const textarea = $('#memoTextarea');
  const saveBtn = $('#saveMemoBtn');
  const cancelBtn = $('#cancelMemoBtn');
  const closeBtn = $('#closeMemoModalBtn');
  
  if (!modal || !textarea) return;
  
  // í˜„ì¬ ë©”ëª¨ ë‚´ìš© ì„¤ì •
  textarea.value = row.memo || '';
  
  // ëª¨ë‹¬ ì—´ê¸°
  modal.classList.add('active');
  textarea.focus();
  
  // ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
  const handleSave = () => {
    row.memo = textarea.value;
    saveFinanceData(row, type);
    modal.classList.remove('active');
    renderFinance();
    cleanup();
  };
  
  // ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸
  const handleCancel = () => {
    modal.classList.remove('active');
    cleanup();
  };
  
  // ì´ë²¤íŠ¸ ì •ë¦¬ í•¨ìˆ˜
  const cleanup = () => {
    saveBtn.removeEventListener('click', handleSave);
    cancelBtn.removeEventListener('click', handleCancel);
    closeBtn.removeEventListener('click', handleCancel);
    modal.removeEventListener('click', handleBackdropClick);
    document.removeEventListener('keydown', handleEsc);
  };
  
  // ë°°ê²½ í´ë¦­ ì‹œ ë‹«ê¸°
  const handleBackdropClick = (e) => {
    if (e.target === modal) {
      handleCancel();
    }
  };
  
  // ESC í‚¤ë¡œ ë‹«ê¸°
  const handleEsc = (e) => {
    if (e.key === 'Escape') {
      handleCancel();
    }
  };
  
  saveBtn.addEventListener('click', handleSave);
  cancelBtn.addEventListener('click', handleCancel);
  closeBtn.addEventListener('click', handleCancel);
  modal.addEventListener('click', handleBackdropClick);
  document.addEventListener('keydown', handleEsc);
}

function loadFinanceData(type) {
  if (!state.useFirebase || !db) return;
  
  try {
    const ref = db.ref(`finance/${type}`);
    ref.on('value', snapshot => {
      const data = snapshot.val();
      if (data) {
        state.financeData[type] = Object.values(data);
        if (state.currentType === 'finance') {
          renderFinance();
        }
      }
    });
  } catch (e) {
    console.error('Firebase ë¡œë“œ ì‹¤íŒ¨:', e);
  }
}

function deleteFinanceData(id, type) {
  if (!state.useFirebase || !db) return;
  
  try {
    const ref = db.ref(`finance/${type}/${id}`);
    ref.remove();
  } catch (e) {
    console.error('Firebase ì‚­ì œ ì‹¤íŒ¨:', e);
  }
}

function openAddModal() {
  if (state.currentType === 'finance') {
    return;
  }
  
  const config = CONFIGS[state.currentType];
  const form = $('#addForm');
  const titleEl = $('#modalTitle');
  
  if(!form || !titleEl) return;
  
  titleEl.textContent = `${config.name} ë“±ë¡`;
  
  let html = '';
  config.fields.forEach(f => {
    if (f.type === 'computed' || f.type === 'hidden') return;
    const full = ['client', 'keywords', 'note'].includes(f.key) ? ' style="grid-column:1/-1"' : '';
    const req = f.required ? 'required' : '';
    
    html += `<div${full}><label>${f.label}${f.required ? ' *' : ''}</label>`;
    
    if (f.type === 'select') {
      html += `<select id="a${f.key}" ${req}><option value="">ì„ íƒ</option>`;
      f.options.forEach(o => html += `<option>${o}</option>`);
      html += '</select>';
    } else {
      const t = f.type === 'number' ? 'number' : f.type === 'url' ? 'url' : f.type === 'date' ? 'date' : 'text';
      const def = f.type === 'date' && f.key === 'startDate' ? `value="${today()}"` : '';
      html += `<input id="a${f.key}" type="${t}" ${req} ${def}${f.type === 'number' ? ' step="any"' : ''}>`;
    }
    html += '</div>';
  });
  
  html += `<div style="grid-column:1/-1; display:flex; gap:12px; justify-content:flex-end; margin-top:8px">
    <button type="button" class="btn outline" id="resetFormBtn">ì´ˆê¸°í™”</button>
    <button type="submit" class="btn">ë“±ë¡</button>
  </div>`;
  
  form.innerHTML = html;
  
  const modalBack = $('#addModalBack');
  if(modalBack) modalBack.classList.add('active');
  
  const resetBtn = $('#resetFormBtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      form.reset();
      const startInputs = form.querySelectorAll('[id^="astart"]');
      startInputs.forEach(el => {
        if (el.type === 'date') el.value = today();
      });
    });
  }
  
  form.onsubmit = (e) => {
    e.preventDefault();
    
    const data = {};
    config.fields.forEach(f => {
      if (f.type === 'computed') return;
      if (f.type === 'hidden') {
        // hidden í•„ë“œëŠ” defaultValue ì‚¬ìš©
        data[f.key] = f.defaultValue;
        return;
      }
      const el = $(`#a${f.key}`);
      if (el) data[f.key] = f.type === 'number' ? parseNum(el.value) : el.value;
    });
    
    // place íƒ€ì…ì¼ ë•Œ í˜„ì¬ ì„œë¸Œíƒ€ì… ì„¤ì •
    if (state.currentType === 'place') {
      data.subType = state.placeSubType;
    }
    
    const newRow = mk(data, config);
    state.rows[state.currentType].unshift(newRow);
    saveData(newRow, state.currentType);
    render();
    closeAddModal();
  };
}

function closeAddModal() {
  const modalBack = $('#addModalBack');
  if(modalBack) modalBack.classList.remove('active');
}


function switchSubType(subType) {
  state.placeSubType = subType;
  state.selected.clear();
  state.pagination.currentPage = 1;
  
  // ì„œë¸Œíƒ­ í™œì„±í™” ìƒíƒœ ë³€ê²½
  $$('.subtab').forEach(t => t.classList.remove('active'));
  const activeSubtab = $(`.subtab[data-subtype="${subType}"]`);
  if (activeSubtab) activeSubtab.classList.add('active');
  
  render();
}

function render() {
  renderFilters();
  renderTable();
}

// Special Notes ê´€ë ¨ í•¨ìˆ˜ë“¤
function getSpecialNoteKey() {
  if (state.currentType === 'place') {
    return `place_${state.placeSubType}`;
  }
  return state.currentType;
}

function loadSpecialNotes() {
  if (!state.useFirebase || !db) return;
  
  db.ref('specialNotes').once('value').then(snapshot => {
    const data = snapshot.val();
    if (data) {
      state.specialNotes = {
        place_reward: data.place_reward || '',
        place_distribution: data.place_distribution || '',
        blog: data.blog || '',
        project: data.project || ''
      };
    }
  }).catch(e => {
    console.error('Special Notes ë¡œë“œ ì‹¤íŒ¨:', e);
  });
}

function saveSpecialNote(key, content) {
  if (!state.useFirebase || !db) return;
  
  db.ref('specialNotes').child(key).set(content).catch(e => {
    console.error('Special Note ì €ì¥ ì‹¤íŒ¨:', e);
  });
}

function openSpecialNoteModal() {
  const modalBack = $('#specialNoteModalBack');
  const textarea = $('#specialNoteTextarea');
  const title = $('#specialNoteModalTitle');
  
  if (!modalBack || !textarea || !title) return;
  
  const key = getSpecialNoteKey();
  const currentNote = state.specialNotes[key] || '';
  
  // ëª¨ë‹¬ ì œëª© ì„¤ì •
  let titleText = 'ğŸ“Œ íŠ¹ì´ì‚¬í•­';
  if (state.currentType === 'place') {
    titleText += ` - í”Œë ˆì´ìŠ¤ ì‘ì—… (${state.placeSubType === 'reward' ? 'ë¦¬ì›Œë“œ' : 'ë°°í¬'})`;
  } else if (state.currentType === 'blog') {
    titleText += ' - ë¸”ë¡œê·¸ ì‘ì—…';
  } else if (state.currentType === 'project') {
    titleText += ' - í”„ë¡œì íŠ¸';
  }
  title.textContent = titleText;
  
  textarea.value = currentNote;
  modalBack.classList.add('active');
  textarea.focus();
}

function closeSpecialNoteModal() {
  const modalBack = $('#specialNoteModalBack');
  if (modalBack) modalBack.classList.remove('active');
}

function saveCurrentSpecialNote() {
  const textarea = $('#specialNoteTextarea');
  if (!textarea) return;
  
  const key = getSpecialNoteKey();
  const content = textarea.value.trim();
  
  state.specialNotes[key] = content;
  saveSpecialNote(key, content);
  
  closeSpecialNoteModal();
  alert('íŠ¹ì´ì‚¬í•­ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

function initApp() {
  console.log('Initializing app...');
  
  const pd = matchMedia('(prefers-color-scheme: dark)').matches;
  document.documentElement.setAttribute('data-theme', pd ? 'dark' : 'light');
  
  // ë¡œê·¸ì¸ í¼ ì´ë²¤íŠ¸
  const loginForm = $('#loginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = $('#loginEmail')?.value;
      const password = $('#loginPassword')?.value;
      if (email && password) {
        handleLogin(email, password);
      }
    });
  }
  
  // ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸
  const logoutBtn = $('#logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        handleLogout();
      }
    });
  }
  
  // ì¤‘ìš”: Firebase ë¨¼ì € ì´ˆê¸°í™”, ê·¸ ë‹¤ìŒ Auth ì´ˆê¸°í™”
  initFirebase();
  
  // Firebase ì´ˆê¸°í™” ëŒ€ê¸° í›„ Auth ì´ˆê¸°í™”
  setTimeout(() => {
    initAuth();
  }, 500);
  
  $$('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      switchType(tab.dataset.type);
    });
  });
  
  // ì„œë¸Œíƒ­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
  $$('.subtab').forEach(subtab => {
    subtab.addEventListener('click', () => {
      switchSubType(subtab.dataset.subtype);
    });
  });
  
  // ì´ˆê¸° ë¡œë“œ ì‹œ ì„œë¸Œíƒ­ì€ ìˆ¨ê¹€ ìƒíƒœë¡œ ì‹œì‘
  const placeSubtabs = $('#placeSubtabs');
  if (placeSubtabs) {
    placeSubtabs.classList.remove('show');
  }
  
  const removeBtn = $('#removeSelectedBtn');
  if(removeBtn) {
    removeBtn.addEventListener('click', () => {
      if (!state.selected.size) return alert('ì„ íƒí•˜ì„¸ìš”');
      if (confirm(`${state.selected.size}ê±´ ì‚­ì œ?`)) {
        state.rows[state.currentType] = state.rows[state.currentType].filter(r => {
          if (state.selected.has(r.id)) {
            deleteData(r.id, state.currentType);
            return false;
          }
          return true;
        });
        state.selected.clear();
        render();
      }
    });
  }
  
  const cloneBtn = $('#cloneSelectedBtn');
  if(cloneBtn) {
    cloneBtn.addEventListener('click', cloneSelected);
  }
  
  const bulkBtn = $('#bulkEditBtn');
  if(bulkBtn) {
    bulkBtn.addEventListener('click', () => {
      openBulkEditModal();
    });
  }
  
  const reportBtn = $('#openReportModalBtn');
  if(reportBtn) {
    reportBtn.addEventListener('click', () => {
      openReportModal();
    });
  }
  
  const themeBtn = $('#themeBtn');
  if(themeBtn) {
    themeBtn.addEventListener('click', () => {
      const cur = document.documentElement.getAttribute('data-theme');
      const next = cur === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
    });
  }
  
  const exportBtn = $('#exportExcelBtn');
  if(exportBtn) {
    exportBtn.addEventListener('click', () => {
      if (!state.selected.size) return alert('ì„ íƒí•˜ì„¸ìš”');
      const config = CONFIGS[state.currentType];
      const selected = state.rows[state.currentType].filter(r => state.selected.has(r.id));
      const data = selected.map(row => {
        const obj = {};
        config.fields.forEach(f => obj[f.label] = row[f.key] ?? '');
        return obj;
      });
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, config.name);
      XLSX.writeFile(wb, `${config.name}_${today()}.xlsx`);
    });
  }
  
  const addBtn = $('#openAddModalBtn');
  if(addBtn) {
    addBtn.addEventListener('click', () => {
      openAddModal();
    });
  }
  
  const closeBtn = $('#closeModalBtn');
  if(closeBtn) {
    closeBtn.addEventListener('click', closeAddModal);
  }
   
  const perPageBtn = $('#perPageSelect');
  if(perPageBtn) {
    perPageBtn.addEventListener('change', e => {
      state.pagination.perPage = parseInt(e.target.value);
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  // Finance íƒ­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì´ˆê¸°í™”
  const finSearchClient = $('#finSearchClient');
  if (finSearchClient) {
    finSearchClient.addEventListener('input', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const finFilterManager = $('#finFilterManager');
  if (finFilterManager) {
    finFilterManager.addEventListener('change', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const finFilterType = $('#finFilterType');
  if (finFilterType) {
    finFilterType.addEventListener('change', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const finFilterYear = $('#finFilterYear');
  if (finFilterYear) {
    finFilterYear.addEventListener('change', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const financeMonth = $('#financeMonth');
  if (financeMonth) {
    financeMonth.addEventListener('change', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const contractStatus = $('#contractStatus');
  if (contractStatus) {
    contractStatus.addEventListener('change', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const finSortOrder = $('#finSortOrder');
  if (finSortOrder) {
    finSortOrder.addEventListener('change', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const finResetBtn = $('#finResetBtn');
  if (finResetBtn) {
    finResetBtn.addEventListener('click', () => {
      if (finSearchClient) finSearchClient.value = '';
      if (finFilterManager) finFilterManager.value = '';
      if (finFilterType) finFilterType.value = '';
      if (finFilterYear) finFilterYear.value = '';
      if (financeMonth) financeMonth.value = '';
      if (contractStatus) contractStatus.value = '';
      if (finSortOrder) finSortOrder.value = '';
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const openFinAddModalBtn = $('#openFinAddModalBtn');
  if (openFinAddModalBtn) {
    openFinAddModalBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openFinAddModal();
    });
  }
  
  const removeFinSelectedBtn = $('#removeFinSelectedBtn');
  if (removeFinSelectedBtn) {
    removeFinSelectedBtn.addEventListener('click', () => {
      if (!state.finSelected.size) return alert('ì„ íƒí•˜ì„¸ìš”');
      if (confirm(`${state.finSelected.size}ê±´ ì‚­ì œ?`)) {
        state.finSelected.forEach(key => {
          const parts = key.split('_');
          const type = parts[0];
          const id = parts.slice(1).join('_');
          
          state.financeData[type] = state.financeData[type].filter(r => r.id !== id);
          deleteFinanceData(id, type);
        });
        
        state.finSelected.clear();
        renderFinance();
      }
    });
  }
  
  const cloneFinSelectedBtn = $('#cloneFinSelectedBtn');
  if (cloneFinSelectedBtn) {
    cloneFinSelectedBtn.addEventListener('click', () => {
      if (!state.finSelected.size) return alert('ë³µì œí•  í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”');
      
      if (!confirm(`ì„ íƒí•œ ${state.finSelected.size}ê°œ í•­ëª©ì„ ë³µì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      
      let clonedCount = 0;
      state.finSelected.forEach(key => {
        const parts = key.split('_');
        const type = parts[0];
        const id = parts.slice(1).join('_');
        
        const original = state.financeData[type].find(r => r.id === id);
        if (original) {
          const cloned = { ...original, id: Date.now() + '_' + Math.random().toString(36).slice(2) };
          cloned.month = cloned.month || '';
          state.financeData[type].unshift(cloned);
          saveFinanceData(cloned, type);
          clonedCount++;
        }
      });
      
      if (clonedCount > 0) {
        alert(`${clonedCount}ê±´ì´ ë³µì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        state.finSelected.clear();
        renderFinance();
      }
    });
  }
  
  const finBulkEditBtn = $('#finBulkEditBtn');
  if (finBulkEditBtn) {
    finBulkEditBtn.addEventListener('click', () => {
      if (!state.finSelected.size) return alert('ì„ íƒí•˜ì„¸ìš”');
      openFinBulkEditModal();
    });
  }
  
  // íŠ¹ì´ì‚¬í•­ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  const openSpecialNoteBtn = $('#openSpecialNoteBtn');
  if (openSpecialNoteBtn) {
    openSpecialNoteBtn.addEventListener('click', () => {
      openSpecialNoteModal();
    });
  }
  
  const closeSpecialNoteModalBtn = $('#closeSpecialNoteModalBtn');
  if (closeSpecialNoteModalBtn) {
    closeSpecialNoteModalBtn.addEventListener('click', () => {
      closeSpecialNoteModal();
    });
  }
  
  const cancelSpecialNoteBtn = $('#cancelSpecialNoteBtn');
  if (cancelSpecialNoteBtn) {
    cancelSpecialNoteBtn.addEventListener('click', () => {
      closeSpecialNoteModal();
    });
  }
  
  const saveSpecialNoteBtn = $('#saveSpecialNoteBtn');
  if (saveSpecialNoteBtn) {
    saveSpecialNoteBtn.addEventListener('click', () => {
      saveCurrentSpecialNote();
    });
  }
  
  render();
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initApp);
} else {
  initApp();
}
</script>
</body>
</html>
