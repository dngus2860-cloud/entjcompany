<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>엔티제컴퍼니 · 작업 대시보드</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<style>
  :root{
    --bg:#0f0f23; --panel:#1a1a2e; --card:#16213e; --card2:#1f2d47;
    --text:#e4e8f0; --muted:#8b94a8; --border:#2a3551; --chip:#2d3a5c;
    --primary:#6366f1; --primary-light:#818cf8; --green:#22c55e; --red:#ef4444; --amber:#f59e0b;
    --shadow:0 20px 60px rgba(0,0,0,0.5);
    --gradient-1:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  [data-theme="light"]{
    --bg:#f5f7fa; --panel:#ffffff; --card:#ffffff; --card2:#f8fafc;
    --text:#1e293b; --muted:#64748b; --border:#e2e8f0; --chip:#e0e7ff;
    --primary:#6366f1; --primary-light:#818cf8; --green:#16a34a; --red:#dc2626; --amber:#d97706;
    --shadow:0 10px 40px rgba(0,0,0,0.08);
  }

  *{box-sizing:border-box; margin:0; padding:0}
  html,body{max-width:100%; overflow-x:hidden; background:var(--bg); color:var(--text); font-size:15px}
  body{font-family:'Pretendard',-apple-system,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif; line-height:1.7}
  img,canvas,svg,video{max-width:100%; height:auto; display:block}

  .wrap{max-width:1600px; margin:0 auto; padding:28px; display:grid; gap:24px}

  .connection-status{position:fixed; top:24px; right:24px; padding:10px 18px; border-radius:20px; font-size:13px; font-weight:600; z-index:1000; display:flex; align-items:center; gap:10px; box-shadow:var(--shadow)}
  .connection-status.connected{background:var(--green); color:white}
  .connection-status.disconnected{background:var(--red); color:white}
  .connection-status.local{background:var(--amber); color:white}
  .connection-status .indicator{width:9px; height:9px; border-radius:50%; background:white; animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{opacity:1} 50%{opacity:0.3}}
  @keyframes urgentPulse{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,0.4)} 50%{box-shadow:0 0 0 6px rgba(239,68,68,0)}}
  @keyframes warningGlow{0%,100%{box-shadow:0 0 0 0 rgba(245,158,11,0.4)} 50%{box-shadow:0 0 0 4px rgba(245,158,11,0)}}
  @keyframes gentleGlow{0%,100%{box-shadow:0 0 3px rgba(239,68,68,0.4)} 50%{box-shadow:0 0 8px rgba(239,68,68,0.6)}}
  @keyframes softPulse{0%,100%{opacity:1} 50%{opacity:0.7}}

  header{background:var(--panel); border:1px solid var(--border); border-radius:20px; padding:28px 36px; box-shadow:var(--shadow); display:flex; align-items:center; justify-content:space-between; position:relative; overflow:hidden}
  header::before{content:''; position:absolute; top:0; left:0; right:0; height:4px; background:var(--gradient-1)}
  .brand{display:flex; align-items:center; gap:18px}
  .brand .icon{font-size:40px; filter:drop-shadow(0 4px 8px rgba(99,102,241,0.4))}
  .brand h1{font-size:28px; font-weight:800; background:var(--gradient-1); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  .chip{background:var(--chip); border:1px solid var(--border); color:var(--primary-light); padding:8px 16px; border-radius:999px; font-size:13px; font-weight:600}

  .btn{background:var(--primary); color:#fff; border:none; padding:12px 24px; border-radius:12px; cursor:pointer; font-weight:600; font-size:15px; transition:all .3s; box-shadow:0 4px 12px rgba(99,102,241,.3)}
  .btn:hover{background:var(--primary-light); transform:translateY(-2px); box-shadow:0 6px 16px rgba(99,102,241,.4)}
  .btn.outline{background:transparent; color:var(--text); border:2px solid var(--border); box-shadow:none}
  .btn.outline:hover{border-color:var(--primary); color:var(--primary); background:rgba(99,102,241,.08); box-shadow:0 2px 8px rgba(99,102,241,.15)}
  .btn.outline.reset{border-color:var(--muted); color:var(--muted)}
  .btn.outline.reset:hover{border-color:var(--primary); color:var(--primary)}
  .btn.danger{background:#ef4444}
  .btn.danger:hover{background:#dc2626}
  .btn.small{padding:10px 18px; font-size:14px}
  .btn.mini{padding:6px 12px; font-size:12px}
  .btn.success{background:var(--green)}
  .btn.success:hover{background:#16a34a}
  .btn.warning{background:var(--amber)}
  .btn.warning:hover{background:#d97706}

  .tabs{display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap; align-items:center}
  .tab{padding:14px 28px; background:var(--card); border:2px solid var(--border); border-radius:12px; cursor:pointer; font-weight:600; font-size:15px; transition:all .3s; color:var(--muted)}
  .tab:hover{border-color:var(--primary-light); background:var(--card2); transform:translateY(-2px)}
  .tab.active{background:var(--primary); color:#fff; border-color:var(--primary); box-shadow:0 4px 12px rgba(99,102,241,.3)}

  .place-subtabs{display:none; gap:8px; margin-left:12px}
  .place-subtabs.show{display:flex}
  .subtab{padding:10px 20px; background:var(--card2); border:2px solid var(--border); border-radius:10px; cursor:pointer; font-size:14px; font-weight:600; transition:all .3s; color:var(--muted)}
  .subtab:hover{border-color:var(--primary-light); background:var(--card)}
  .subtab.active{background:var(--primary-light); color:#fff; border-color:var(--primary-light); box-shadow:0 2px 8px rgba(99,102,241,.3)}

  .panel{background:var(--panel); border:1px solid var(--border); border-radius:20px; box-shadow:var(--shadow); overflow:hidden}
  .panel .h{padding:24px 32px; border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; background:linear-gradient(to right, rgba(99,102,241,.05), transparent)}
  .panel .h strong{font-size:20px; font-weight:700; display:flex; align-items:center; gap:8px}
  .panel .b{padding:28px 32px}
  
  #kpisPanel .b{background:linear-gradient(to bottom, rgba(99,102,241,.02), transparent)}

  .filters{display:grid; gap:14px; align-items:end}
  @media (min-width:1400px){.filters{grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr auto}}
  @media (max-width:1399px){.filters{grid-template-columns:repeat(3, 1fr)}}
  @media (max-width:900px){.filters{grid-template-columns:repeat(2, 1fr)}}
  @media (max-width:600px){.filters{grid-template-columns:1fr}}
  
  .filter-group{display:flex; flex-direction:column; gap:6px}
  .filter-label{font-size:12px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px; padding-left:4px; display:flex; align-items:center; gap:4px}
  
  input[type="date"]{position:relative; color-scheme:dark}
  input[type="date"]::-webkit-calendar-picker-indicator{cursor:pointer; filter:invert(0.7)}

  input, select, textarea{width:100%; padding:14px 18px; border-radius:12px; border:2px solid var(--border); background:var(--card); color:var(--text); font-size:15px; font-weight:500; transition:all .3s}
  input:focus, select:focus, textarea:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 4px rgba(99,102,241,.15); background:var(--panel)}
  input::placeholder, textarea::placeholder{color:var(--muted); opacity:0.7}
  select{cursor:pointer; appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%238b94a8' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 14px center; padding-right:40px}
  select:hover{border-color:var(--primary-light)}
  select option{padding:10px; background:var(--card); color:var(--text)}

  .toolbar{display:flex; gap:12px; align-items:center; flex-wrap:wrap}
  .sep{height:1px; background:var(--border); margin:24px 0}
  .muted{color:var(--muted); font-size:14px; font-weight:500}

  .table-wrap{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch}
  table{width:100%; border-collapse:collapse}
  thead th{position:sticky; top:0; background:linear-gradient(135deg, rgba(99,102,241,.08), rgba(139,92,246,.08)); border-bottom:2px solid var(--primary); padding:18px 14px; font-size:14px; font-weight:700; text-transform:uppercase; letter-spacing:.8px; color:var(--primary-light); white-space:nowrap; text-align:left}
  thead th.num{text-align:right}
  thead th.center{text-align:center}
  tbody tr{transition:all .2s; border-bottom:1px solid var(--border)}
  tbody tr:hover{background:rgba(99,102,241,.08); transform:scale(1.001)}
  td{padding:18px 14px; font-size:14px; vertical-align:middle; text-align:left; line-height:1.6}
  td.num{text-align:right; font-variant-numeric:tabular-nums; font-weight:600}
  td.center{text-align:center}
  td.nowrap{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:280px}

  .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:16px}
  @media (max-width:800px){.kpis{grid-template-columns:repeat(2,1fr)}}
  .kpi{padding:22px; background:var(--card2); border:2px solid var(--border); border-radius:16px; transition:all .3s; position:relative; overflow:hidden}
  .kpi::before{content:''; position:absolute; top:0; left:0; right:0; height:3px; background:var(--gradient-1); opacity:0; transition:opacity .3s}
  .kpi:hover{border-color:var(--primary); transform:translateY(-4px); box-shadow:0 8px 24px rgba(99,102,241,.2)}
  .kpi:hover::before{opacity:1}
  .kpi .muted{font-size:14px; font-weight:600; margin-bottom:8px}
  .kpi .v{font-weight:900; font-size:28px; background:var(--gradient-1); -webkit-background-clip:text; -webkit-text-fill-color:transparent}

  .bars{display:flex; align-items:flex-end; gap:12px; height:200px; padding:16px; border:2px solid var(--border); border-radius:16px; background:var(--card2); overflow-x:auto}
  .bars .col{flex:1; display:flex; flex-direction:column; align-items:center; gap:10px; min-width:70px}
  .bars .bar{width:100%; max-width:55px; background:var(--gradient-1); border:2px solid var(--border); border-radius:12px 12px 6px 6px; height:10%; box-shadow:0 4px 12px rgba(99,102,241,.2); transition:all .3s}
  .bars .col:hover .bar{transform:translateY(-6px); box-shadow:0 6px 16px rgba(99,102,241,.3)}
  .bar-value{font-size:14px; font-weight:700; color:var(--text); margin-bottom:6px}
  .note{font-size:12px; color:var(--muted); font-weight:600}

  .month-item{margin-bottom:10px; padding:10px 14px; background:var(--card2); border-radius:10px; border-left:3px solid var(--primary); cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:all .2s; font-size:14px}
  .month-item:hover{background:var(--card); transform:translateX(6px); box-shadow:0 2px 8px rgba(99,102,241,.15)}
  
  /* 드래그 앤 드롭 스타일 */
  .drag-handle{cursor:grab; font-size:18px; color:var(--muted); padding:0 8px; display:inline-flex; align-items:center; justify-content:center; transition:color .2s; user-select:none}
  .drag-handle:hover{color:var(--primary-light)}
  .drag-handle:active{cursor:grabbing}
  tbody tr.dragging{opacity:0.3; background:rgba(99,102,241,.2); box-shadow:0 4px 12px rgba(0,0,0,.3)}
  tbody tr.drag-over{border-top:3px solid var(--primary) !important; background:rgba(99,102,241,.15)}
  tbody tr[draggable="true"]{transition:all .2s}
  
  /* 날짜 범위 선택기 스타일 - 모달 형태 */
  .date-range-modal-back{position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(4px); display:flex; align-items:center; justify-content:center; z-index:2000; padding:20px}
  .date-range-modal{background:var(--panel); border:2px solid var(--border); border-radius:20px; box-shadow:0 30px 80px rgba(0,0,0,.6); width:450px; max-width:100%; padding:28px}
  .date-range-modal-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:24px; padding-bottom:16px; border-bottom:2px solid var(--border)}
  .date-range-modal-header strong{font-size:20px; font-weight:700; color:var(--primary-light)}
  .date-picker-grid{display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px}
  .date-picker-field{display:flex; flex-direction:column; gap:10px}
  .date-picker-field label{font-size:13px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:0.5px}
  .date-picker-field input[type="date"]{width:100%; padding:12px 16px; border-radius:10px; border:2px solid var(--border); background:var(--card); color:var(--text); font-size:15px; font-weight:500; transition:all .3s}
  .date-picker-field input[type="date"]:focus{border-color:var(--primary); box-shadow:0 0 0 4px rgba(99,102,241,.15); outline:none}
  .date-picker-actions{display:flex; gap:12px; justify-content:flex-end; padding-top:16px; border-top:2px solid var(--border)}
  .date-picker-actions button{padding:12px 24px; border-radius:10px; border:none; cursor:pointer; font-weight:600; font-size:15px; transition:all .3s}
  .date-picker-actions .btn-apply{background:var(--primary); color:white; box-shadow:0 4px 12px rgba(99,102,241,.3)}
  .date-picker-actions .btn-apply:hover{background:var(--primary-light); transform:translateY(-2px)}
  .date-picker-actions .btn-cancel{background:var(--card2); color:var(--text); border:2px solid var(--border)}
  .date-picker-actions .btn-cancel:hover{background:var(--card); border-color:var(--primary)}

  .bulk-edit-bar{background:linear-gradient(135deg, rgba(99,102,241,.1), rgba(139,92,246,.1)); border:2px solid var(--primary); border-radius:16px; padding:18px 24px; margin-bottom:20px; display:none; align-items:center; gap:18px}
  .bulk-edit-bar.active{display:flex}

  .pagination-wrapper{display:flex; align-items:center; justify-content:space-between; padding:24px 0; gap:18px; flex-wrap:wrap}
  .pagination{display:flex; gap:10px; align-items:center}
  .page-btn{min-width:40px; height:40px; padding:0 14px; border:2px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; cursor:pointer; font-weight:600; font-size:15px; transition:all .3s}
  .page-btn:hover:not(.active):not(:disabled){border-color:var(--primary); background:var(--card2); transform:translateY(-2px)}
  .page-btn.active{background:var(--primary); color:#fff; border-color:var(--primary); box-shadow:0 4px 12px rgba(99,102,241,.3)}
  .page-btn:disabled{opacity:.3; cursor:not-allowed}

  .modal-back{position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; z-index:1000; padding:20px}
  .modal-back.active{display:flex}
  .modal{background:var(--panel); border:2px solid var(--border); border-radius:24px; box-shadow:0 30px 80px rgba(0,0,0,.6); width:900px; max-width:100%; max-height:90vh; overflow:auto}
  .modal .mh{padding:28px 32px; border-bottom:2px solid var(--border); display:flex; align-items:center; justify-content:space-between; background:linear-gradient(to right, rgba(99,102,241,.05), transparent)}
  .modal .mh strong{font-size:22px; font-weight:800}
  .modal .mb{padding:32px}
  .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:18px}
  .form-grid .full{grid-column:1/-1}
  .form-grid label{display:block; font-size:14px; font-weight:600; color:var(--muted); margin-bottom:8px; text-transform:uppercase; letter-spacing:.6px}
  
  /* 로그인 페이지 스타일 */
  .login-container{position:fixed; inset:0; background:var(--bg); display:flex; align-items:center; justify-content:center; z-index:9999}
  .login-box{background:var(--panel); border:2px solid var(--border); border-radius:24px; padding:48px; width:450px; max-width:90%; box-shadow:0 30px 80px rgba(0,0,0,.6)}
  .login-box .logo{text-align:center; margin-bottom:32px}
  .login-box .logo .icon{font-size:64px; margin-bottom:16px; filter:drop-shadow(0 4px 12px rgba(99,102,241,0.5))}
  .login-box h1{text-align:center; font-size:28px; font-weight:800; background:var(--gradient-1); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:8px}
  .login-box p{text-align:center; color:var(--muted); font-size:14px; margin-bottom:32px}
  .login-form{display:flex; flex-direction:column; gap:20px}
  .login-input{width:100%; padding:16px 20px; border-radius:12px; border:2px solid var(--border); background:var(--card); color:var(--text); font-size:15px; font-weight:500; transition:all .3s}
  .login-input:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 4px rgba(99,102,241,.15); background:var(--panel)}
  .login-btn{width:100%; padding:16px; background:var(--primary); color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:700; cursor:pointer; transition:all .3s; box-shadow:0 4px 12px rgba(99,102,241,.3)}
  .login-btn:hover{background:var(--primary-light); transform:translateY(-2px); box-shadow:0 6px 16px rgba(99,102,241,.4)}
  .login-btn:disabled{opacity:.5; cursor:not-allowed; transform:none}
  .login-error{background:rgba(239,68,68,.1); border:2px solid var(--red); color:var(--red); padding:12px 16px; border-radius:8px; font-size:14px; font-weight:600; text-align:center}
  .user-info{display:flex; align-items:center; gap:12px; padding:10px 18px; background:var(--card); border-radius:12px; border:2px solid var(--border)}
  .user-email{color:var(--text); font-weight:600; font-size:14px}
  .logout-btn{padding:8px 16px; background:transparent; color:var(--red); border:2px solid var(--red); border-radius:8px; font-size:13px; font-weight:600; cursor:pointer; transition:all .3s}
  .logout-btn:hover{background:var(--red); color:#fff}

  .fin-section{margin-bottom:40px}
  .fin-title{font-weight:700; font-size:18px; margin-bottom:18px; padding:14px 0; border-bottom:2px solid var(--border); color:var(--primary-light)}
  .fin-count{margin-left:10px; padding:4px 12px; background:rgba(99,102,241,0.1); border-radius:8px; font-size:13px}
  .fin-cell{cursor:pointer; padding:12px 14px; border-radius:8px; transition:all .2s; font-size:14px}
  .fin-cell:hover{background:var(--card2); color:var(--primary-light)}
  
  /* 금액 컬럼 스타일링 */
  .revenue-cell{background:rgba(59,130,246,0.08) !important; border:2px solid rgba(59,130,246,0.3); font-weight:700; color:#3b82f6}
  .revenue-cell:hover{background:rgba(59,130,246,0.15) !important; border-color:#3b82f6}
  
  .cost-cell{background:rgba(249,115,22,0.08) !important; border:2px solid rgba(249,115,22,0.3); font-weight:700; color:#f97316}
  .cost-cell:hover{background:rgba(249,115,22,0.15) !important; border-color:#f97316}
  
  .profit-cell{border:2px solid rgba(34,197,94,0.3); font-weight:700}
  .profit-cell.positive{background:rgba(34,197,94,0.08) !important; color:#22c55e}
  .profit-cell.positive:hover{background:rgba(34,197,94,0.15) !important; border-color:#22c55e}
  .profit-cell.negative{background:rgba(239,68,68,0.08) !important; color:#ef4444; border-color:rgba(239,68,68,0.3)}
  .profit-cell.negative:hover{background:rgba(239,68,68,0.15) !important; border-color:#ef4444}
  
  .rate-cell{background:rgba(168,85,247,0.08) !important; border:2px solid rgba(168,85,247,0.3); font-weight:700; color:#a855f7}
  .rate-cell:hover{background:rgba(168,85,247,0.15) !important; border-color:#a855f7}

  .kpi-summary{display:grid; grid-template-columns:repeat(3,1fr); gap:16px; max-width:900px}
  @media (max-width:768px){.kpi-summary{grid-template-columns:repeat(2,1fr)}}
  
  /* 테이블 정렬 개선 */
  .fin-cell.center{text-align:center}
  .fin-cell.num{text-align:right; font-variant-numeric:tabular-nums}

  .d-day-badge{display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:8px; font-size:12px; font-weight:700; text-transform:uppercase; margin-left:10px}
  .d-day-badge.d-0{background:rgba(239,68,68,0.2); color:var(--red); border:2px solid var(--red); animation:urgentPulse 3s ease-in-out infinite}
  .d-day-badge.d-1{background:rgba(245,158,11,0.2); color:var(--amber); border:2px solid var(--amber); animation:warningGlow 3.5s ease-in-out infinite}
  .d-day-badge.d-3{background:rgba(34,197,94,0.15); color:var(--green); border:1px solid var(--green)}
  .d-day-badge.d-7{background:rgba(99,102,241,0.15); color:var(--primary); border:1px solid var(--primary)}
  
  tr.urgent-row{background:rgba(239,68,68,0.08) !important; border-left:4px solid var(--red)}
  tr.warning-row{background:rgba(245,158,11,0.08) !important; border-left:4px solid var(--amber)}
  
  .deadline-cell{position:relative; transition:all 0.3s}
  .deadline-cell.urgent{animation:gentleGlow 3s ease-in-out infinite; font-weight:700; color:var(--red)}
  .deadline-cell.warning{font-weight:600; color:var(--amber); animation:softPulse 3s ease-in-out infinite}

  .profit-indicator{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:8px; font-weight:700; font-size:14px}
  .profit-indicator.positive{background:rgba(34,197,94,0.15); color:var(--green)}
  .profit-indicator.negative{background:rgba(239,68,68,0.15); color:var(--red)}

  .report-text{background:var(--card2); border:2px solid var(--border); border-radius:12px; padding:24px; font-family:'Courier New', monospace; font-size:14px; line-height:1.9; white-space:pre-wrap; word-break:break-all; max-height:500px; overflow-y:auto; color:var(--text)}

  .calendar-picker{position:relative; display:inline-block; width:100%}
  .calendar-input{cursor:pointer; padding:14px 18px; border-radius:12px; border:2px solid var(--border); background:var(--card); color:var(--text); font-size:15px; font-weight:500; transition:all .3s; display:flex; align-items:center; justify-content:space-between; width:100%}
  .calendar-input:hover{border-color:var(--primary)}
  .calendar-dropdown{position:absolute; top:100%; left:0; margin-top:10px; background:var(--panel); border:2px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:22px; z-index:100; display:none; width:340px}
  .calendar-dropdown.active{display:block}
  
  .calendar-header{display:flex; align-items:center; justify-content:space-between; margin-bottom:18px}
  .calendar-header button{background:transparent; border:none; color:var(--text); padding:10px; cursor:pointer; font-size:18px; font-weight:700; transition:all .3s; border-radius:8px}
  .calendar-header button:hover{background:var(--card2)}
  .calendar-header .month-year{font-weight:700; font-size:16px; display:flex; align-items:center; gap:10px}
  .calendar-header select{background:var(--card); border:2px solid var(--border); color:var(--text); padding:8px 12px; border-radius:8px; font-weight:600; cursor:pointer; font-size:14px}
  
  .calendar-weekdays{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:10px}
  .calendar-weekday{text-align:center; font-size:13px; font-weight:600; color:var(--muted); padding:10px 4px}
  
  .calendar-days{display:grid; grid-template-columns:repeat(7,1fr); gap:6px; margin-bottom:14px}
  .calendar-day{text-align:center; padding:12px 4px; border-radius:8px; cursor:pointer; font-weight:500; font-size:15px; transition:all .2s; border:2px solid transparent}
  .calendar-day:hover:not(.disabled):not(.selected){background:var(--card2)}
  .calendar-day.disabled{color:var(--muted); opacity:0.4; cursor:not-allowed}
  .calendar-day.disabled:hover{background:transparent}
  .calendar-day.selected{background:var(--primary); color:#fff; border-radius:50%; font-weight:700}
  .calendar-day.today{color:var(--primary); font-weight:700}
  
  .calendar-actions{display:flex; gap:10px; padding-top:14px; border-top:2px solid var(--border)}
  .calendar-actions button{flex:1; padding:12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; transition:all .3s; font-size:14px}
  .calendar-actions .clear-btn{background:transparent; color:var(--primary); border:2px solid var(--primary)}
  .calendar-actions .clear-btn:hover{background:var(--primary); color:#fff}
  .calendar-actions .today-btn{background:var(--primary); color:#fff}
  .calendar-actions .today-btn:hover{background:var(--primary-light)}

  .growth-card{display:grid; grid-template-columns:1fr auto; gap:24px; padding:24px; background:var(--card2); border-radius:16px; border:2px solid var(--border); align-items:center}
  .growth-info .label{font-size:14px; font-weight:600; color:var(--muted); text-transform:uppercase; letter-spacing:0.8px; margin-bottom:10px}
  .growth-value{display:flex; align-items:center; gap:14px}
  .growth-value .number{font-size:36px; font-weight:900}
  .growth-value .number.positive{color:var(--green)}
  .growth-value .number.negative{color:var(--red)}
  .growth-icon{width:70px; height:70px; border-radius:14px; display:flex; align-items:center; justify-content:center; font-size:32px}
  .growth-icon.positive{background:rgba(34,197,94,0.15)}
  .growth-icon.negative{background:rgba(239,68,68,0.15)}
</style>
</head>
<body>
<div class="login-container" id="loginContainer">
  <div class="login-box">
    <div class="logo">
      <div class="icon">💼</div>
      <h1>엔티제컴퍼니</h1>
      <p>관리자 로그인</p>
    </div>
    <form class="login-form" id="loginForm">
      <input type="email" class="login-input" id="loginEmail" placeholder="이메일" required autocomplete="email">
      <input type="password" class="login-input" id="loginPassword" placeholder="비밀번호" required autocomplete="current-password">
      <div id="loginError" class="login-error" style="display:none"></div>
      <button type="submit" class="login-btn" id="loginBtn">로그인</button>
    </form>
  </div>
</div>

<div class="connection-status local" id="connectionStatus">
  <span class="indicator"></span>
  <span id="connectionText">연결 중...</span>
</div>

<div class="wrap" id="app" style="display:none">
  <header>
    <div class="brand">
      <span class="icon">💼</span>
      <div>
        <h1>엔티제컴퍼니</h1>
        <span class="chip" id="modeChip">작업 대시보드</span>
      </div>
    </div>
    <div class="toolbar">
      <div class="user-info" id="userInfo" style="display:none">
        <span class="user-email" id="userEmail"></span>
        <button class="logout-btn" id="logoutBtn">로그아웃</button>
      </div>
      <button class="btn outline" id="exportExcelBtn">📊 엑셀 내보내기</button>
      <button class="btn" id="themeBtn">🌓 테마 전환</button>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-type="place">📍 플레이스 작업</div>
    <div class="place-subtabs" id="placeSubtabs" style="display:flex; gap:8px; margin-left:12px">
      <div class="subtab active" data-subtype="reward">🎁 리워드</div>
      <div class="subtab" data-subtype="distribution">📦 배포</div>
    </div>
    <div class="tab" data-type="blog">📝 블로그 작업</div>
    <div class="tab" data-type="project">🎯 프로젝트</div>
    <div class="tab" data-type="finance">💰 매출/매입</div>
  </div>

  <section class="panel" id="kpisPanel">
    <div class="h">
      <strong>🔍 검색 및 필터</strong>
      <span class="chip" style="background:rgba(99,102,241,0.1); border:1px solid var(--primary); font-size:11px">조건별 검색</span>
    </div>
    <div class="b" id="filtersContainer"></div>
  </section>

  <section class="panel" id="tablePanel">
    <div class="h">
      <strong id="listTitle">📋 작업 목록</strong>
      <div class="toolbar">
        <span class="muted" id="countInfo">0건</span>
        <button class="btn small outline" id="openSpecialNoteBtn" style="border-color:var(--primary); color:var(--primary)">📌 특이사항</button>
        <button class="btn small success" id="openReportModalBtn">📱 리포트 문자</button>
        <button class="btn small" id="openAddModalBtn">➕ 새 항목</button>
        <button class="btn warning small" id="cloneSelectedBtn">📋 복제</button>
        <button class="btn danger small" id="removeSelectedBtn">🗑️ 선택 삭제</button>
      </div>
    </div>
    <div class="b">
      <div class="bulk-edit-bar" id="bulkEditBar">
        <span class="muted" id="selectedCount">0개 선택</span>
        <button class="btn small" id="bulkEditBtn">✏️ 일괄수정</button>
      </div>
      <div class="table-wrap">
        <table id="tbl">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="pagination-wrapper">
        <div style="display:flex; align-items:center; gap:10px">
          <span class="muted">페이지당 표시:</span>
          <select id="perPageSelect" style="width:auto; padding:8px 12px">
            <option value="30">30개</option>
            <option value="50">50개</option>
            <option value="100">100개</option>
          </select>
        </div>
        <div class="pagination" id="pagination"></div>
      </div>
    </div>
  </section>

  <section class="panel" id="kpisSummaryPanel">
    <div class="h"><strong>📊 데이터 요약</strong></div>
    <div class="b">
      <div class="kpis">
        <div class="kpi"><div class="muted">총 건수</div><div class="v" id="kpiCount">0</div></div>
        <div class="kpi"><div class="muted" id="kpiQtyLabel">총 작업량</div><div class="v" id="kpiQty">0</div></div>
        <div class="kpi"><div class="muted" id="kpiCostLabel">총 작업비</div><div class="v" id="kpiCost">₩0</div></div>
        <div class="kpi"><div class="muted" id="kpiAvgLabel">평균 단가</div><div class="v" id="kpiAvg">₩0</div></div>
      </div>
      <div class="sep"></div>
      <div class="toolbar"><strong id="barChartTitle">📈 상품별 총 작업비</strong></div>
      <div class="bars" id="barsByProduct"></div>
      <div class="sep"></div>
      <div class="toolbar"><strong id="monthChartTitle">💰 월 총 작업비</strong></div>
      <div id="monthlyCost"></div>
    </div>
  </section>

  <section class="panel" id="financePanel" style="display:none">
    <div class="h">
      <strong>💼 업체별 수익정리</strong>
      <div class="toolbar">
        <button class="btn small" id="openFinAddModalBtn">➕ 새 항목</button>
        <button class="btn success small" id="cloneFinSelectedBtn">📋 복제</button>
        <button class="btn danger small" id="removeFinSelectedBtn">🗑️ 선택 삭제</button>
      </div>
    </div>
    <div class="b">
      <div class="bulk-edit-bar" id="finBulkEditBar">
        <span class="muted" id="finSelectedCount">0개 선택</span>
        <button class="btn small" id="finBulkEditBtn">✏️ 일괄수정</button>
      </div>
      
      <div style="margin-bottom:24px">
        <div class="filters" style="grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr">
          <div class="filter-group">
            <label class="filter-label">🔍 업체명 검색</label>
            <input id="finSearchClient" placeholder="업체명 입력..." style="width:100%">
          </div>
          <div class="filter-group">
            <label class="filter-label">👤 담당자</label>
            <select id="finFilterManager">
              <option value="">전체</option>
              <option value="전병황">전병황</option>
              <option value="강태우">강태우</option>
              <option value="오영은">오영은</option>
              <option value="김하늬">김하늬</option>
              <option value="김우현">김우현</option>
              <option value="공민경">공민경</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">📋 유형</label>
            <select id="finFilterType">
              <option value="">전체</option>
              <option value="place">📍 플레이스</option>
              <option value="blog">📝 블로그</option>
              <option value="project">🎯 프로젝트</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">📅 연도</label>
            <select id="finFilterYear">
              <option value="">전체</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
              <option value="2027">2027</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label">🔄 정렬</label>
            <select id="finSortOrder">
              <option value="order_asc">📝 등록순</option>
              <option value="created_desc">📆 등록일 ↓</option>
              <option value="created_asc">📆 등록일 ↑</option>
              <option value="startdate_desc">🗓️ 시작일 ↓</option>
              <option value="startdate_asc">🗓️ 시작일 ↑</option>
              <option value="enddate_desc">📅 종료일 ↓</option>
              <option value="enddate_asc">📅 종료일 ↑</option>
              <option value="revenue_desc">💰 매출 ↓</option>
              <option value="revenue_asc">💰 매출 ↑</option>
              <option value="profit_desc">💵 이익 ↓</option>
              <option value="profit_asc">💵 이익 ↑</option>
            </select>
          </div>
          <div class="filter-group">
            <label class="filter-label" style="opacity:0">초기화</label>
            <button class="btn small outline" id="finResetBtn" style="width:100%">🔄 초기화</button>
          </div>
        </div>
      </div>

      <div style="margin-bottom:24px; padding:20px; background:var(--card2); border-radius:12px; border:2px solid var(--border)">
        <div style="display:flex; gap:20px; align-items:flex-end">
          <div>
            <label class="filter-label" style="font-size:14px; margin-bottom:10px; display:block">📊 월별 조회</label>
            <select id="financeMonth" style="width:220px">
              <option value="">전체 월</option>
              <option value="1월">1월</option>
              <option value="2월">2월</option>
              <option value="3월">3월</option>
              <option value="4월">4월</option>
              <option value="5월">5월</option>
              <option value="6월">6월</option>
              <option value="7월">7월</option>
              <option value="8월">8월</option>
              <option value="9월">9월</option>
              <option value="10월">10월</option>
              <option value="11월">11월</option>
              <option value="12월">12월</option>
            </select>
          </div>
          <div>
            <label class="filter-label" style="font-size:14px; margin-bottom:10px; display:block">🔖 계약 상태</label>
            <select id="contractStatus" style="width:220px">
              <option value="">전체</option>
              <option value="진행중">진행중</option>
              <option value="대기중">대기중</option>
              <option value="계약종료">계약종료</option>
            </select>
          </div>
        </div>
      </div>

      <div class="fin-section">
        <div class="fin-title">📍 플레이스 작업 <span class="fin-count" id="finPlaceCount"></span></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th class="center" style="width:40px">↕</th><th class="center"><input type="checkbox" id="chkAllFinPlace"></th><th class="center">월별</th><th class="center">담당자</th><th>업체명</th><th>대표</th><th class="num">매출</th><th class="center">입금여부</th><th>작업기간</th><th class="num">작업비</th><th class="num">영업이익</th><th class="num">순이익율</th><th class="center">계약 상태</th><th>메모</th><th class="center">세금</th></tr></thead>
            <tbody id="finPlace"></tbody>
          </table>
        </div>
        <div class="pagination-wrapper">
          <div style="display:flex; align-items:center; gap:10px">
            <span class="muted">페이지당 표시:</span>
            <select id="finPlacePerPage" style="width:auto; padding:8px 12px">
              <option value="30">30개</option>
              <option value="50">50개</option>
              <option value="100">100개</option>
            </select>
            <span class="muted" style="margin:0 8px">|</span>
            <span class="muted">총 <strong id="finPlaceTotalCount" style="color:var(--primary-light); font-size:16px">0</strong>개 업체</span>
          </div>
          <div class="pagination" id="finPlacePagination"></div>
        </div>
      </div>

      <div class="fin-section">
        <div class="fin-title">📝 블로그 작업 <span class="fin-count" id="finBlogCount"></span></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th class="center" style="width:40px">↕</th><th class="center"><input type="checkbox" id="chkAllFinBlog"></th><th class="center">월별</th><th class="center">담당자</th><th>업체명</th><th>대표</th><th class="num">매출</th><th class="center">입금여부</th><th>작업기간</th><th class="num">작업비</th><th class="num">영업이익</th><th class="num">순이익율</th><th class="center">계약 상태</th><th>메모</th><th class="center">세금</th></tr></thead>
            <tbody id="finBlog"></tbody>
          </table>
        </div>
        <div class="pagination-wrapper">
          <div style="display:flex; align-items:center; gap:10px">
            <span class="muted">페이지당 표시:</span>
            <select id="finBlogPerPage" style="width:auto; padding:8px 12px">
              <option value="30">30개</option>
              <option value="50">50개</option>
              <option value="100">100개</option>
            </select>
            <span class="muted" style="margin:0 8px">|</span>
            <span class="muted">총 <strong id="finBlogTotalCount" style="color:var(--primary-light); font-size:16px">0</strong>개 업체</span>
          </div>
          <div class="pagination" id="finBlogPagination"></div>
        </div>
      </div>

      <div class="fin-section">
        <div class="fin-title">🎯 프로젝트 <span class="fin-count" id="finProjectCount"></span></div>
        <div class="table-wrap">
          <table>
            <thead><tr><th class="center" style="width:40px">↕</th><th class="center"><input type="checkbox" id="chkAllFinProject"></th><th class="center">월별</th><th class="center">담당자</th><th>업체명</th><th>대표</th><th class="num">매출</th><th class="center">입금여부</th><th>작업기간</th><th class="num">작업비</th><th class="num">영업이익</th><th class="num">순이익율</th><th class="center">계약 상태</th><th>메모</th><th class="center">세금</th></tr></thead>
            <tbody id="finProject"></tbody>
          </table>
        </div>
        <div class="pagination-wrapper">
          <div style="display:flex; align-items:center; gap:10px">
            <span class="muted">페이지당 표시:</span>
            <select id="finProjectPerPage" style="width:auto; padding:8px 12px">
              <option value="30">30개</option>
              <option value="50">50개</option>
              <option value="100">100개</option>
            </select>
            <span class="muted" style="margin:0 8px">|</span>
            <span class="muted">총 <strong id="finProjectTotalCount" style="color:var(--primary-light); font-size:16px">0</strong>개 업체</span>
          </div>
          <div class="pagination" id="finProjectPagination"></div>
        </div>
      </div>

      <div class="sep"></div>
      <div style="font-weight:700; margin-bottom:16px; font-size:16px">📊 종합 요약 (필터 적용) <span class="fin-count" id="totalCompanyCount"></span></div>
      <div class="kpi-summary">
        <div class="kpi"><div class="muted">총 매출</div><div class="v" id="totalRevenue">₩0</div></div>
        <div class="kpi"><div class="muted">총 매입(작업비)</div><div class="v" id="totalCost">₩0</div></div>
        <div class="kpi"><div class="muted">총 영업이익</div><div class="v" id="totalProfit">₩0</div></div>
      </div>
      
      <div style="margin-top:20px">
        <div class="growth-card" id="growthCard">
          <div class="growth-info">
            <div class="label">📈 전월 대비 성장률</div>
            <div class="growth-value">
              <span class="number" id="revenueGrowth">0%</span>
            </div>
          </div>
          <div class="growth-icon" id="growthIcon">📊</div>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <div style="margin-bottom:16px">
        <div style="font-weight:700; margin-bottom:16px; font-size:16px; color:var(--primary-light)">📊 월별 매출 추이 (최근 6개월)</div>
        <canvas id="revenueGrowthChart" width="800" height="300" style="max-width:100%; height:auto"></canvas>
      </div>
    </div>
  </section>
</div>

<div class="modal-back" id="addModalBack">
  <div class="modal">
    <div class="mh">
      <strong id="modalTitle">➕ 새 항목 등록</strong>
      <button class="btn small outline" id="closeModalBtn">✕ 닫기</button>
    </div>
    <div class="mb">
      <form id="addForm" class="form-grid"></form>
    </div>
  </div>
</div>

<div class="modal-back" id="memoModalBack">
  <div class="modal" style="max-width:600px">
    <div class="mh">
      <strong>📝 메모 편집</strong>
      <button class="btn small outline" id="closeMemoModalBtn">✕ 닫기</button>
    </div>
    <div class="mb">
      <div style="margin-bottom:16px">
        <label style="display:block; font-size:14px; font-weight:600; color:var(--muted); margin-bottom:8px; text-transform:uppercase; letter-spacing:.6px">메모 내용</label>
        <textarea id="memoTextarea" rows="8" style="width:100%; padding:14px 18px; border-radius:12px; border:2px solid var(--border); background:var(--card); color:var(--text); font-size:15px; font-weight:500; resize:vertical; font-family:inherit; line-height:1.6" placeholder="메모를 입력하세요..."></textarea>
      </div>
      <div style="display:flex; gap:12px; justify-content:flex-end">
        <button class="btn outline" id="cancelMemoBtn">취소</button>
        <button class="btn" id="saveMemoBtn">💾 저장</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-back" id="specialNoteModalBack">
  <div class="modal" style="max-width:700px">
    <div class="mh">
      <strong id="specialNoteModalTitle">📌 특이사항</strong>
      <button class="btn small outline" id="closeSpecialNoteModalBtn">✕ 닫기</button>
    </div>
    <div class="mb">
      <div style="margin-bottom:16px">
        <label style="display:block; font-size:14px; font-weight:600; color:var(--muted); margin-bottom:8px">특이사항 메모</label>
        <textarea id="specialNoteTextarea" rows="10" style="width:100%; padding:14px 18px; border-radius:12px; border:2px solid var(--border); background:var(--card); color:var(--text); font-size:15px; font-weight:500; resize:vertical; font-family:inherit; line-height:1.6" placeholder="이 작업 목록에 대한 특이사항을 입력하세요..."></textarea>
      </div>
      <div style="display:flex; gap:12px; justify-content:flex-end">
        <button class="btn outline" id="cancelSpecialNoteBtn">취소</button>
        <button class="btn" id="saveSpecialNoteBtn">💾 저장</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const USE_FIREBASE = true;
const firebaseConfig = {
  apiKey: "AIzaSyCV9pjrGzHEoc-s4ppz44lMba5BKE53VAs",
  authDomain: "entjcompany.firebaseapp.com",
  databaseURL: "https://entjcompany.firebaseio.com",
  projectId: "entjcompany",
  storageBucket: "entjcompany.firebasestorage.app",
  messagingSenderId: "567861521069",
  appId: "1:567861521069:web:084f0212f2931e2c9fb424",
  measurementId: "G-0F57YWZJPS"
};

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmtMoney = n => '₩' + Math.round(n||0).toLocaleString('ko-KR');
const parseNum = v => { const num = Number(v); return isNaN(num) ? null : num; };
const toISO = d => { if(!d)return''; const z=new Date(d); return new Date(z - z.getTimezoneOffset()*60000).toISOString().slice(0,10); };
const today = () => toISO(new Date());
const getYearMonth = d => { const date=new Date(d); return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`; };

const getDDay = (endDate) => {
  if (!endDate) return null;
  const end = new Date(endDate);
  const now = new Date();
  now.setHours(0, 0, 0, 0);
  end.setHours(0, 0, 0, 0);
  const diff = Math.ceil((end - now) / (1000 * 60 * 60 * 24));
  return diff;
};

const getDDayBadge = (endDate) => {
  const dday = getDDay(endDate);
  if (dday === null) return '';
  
  if (dday < 0) return `<span class="d-day-badge d-0">종료</span>`;
  if (dday === 0) return `<span class="d-day-badge d-0">D-0</span>`;
  if (dday === 1) return `<span class="d-day-badge d-1">D-1</span>`;
  if (dday <= 3) return `<span class="d-day-badge d-3">D-${dday}</span>`;
  if (dday <= 7) return `<span class="d-day-badge d-7">D-${dday}</span>`;
  return '';
};

const getRowClass = (endDate) => {
  const dday = getDDay(endDate);
  if (dday === null) return '';
  if (dday === 0 || dday < 0) return 'urgent-row';
  if (dday === 1) return 'warning-row';
  return '';
};

const MANAGERS = ['전병황', '강태우', '오영은', '김하늬', '김우현', '공민경'];

const state = {
  currentType: 'place',
  placeSubType: 'reward',
  rows: {place: [], blog: [], project: []},
  financeData: {},
  specialNotes: {
    place_reward: '',
    place_distribution: '',
    blog: '',
    project: ''
  },
  filters: {},
  selected: new Set(),
  finSelected: new Set(),
  pagination: {currentPage:1, perPage:30},
  financePagination: {
    place: {currentPage: 1, perPage: 30},
    blog: {currentPage: 1, perPage: 30},
    project: {currentPage: 1, perPage: 30}
  },
  isFirebaseConnected: false,
  useFirebase: USE_FIREBASE
};

let db = null;
let dataRefs = {};

const CONFIGS = {
  place: {
    name: '플레이스 작업',
    path: 'place',
    rewardFields: [
      {key:'manager', label:'담당자', type:'select', options:['전병황', '강태우', '오영은', '김하늬', '김우현', '공민경']},
      {key:'product', label:'상품', type:'text'},
      {key:'category', label:'구분', type:'select', options:['트래픽','저장','길찾기','영수증']},
      {key:'client', label:'업체명', type:'text', required:true},
      {key:'mid', label:'Mid', type:'url'},
      {key:'keywords', label:'키워드', type:'text'},
      {key:'startDate', label:'시작일', type:'date', required:true},
      {key:'endDate', label:'종료일', type:'date'},
      {key:'units', label:'일타', type:'number'},
      {key:'days', label:'일수', type:'number'},
      {key:'unitPrice', label:'단가', type:'number'},
      {key:'totalQty', label:'총량', type:'computed'},
      {key:'cost', label:'작업비', type:'computed'},
      {key:'tax', label:'세금', type:'select', options:['발행','미발행']},
      {key:'note', label:'비고', type:'text'}
    ],
    distributionFields: [
      {key:'manager', label:'담당자', type:'select', options:['전병황', '강태우', '오영은', '김하늬', '김우현', '공민경']},
      {key:'product', label:'상품', type:'text'},
      {key:'client', label:'업체명', type:'text', required:true},
      {key:'url', label:'URL', type:'url'},
      {key:'realName', label:'실/비', type:'select', options:['실명','비실명']},
      {key:'category', label:'구분', type:'select', options:['정보성','후기성']},
      {key:'totalQty', label:'총수량', type:'number'},
      {key:'dailyPublish', label:'일 발행', type:'number'},
      {key:'unitPrice', label:'단가', type:'number'},
      {key:'keywords', label:'키워드', type:'text'},
      {key:'startDate', label:'시작일', type:'date', required:true},
      {key:'endDate', label:'종료일', type:'date'},
      {key:'cost', label:'작업비', type:'computed'},
      {key:'tax', label:'세금', type:'select', options:['발행','미발행']},
      {key:'note', label:'비고', type:'text'}
    ],
    get fields() {
      // 현재 서브타입에 따라 필드 반환
      return state.placeSubType === 'distribution' ? this.distributionFields : this.rewardFields;
    }
  },
  blog: {
    name: '블로그 작업',
    path: 'blog',
    fields: [
      {key:'manager', label:'담당자', type:'select', options:['전병황', '강태우', '오영은', '김하늬', '김우현', '공민경']},
      {key:'product', label:'상품', type:'text'},
      {key:'category', label:'구분', type:'select', options:['블로그리뷰','단순배포','건바이','월보장','일반형','프리미엄형']},
      {key:'client', label:'업체명', type:'text', required:true},
      {key:'mid', label:'Mid', type:'url'},
      {key:'keywords', label:'키워드', type:'text'},
      {key:'startDate', label:'시작일', type:'date', required:true},
      {key:'endDate', label:'종료일', type:'date'},
      {key:'totalQty', label:'총량', type:'number'},
      {key:'unitPrice', label:'단가', type:'number'},
      {key:'cost', label:'작업비', type:'computed'},
      {key:'tax', label:'세금', type:'select', options:['발행','미발행']},
      {key:'note', label:'비고', type:'text'}
    ]
  },
  project: {
    name: '프로젝트',
    path: 'project',
    fields: [
      {key:'manager', label:'담당자', type:'select', options:['전병황', '강태우', '오영은', '김하늬', '김우현', '공민경']},
      {key:'client', label:'업체명', type:'text', required:true},
      {key:'platform', label:'플랫폼', type:'select', options:['Instagram','Facebook','TikTok','YouTube']},
      {key:'accountName', label:'계정명', type:'text'},
      {key:'url', label:'URL', type:'url'},
      {key:'category', label:'카테고리', type:'text'},
      {key:'dailyCost', label:'하루비용', type:'number'},
      {key:'startDate', label:'시작일', type:'date', required:true},
      {key:'endDate', label:'종료일', type:'date'},
      {key:'days', label:'기간(일)', type:'computed'},
      {key:'totalSpent', label:'총 지출비', type:'computed'},
      {key:'note', label:'메모', type:'text'}
    ]
  }
};

let auth = null;
let currentUser = null;

// 인증 초기화
function initAuth() {
  console.log('Initializing authentication...');
  
  if (typeof firebase === 'undefined') {
    console.error('Firebase not loaded');
    showLogin();
    return;
  }
  
  if (!firebase.apps || firebase.apps.length === 0) {
    console.error('Firebase App not initialized');
    showLogin();
    return;
  }
  
  try {
    auth = firebase.auth();
    console.log('Firebase Auth initialized');
    
    // 인증 상태 변경 감지
    auth.onAuthStateChanged(user => {
      if (user) {
        console.log('User logged in:', user.email);
        currentUser = user;
        showDashboard();
        updateUserInfo(user.email);
      } else {
        console.log('User not logged in');
        currentUser = null;
        showLogin();
      }
    });
  } catch (error) {
    console.error('Auth initialization error:', error);
    showLogin();
  }
}

// 로그인 처리
async function handleLogin(email, password) {
  console.log('Login attempt for:', email);
  
  const loginBtn = $('#loginBtn');
  const loginError = $('#loginError');
  
  if (loginBtn) loginBtn.disabled = true;
  if (loginError) loginError.style.display = 'none';
  
  if (!auth) {
    console.error('Auth not initialized');
    if (loginError) {
      loginError.textContent = 'Firebase 인증이 초기화되지 않았습니다. 페이지를 새로고침해주세요.';
      loginError.style.display = 'block';
    }
    if (loginBtn) loginBtn.disabled = false;
    return;
  }
  
  try {
    console.log('Attempting to sign in...');
    const result = await auth.signInWithEmailAndPassword(email, password);
    console.log('Login successful:', result.user.email);
    // 로그인 성공 - onAuthStateChanged가 처리함
  } catch (error) {
    console.error('로그인 실패:', error);
    console.error('Error code:', error.code);
    console.error('Error message:', error.message);
    if (loginError) {
      loginError.textContent = getErrorMessage(error.code);
      loginError.style.display = 'block';
    }
    if (loginBtn) loginBtn.disabled = false;
  }
}

// 로그아웃 처리
async function handleLogout() {
  try {
    await auth.signOut();
    // 로그아웃 성공 - onAuthStateChanged가 처리함
  } catch (error) {
    console.error('로그아웃 실패:', error);
    alert('로그아웃에 실패했습니다.');
  }
}

// 대시보드 표시
function showDashboard() {
  const loginContainer = $('#loginContainer');
  const app = $('#app');
  
  if (loginContainer) loginContainer.style.display = 'none';
  if (app) app.style.display = 'block';
}

// 로그인 페이지 표시
function showLogin() {
  const loginContainer = $('#loginContainer');
  const app = $('#app');
  
  if (loginContainer) loginContainer.style.display = 'flex';
  if (app) app.style.display = 'none';
}

// 사용자 정보 업데이트
function updateUserInfo(email) {
  const userInfo = $('#userInfo');
  const userEmail = $('#userEmail');
  
  if (userInfo) userInfo.style.display = 'flex';
  if (userEmail) userEmail.textContent = email;
}

// 에러 메시지 변환
function getErrorMessage(errorCode) {
  const messages = {
    'auth/invalid-email': '유효하지 않은 이메일 형식입니다.',
    'auth/user-disabled': '비활성화된 계정입니다.',
    'auth/user-not-found': '등록되지 않은 이메일입니다.',
    'auth/wrong-password': '비밀번호가 올바르지 않습니다.',
    'auth/invalid-credential': '이메일 또는 비밀번호가 올바르지 않습니다.',
    'auth/too-many-requests': '너무 많은 시도가 있었습니다. 잠시 후 다시 시도해주세요.',
    'auth/network-request-failed': '네트워크 오류가 발생했습니다.',
  };
  
  return messages[errorCode] || '로그인에 실패했습니다. 다시 시도해주세요.';
}

function initFirebase() {
  if (!USE_FIREBASE) {
    updateConnectionStatus('local');
    render();
    return;
  }

  try {
    if (typeof firebase !== 'undefined') {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      
      Object.keys(CONFIGS).forEach(key => {
        dataRefs[key] = db.ref(CONFIGS[key].path);
        setupListeners(key);
        loadData(key);
      });
      
            
      // Finance 데이터 로드
      ['place', 'blog', 'project'].forEach(type => {
        loadFinanceData(type);
      });
      
      // Special Notes 로드
      loadSpecialNotes();
      
      db.ref('.info/connected').on('value', s => {
        state.isFirebaseConnected = s.val() === true;
        updateConnectionStatus(state.isFirebaseConnected ? 'connected' : 'disconnected');
      });
    }
  } catch(e) {
    console.error('Firebase 초기화 실패:', e);
    state.useFirebase = false;
    updateConnectionStatus('local');
  }
}

function updateConnectionStatus(s) {
  const el = $('#connectionStatus');
  if(el) {
    el.className = 'connection-status ' + s;
    const txt = $('#connectionText');
    if(txt) txt.textContent = s === 'connected' ? '실시간 동기화' : s === 'local' ? '로컬 모드' : '오프라인';
  }
}

function mk(p, config) {
  const id = p.id || 'r_'+Math.random().toString(36).slice(2,9);
  const createdAt = p.createdAt || new Date().toISOString();
  const row = {id, createdAt, ...p};
  
  if (config.path === 'place') {
    // 리워드인 경우에만 계산 (기본값은 reward)
    const subType = row.subType || 'reward';
    if (subType === 'reward') {
      if (row.units !== undefined && row.days !== undefined) {
        row.totalQty = (row.units||0) * (row.days||0);
      }
      if (row.totalQty !== undefined && row.unitPrice !== undefined) {
        row.cost = (row.totalQty||0) * (row.unitPrice||0);
      }
    } else if (subType === 'distribution') {
      // 배포는 총수량 * 단가로 계산
      if (row.totalQty !== undefined && row.unitPrice !== undefined) {
        row.cost = (row.totalQty||0) * (row.unitPrice||0);
      }
    }
  } else if (config.path === 'blog') {
    if (row.totalQty !== undefined && row.unitPrice !== undefined) {
      row.cost = (row.totalQty||0) * (row.unitPrice||0);
    }
  } else if (config.path === 'project') {
    if (row.startDate && row.endDate) {
      const start = new Date(row.startDate);
      const end = new Date(row.endDate);
      const diffTime = Math.abs(end - start);
      row.days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
    } else {
      row.days = 0;
    }
    row.totalSpent = (row.dailyCost || 0) * (row.days || 0);
  }
  
  return row;
}

function setupListeners(key) {
  if (!dataRefs[key]) return;
  
  dataRefs[key].on('child_added', s => {
    const data = s.val();
    if (data && !state.rows[key].find(r => r.id === data.id)) {
      state.rows[key].unshift(mk(data, CONFIGS[key]));
      if (state.currentType === key) render();
    }
  });

  dataRefs[key].on('child_changed', s => {
    const data = s.val();
    if (data) {
      const idx = state.rows[key].findIndex(r => r.id === data.id);
      if (idx !== -1) {
        state.rows[key][idx] = mk(data, CONFIGS[key]);
        if (state.currentType === key) render();
      }
    }
  });

  dataRefs[key].on('child_removed', s => {
    const data = s.val();
    if (data) {
      state.rows[key] = state.rows[key].filter(r => r.id !== data.id);
      if (state.currentType === key) render();
    }
  });
}

function saveData(row, key) {
  if (!state.useFirebase || !dataRefs[key]) return;
  dataRefs[key].child(row.id).set(row);
}

function deleteData(id, key) {
  if (!state.useFirebase || !dataRefs[key]) return;
  dataRefs[key].child(id).remove();
}

function loadData(key) {
  if (!dataRefs[key]) return;
  dataRefs[key].once('value').then(s => {
    const data = s.val();
    if (data) {
      state.rows[key] = Object.values(data).map(d => mk(d, CONFIGS[key]));
      if (state.currentType === key) render();
    }
  });
}

function switchType(type) {
  const placeSubtabs = $('#placeSubtabs');
  
  // 플레이스 탭 토글 처리: 이미 활성화되어 있고 서브탭이 표시 중일 때
  if (type === 'place' && state.currentType === 'place') {
    if (placeSubtabs && placeSubtabs.classList.contains('show')) {
      // 서브탭 숨김
      placeSubtabs.classList.remove('show');
      return;
    }
  }
  
  state.currentType = type;
  state.selected.clear();
  state.pagination.currentPage = 1;
  
  $$('.tab').forEach(t => t.classList.remove('active'));
  const activeTab = $(`.tab[data-type="${type}"]`);
  if (activeTab) activeTab.classList.add('active');
  
  // 플레이스 서브탭 표시/숨김
  if (placeSubtabs) {
    if (type === 'place') {
      placeSubtabs.classList.add('show');
    } else {
      placeSubtabs.classList.remove('show');
    }
  }
  
  // 특이사항 버튼 표시/숨김
  const specialNoteBtn = $('#openSpecialNoteBtn');
  if (specialNoteBtn) {
    if (type === 'finance') {
      specialNoteBtn.style.display = 'none';
    } else {
      specialNoteBtn.style.display = 'inline-block';
    }
  }
  
  if (type === 'finance') {
    const kpisPanel = $('#kpisPanel');
    const tablePanel = $('#tablePanel');
    const summaryPanel = $('#kpisSummaryPanel');
    const financePanel = $('#financePanel');
    
    if (kpisPanel) kpisPanel.style.display = 'none';
    if (tablePanel) tablePanel.style.display = 'none';
    if (summaryPanel) summaryPanel.style.display = 'none';
    if (financePanel) financePanel.style.display = 'block';
    
    // Finance 탭 렌더링
    setTimeout(() => {
      renderFinance();
    }, 0);
  } else {
    $('#kpisPanel').style.display = 'block';
    $('#tablePanel').style.display = 'block';
    $('#kpisSummaryPanel').style.display = 'block';
    $('#financePanel').style.display = 'none';
    
    render();
  }
}

function applyFilters(rows) {
  const f = state.filters[state.currentType] || {};
  let arr = rows.slice();
  
  // 플레이스 서브타입 필터링
  if (state.currentType === 'place' && state.placeSubType) {
    arr = arr.filter(r => (r.subType || 'reward') === state.placeSubType);
  }
  
  if (f.q) {
    const q = f.q.toLowerCase();
    arr = arr.filter(r => {
      const searchFields = [r.client, r.keywords, r.product, r.category, r.accountName, r.manager, r.platform].filter(Boolean).join(' ').toLowerCase();
      return searchFields.includes(q);
    });
  }
  
  const config = CONFIGS[state.currentType];
  const catField = config.fields.find(x => x.key === 'category');
  if (catField && catField.type === 'select') {
    if (f.category && f.category !== 'all') {
      arr = arr.filter(r => r.category === f.category);
    }
  }
  
  // 플랫폼 필터 (프로젝트용)
  if (f.platform && f.platform !== 'all') {
    arr = arr.filter(r => r.platform === f.platform);
  }
  
  // 담당자 필터 (프로젝트용)
  if (f.manager && f.manager !== 'all') {
    arr = arr.filter(r => r.manager === f.manager);
  }
  
  if (f.tax && f.tax !== 'all') arr = arr.filter(r => (f.tax === 'yes' ? r.tax === '발행' : r.tax === '미발행'));
  
  if (f.dday) {
    arr = arr.filter(r => {
      if (!r.endDate) return false;
      const dday = getDDay(r.endDate);
      if (dday === null) return false;
      
      if (f.dday === 'd0') return dday <= 0;
      if (f.dday === 'd1') return dday >= 0 && dday <= 1;
      if (f.dday === 'd3') return dday >= 0 && dday <= 3;
      if (f.dday === 'd7') return dday >= 0 && dday <= 7;
      return true;
    });
  }
  
  // 월별 필터
  if (f.month) {
    arr = arr.filter(r => {
      if (!r.startDate) return false;
      const date = new Date(r.startDate);
      const monthName = (date.getMonth() + 1) + '월';
      return monthName === f.month;
    });
  }
  
  const [sf, dir] = (f.sort || 'order_asc').split('_');
  const mul = dir === 'asc' ? 1 : -1;
  arr.sort((a, b) => {
    if (sf === 'order') {
      // order 필드가 없으면 9999로 설정하여 뒤로 보냄
      const orderA = typeof a.order === 'number' ? a.order : 9999;
      const orderB = typeof b.order === 'number' ? b.order : 9999;
      return (orderA - orderB) * mul;
    }
    if (sf === 'date') return (a.startDate || '').localeCompare(b.startDate || '') * mul;
    if (sf === 'cost') {
      const costA = config.path === 'project' ? (a.totalSpent || 0) : (a.cost || 0);
      const costB = config.path === 'project' ? (b.totalSpent || 0) : (b.cost || 0);
      return (costA - costB) * mul;
    }
    return 0;
  });
  
  return arr;
}

function createCalendarPicker() {
  const picker = document.createElement('div');
  picker.className = 'calendar-picker';
  
  const input = document.createElement('div');
  input.className = 'calendar-input';
  
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth() + 1;
  const day = today.getDate();
  
  input.innerHTML = `
    <div style="display: flex; align-items: center; gap: 6px; width: 100%;">
      <input type="number" id="yearInput" placeholder="년" value="${year}" min="2020" max="2030" 
        style="width: 70px; padding: 8px 4px; text-align: center; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 6px; font-size: 13px;">
      <span style="color: var(--muted);">-</span>
      <input type="number" id="monthInput" placeholder="월" value="${month}" min="1" max="12" 
        style="width: 50px; padding: 8px 4px; text-align: center; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 6px; font-size: 13px;">
      <span style="color: var(--muted);">-</span>
      <input type="number" id="dayInput" placeholder="일" value="${day}" min="1" max="31" 
        style="width: 50px; padding: 8px 4px; text-align: center; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 6px; font-size: 13px;">
    </div>
    <span style="cursor: pointer; font-size:16px; color: var(--muted);" id="calendarToggle">▼</span>
  `;
  
  const dropdown = document.createElement('div');
  dropdown.className = 'calendar-dropdown';
  dropdown.id = 'calendarDropdown';
  
  picker.appendChild(input);
  picker.appendChild(dropdown);
  
  const toggleBtn = input.querySelector('#calendarToggle');
  if (toggleBtn) {
    toggleBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    dropdown.classList.toggle('active');
    if (dropdown.classList.contains('active')) {
      renderCalendar();
    }
    });
  }
  
  const yearInput = input.querySelector('#yearInput');
  const monthInput = input.querySelector('#monthInput');
  const dayInput = input.querySelector('#dayInput');
  
  const updateDateFromInputs = () => {
    const y = parseInt(yearInput.value) || year;
    const m = parseInt(monthInput.value) || month;
    const d = parseInt(dayInput.value) || day;
    
    if (m < 1 || m > 12 || d < 1 || d > 31) return;
    
    try {
      const dateStr = toISO(new Date(y, m - 1, d));
      state.calendarState.selectedDate = dateStr;
      if (!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].selectedDate = dateStr;
      state.pagination.currentPage = 1;
      renderTable();
    } catch (e) {
      console.error('Invalid date:', e);
    }
  };
  
  if (yearInput) yearInput.addEventListener('change', updateDateFromInputs);
  if (monthInput) monthInput.addEventListener('change', updateDateFromInputs);
  if (dayInput) dayInput.addEventListener('change', updateDateFromInputs);
  
  document.addEventListener('click', (e) => {
    if (!picker.contains(e.target)) {
      dropdown.classList.remove('active');
    }
  });
  
  return picker;
}

function renderCalendar() {
  const dropdown = $('#calendarDropdown');
  if (!dropdown) return;
  
  const current = state.calendarState.currentMonth;
  const year = current.getFullYear();
  const month = current.getMonth();
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const prevLastDay = new Date(year, month, 0);
  
  const firstDayOfWeek = firstDay.getDay();
  const lastDate = lastDay.getDate();
  const prevLastDate = prevLastDay.getDate();
  
  const todayStr = toISO(new Date());
  const selectedStr = state.calendarState.selectedDate;
  
  let html = `
    <div class="calendar-header">
      <button id="prevMonth">▲</button>
      <div class="month-year">
        <select id="yearSelect">
          ${[2024, 2025, 2026, 2027].map(y => `<option value="${y}" ${y === year ? 'selected' : ''}>${y}년</option>`).join('')}
        </select>
        <select id="monthSelect">
          ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `<option value="${m}" ${m === month + 1 ? 'selected' : ''}>${m}월</option>`).join('')}
        </select>
      </div>
      <button id="nextMonth">▼</button>
    </div>
    <div class="calendar-weekdays">
      <div class="calendar-weekday">일</div>
      <div class="calendar-weekday">월</div>
      <div class="calendar-weekday">화</div>
      <div class="calendar-weekday">수</div>
      <div class="calendar-weekday">목</div>
      <div class="calendar-weekday">금</div>
      <div class="calendar-weekday">토</div>
    </div>
    <div class="calendar-days">
  `;
  
  // 이전 달 날짜
  for (let i = firstDayOfWeek; i > 0; i--) {
    html += `<div class="calendar-day disabled">${prevLastDate - i + 1}</div>`;
  }
  
  // 현재 달 날짜
  for (let date = 1; date <= lastDate; date++) {
    const dateStr = toISO(new Date(year, month, date));
    const isToday = dateStr === todayStr;
    const isSelected = dateStr === selectedStr;
    const classes = ['calendar-day'];
    if (isToday) classes.push('today');
    if (isSelected) classes.push('selected');
    
    html += `<div class="${classes.join(' ')}" data-date="${dateStr}">${date}</div>`;
  }
  
  // 다음 달 날짜
  const totalCells = firstDayOfWeek + lastDate;
  const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
  for (let date = 1; date <= remainingCells; date++) {
    html += `<div class="calendar-day disabled">${date}</div>`;
  }
  
  html += `</div>
    <div class="calendar-actions">
      <button class="clear-btn" id="clearDate">지우기</button>
      <button class="today-btn" id="todayDate">오늘</button>
    </div>
  `;
  
  dropdown.innerHTML = html;
  
  // 이전/다음 월 버튼
  $('#prevMonth')?.addEventListener('click', () => {
    state.calendarState.currentMonth = new Date(year, month - 1);
    renderCalendar();
  });
  
  $('#nextMonth')?.addEventListener('click', () => {
    state.calendarState.currentMonth = new Date(year, month + 1);
    renderCalendar();
  });
  
  // 년/월 선택
  $('#yearSelect')?.addEventListener('change', (e) => {
    const newYear = parseInt(e.target.value);
    state.calendarState.currentMonth = new Date(newYear, month);
    renderCalendar();
  });
  
  $('#monthSelect')?.addEventListener('change', (e) => {
    const newMonth = parseInt(e.target.value) - 1;
    state.calendarState.currentMonth = new Date(year, newMonth);
    renderCalendar();
  });
  
  // 날짜 선택
  dropdown.querySelectorAll('.calendar-day:not(.disabled)').forEach(day => {
    day.addEventListener('click', () => {
      const dateStr = day.dataset.date;
      state.calendarState.selectedDate = dateStr;
      if (!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].selectedDate = dateStr;
      state.pagination.currentPage = 1;
      
      const yearInput = $('#yearInput');
      const monthInput = $('#monthInput');
      const dayInput = $('#dayInput');
      if (yearInput && monthInput && dayInput) {
        const date = new Date(dateStr);
        yearInput.value = date.getFullYear();
        monthInput.value = date.getMonth() + 1;
        dayInput.value = date.getDate();
      }
      
      dropdown.classList.remove('active');
      renderTable();
    });
  });
  
  // 지우기 버튼
  $('#clearDate')?.addEventListener('click', () => {
    state.calendarState.selectedDate = null;
    if (state.filters[state.currentType]) {
      delete state.filters[state.currentType].selectedDate;
    }
    state.pagination.currentPage = 1;
    
    const yearInput = $('#yearInput');
    const monthInput = $('#monthInput');
    const dayInput = $('#dayInput');
    if (yearInput && monthInput && dayInput) {
      const today = new Date();
      yearInput.value = today.getFullYear();
      monthInput.value = today.getMonth() + 1;
      dayInput.value = today.getDate();
    }
    
    dropdown.classList.remove('active');
    renderTable();
  });
  
  // 오늘 버튼
  $('#todayDate')?.addEventListener('click', () => {
    const dateStr = todayStr;
    state.calendarState.selectedDate = dateStr;
    if (!state.filters[state.currentType]) state.filters[state.currentType] = {};
    state.filters[state.currentType].selectedDate = dateStr;
    state.pagination.currentPage = 1;
    
    const yearInput = $('#yearInput');
      const monthInput = $('#monthInput');
      const dayInput = $('#dayInput');
      if (yearInput && monthInput && dayInput) {
        const date = new Date(dateStr);
        yearInput.value = date.getFullYear();
        monthInput.value = date.getMonth() + 1;
        dayInput.value = date.getDate();
      }
    
    dropdown.classList.remove('active');
    renderTable();
  });
}

function renderFilters() {
  const config = CONFIGS[state.currentType];
  if(!config) return;
  
  const f = state.filters[state.currentType] || {};
  
  // 프로젝트 여부에 따라 그리드 구성
  const isProject = config.path === 'project';
  
  let html = '<div class="filters" style="grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr auto;">';
  
  // 검색 필터
  html += `
    <div class="filter-group">
      <label class="filter-label">🔍 검색</label>
      <input id="q" placeholder="업체명, 키워드, 담당자 검색..." value="${f.q || ''}">
    </div>
  `;
  
  // 카테고리/플랫폼 필터
  const catField = config.fields.find(x => x.key === 'category');
  const platformField = config.fields.find(x => x.key === 'platform');
  
  if (catField && catField.type === 'select') {
    html += `
      <div class="filter-group">
        <label class="filter-label">📂 카테고리</label>
        <select id="fcat">
          <option value="all">전체</option>
    `;
    catField.options.forEach(o => html += `<option value="${o}" ${f.category === o ? 'selected' : ''}>${o}</option>`);
    html += `</select></div>`;
  } else if (platformField && platformField.type === 'select') {
    // 프로젝트의 경우 플랫폼 필터
    html += `
      <div class="filter-group">
        <label class="filter-label">📱 플랫폼</label>
        <select id="fplatform">
          <option value="all">전체</option>
    `;
    platformField.options.forEach(o => html += `<option value="${o}" ${f.platform === o ? 'selected' : ''}>${o}</option>`);
    html += `</select></div>`;
  }
  
  // 담당자 필터 (프로젝트용) 또는 세금 필터 (플레이스/블로그용)
  if (isProject) {
    const managerField = config.fields.find(x => x.key === 'manager');
    if (managerField && managerField.type === 'select') {
      html += `
        <div class="filter-group">
          <label class="filter-label">👤 담당자</label>
          <select id="fmanager">
            <option value="all">전체</option>
      `;
      managerField.options.forEach(o => html += `<option value="${o}" ${f.manager === o ? 'selected' : ''}>${o}</option>`);
      html += `</select></div>`;
    }
  } else if (config.path === 'place' || config.path === 'blog') {
    html += `
      <div class="filter-group">
        <label class="filter-label">💳 세금계산서</label>
        <select id="ftax">
          <option value="all" ${!f.tax||f.tax==='all'?'selected':''}>전체</option>
          <option value="completed" ${f.tax==='completed'?'selected':''}>발행완료</option>
          <option value="yes" ${f.tax==='yes'?'selected':''}>발행</option>
          <option value="no" ${f.tax==='no'?'selected':''}>미발행</option>
        </select>
      </div>
    `;
  }
  
  // 월별 조회 필터
  html += `
    <div class="filter-group">
      <label class="filter-label">📊 월별 조회</label>
      <select id="fmonth">
        <option value="">전체 월</option>
        <option value="1월" ${f.month==='1월'?'selected':''}>1월</option>
        <option value="2월" ${f.month==='2월'?'selected':''}>2월</option>
        <option value="3월" ${f.month==='3월'?'selected':''}>3월</option>
        <option value="4월" ${f.month==='4월'?'selected':''}>4월</option>
        <option value="5월" ${f.month==='5월'?'selected':''}>5월</option>
        <option value="6월" ${f.month==='6월'?'selected':''}>6월</option>
        <option value="7월" ${f.month==='7월'?'selected':''}>7월</option>
        <option value="8월" ${f.month==='8월'?'selected':''}>8월</option>
        <option value="9월" ${f.month==='9월'?'selected':''}>9월</option>
        <option value="10월" ${f.month==='10월'?'selected':''}>10월</option>
        <option value="11월" ${f.month==='11월'?'selected':''}>11월</option>
        <option value="12월" ${f.month==='12월'?'selected':''}>12월</option>
      </select>
    </div>
  `;
  
  // D-day 필터
  html += `
    <div class="filter-group">
      <label class="filter-label">⏰ 종료일</label>
      <select id="fdday">
        <option value="" ${!f.dday?'selected':''}>전체</option>
        <option value="d0" ${f.dday==='d0'?'selected':''}>⚠️ 종료/D-0</option>
        <option value="d1" ${f.dday==='d1'?'selected':''}>🔔 D-1 이내</option>
        <option value="d3" ${f.dday==='d3'?'selected':''}>📌 D-3 이내</option>
        <option value="d7" ${f.dday==='d7'?'selected':''}>📅 D-7 이내</option>
      </select>
    </div>
  `;
  
  // 정렬 필터
  const sortLabel = config.path === 'project' ? '지출비' : '작업비';
  html += `
    <div class="filter-group">
      <label class="filter-label">🔄 정렬</label>
      <select id="fsort">
        <option value="order_asc" ${!f.sort||f.sort==='order_asc'?'selected':''}>📝 등록순</option>
        <option value="date_desc" ${f.sort==='date_desc'?'selected':''}>📆 최신순</option>
        <option value="date_asc" ${f.sort==='date_asc'?'selected':''}>📆 오래된순</option>
        <option value="cost_desc" ${f.sort==='cost_desc'?'selected':''}>💰 ${sortLabel} 높은순</option>
        <option value="cost_asc" ${f.sort==='cost_asc'?'selected':''}>💰 ${sortLabel} 낮은순</option>
      </select>
    </div>
  `;
  
  // 초기화 버튼을 같은 줄에 추가
  html += `
    <div class="filter-group">
      <label class="filter-label" style="opacity:0">초기화</label>
      <button class="btn small outline" id="bresetbtn" style="white-space:nowrap">🔄 초기화</button>
    </div>
  `;
  
  html += '</div>';
  
  const container = $('#filtersContainer');
  if(container) container.innerHTML = html;
  
  const qEl = $('#q');
  if(qEl) {
    qEl.addEventListener('input', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].q = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const fcatEl = $('#fcat');
  if(fcatEl) {
    fcatEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].category = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const fplatformEl = $('#fplatform');
  if(fplatformEl) {
    fplatformEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].platform = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const fmanagerEl = $('#fmanager');
  if(fmanagerEl) {
    fmanagerEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].manager = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const ftaxEl = $('#ftax');
  if(ftaxEl) {
    ftaxEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].tax = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const fmonthEl = $('#fmonth');
  if(fmonthEl) {
    fmonthEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].month = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const fddayEl = $('#fdday');
  if(fddayEl) {
    fddayEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].dday = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const fsortEl = $('#fsort');
  if(fsortEl) {
    fsortEl.addEventListener('change', e => {
      if(!state.filters[state.currentType]) state.filters[state.currentType] = {};
      state.filters[state.currentType].sort = e.target.value;
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  const resetBtn = $('#bresetbtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      state.filters[state.currentType] = {};
      state.pagination.currentPage = 1;
      render();
    });
  }
}

function renderTable() {
  const config = CONFIGS[state.currentType];
  if(!config) return;
  
  const rows = state.rows[state.currentType];
  
  const titleEl = $('#listTitle');
  if(titleEl) titleEl.textContent = config.name;
  
  let h = '<tr><th class="center"><input type="checkbox" id="chkAll"></th>';
  config.fields.forEach(f => h += `<th class="${f.type === 'number' || f.type === 'computed' ? 'num' : ''}">${f.label}</th>`);
  h += '</tr>';
  
  const theadEl = $('#thead');
  if(theadEl) theadEl.innerHTML = h;
  
  const tbody = $('#tbody');
  if(!tbody) return;
  tbody.innerHTML = '';
  
  const filtered = applyFilters(rows);
  const {perPage, currentPage} = state.pagination;
  const pages = Math.ceil(filtered.length / perPage);
  const start = (currentPage - 1) * perPage;
  const pageRows = filtered.slice(start, start + perPage);
  
  pageRows.forEach((row, rowIndex) => {
    const tr = document.createElement('tr');
    const rowClass = getRowClass(row.endDate);
    if (rowClass) tr.className = rowClass;
    
    
    const td0 = document.createElement('td');
    td0.className = 'center';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = state.selected.has(row.id);
    cb.addEventListener('change', () => {
      if (cb.checked) state.selected.add(row.id);
      else state.selected.delete(row.id);
      
      // 전체 선택 체크박스 상태 업데이트
      const chkAll = $('#chkAll');
      if (chkAll) {
        const allCheckboxes = tbody.querySelectorAll('input[type="checkbox"]');
        const allChecked = Array.from(allCheckboxes).every(checkbox => checkbox.checked);
        chkAll.checked = allChecked;
      }
      
      updateBulkEditBar();
    });
    td0.appendChild(cb);
    tr.appendChild(td0);
    
    config.fields.forEach(f => {
      const td = document.createElement('td');
      if (f.type === 'computed') {
        if (f.key === 'totalQty') {
          td.textContent = row.totalQty || '';
          td.className = 'num';
        } else if (f.key === 'cost') {
          td.textContent = fmtMoney(row.cost || 0);
          td.className = 'num';
        } else if (f.key === 'days') {
          td.textContent = row.days || '';
          td.className = 'num';
        } else if (f.key === 'totalSpent') {
          td.textContent = fmtMoney(row.totalSpent || 0);
          td.className = 'num';
        }
      } else if (f.type === 'number') {
        td.textContent = row[f.key] ?? '';
        td.className = 'num';
        td.style.cursor = 'pointer';
        td.addEventListener('click', () => startEdit(td, row, f));
      } else if (f.key === 'mid' || f.key === 'url') {
        const urlValue = row[f.key] || '';
        if (urlValue) {
          const btn = document.createElement('button');
          btn.className = 'btn mini';
          btn.textContent = '🔗 열기';
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            let url = urlValue;
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
              url = 'https://' + url;
            }
            window.open(url, '_blank');
          });
          td.appendChild(btn);
        } else {
          td.textContent = '입력 필요';
          td.style.cursor = 'pointer';
          td.style.color = 'var(--muted)';
          td.addEventListener('click', () => startEdit(td, row, f));
        }
      } else if (f.key === 'note') {
        const noteValue = row[f.key] || '';
        
        // 플레이스 작업인지 확인
        const isPlace = state.currentType === 'place';
        
        if (isPlace) {
          // 플레이스 작업은 메모 버튼 없이 텍스트만 표시
          td.textContent = noteValue;
          td.style.cursor = 'pointer';
          td.addEventListener('click', () => startEdit(td, row, f));
        } else {
          // 다른 작업은 메모 버튼 포함
          const wrapper = document.createElement('div');
          wrapper.style.display = 'flex';
          wrapper.style.gap = '8px';
          wrapper.style.alignItems = 'center';
          
          const noteSpan = document.createElement('span');
          noteSpan.textContent = noteValue.length > 20 ? noteValue.substring(0, 20) + '...' : (noteValue || '');
          noteSpan.style.flex = '1';
          noteSpan.style.cursor = 'pointer';
          noteSpan.addEventListener('click', () => startEdit(td, row, f));
          
          const memoBtn = document.createElement('button');
          memoBtn.className = 'btn mini';
          memoBtn.textContent = '📝 메모';
          memoBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            openMemoModal(row, state.currentType);
          });
          
          wrapper.appendChild(noteSpan);
          wrapper.appendChild(memoBtn);
          td.appendChild(wrapper);
        }
      } else if (f.key === 'endDate') {
        const dateText = row[f.key] || '';
        const badge = getDDayBadge(row.endDate);
        td.innerHTML = `${dateText} ${badge}`;
        td.style.cursor = 'pointer';
        td.addEventListener('click', () => startEdit(td, row, f));
      } else {
        td.textContent = row[f.key] ?? '';
        td.style.cursor = 'pointer';
        td.addEventListener('click', () => startEdit(td, row, f));
      }
      tr.appendChild(td);
    });
    
    tbody.appendChild(tr);
  });
  
  const countEl = $('#countInfo');
  if(countEl) countEl.textContent = `${filtered.length}건`;
  
  const chkAll = $('#chkAll');
  if (chkAll) {
    // 초기 상태 설정: 현재 페이지의 모든 항목이 선택되어 있는지 확인
    const allSelected = pageRows.length > 0 && pageRows.every(row => state.selected.has(row.id));
    chkAll.checked = allSelected;
    
    chkAll.addEventListener('change', () => {
      // 현재 페이지의 모든 체크박스 요소 가져오기
      const checkboxes = tbody.querySelectorAll('input[type="checkbox"]');
      
      checkboxes.forEach((cb, index) => {
        const row = pageRows[index];
        if (row) {
          cb.checked = chkAll.checked;
          if (chkAll.checked) {
            state.selected.add(row.id);
          } else {
            state.selected.delete(row.id);
          }
        }
      });
      
      updateBulkEditBar();
    });
  }
  
  updateBulkEditBar();
  renderKpis();
  
  const p = $('#pagination');
  if(!p) return;
  p.innerHTML = '';
  if (pages <= 1) return;
  
  const prev = document.createElement('button');
  prev.className = 'page-btn';
  prev.textContent = '‹';
  prev.disabled = currentPage === 1;
  prev.addEventListener('click', () => {
    state.pagination.currentPage--;
    renderTable();
  });
  p.appendChild(prev);
  
  let s = Math.max(1, currentPage - 3);
  let e = Math.min(pages, s + 6);
  
  for (let i = s; i <= e; i++) {
    const btn = document.createElement('button');
    btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
    btn.textContent = i;
    btn.addEventListener('click', () => {
      state.pagination.currentPage = i;
      renderTable();
    });
    p.appendChild(btn);
  }
  
  const next = document.createElement('button');
  next.className = 'page-btn';
  next.textContent = '›';
  next.disabled = currentPage === pages;
  next.addEventListener('click', () => {
    state.pagination.currentPage++;
    renderTable();
  });
  p.appendChild(next);
  
}


function updateBulkEditBar() {
  const count = state.selected.size;
  const countEl = $('#selectedCount');
  if(countEl) countEl.textContent = `${count}개 선택`;
  
  const barEl = $('#bulkEditBar');
  if(barEl) barEl.classList.toggle('active', count > 0);
}

function cloneSelected() {
  if (!state.selected.size) {
    alert('복제할 항목을 선택해주세요.');
    return;
  }
  
  if (!confirm(`선택한 ${state.selected.size}개 항목을 복제하시겠습니까?`)) {
    return;
  }
  
  const config = CONFIGS[state.currentType];
  const selectedRows = state.rows[state.currentType].filter(r => state.selected.has(r.id));
  
  selectedRows.forEach(row => {
    const clonedData = {...row};
    delete clonedData.id;
    delete clonedData.createdAt;
    
    const newRow = mk(clonedData, config);
    state.rows[state.currentType].unshift(newRow);
    saveData(newRow, state.currentType);
  });
  
  state.selected.clear();
  render();
  alert(`${selectedRows.length}개 항목이 복제되었습니다.`);
}

function openReportModal() {
  if (!state.selected.size) {
    alert('리포트를 생성할 항목을 선택해주세요.');
    return;
  }
  
  const config = CONFIGS[state.currentType];
  const selectedRows = state.rows[state.currentType].filter(r => state.selected.has(r.id));
  
  let reportText = `📊 ${config.name} 리포트\n`;
  reportText += `생성일시: ${new Date().toLocaleString('ko-KR')}\n`;
  reportText += `총 ${selectedRows.length}개 업체\n`;
  reportText += `${'='.repeat(50)}\n\n`;
  
  selectedRows.forEach((row, idx) => {
    reportText += `[${idx + 1}] ${row.client || '업체명 없음'}\n`;
    
    if (config.path === 'project') {
      if (row.manager) reportText += `담당자: ${row.manager}\n`;
      if (row.platform) reportText += `플랫폼: ${row.platform}\n`;
      if (row.accountName) reportText += `계정명: ${row.accountName}\n`;
      if (row.category) reportText += `카테고리: ${row.category}\n`;
      
      if (row.startDate) {
        reportText += `시작일: ${row.startDate}`;
        if (row.endDate) {
          const dday = getDDay(row.endDate);
          reportText += ` ~ ${row.endDate}`;
          if (dday !== null) {
            if (dday < 0) reportText += ` (종료됨)`;
            else if (dday === 0) reportText += ` (⚠️ 오늘 종료)`;
            else if (dday <= 3) reportText += ` (⏰ ${dday}일 남음)`;
          }
          reportText += ` (${row.days || 0}일)`;
        }
        reportText += `\n`;
      }
      
      if (row.dailyCost) reportText += `하루비용: ${fmtMoney(row.dailyCost)}\n`;
      if (row.totalSpent) reportText += `💰 총 지출비: ${fmtMoney(row.totalSpent)}\n`;
    } else {
      reportText += `상품: ${row.product || '-'}\n`;
      reportText += `구분: ${row.category || '-'}\n`;
      
      if (row.startDate) {
        reportText += `시작일: ${row.startDate}`;
        if (row.endDate) {
          const dday = getDDay(row.endDate);
          reportText += ` ~ ${row.endDate}`;
          if (dday !== null) {
            if (dday < 0) reportText += ` (종료됨)`;
            else if (dday === 0) reportText += ` (⚠️ 오늘 종료)`;
            else if (dday <= 3) reportText += ` (⏰ ${dday}일 남음)`;
          }
        }
        reportText += `\n`;
      }
      
      if (config.path === 'place') {
        if (row.units || row.days) {
          reportText += `일타: ${row.units || 0} | 일수: ${row.days || 0} | 총량: ${row.totalQty || 0}\n`;
        }
      } else if (config.path === 'blog') {
        if (row.totalQty) {
          reportText += `총량: ${row.totalQty}\n`;
        }
      }
      
      if (row.unitPrice) {
        reportText += `단가: ${fmtMoney(row.unitPrice)}\n`;
      }
      
      if (row.cost) {
        reportText += `💰 작업비: ${fmtMoney(row.cost)}\n`;
      }
      
      if (row.tax) {
        reportText += `세금계산서: ${row.tax}\n`;
      }
      
      if (row.keywords) {
        reportText += `키워드: ${row.keywords}\n`;
      }
    }
    
    if (row.note || row.clientMemo) {
      reportText += `메모: ${row.note || row.clientMemo || ''}\n`;
    }
    
    reportText += `${'-'.repeat(50)}\n`;
  });
  
  let totalCost = 0;
  let totalQty = 0;
  
  if (config.path === 'project') {
    totalCost = selectedRows.reduce((sum, row) => sum + (row.totalSpent || 0), 0);
    const totalDays = selectedRows.reduce((sum, row) => sum + (row.days || 0), 0);
    
    reportText += `\n📈 요약 정보\n`;
    reportText += `${'='.repeat(50)}\n`;
    reportText += `총 업체 수: ${selectedRows.length}개\n`;
    reportText += `총 진행일수: ${totalDays}일\n`;
    reportText += `총 지출비: ${fmtMoney(totalCost)}\n`;
  } else {
    totalCost = selectedRows.reduce((sum, row) => sum + (row.cost || 0), 0);
    totalQty = selectedRows.reduce((sum, row) => sum + (row.totalQty || 0), 0);
    
    reportText += `\n📈 요약 정보\n`;
    reportText += `${'='.repeat(50)}\n`;
    reportText += `총 업체 수: ${selectedRows.length}개\n`;
    reportText += `총 작업량: ${totalQty.toLocaleString('ko-KR')}\n`;
    reportText += `총 작업비: ${fmtMoney(totalCost)}\n`;
    reportText += `평균 단가: ${fmtMoney(totalQty > 0 ? totalCost / totalQty : 0)}\n`;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal-back active';
  
  const content = document.createElement('div');
  content.className = 'modal';
  content.style.maxWidth = '800px';
  
  content.innerHTML = `
    <div class="mh">
      <strong>📱 리포트 발송 문자</strong>
      <button class="btn small outline" id="closeReportModal">✕ 닫기</button>
    </div>
    <div class="mb">
      <div style="margin-bottom:16px; padding:12px 16px; background:var(--card2); border-radius:8px; border-left:3px solid var(--primary)">
        <div style="font-size:12px; color:var(--muted); margin-bottom:4px">선택된 항목</div>
        <div style="font-weight:700; font-size:16px">${selectedRows.length}개 업체 | 총 작업비 ${fmtMoney(totalCost)}</div>
      </div>
      <div class="report-text" id="reportTextContent">${reportText}</div>
      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:16px">
        <button class="btn outline" id="closeReportBtn">닫기</button>
        <button class="btn success" id="copyReportBtn">📋 복사하기</button>
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  
  const closeModal = () => {
    if(document.body.contains(modal)) document.body.removeChild(modal);
  };
  
  content.querySelector('#closeReportModal').addEventListener('click', closeModal);
  content.querySelector('#closeReportBtn').addEventListener('click', closeModal);
  
  content.querySelector('#copyReportBtn').addEventListener('click', () => {
    navigator.clipboard.writeText(reportText).then(() => {
      const btn = content.querySelector('#copyReportBtn');
      const originalText = btn.textContent;
      btn.textContent = '✅ 복사 완료!';
      btn.style.background = 'var(--green)';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 2000);
    }).catch(() => {
      alert('복사에 실패했습니다. 텍스트를 직접 선택해서 복사해주세요.');
    });
  });
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
}

function openMemoModal(row, type) {
  const modal = document.createElement('div');
  modal.className = 'modal-back active';
  
  const content = document.createElement('div');
  content.className = 'modal';
  content.style.maxWidth = '800px';
  
  const currentMemo = row.clientMemo || '';
  
  content.innerHTML = `
    <div class="mh">
      <strong>📝 업체 상담 내용 메모</strong>
      <button class="btn small outline" id="closeMemoModal">✕ 닫기</button>
    </div>
    <div class="mb">
      <div style="margin-bottom:12px">
        <strong style="color:var(--primary-light)">${row.client || '업체명 없음'}</strong>
        <span style="color:var(--muted); margin-left:8px">${row.product || ''}</span>
      </div>
      <textarea id="memoContent" style="width:100%; min-height:300px; padding:16px; border:2px solid var(--border); border-radius:12px; background:var(--card); color:var(--text); font-size:14px; font-family:inherit; line-height:1.6; resize:vertical">${currentMemo}</textarea>
      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:16px">
        <button class="btn outline" id="cancelMemo">취소</button>
        <button class="btn" id="saveMemo">저장</button>
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  
  const textarea = content.querySelector('#memoContent');
  textarea.focus();
  
  const closeModal = () => {
    if(document.body.contains(modal)) document.body.removeChild(modal);
  };
  
  content.querySelector('#closeMemoModal').addEventListener('click', closeModal);
  content.querySelector('#cancelMemo').addEventListener('click', closeModal);
  
  content.querySelector('#saveMemo').addEventListener('click', () => {
    row.clientMemo = textarea.value;
    saveData(row, type);
    closeModal();
    render();
  });
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
}

function openMonthDetailModal(yearMonth, rows) {
  const [year, month] = yearMonth.split('-');
  const monthRows = rows.filter(r => r.startDate && getYearMonth(r.startDate) === yearMonth);
  
  const config = CONFIGS[state.currentType];
  
  const byCategory = {};
  const byClient = {};
  let totalCost = 0;
  
  monthRows.forEach(r => {
    const category = config.path === 'project' ? (r.platform || '미분류') : (r.product || '미분류');
    const client = r.client || '업체명 없음';
    const cost = config.path === 'project' ? (r.totalSpent || 0) : (r.cost || 0);
    
    byCategory[category] = (byCategory[category] || 0) + cost;
    byClient[client] = (byClient[client] || 0) + cost;
    totalCost += cost;
  });
  
  const categoryData = Object.entries(byCategory).sort((a, b) => b[1] - a[1]);
  const clientData = Object.entries(byClient).sort((a, b) => b[1] - a[1]);
  
  const modal = document.createElement('div');
  modal.className = 'modal-back active';
  
  const content = document.createElement('div');
  content.className = 'modal';
  content.style.maxWidth = '1000px';
  
  const categoryLabel = config.path === 'project' ? '플랫폼별' : '상품별';
  
  const categoryList = categoryData.map(([name, cost]) => {
    const percentage = totalCost > 0 ? ((cost / totalCost) * 100).toFixed(1) : 0;
    return `<div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--card2); border-radius:8px; margin-bottom:8px">
      <div style="flex:1">
        <strong>${name}</strong>
        <div style="font-size:12px; color:var(--muted); margin-top:4px">${percentage}%</div>
      </div>
      <strong style="color:var(--primary-light)">${fmtMoney(cost)}</strong>
    </div>`;
  }).join('');
  
  const clientList = clientData.slice(0, 10).map(([name, cost]) => {
    const percentage = totalCost > 0 ? ((cost / totalCost) * 100).toFixed(1) : 0;
    return `<div style="display:flex; justify-content:space-between; align-items:center; padding:10px; background:var(--card2); border-radius:6px; margin-bottom:6px">
      <span>${name}</span>
      <div style="text-align:right">
        <strong style="color:var(--text)">${fmtMoney(cost)}</strong>
        <div style="font-size:11px; color:var(--muted)">${percentage}%</div>
      </div>
    </div>`;
  }).join('');
  
  const chartId = 'pieChart_' + Math.random().toString(36).slice(2, 9);
  const costLabel = config.path === 'project' ? '지출비' : '작업비';
  
  content.innerHTML = `
    <div class="mh">
      <strong>📊 ${year}년 ${month}월 ${costLabel} 상세</strong>
      <button class="btn small outline" id="closeMonthModal">✕ 닫기</button>
    </div>
    <div class="mb">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:24px">
        <div class="kpi" style="grid-column:1/-1">
          <div class="muted">총 ${costLabel}</div>
          <div class="v">${fmtMoney(totalCost)}</div>
        </div>
      </div>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px">
        <div>
          <div style="font-weight:700; margin-bottom:16px; color:var(--primary-light)">📈 ${categoryLabel} ${costLabel}</div>
          <canvas id="${chartId}" width="400" height="300" style="max-height:300px; margin-bottom:20px"></canvas>
        </div>
        
        <div>
          <div style="font-weight:700; margin-bottom:16px; color:var(--primary-light)">🏢 업체별 ${costLabel} TOP 10</div>
          <div style="max-height:400px; overflow-y:auto">${clientList}</div>
        </div>
      </div>
      
      <div class="sep"></div>
      
      <div>
        <div style="font-weight:700; margin-bottom:16px; color:var(--primary-light)">📦 ${categoryLabel} 상세</div>
        ${categoryList}
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  
  const canvas = document.getElementById(chartId);
  if(canvas) {
    const ctx = canvas.getContext('2d');
    
    const colors = [
      '#6366f1', '#8b5cf6', '#ec4899', '#f43f5e', '#f59e0b',
      '#10b981', '#14b8a6', '#06b6d4', '#3b82f6', '#6366f1'
    ];
    
    drawPieChart(ctx, categoryData, colors, canvas.width, canvas.height);
  }
  
  const closeModal = () => {
    if(document.body.contains(modal)) document.body.removeChild(modal);
  };
  
  content.querySelector('#closeMonthModal').addEventListener('click', closeModal);
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
}

function drawPieChart(ctx, data, colors, width, height) {
  const total = data.reduce((sum, [_, value]) => sum + value, 0);
  if (total === 0) return;
  
  const centerX = width / 2;
  const centerY = height / 2;
  const radius = Math.min(width, height) / 2 - 20;
  
  let currentAngle = -Math.PI / 2;
  
  data.forEach(([label, value], index) => {
    const sliceAngle = (value / total) * 2 * Math.PI;
    
    ctx.fillStyle = colors[index % colors.length];
    ctx.beginPath();
    ctx.moveTo(centerX, centerY);
    ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
    ctx.closePath();
    ctx.fill();
    
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;
    ctx.stroke();
    
    const midAngle = currentAngle + sliceAngle / 2;
    const labelX = centerX + Math.cos(midAngle) * (radius * 0.7);
    const labelY = centerY + Math.sin(midAngle) * (radius * 0.7);
    
    const percentage = ((value / total) * 100).toFixed(1);
    if (percentage > 5) {
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 12px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(`${percentage}%`, labelX, labelY);
    }
    
    currentAngle += sliceAngle;
  });
}

function drawLineChart(ctx, labels, data, width, height) {
  const padding = 60;
  const chartWidth = width - padding * 2;
  const chartHeight = height - padding * 2;
  
  ctx.clearRect(0, 0, width, height);
  
  const maxValue = Math.max(...data, 1);
  const minValue = 0;
  const range = maxValue - minValue;
  
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  ctx.fillStyle = isDark ? '#16213e' : '#f8fafc';
  ctx.fillRect(0, 0, width, height);
  
  ctx.strokeStyle = isDark ? '#2a3551' : '#e2e8f0';
  ctx.lineWidth = 1;
  
  for (let i = 0; i <= 5; i++) {
    const y = padding + (chartHeight / 5) * i;
    ctx.beginPath();
    ctx.moveTo(padding, y);
    ctx.lineTo(width - padding, y);
    ctx.stroke();
    
    const value = maxValue - (range / 5) * i;
    ctx.fillStyle = isDark ? '#8b94a8' : '#64748b';
    ctx.font = '12px Arial';
    ctx.textAlign = 'right';
    ctx.fillText(fmtMoney(value), padding - 10, y + 4);
  }
  
  if (data.length > 0) {
    ctx.beginPath();
    ctx.strokeStyle = '#6366f1';
    ctx.lineWidth = 3;
    
    data.forEach((value, index) => {
      const x = padding + (chartWidth / (data.length - 1 || 1)) * index;
      const y = padding + chartHeight - ((value - minValue) / range) * chartHeight;
      
      if (index === 0) {
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
      }
    });
    
    ctx.stroke();
    
    data.forEach((value, index) => {
      const x = padding + (chartWidth / (data.length - 1 || 1)) * index;
      const y = padding + chartHeight - ((value - minValue) / range) * chartHeight;
      
      ctx.beginPath();
      ctx.arc(x, y, 5, 0, Math.PI * 2);
      ctx.fillStyle = '#6366f1';
      ctx.fill();
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.stroke();
      
      ctx.fillStyle = isDark ? '#e4e8f0' : '#1e293b';
      ctx.font = 'bold 12px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(fmtMoney(value), x, y - 15);
    });
  }
  
  labels.forEach((label, index) => {
    const x = padding + (chartWidth / (labels.length - 1 || 1)) * index;
    const [year, month] = label.split('-');
    ctx.fillStyle = isDark ? '#8b94a8' : '#64748b';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(`${month}월`, x, height - padding + 20);
  });
}

function openBulkEditModal() {
  if (!state.selected.size) return;
  
  const config = CONFIGS[state.currentType];
  const selectedRows = state.rows[state.currentType].filter(r => state.selected.has(r.id));
  
  const modal = document.createElement('div');
  modal.className = 'modal-back active';
  
  const content = document.createElement('div');
  content.className = 'modal';
  
  const selectedList = selectedRows.map(row => 
    `<div style="padding:8px; background:var(--card2); border-radius:6px; margin-bottom:4px">
      <strong>${row.client || '업체명 없음'}</strong>
      <span style="color:var(--muted); font-size:12px"> - ${row.product || ''}</span>
    </div>`
  ).join('');
  
  let formFields = '';
  config.fields.forEach(f => {
    if (f.type === 'computed') return;
    
    const full = ['client', 'keywords', 'note'].includes(f.key) ? ' style="grid-column:1/-1"' : '';
    
    formFields += `<div${full}><label>${f.label}</label>`;
    
    if (f.type === 'select') {
      formFields += `<select id="bulk_${f.key}"><option value="">변경 안함</option>`;
      f.options.forEach(o => formFields += `<option value="${o}">${o}</option>`);
      formFields += '</select>';
    } else {
      const t = f.type === 'number' ? 'number' : f.type === 'url' ? 'url' : f.type === 'date' ? 'date' : 'text';
      formFields += `<input id="bulk_${f.key}" type="${t}" placeholder="변경 안함"${f.type === 'number' ? ' step="any"' : ''}>`;
    }
    formFields += '</div>';
  });
  
  content.innerHTML = `
    <div class="mh">
      <strong>일괄 수정 (${state.selected.size}개 항목)</strong>
      <button class="btn small outline" id="closeBulkModal">✕ 닫기</button>
    </div>
    <div class="mb">
      <div style="margin-bottom:20px; padding:16px; background:var(--card2); border-radius:12px; max-height:200px; overflow-y:auto">
        <div style="font-weight:600; margin-bottom:12px; color:var(--primary-light)">선택된 항목:</div>
        ${selectedList}
      </div>
      
      <div class="form-grid">
        ${formFields}
        <div style="grid-column:1/-1; display:flex; gap:12px; justify-content:flex-end; margin-top:8px">
          <button class="btn outline" id="cancelBulk">취소</button>
          <button class="btn" id="confirmBulk">적용</button>
        </div>
      </div>
    </div>
  `;
  
  modal.appendChild(content);
  document.body.appendChild(modal);
  
  const closeModal = () => {
    if(document.body.contains(modal)) document.body.removeChild(modal);
  };
  
  content.querySelector('#closeBulkModal').addEventListener('click', closeModal);
  content.querySelector('#cancelBulk').addEventListener('click', closeModal);
  
  content.querySelector('#confirmBulk').addEventListener('click', () => {
    const updates = {};
    config.fields.forEach(f => {
      if (f.type === 'computed') return;
      const el = content.querySelector(`#bulk_${f.key}`);
      if (el && el.value) {
        updates[f.key] = f.type === 'number' ? parseNum(el.value) : el.value;
      }
    });
    
    selectedRows.forEach(row => {
      Object.keys(updates).forEach(key => {
        if (updates[key] !== null && updates[key] !== '') {
          row[key] = updates[key];
        }
      });
      
      const config = CONFIGS[state.currentType];
      
      if (config.path === 'place') {
        if (row.units !== undefined && row.days !== undefined) {
          row.totalQty = (row.units||0) * (row.days||0);
        }
        if (row.totalQty !== undefined && row.unitPrice !== undefined) {
          row.cost = (row.totalQty||0) * (row.unitPrice||0);
        }
      } else if (config.path === 'blog') {
        if (row.totalQty !== undefined && row.unitPrice !== undefined) {
          row.cost = (row.totalQty||0) * (row.unitPrice||0);
        }
      } else if (config.path === 'project') {
        if (row.startDate && row.endDate) {
          const start = new Date(row.startDate);
          const end = new Date(row.endDate);
          const diffTime = Math.abs(end - start);
          row.days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
        } else {
          row.days = 0;
        }
        row.totalSpent = (row.dailyCost || 0) * (row.days || 0);
      }
      
      saveData(row, state.currentType);
    });
    
    closeModal();
    render();
  });
  
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
}

function startEdit(td, row, field) {
  const old = row[field.key] ?? '';
  let el;
  
  if (field.type === 'select') {
    el = document.createElement('select');
    el.innerHTML = field.options.map(v => `<option>${v}</option>`).join('');
    el.value = old;
  } else {
    el = document.createElement('input');
    el.type = field.type === 'number' ? 'number' : field.type === 'date' ? 'date' : 'text';
    el.value = old;
    if (field.type === 'number') el.step = 'any';
  }
  
  el.style.width = '100%';
  td.innerHTML = '';
  td.appendChild(el);
  el.focus();
  
  const commit = () => {
    let v = el.value;
    if (field.type === 'number') v = parseNum(v);
    row[field.key] = v !== null ? v : '';
    
    const config = CONFIGS[state.currentType];
    
    if (config.path === 'place') {
      if (row.units !== undefined && row.days !== undefined) {
        row.totalQty = (row.units||0) * (row.days||0);
      }
      if (row.totalQty !== undefined && row.unitPrice !== undefined) {
        row.cost = (row.totalQty||0) * (row.unitPrice||0);
      }
    } else if (config.path === 'blog') {
      if (row.totalQty !== undefined && row.unitPrice !== undefined) {
        row.cost = (row.totalQty||0) * (row.unitPrice||0);
      }
    } else if (config.path === 'project') {
      if (row.startDate && row.endDate) {
        const start = new Date(row.startDate);
        const end = new Date(row.endDate);
        const diffTime = Math.abs(end - start);
        row.days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
      } else {
        row.days = 0;
      }
      row.totalSpent = (row.dailyCost || 0) * (row.days || 0);
    }
    
    saveData(row, state.currentType);
    render();
  };
  
  el.addEventListener('keydown', e => {
    if (e.key === 'Enter') { e.preventDefault(); commit(); }
    else if (e.key === 'Escape') { e.preventDefault(); render(); }
  });
  el.addEventListener('blur', commit);
}

function renderKpis() {
  const rows = applyFilters(state.rows[state.currentType]);
  const cnt = rows.length;
  
  let qty = 0;
  let cost = 0;
  
  const config = CONFIGS[state.currentType];
  
  if (config.path === 'project') {
    cost = rows.reduce((s, r) => s + (r.totalSpent || 0), 0);
    const avgDailyCost = cnt > 0 ? cost / cnt : 0;
    
    const countEl = $('#kpiCount');
    const qtyEl = $('#kpiQty');
    const qtyLabelEl = $('#kpiQtyLabel');
    const costEl = $('#kpiCost');
    const costLabelEl = $('#kpiCostLabel');
    const avgEl = $('#kpiAvg');
    const avgLabelEl = $('#kpiAvgLabel');
    
    if(countEl) countEl.textContent = cnt.toLocaleString('ko-KR');
    if(qtyEl) {
      const totalDays = rows.reduce((s, r) => s + (r.days || 0), 0);
      qtyEl.textContent = totalDays.toLocaleString('ko-KR');
    }
    if(qtyLabelEl) qtyLabelEl.textContent = '총 진행일수';
    if(costEl) costEl.textContent = fmtMoney(cost);
    if(costLabelEl) costLabelEl.textContent = '총 지출비';
    if(avgEl) {
      avgEl.textContent = fmtMoney(avgDailyCost);
      avgEl.style.color = '';
    }
    if(avgLabelEl) avgLabelEl.textContent = '평균 프로젝트 지출';
  } else {
    qty = rows.reduce((s, r) => s + (r.totalQty || 0), 0);
    cost = rows.reduce((s, r) => s + (r.cost || 0), 0);
    
    const countEl = $('#kpiCount');
    const qtyEl = $('#kpiQty');
    const qtyLabelEl = $('#kpiQtyLabel');
    const costEl = $('#kpiCost');
    const costLabelEl = $('#kpiCostLabel');
    const avgEl = $('#kpiAvg');
    const avgLabelEl = $('#kpiAvgLabel');
    
    if(countEl) countEl.textContent = cnt.toLocaleString('ko-KR');
    if(qtyEl) qtyEl.textContent = qty.toLocaleString('ko-KR');
    if(qtyLabelEl) qtyLabelEl.textContent = '총 작업량';
    if(costEl) costEl.textContent = fmtMoney(cost);
    if(costLabelEl) costLabelEl.textContent = '총 작업비';
    if(avgEl) {
      avgEl.textContent = fmtMoney(qty > 0 ? cost / qty : 0);
      avgEl.style.color = '';
    }
    if(avgLabelEl) avgLabelEl.textContent = '평균 단가';
  }
  
  const byP = {};
  rows.forEach(r => {
    const p = r.client || '미분류';
    const c = config.path === 'project' ? (r.totalSpent || 0) : (r.cost || 0);
    byP[p] = (byP[p] || 0) + c;
  });
  const pData = Object.entries(byP).map(([p, c]) => ({label: p, value: c})).sort((a, b) => b.value - a.value);
  
  const bars = $('#barsByProduct');
  if(bars) {
    bars.innerHTML = '';
    const max = Math.max(1, ...pData.map(d => d.value));
    
    pData.forEach(d => {
      const col = document.createElement('div');
      col.className = 'col';
      const bar = document.createElement('div');
      bar.className = 'bar';
      bar.style.height = Math.round(d.value / max * 100) + '%';
      const val = document.createElement('div');
      val.className = 'bar-value';
      val.textContent = fmtMoney(d.value);
      const lab = document.createElement('div');
      lab.className = 'note';
      lab.textContent = d.label.length > 10 ? d.label.substring(0, 10) + '...' : d.label;
      col.append(bar, val, lab);
      bars.appendChild(col);
    });
  }
  
  const costLabel = config.path === 'project' ? '지출비' : '작업비';
  const barTitleEl = $('#barChartTitle');
  if(barTitleEl) barTitleEl.textContent = `📈 업체별 총 ${costLabel}`;
  
  const byM = {};
  rows.forEach(r => {
    if (!r.startDate) return;
    const ym = getYearMonth(r.startDate);
    const c = config.path === 'project' ? (r.totalSpent || 0) : (r.cost || 0);
    byM[ym] = (byM[ym] || 0) + c;
  });
  const mData = Object.entries(byM).sort((a, b) => b[0].localeCompare(a[0]));
  const mc = $('#monthlyCost');
  if(mc) {
    mc.innerHTML = mData.map(([ym, c]) => {
      const [y, m] = ym.split('-');
      return `<div class="month-item" data-month="${ym}"><span>${y}년 ${m}월: <strong>${fmtMoney(c)}</strong></span></div>`;
    }).join('') || '<div class="muted">데이터 없음</div>';
    
    mc.querySelectorAll('.month-item').forEach(item => {
      item.addEventListener('click', () => {
        const selectedMonth = item.dataset.month;
        openMonthDetailModal(selectedMonth, rows);
      });
    });
  }
  
  const monthTitleEl = $('#monthChartTitle');
  if(monthTitleEl) monthTitleEl.textContent = `💰 월 총 ${costLabel}`;
}

function renderFinance() {
  renderFinanceTable('place');
  renderFinanceTable('blog');
  renderFinanceTable('project');
  calculateFinanceSummary();
  renderMonthlyRevenueChart();
  setupFinanceCheckboxes();
  setupFinanceEventListeners();
}

function renderFinanceTable(type) {
  const tbody = $(`#fin${type.charAt(0).toUpperCase() + type.slice(1)}`);
  if (!tbody) return;
  
  const allRows = getFilteredFinanceRows(type);
  const pagination = state.financePagination[type];
  const { currentPage, perPage } = pagination;
  
  // 페이지네이션 적용
  const totalPages = Math.ceil(allRows.length / perPage);
  const startIdx = (currentPage - 1) * perPage;
  const endIdx = startIdx + perPage;
  const rows = allRows.slice(startIdx, endIdx);
  
  // 업체 갯수 표시 업데이트
  const countEl = $(`#fin${type.charAt(0).toUpperCase() + type.slice(1)}Count`);
  if (countEl) {
    countEl.textContent = `(${allRows.length}개 업체)`;
    countEl.style.color = 'var(--primary-light)';
    countEl.style.fontSize = '14px';
    countEl.style.fontWeight = '600';
  }
  
  // 페이지네이션 영역의 업체 갯수도 업데이트
  const totalCountEl = $(`#fin${type.charAt(0).toUpperCase() + type.slice(1)}TotalCount`);
  if (totalCountEl) {
    totalCountEl.textContent = allRows.length;
  }
  
  tbody.innerHTML = '';
  
  rows.forEach((row, rowIndex) => {
    const profitClass = (row.profit || 0) >= 0 ? 'positive' : 'negative';
    
    // 작업기간에서 종료일 추출
    let endDate = null;
    let periodDisplay = row.period || '';
    let ddayBadge = '';
    let rowClass = '';
    let periodClass = '';
    
    if (row.period && row.period.includes('~')) {
      const parts = row.period.split('~');
      endDate = parts[1]?.trim();
      
      if (endDate) {
        ddayBadge = getDDayBadge(endDate);
        rowClass = getRowClass(endDate);
        
        const dday = getDDay(endDate);
        if (dday !== null && dday <= 1) {
          periodClass = dday === 0 || dday < 0 ? 'deadline-cell urgent' : 'deadline-cell warning';
        }
      }
    }
    
    const tr = document.createElement('tr');
    if (rowClass) tr.className = rowClass;
    
    // 드래그 가능 설정
    tr.draggable = true;
    tr.dataset.rowId = row.id;
    tr.dataset.rowIndex = rowIndex;
    tr.dataset.type = type;
    
    // 순이익율 계산
    const profitRate = (row.revenue && row.revenue !== 0) ? ((row.profit || 0) / row.revenue * 100).toFixed(1) : '0.0';
    
    tr.innerHTML = `
      <td class="center" style="width:40px"><span class="drag-handle">☰</span></td>
      <td class="center"><input type="checkbox" class="fin-check" data-type="${type}" data-id="${row.id}"></td>
      <td class="fin-cell center" data-type="${type}" data-id="${row.id}" data-field="month">${row.month || ''}</td>
      <td class="fin-cell center" data-type="${type}" data-id="${row.id}" data-field="manager">${row.manager || ''}</td>
      <td class="fin-cell nowrap" data-type="${type}" data-id="${row.id}" data-field="client">${row.client || ''}</td>
      <td class="fin-cell" data-type="${type}" data-id="${row.id}" data-field="owner">${row.owner || ''}</td>
      <td class="fin-cell num revenue-cell" data-type="${type}" data-id="${row.id}" data-field="revenue">${fmtMoney(row.revenue || 0)}</td>
      <td class="fin-cell center" data-type="${type}" data-id="${row.id}" data-field="paid">${row.paid || '미입금'}</td>
      <td class="fin-cell ${periodClass}" data-type="${type}" data-id="${row.id}" data-field="period">${periodDisplay}${ddayBadge}</td>
      <td class="fin-cell num cost-cell" data-type="${type}" data-id="${row.id}" data-field="cost">${fmtMoney(row.cost || 0)}</td>
      <td class="fin-cell num profit-cell ${profitClass}" data-type="${type}" data-id="${row.id}" data-field="profit">${fmtMoney(row.profit || 0)}</td>
      <td class="fin-cell num rate-cell" data-type="${type}" data-id="${row.id}" data-field="profitRate">${profitRate}%</td>
      <td class="center"><select class="contract-status-select" data-type="${type}" data-id="${row.id}" style="padding:8px 12px; font-size:13px; border-radius:8px; border:2px solid var(--border); background:var(--card); color:var(--text); cursor:pointer">
        <option value="진행중" ${(row.contractStatus || '진행중') === '진행중' ? 'selected' : ''}>진행중</option>
        <option value="대기중" ${(row.contractStatus || '') === '대기중' ? 'selected' : ''}>대기중</option>
        <option value="계약종료" ${(row.contractStatus || '') === '계약종료' ? 'selected' : ''}>계약종료</option>
      </select></td>
      <td class="fin-cell center" data-type="${type}" data-id="${row.id}" data-field="memo" title="${row.memo || '클릭하여 메모 작성'}" style="cursor:pointer; font-size:18px">
        ${row.memo ? '📝' : '➕'}
      </td>
      <td class="fin-cell center" data-type="${type}" data-id="${row.id}" data-field="tax">${row.tax || '미발행'}</td>
    `;
    tbody.appendChild(tr);
  });
  
  tbody.querySelectorAll('.fin-check').forEach(cb => {
    cb.addEventListener('change', () => {
      const key = `${cb.dataset.type}_${cb.dataset.id}`;
      if (cb.checked) {
        state.finSelected.add(key);
      } else {
        state.finSelected.delete(key);
      }
      
      // 전체 선택 체크박스 상태 업데이트
      const checkAllId = `chkAllFin${type.charAt(0).toUpperCase() + type.slice(1)}`;
      const chkAll = $(`#${checkAllId}`);
      if (chkAll) {
        const allCheckboxes = tbody.querySelectorAll('.fin-check');
        const allChecked = Array.from(allCheckboxes).every(checkbox => checkbox.checked);
        chkAll.checked = allChecked;
      }
      
      updateFinBulkEditBar();
    });
  });
  
  tbody.querySelectorAll('.fin-cell').forEach(cell => {
    cell.addEventListener('click', () => {
      startFinEdit(cell, cell.dataset.type, cell.dataset.id, cell.dataset.field);
    });
  });
  
  // 계약 상태 select 이벤트 리스너
  tbody.querySelectorAll('.contract-status-select').forEach(select => {
    select.addEventListener('change', (e) => {
      const type = select.dataset.type;
      const id = select.dataset.id;
      const newStatus = e.target.value;
      
      const row = state.financeData[type].find(r => r.id === id);
      if (row) {
        row.contractStatus = newStatus;
        if (state.useFirebase && state.isFirebaseConnected) {
          saveFinanceData(row, type);
        }
      }
    });
  });
  
  // 드래그 앤 드롭 이벤트 핸들러 추가
  setupFinanceDragAndDrop(type);
  
  // 페이지네이션 렌더링
  renderFinancePagination(type, allRows.length);
}

function setupFinanceDragAndDrop(type) {
  const tbody = $(`#fin${type.charAt(0).toUpperCase() + type.slice(1)}`);
  if (!tbody) return;
  
  let draggedRow = null;
  let draggedData = null;
  
  tbody.querySelectorAll('tr[draggable="true"]').forEach(tr => {
    tr.addEventListener('dragstart', (e) => {
      draggedRow = tr;
      const rowType = tr.dataset.type;
      const rowId = tr.dataset.rowId;
      draggedData = state.financeData[rowType].find(r => r.id === rowId);
      tr.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    
    tr.addEventListener('dragend', (e) => {
      tr.classList.remove('dragging');
      tbody.querySelectorAll('tr').forEach(row => row.classList.remove('drag-over'));
    });
    
    tr.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      const targetRow = e.currentTarget;
      if (draggedRow && targetRow !== draggedRow) {
        tbody.querySelectorAll('tr').forEach(row => row.classList.remove('drag-over'));
        targetRow.classList.add('drag-over');
      }
    });
    
    tr.addEventListener('dragleave', (e) => {
      const targetRow = e.currentTarget;
      targetRow.classList.remove('drag-over');
    });
    
    tr.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const targetRow = e.currentTarget;
      targetRow.classList.remove('drag-over');
      
      if (draggedRow && targetRow !== draggedRow && draggedData) {
        const targetType = targetRow.dataset.type;
        const targetId = targetRow.dataset.rowId;
        const targetData = state.financeData[targetType].find(r => r.id === targetId);
        
        if (targetData && targetType === type) {
          // 배열에서 원본 위치 찾기
          const rows = state.financeData[type];
          const draggedIndex = rows.findIndex(r => r.id === draggedData.id);
          const targetIndex = rows.findIndex(r => r.id === targetData.id);
          
          if (draggedIndex === -1 || targetIndex === -1) return;
          
          // 배열 순서 변경 - 올바른 방법
          // 1. 드래그된 항목 제거
          const [removed] = rows.splice(draggedIndex, 1);
          
          // 2. 타겟 위치에 삽입
          // draggedIndex가 targetIndex보다 작으면, 제거 후 targetIndex가 1 감소함
          const insertIndex = draggedIndex < targetIndex ? targetIndex : targetIndex;
          rows.splice(insertIndex, 0, removed);
          
          // Firebase에 순서 정보 저장
          rows.forEach((row, index) => {
            row.order = index;
            if (state.useFirebase && state.isFirebaseConnected) {
              saveFinanceData(row, type);
            }
          });
          
          renderFinance();
        }
      }
    });
  });
}

function getFilteredFinanceRows(type) {
  const rows = state.financeData[type] || [];
  const filters = {
    searchClient: $('#finSearchClient')?.value || '',
    filterManager: $('#finFilterManager')?.value || '',
    filterType: $('#finFilterType')?.value || '',
    filterYear: $('#finFilterYear')?.value || '',
    selectedMonth: $('#financeMonth')?.value || '',
    contractStatus: $('#contractStatus')?.value || '',
    sortOrder: $('#finSortOrder')?.value || 'order_asc'
  };
  
  let filtered = rows.slice();
  
  if (filters.searchClient) {
    filtered = filtered.filter(r => (r.client || '').includes(filters.searchClient));
  }
  
  if (filters.filterManager) {
    filtered = filtered.filter(r => r.manager === filters.filterManager);
  }
  
  if (filters.filterType && filters.filterType !== type) {
    return [];
  }
  
  if (filters.filterYear) {
    filtered = filtered.filter(r => (r.month || '').startsWith(filters.filterYear));
  }
  
  if (filters.contractStatus) {
    filtered = filtered.filter(r => (r.contractStatus || '진행중') === filters.contractStatus);
  }
  
  if (filters.selectedMonth) {
    const monthNum = filters.selectedMonth.replace('월', '');
    filtered = filtered.filter(r => {
      if (!r.month) return false;
      const [y, m] = r.month.split('-');
      return parseInt(m) === parseInt(monthNum);
    });
  }
  
  // 정렬
  if (filters.sortOrder === 'order_asc') {
    // 등록순 (order 필드 기준)
    filtered.sort((a, b) => {
      const orderA = typeof a.order === 'number' ? a.order : 9999;
      const orderB = typeof b.order === 'number' ? b.order : 9999;
      return orderA - orderB;
    });
  } else if (filters.sortOrder === 'created_desc') {
    filtered.sort((a, b) => (b.month || '').localeCompare(a.month || ''));
  } else if (filters.sortOrder === 'created_asc') {
    filtered.sort((a, b) => (a.month || '').localeCompare(b.month || ''));
  } else if (filters.sortOrder === 'startdate_desc') {
    filtered.sort((a, b) => {
      const getStartDate = (row) => {
        if (!row.period || !row.period.includes('~')) return '';
        return row.period.split('~')[0]?.trim() || '';
      };
      return (getStartDate(b) || '').localeCompare(getStartDate(a) || '');
    });
  } else if (filters.sortOrder === 'startdate_asc') {
    filtered.sort((a, b) => {
      const getStartDate = (row) => {
        if (!row.period || !row.period.includes('~')) return '';
        return row.period.split('~')[0]?.trim() || '';
      };
      return (getStartDate(a) || '').localeCompare(getStartDate(b) || '');
    });
  } else if (filters.sortOrder === 'enddate_desc') {
    filtered.sort((a, b) => {
      const getEndDate = (row) => {
        if (!row.period || !row.period.includes('~')) return '';
        return row.period.split('~')[1]?.trim() || '';
      };
      return (getEndDate(b) || '').localeCompare(getEndDate(a) || '');
    });
  } else if (filters.sortOrder === 'enddate_asc') {
    filtered.sort((a, b) => {
      const getEndDate = (row) => {
        if (!row.period || !row.period.includes('~')) return '';
        return row.period.split('~')[1]?.trim() || '';
      };
      return (getEndDate(a) || '').localeCompare(getEndDate(b) || '');
    });
  } else if (filters.sortOrder === 'revenue_desc') {
    filtered.sort((a, b) => (b.revenue || 0) - (a.revenue || 0));
  } else if (filters.sortOrder === 'revenue_asc') {
    filtered.sort((a, b) => (a.revenue || 0) - (b.revenue || 0));
  } else if (filters.sortOrder === 'profit_desc') {
    filtered.sort((a, b) => (b.profit || 0) - (a.profit || 0));
  } else if (filters.sortOrder === 'profit_asc') {
    filtered.sort((a, b) => (a.profit || 0) - (b.profit || 0));
  }
  
  return filtered;
}

function calculateFinanceSummary() {
  let totalRevenue = 0;
  let totalCost = 0;
  let totalProfit = 0;
  let totalCompanies = 0;
  
  ['place', 'blog', 'project'].forEach(type => {
    const rows = getFilteredFinanceRows(type);
    totalCompanies += rows.length;
    rows.forEach(row => {
      totalRevenue += row.revenue || 0;
      totalCost += row.cost || 0;
      totalProfit += row.profit || 0;
    });
  });
  
  const revenueEl = $('#totalRevenue');
  const costEl = $('#totalCost');
  const profitEl = $('#totalProfit');
  const companyCountEl = $('#totalCompanyCount');
  
  if (revenueEl) revenueEl.textContent = fmtMoney(totalRevenue);
  if (costEl) costEl.textContent = fmtMoney(totalCost);
  if (profitEl) profitEl.textContent = fmtMoney(totalProfit);
  if (companyCountEl) {
    companyCountEl.textContent = `(총 ${totalCompanies}개 업체)`;
    companyCountEl.style.color = 'var(--primary-light)';
    companyCountEl.style.fontSize = '14px';
    companyCountEl.style.fontWeight = '600';
  }
}


function renderFinancePagination(type, totalCount) {
  const pagination = state.financePagination[type];
  const { currentPage, perPage } = pagination;
  const totalPages = Math.ceil(totalCount / perPage);
  
  const paginationEl = $(`#fin${type.charAt(0).toUpperCase() + type.slice(1)}Pagination`);
  if (!paginationEl) return;
  
  paginationEl.innerHTML = '';
  
  if (totalPages <= 1) return;
  
  // 이전 버튼
  const prevBtn = document.createElement('button');
  prevBtn.className = 'page-btn';
  prevBtn.textContent = '‹';
  prevBtn.disabled = currentPage === 1;
  prevBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      state.financePagination[type].currentPage--;
      renderFinanceTable(type);
    }
  });
  paginationEl.appendChild(prevBtn);
  
  // 페이지 번호 버튼
  let startPage = Math.max(1, currentPage - 3);
  let endPage = Math.min(totalPages, startPage + 6);
  
  for (let i = startPage; i <= endPage; i++) {
    const btn = document.createElement('button');
    btn.className = 'page-btn' + (i === currentPage ? ' active' : '');
    btn.textContent = i;
    btn.addEventListener('click', () => {
      state.financePagination[type].currentPage = i;
      renderFinanceTable(type);
    });
    paginationEl.appendChild(btn);
  }
  
  // 다음 버튼
  const nextBtn = document.createElement('button');
  nextBtn.className = 'page-btn';
  nextBtn.textContent = '›';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.addEventListener('click', () => {
    if (currentPage < totalPages) {
      state.financePagination[type].currentPage++;
      renderFinanceTable(type);
    }
  });
  paginationEl.appendChild(nextBtn);
}

function renderMonthlyRevenueChart() {
  const monthlyData = {};
  
  ['place', 'blog', 'project'].forEach(type => {
    const rows = getFilteredFinanceRows(type);
    rows.forEach(row => {
      if (!row.month) return;
      const revenue = parseNum(row.revenue) || 0;
      monthlyData[row.month] = (monthlyData[row.month] || 0) + revenue;
    });
  });
  
  const sortedMonths = Object.keys(monthlyData).sort((a, b) => b.localeCompare(a)).slice(0, 6).reverse();
  const revenues = sortedMonths.map(month => monthlyData[month]);
  
  if (revenues.length >= 2) {
    const current = revenues[revenues.length - 1];
    const previous = revenues[revenues.length - 2];
    const growth = previous > 0 ? ((current - previous) / previous * 100).toFixed(1) : 0;
    const growthEl = $('#revenueGrowth');
    const growthIcon = $('#growthIcon');
    
    if (growthEl) {
      const isPositive = growth >= 0;
      growthEl.textContent = `${growth > 0 ? '+' : ''}${growth}%`;
      growthEl.className = `number ${isPositive ? 'positive' : 'negative'}`;
      
      if (growthIcon) {
        growthIcon.textContent = isPositive ? '📈' : '📉';
        growthIcon.className = `growth-icon ${isPositive ? 'positive' : 'negative'}`;
      }
    }
  }
  
  const canvas = $('#revenueGrowthChart');
  if (canvas && sortedMonths.length > 0) {
    const ctx = canvas.getContext('2d');
    drawLineChart(ctx, sortedMonths, revenues, canvas.width, canvas.height);
  }
}

function setupFinanceCheckboxes() {
  const chkAllPlace = $('#chkAllFinPlace');
  if (chkAllPlace) {
    // 초기 상태 설정
    const placeChecks = document.querySelectorAll('#finPlace .fin-check');
    const allPlaceChecked = placeChecks.length > 0 && Array.from(placeChecks).every(cb => cb.checked);
    chkAllPlace.checked = allPlaceChecked;
    
    chkAllPlace.addEventListener('change', () => {
      const checks = document.querySelectorAll('#finPlace .fin-check');
      checks.forEach(cb => {
        cb.checked = chkAllPlace.checked;
        const key = `${cb.dataset.type}_${cb.dataset.id}`;
        if (chkAllPlace.checked) state.finSelected.add(key);
        else state.finSelected.delete(key);
      });
      updateFinBulkEditBar();
    });
  }
  
  const chkAllBlog = $('#chkAllFinBlog');
  if (chkAllBlog) {
    // 초기 상태 설정
    const blogChecks = document.querySelectorAll('#finBlog .fin-check');
    const allBlogChecked = blogChecks.length > 0 && Array.from(blogChecks).every(cb => cb.checked);
    chkAllBlog.checked = allBlogChecked;
    
    chkAllBlog.addEventListener('change', () => {
      const checks = document.querySelectorAll('#finBlog .fin-check');
      checks.forEach(cb => {
        cb.checked = chkAllBlog.checked;
        const key = `${cb.dataset.type}_${cb.dataset.id}`;
        if (chkAllBlog.checked) state.finSelected.add(key);
        else state.finSelected.delete(key);
      });
      updateFinBulkEditBar();
    });
  }
  
  const chkAllProject = $('#chkAllFinProject');
  if (chkAllProject) {
    // 초기 상태 설정
    const projectChecks = document.querySelectorAll('#finProject .fin-check');
    const allProjectChecked = projectChecks.length > 0 && Array.from(projectChecks).every(cb => cb.checked);
    chkAllProject.checked = allProjectChecked;
    
    chkAllProject.addEventListener('change', () => {
      const checks = document.querySelectorAll('#finProject .fin-check');
      checks.forEach(cb => {
        cb.checked = chkAllProject.checked;
        const key = `${cb.dataset.type}_${cb.dataset.id}`;
        if (chkAllProject.checked) state.finSelected.add(key);
        else state.finSelected.delete(key);
      });
      updateFinBulkEditBar();
    });
  }
}

function setupFinanceEventListeners() {
  const finSearchClient = $('#finSearchClient');
  if (finSearchClient) {
    finSearchClient.removeEventListener('input', handleFinSearchInput);
    finSearchClient.addEventListener('input', handleFinSearchInput);
  }
  
  const finFilterManager = $('#finFilterManager');
  if (finFilterManager) {
    finFilterManager.removeEventListener('change', handleFinFilterChange);
    finFilterManager.addEventListener('change', handleFinFilterChange);
  }
  
  const finFilterType = $('#finFilterType');
  if (finFilterType) {
    finFilterType.removeEventListener('change', handleFinFilterChange);
    finFilterType.addEventListener('change', handleFinFilterChange);
  }
  
  const finFilterYear = $('#finFilterYear');
  if (finFilterYear) {
    finFilterYear.removeEventListener('change', handleFinFilterChange);
    finFilterYear.addEventListener('change', handleFinFilterChange);
  }
  
  const financeMonth = $('#financeMonth');
  if (financeMonth) {
    financeMonth.removeEventListener('change', handleFinFilterChange);
    financeMonth.addEventListener('change', handleFinFilterChange);
  }
  
  const contractStatus = $('#contractStatus');
  if (contractStatus) {
    contractStatus.removeEventListener('change', handleFinFilterChange);
    contractStatus.addEventListener('change', handleFinFilterChange);
  }
  
  const finSortOrder = $('#finSortOrder');
  if (finSortOrder) {
    finSortOrder.removeEventListener('change', handleFinFilterChange);
    finSortOrder.addEventListener('change', handleFinFilterChange);
  }
  
  const finResetBtn = $('#finResetBtn');
  if (finResetBtn) {
    finResetBtn.removeEventListener('click', handleFinReset);
    finResetBtn.addEventListener('click', handleFinReset);
  }

  // 페이지당 표시 개수 변경 이벤트
  const finPlacePerPage = $('#finPlacePerPage');
  if (finPlacePerPage) {
    finPlacePerPage.addEventListener('change', (e) => {
      state.financePagination.place.perPage = parseInt(e.target.value);
      state.financePagination.place.currentPage = 1;
      renderFinanceTable('place');
    });
  }
  
  const finBlogPerPage = $('#finBlogPerPage');
  if (finBlogPerPage) {
    finBlogPerPage.addEventListener('change', (e) => {
      state.financePagination.blog.perPage = parseInt(e.target.value);
      state.financePagination.blog.currentPage = 1;
      renderFinanceTable('blog');
    });
  }
  
  const finProjectPerPage = $('#finProjectPerPage');
  if (finProjectPerPage) {
    finProjectPerPage.addEventListener('change', (e) => {
      state.financePagination.project.perPage = parseInt(e.target.value);
      state.financePagination.project.currentPage = 1;
      renderFinanceTable('project');
    });
  }
}

function handleFinSearchInput() {
  if (state.currentType === 'finance') renderFinance();
}

function handleFinFilterChange() {
  if (state.currentType === 'finance') renderFinance();
}

function handleFinReset() {
  const finSearchClient = $('#finSearchClient');
  const finFilterManager = $('#finFilterManager');
  const finFilterType = $('#finFilterType');
  const finFilterYear = $('#finFilterYear');
  const financeMonth = $('#financeMonth');
  const contractStatus = $('#contractStatus');
  const finSortOrder = $('#finSortOrder');
  
  if (finSearchClient) finSearchClient.value = '';
  if (finFilterManager) finFilterManager.value = '';
  if (finFilterType) finFilterType.value = '';
  if (finFilterYear) finFilterYear.value = '';
  if (financeMonth) financeMonth.value = '';
  if (contractStatus) contractStatus.value = '';
  if (finSortOrder) finSortOrder.value = '';
  
  if (state.currentType === 'finance') renderFinance();
}



function updateFinBulkEditBar() {
  const bar = $('#finBulkEditBar');
  const count = $('#finSelectedCount');
  if (bar && count) {
    count.textContent = `${state.finSelected.size}개 선택`;
    if (state.finSelected.size > 0) {
      bar.classList.add('active');
    } else {
      bar.classList.remove('active');
    }
  }
}


function openFinBulkEditModal() {
  if (!state.finSelected.size) {
    alert('일괄수정할 항목을 선택해주세요.');
    return;
  }
  
  const modal = document.createElement('div');
  modal.className = 'modal-back active';
  modal.id = 'finBulkEditModal';
  
  const content_div = document.createElement('div');
  content_div.className = 'modal';
  
  content_div.innerHTML = `
    <div class="mh">
      <strong>✏️ 일괄수정 (${state.finSelected.size}개 항목)</strong>
      <button class="btn small outline" id="closeBulkEditModal">✕ 닫기</button>
    </div>
    <div class="mb">
      <div style="padding: 16px; background: rgba(99,102,241,0.1); border: 2px solid var(--primary); border-radius: 12px; margin-bottom: 20px">
        <p style="font-size: 14px; color: var(--text); line-height: 1.6">
          ℹ️ 선택한 ${state.finSelected.size}개 항목의 공통 필드를 일괄 수정합니다.<br>
          비어있는 필드는 수정되지 않습니다.
        </p>
      </div>
      <form id="finBulkEditForm" class="form-grid">
        <div>
          <label>담당자</label>
          <select id="bulkManager">
            <option value="">변경 안 함</option>
            <option value="전병황">전병황</option>
            <option value="강태우">강태우</option>
            <option value="오영은">오영은</option>
            <option value="김하늬">김하늬</option>
            <option value="김우현">김우현</option>
            <option value="공민경">공민경</option>
          </select>
        </div>
        <div>
          <label>입금여부</label>
          <select id="bulkPaid">
            <option value="">변경 안 함</option>
            <option value="미입금">미입금</option>
            <option value="입금완료">입금완료</option>
            <option value="일부입금">일부입금</option>
          </select>
        </div>
        <div>
          <label>세금</label>
          <select id="bulkTax">
            <option value="">변경 안 함</option>
            <option value="미발행">미발행</option>
            <option value="발행">발행</option>
          </select>
        </div>
        <div>
          <label>월별</label>
          <input type="month" id="bulkMonth">
          <small style="color: var(--muted); font-size: 12px">비어있으면 변경 안 함</small>
        </div>
        <div style="grid-column: 1/-1">
          <label>메모 추가 (기존 메모에 추가됩니다)</label>
          <input type="text" id="bulkMemoAppend" placeholder="추가할 메모 내용">
        </div>
        <div style="grid-column: 1/-1; display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px">
          <button type="button" class="btn outline" id="cancelBulkEdit">취소</button>
          <button type="submit" class="btn">일괄 적용</button>
        </div>
      </form>
    </div>
  `;
  
  modal.appendChild(content_div);
  document.body.appendChild(modal);
  
  // 취소 버튼
  $('#closeBulkEditModal')?.addEventListener('click', () => {
    modal.remove();
  });
  
  $('#cancelBulkEdit')?.addEventListener('click', () => {
    modal.remove();
  });
  
  // 일괄 적용
  $('#finBulkEditForm')?.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const bulkManager = $('#bulkManager')?.value;
    const bulkPaid = $('#bulkPaid')?.value;
    const bulkTax = $('#bulkTax')?.value;
    const bulkMonth = $('#bulkMonth')?.value;
    const bulkMemoAppend = $('#bulkMemoAppend')?.value;
    
    if (!bulkManager && !bulkPaid && !bulkTax && !bulkMonth && !bulkMemoAppend) {
      alert('변경할 항목을 선택해주세요.');
      return;
    }
    
    if (!confirm(`선택한 ${state.finSelected.size}개 항목을 일괄 수정하시겠습니까?`)) {
      return;
    }
    
    let updatedCount = 0;
    
    state.finSelected.forEach(key => {
      const parts = key.split('_');
      const type = parts[0];
      const id = parts.slice(1).join('_');
      
      const row = state.financeData[type].find(r => r.id === id);
      if (row) {
        // 변경사항 적용
        if (bulkManager) row.manager = bulkManager;
        if (bulkPaid) row.paid = bulkPaid;
        if (bulkTax) row.tax = bulkTax;
        if (bulkMonth) row.month = bulkMonth;
        if (bulkMemoAppend) {
          row.memo = (row.memo || '') + (row.memo ? ' / ' : '') + bulkMemoAppend;
        }
        
        // 저장
        saveFinanceData(row, type);
        updatedCount++;
      }
    });
    
    if (updatedCount > 0) {
      alert(`${updatedCount}개 항목이 일괄 수정되었습니다.`);
      state.finSelected.clear();
      renderFinance();
      modal.remove();
    }
  });
  
  // 모달 외부 클릭 시 닫기
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.remove();
    }
  });
}

function openDateRangeModal(inputElement) {
  // 기존 값 파싱
  let startDate = '';
  let endDate = '';
  const currentValue = inputElement.value;
  if (currentValue && currentValue.includes('~')) {
    const parts = currentValue.split('~');
    startDate = parts[0]?.trim() || '';
    endDate = parts[1]?.trim() || '';
  }
  
  // 기존 모달이 있으면 제거
  const existingModal = document.querySelector('.date-range-modal-back');
  if (existingModal) {
    document.body.removeChild(existingModal);
  }
  
  // 모달 생성
  const modalBack = document.createElement('div');
  modalBack.className = 'date-range-modal-back';
  
  const modal = document.createElement('div');
  modal.className = 'date-range-modal';
  modal.innerHTML = `
    <div class="date-range-modal-header">
      <strong>📅 작업기간 설정</strong>
      <button class="btn mini outline" id="closeDateModal">✕</button>
    </div>
    <div class="date-picker-grid">
      <div class="date-picker-field">
        <label>시작일</label>
        <input type="date" id="modalStartDate" value="${startDate}">
      </div>
      <div class="date-picker-field">
        <label>종료일</label>
        <input type="date" id="modalEndDate" value="${endDate}">
      </div>
    </div>
    <div class="date-picker-actions">
      <button class="btn-cancel" id="cancelDateModal">취소</button>
      <button class="btn-apply" id="applyDateModal">적용</button>
    </div>
  `;
  
  modalBack.appendChild(modal);
  document.body.appendChild(modalBack);
  
  const startInput = modal.querySelector('#modalStartDate');
  const endInput = modal.querySelector('#modalEndDate');
  
  const closeModal = () => {
    if (document.body.contains(modalBack)) {
      document.body.removeChild(modalBack);
    }
  };
  
  const applyDates = () => {
    const start = startInput.value;
    const end = endInput.value;
    if (start && end) {
      inputElement.value = `${start}~${end}`;
    } else if (start) {
      inputElement.value = start;
    } else {
      inputElement.value = '';
    }
    closeModal();
  };
  
  // 이벤트 리스너
  modal.querySelector('#applyDateModal').addEventListener('click', (e) => {
    e.stopPropagation();
    applyDates();
  });
  
  modal.querySelector('#cancelDateModal').addEventListener('click', (e) => {
    e.stopPropagation();
    closeModal();
  });
  
  modal.querySelector('#closeDateModal').addEventListener('click', (e) => {
    e.stopPropagation();
    closeModal();
  });
  
  // 배경 클릭 시 닫기
  modalBack.addEventListener('click', (e) => {
    if (e.target === modalBack) {
      closeModal();
    }
  });
  
  // ESC 키로 닫기
  const handleEsc = (e) => {
    if (e.key === 'Escape') {
      closeModal();
      document.removeEventListener('keydown', handleEsc);
    }
  };
  document.addEventListener('keydown', handleEsc);
  
  // 모달 내부 클릭은 전파 중지
  modal.addEventListener('click', (e) => {
    e.stopPropagation();
  });
}

function openFinAddModal() {
  const modal = document.createElement('div');
  modal.className = 'modal-back active';
  
  const content_div = document.createElement('div');
  content_div.className = 'modal';
  
  content_div.innerHTML = `
    <div class="mh">
      <strong>➕ 업체별 수익정리 등록</strong>
      <button class="btn small outline" id="closeFinAddModal">✕ 닫기</button>
    </div>
    <div class="mb">
      <form id="finAddForm" class="form-grid">
        <div>
          <label>유형 *</label>
          <select id="finType" required>
            <option value="">선택</option>
            <option value="place">플레이스</option>
            <option value="blog">블로그</option>
            <option value="project">프로젝트</option>
          </select>
        </div>
        <div>
          <label>월별 *</label>
          <input type="month" id="finMonth" required>
        </div>
        <div>
          <label>담당자 *</label>
          <select id="finManager" required>
            <option value="">선택</option>
            <option value="전병황">전병황</option>
            <option value="강태우">강태우</option>
            <option value="오영은">오영은</option>
            <option value="김하늬">김하늬</option>
            <option value="김우현">김우현</option>
            <option value="공민경">공민경</option>
          </select>
        </div>
        <div style="grid-column: 1/-1">
          <label>업체명 *</label>
          <input type="text" id="finClient" required>
        </div>
        <div>
          <label>대표</label>
          <input type="text" id="finOwner">
        </div>
        <div>
          <label>매출 *</label>
          <input type="number" id="finRevenue" step="any" required value="0">
        </div>
        <div>
          <label>입금여부</label>
          <select id="finPaid">
            <option value="미입금">미입금</option>
            <option value="입금완료">입금완료</option>
            <option value="일부입금">일부입금</option>
          </select>
        </div>
        <div>
          <label>작업기간</label>
          <input type="text" id="finPeriod" placeholder="📅 클릭하여 날짜 선택" readonly style="cursor:pointer; background:var(--card2)">
        </div>
        <div>
          <label>작업비(매입)</label>
          <input type="number" id="finCost" step="any" value="0">
        </div>
        <div>
          <label>마진</label>
          <input type="number" id="finMargin" step="any" readonly>
        </div>
        <div>
          <label>영업이익</label>
          <input type="number" id="finProfit" step="any" readonly>
        </div>
        <div>
          <label>세금</label>
          <select id="finTax">
            <option value="미발행">미발행</option>
            <option value="발행">발행</option>
          </select>
        </div>
        <div style="grid-column: 1/-1">
          <label>메모</label>
          <input type="text" id="finMemo">
        </div>
        <div style="grid-column: 1/-1; display: flex; gap: 12px; justify-content: flex-end; margin-top: 8px">
          <button type="button" class="btn outline" id="finResetFormBtn">초기화</button>
          <button type="submit" class="btn">등록</button>
        </div>
      </form>
    </div>
  `;
  
  modal.appendChild(content_div);
  document.body.appendChild(modal);
  
  const now = new Date();
  const monthInput = $('#finMonth');
  if (monthInput) {
    monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  }
  
  const revenueInput = $('#finRevenue');
  const costInput = $('#finCost');
  const marginInput = $('#finMargin');
  const profitInput = $('#finProfit');
  
  const autoCalculate = () => {
    const revenue = parseNum(revenueInput?.value) || 0;
    const cost = parseNum(costInput?.value) || 0;
    const margin = revenue - cost;
    if (marginInput) marginInput.value = margin;
    if (profitInput) profitInput.value = margin;
  };
  
  revenueInput?.addEventListener('input', autoCalculate);
  costInput?.addEventListener('input', autoCalculate);
  autoCalculate();
  
  // 작업기간 달력 선택기
  const periodInput = $('#finPeriod');
  if (periodInput) {
    periodInput.addEventListener('click', () => {
      openDateRangeModal(periodInput);
    });
  }
  
  const closeModal = () => {
    if (document.body.contains(modal)) document.body.removeChild(modal);
  };
  
  content_div.querySelector('#closeFinAddModal')?.addEventListener('click', closeModal);
  modal.addEventListener('click', (e) => {
    if (e.target === modal) closeModal();
  });
  
  content_div.querySelector('#finResetFormBtn')?.addEventListener('click', () => {
    const form = $('#finAddForm');
    if (form) form.reset();
    if (monthInput) monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    autoCalculate();
  });
  
  const form = $('#finAddForm');
  if (form) {
    form.onsubmit = (e) => {
      e.preventDefault();
      
      const type = $('#finType')?.value;
      if (!type) return alert('유형을 선택하세요');
      
      const monthVal = $('#finMonth')?.value || '';
      const data = {
        id: 'fin_' + Date.now() + '_' + Math.random().toString(36).slice(2, 9),
        createdAt: new Date().toISOString(),
        month: monthVal,
        manager: $('#finManager')?.value || '',
        client: $('#finClient')?.value || '',
        owner: $('#finOwner')?.value || '',
        revenue: parseNum($('#finRevenue')?.value) || 0,
        paid: $('#finPaid')?.value || '미입금',
        period: $('#finPeriod')?.value || '',
        cost: parseNum($('#finCost')?.value) || 0,
        margin: parseNum($('#finMargin')?.value) || 0,
        profit: parseNum($('#finProfit')?.value) || 0,
        tax: $('#finTax')?.value || '미발행',
        memo: $('#finMemo')?.value || ''
      };
      
      if (!state.financeData[type]) state.financeData[type] = [];
      state.financeData[type].unshift(data);
      
      saveFinanceData(data, type);
      closeModal();
      renderFinance();
    };
  }
}

function startFinEdit(cell, type, id, field) {
  const finData = state.financeData[type] || [];
  const row = finData.find(r => r.id === id);
  if (!row) return;
  
  // 메모 필드는 모달로 처리
  if (field === 'memo') {
    openMemoModal(row, type);
    return;
  }
  
  const oldValue = row[field];
  let input;
  
  const isNumber = ['revenue', 'cost', 'margin', 'profit'].includes(field);
  
  if (field === 'manager') {
    input = document.createElement('select');
    input.innerHTML = `
      <option value="">선택</option>
      <option value="전병황">전병황</option>
      <option value="강태우">강태우</option>
      <option value="오영은">오영은</option>
      <option value="김하늬">김하늬</option>
      <option value="김우현">김우현</option>
      <option value="공민경">공민경</option>
    `;
    input.value = oldValue || '';
  } else if (field === 'paid') {
    input = document.createElement('select');
    input.innerHTML = `
      <option value="미입금">미입금</option>
      <option value="입금완료">입금완료</option>
      <option value="일부입금">일부입금</option>
    `;
    input.value = oldValue || '미입금';
  } else if (field === 'tax') {
    input = document.createElement('select');
    input.innerHTML = `
      <option value="미발행">미발행</option>
      <option value="발행">발행</option>
    `;
    input.value = oldValue || '미발행';
  } else if (field === 'month') {
    input = document.createElement('input');
    input.type = 'month';
    input.value = oldValue || '';
  } else if (field === 'period') {
    // 작업기간을 모달 달력 선택기로 표시
    
    // 기존 값 파싱
    let startDate = '';
    let endDate = '';
    if (oldValue && oldValue.includes('~')) {
      const parts = oldValue.split('~');
      startDate = parts[0]?.trim() || '';
      endDate = parts[1]?.trim() || '';
    }
    
    // 기존 모달이 있으면 제거
    const existingModal = document.querySelector('.date-range-modal-back');
    if (existingModal) {
      document.body.removeChild(existingModal);
    }
    
    // 모달 생성
    const modalBack = document.createElement('div');
    modalBack.className = 'date-range-modal-back';
    
    const modal = document.createElement('div');
    modal.className = 'date-range-modal';
    modal.innerHTML = `
      <div class="date-range-modal-header">
        <strong>📅 작업기간 설정</strong>
        <button class="btn mini outline" id="closeDateModal">✕</button>
      </div>
      <div class="date-picker-grid">
        <div class="date-picker-field">
          <label>시작일</label>
          <input type="date" id="periodStartDate" value="${startDate}">
        </div>
        <div class="date-picker-field">
          <label>종료일</label>
          <input type="date" id="periodEndDate" value="${endDate}">
        </div>
      </div>
      <div class="date-picker-actions">
        <button class="btn-cancel" id="cancelDatePicker">취소</button>
        <button class="btn-apply" id="applyDatePicker">적용</button>
      </div>
    `;
    
    modalBack.appendChild(modal);
    document.body.appendChild(modalBack);
    
    const startInput = modal.querySelector('#periodStartDate');
    const endInput = modal.querySelector('#periodEndDate');
    
    const closeModal = () => {
      if (document.body.contains(modalBack)) {
        document.body.removeChild(modalBack);
      }
      renderFinance();
    };
    
    const commit = () => {
      const start = startInput.value;
      const end = endInput.value;
      if (start && end) {
        row[field] = `${start}~${end}`;
      } else if (start) {
        row[field] = start;
      } else {
        row[field] = '';
      }
      saveFinanceData(row, type);
      closeModal();
    };
    
    // 이벤트 리스너
    modal.querySelector('#applyDatePicker').addEventListener('click', (e) => {
      e.stopPropagation();
      commit();
    });
    
    modal.querySelector('#cancelDatePicker').addEventListener('click', (e) => {
      e.stopPropagation();
      closeModal();
    });
    
    modal.querySelector('#closeDateModal').addEventListener('click', (e) => {
      e.stopPropagation();
      closeModal();
    });
    
    // 배경 클릭 시 닫기
    modalBack.addEventListener('click', (e) => {
      if (e.target === modalBack) {
        closeModal();
      }
    });
    
    // ESC 키로 닫기
    const handleEsc = (e) => {
      if (e.key === 'Escape') {
        closeModal();
        document.removeEventListener('keydown', handleEsc);
      }
    };
    document.addEventListener('keydown', handleEsc);
    
    // 모달 내부 클릭은 전파 중지
    modal.addEventListener('click', (e) => {
      e.stopPropagation();
    });
    
    return;
  } else {
    input = document.createElement('input');
    input.type = isNumber ? 'number' : 'text';
    if (isNumber) {
      input.step = 'any';
      input.value = oldValue || '';
    } else {
      input.value = oldValue || '';
    }
  }
  
  input.style.width = '100%';
  input.style.padding = '8px';
  input.style.background = 'var(--card)';
  input.style.color = 'var(--text)';
  input.style.border = '2px solid var(--primary)';
  input.style.borderRadius = '6px';
  
  cell.innerHTML = '';
  cell.appendChild(input);
  input.focus();
  
  const commit = () => {
    let value = input.value;
    if (isNumber) value = parseNum(value) || 0;
    row[field] = value;
    
    if (['revenue', 'cost'].includes(field)) {
      row.margin = (row.revenue || 0) - (row.cost || 0);
      row.profit = row.margin;
    }
    
    saveFinanceData(row, type);
    renderFinance();
  };
  
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      commit();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      renderFinance();
    }
  });
  
  input.addEventListener('blur', commit);
}

function saveFinanceData(data, type) {
  if (!state.useFirebase || !db) return;
  
  try {
    const ref = db.ref(`finance/${type}/${data.id}`);
    ref.set(data);
  } catch (e) {
    console.error('Firebase 저장 실패:', e);
  }
}

function openMemoModal(row, type) {
  const modal = $('#memoModalBack');
  const textarea = $('#memoTextarea');
  const saveBtn = $('#saveMemoBtn');
  const cancelBtn = $('#cancelMemoBtn');
  const closeBtn = $('#closeMemoModalBtn');
  
  if (!modal || !textarea) return;
  
  // 현재 메모 내용 설정
  textarea.value = row.memo || '';
  
  // 모달 열기
  modal.classList.add('active');
  textarea.focus();
  
  // 저장 버튼 이벤트
  const handleSave = () => {
    row.memo = textarea.value;
    saveFinanceData(row, type);
    modal.classList.remove('active');
    renderFinance();
    cleanup();
  };
  
  // 취소 버튼 이벤트
  const handleCancel = () => {
    modal.classList.remove('active');
    cleanup();
  };
  
  // 이벤트 정리 함수
  const cleanup = () => {
    saveBtn.removeEventListener('click', handleSave);
    cancelBtn.removeEventListener('click', handleCancel);
    closeBtn.removeEventListener('click', handleCancel);
    modal.removeEventListener('click', handleBackdropClick);
    document.removeEventListener('keydown', handleEsc);
  };
  
  // 배경 클릭 시 닫기
  const handleBackdropClick = (e) => {
    if (e.target === modal) {
      handleCancel();
    }
  };
  
  // ESC 키로 닫기
  const handleEsc = (e) => {
    if (e.key === 'Escape') {
      handleCancel();
    }
  };
  
  saveBtn.addEventListener('click', handleSave);
  cancelBtn.addEventListener('click', handleCancel);
  closeBtn.addEventListener('click', handleCancel);
  modal.addEventListener('click', handleBackdropClick);
  document.addEventListener('keydown', handleEsc);
}

function loadFinanceData(type) {
  if (!state.useFirebase || !db) return;
  
  try {
    const ref = db.ref(`finance/${type}`);
    ref.on('value', snapshot => {
      const data = snapshot.val();
      if (data) {
        state.financeData[type] = Object.values(data);
        if (state.currentType === 'finance') {
          renderFinance();
        }
      }
    });
  } catch (e) {
    console.error('Firebase 로드 실패:', e);
  }
}

function deleteFinanceData(id, type) {
  if (!state.useFirebase || !db) return;
  
  try {
    const ref = db.ref(`finance/${type}/${id}`);
    ref.remove();
  } catch (e) {
    console.error('Firebase 삭제 실패:', e);
  }
}

function openAddModal() {
  if (state.currentType === 'finance') {
    return;
  }
  
  const config = CONFIGS[state.currentType];
  const form = $('#addForm');
  const titleEl = $('#modalTitle');
  
  if(!form || !titleEl) return;
  
  titleEl.textContent = `${config.name} 등록`;
  
  let html = '';
  config.fields.forEach(f => {
    if (f.type === 'computed' || f.type === 'hidden') return;
    const full = ['client', 'keywords', 'note'].includes(f.key) ? ' style="grid-column:1/-1"' : '';
    const req = f.required ? 'required' : '';
    
    html += `<div${full}><label>${f.label}${f.required ? ' *' : ''}</label>`;
    
    if (f.type === 'select') {
      html += `<select id="a${f.key}" ${req}><option value="">선택</option>`;
      f.options.forEach(o => html += `<option>${o}</option>`);
      html += '</select>';
    } else {
      const t = f.type === 'number' ? 'number' : f.type === 'url' ? 'url' : f.type === 'date' ? 'date' : 'text';
      const def = f.type === 'date' && f.key === 'startDate' ? `value="${today()}"` : '';
      html += `<input id="a${f.key}" type="${t}" ${req} ${def}${f.type === 'number' ? ' step="any"' : ''}>`;
    }
    html += '</div>';
  });
  
  html += `<div style="grid-column:1/-1; display:flex; gap:12px; justify-content:flex-end; margin-top:8px">
    <button type="button" class="btn outline" id="resetFormBtn">초기화</button>
    <button type="submit" class="btn">등록</button>
  </div>`;
  
  form.innerHTML = html;
  
  const modalBack = $('#addModalBack');
  if(modalBack) modalBack.classList.add('active');
  
  const resetBtn = $('#resetFormBtn');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      form.reset();
      const startInputs = form.querySelectorAll('[id^="astart"]');
      startInputs.forEach(el => {
        if (el.type === 'date') el.value = today();
      });
    });
  }
  
  form.onsubmit = (e) => {
    e.preventDefault();
    
    const data = {};
    config.fields.forEach(f => {
      if (f.type === 'computed') return;
      if (f.type === 'hidden') {
        // hidden 필드는 defaultValue 사용
        data[f.key] = f.defaultValue;
        return;
      }
      const el = $(`#a${f.key}`);
      if (el) data[f.key] = f.type === 'number' ? parseNum(el.value) : el.value;
    });
    
    // place 타입일 때 현재 서브타입 설정
    if (state.currentType === 'place') {
      data.subType = state.placeSubType;
    }
    
    const newRow = mk(data, config);
    state.rows[state.currentType].unshift(newRow);
    saveData(newRow, state.currentType);
    render();
    closeAddModal();
  };
}

function closeAddModal() {
  const modalBack = $('#addModalBack');
  if(modalBack) modalBack.classList.remove('active');
}


function switchSubType(subType) {
  state.placeSubType = subType;
  state.selected.clear();
  state.pagination.currentPage = 1;
  
  // 서브탭 활성화 상태 변경
  $$('.subtab').forEach(t => t.classList.remove('active'));
  const activeSubtab = $(`.subtab[data-subtype="${subType}"]`);
  if (activeSubtab) activeSubtab.classList.add('active');
  
  render();
}

function render() {
  renderFilters();
  renderTable();
}

// Special Notes 관련 함수들
function getSpecialNoteKey() {
  if (state.currentType === 'place') {
    return `place_${state.placeSubType}`;
  }
  return state.currentType;
}

function loadSpecialNotes() {
  if (!state.useFirebase || !db) return;
  
  db.ref('specialNotes').once('value').then(snapshot => {
    const data = snapshot.val();
    if (data) {
      state.specialNotes = {
        place_reward: data.place_reward || '',
        place_distribution: data.place_distribution || '',
        blog: data.blog || '',
        project: data.project || ''
      };
    }
  }).catch(e => {
    console.error('Special Notes 로드 실패:', e);
  });
}

function saveSpecialNote(key, content) {
  if (!state.useFirebase || !db) return;
  
  db.ref('specialNotes').child(key).set(content).catch(e => {
    console.error('Special Note 저장 실패:', e);
  });
}

function openSpecialNoteModal() {
  const modalBack = $('#specialNoteModalBack');
  const textarea = $('#specialNoteTextarea');
  const title = $('#specialNoteModalTitle');
  
  if (!modalBack || !textarea || !title) return;
  
  const key = getSpecialNoteKey();
  const currentNote = state.specialNotes[key] || '';
  
  // 모달 제목 설정
  let titleText = '📌 특이사항';
  if (state.currentType === 'place') {
    titleText += ` - 플레이스 작업 (${state.placeSubType === 'reward' ? '리워드' : '배포'})`;
  } else if (state.currentType === 'blog') {
    titleText += ' - 블로그 작업';
  } else if (state.currentType === 'project') {
    titleText += ' - 프로젝트';
  }
  title.textContent = titleText;
  
  textarea.value = currentNote;
  modalBack.classList.add('active');
  textarea.focus();
}

function closeSpecialNoteModal() {
  const modalBack = $('#specialNoteModalBack');
  if (modalBack) modalBack.classList.remove('active');
}

function saveCurrentSpecialNote() {
  const textarea = $('#specialNoteTextarea');
  if (!textarea) return;
  
  const key = getSpecialNoteKey();
  const content = textarea.value.trim();
  
  state.specialNotes[key] = content;
  saveSpecialNote(key, content);
  
  closeSpecialNoteModal();
  alert('특이사항이 저장되었습니다.');
}

function initApp() {
  console.log('Initializing app...');
  
  const pd = matchMedia('(prefers-color-scheme: dark)').matches;
  document.documentElement.setAttribute('data-theme', pd ? 'dark' : 'light');
  
  // 로그인 폼 이벤트
  const loginForm = $('#loginForm');
  if (loginForm) {
    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = $('#loginEmail')?.value;
      const password = $('#loginPassword')?.value;
      if (email && password) {
        handleLogin(email, password);
      }
    });
  }
  
  // 로그아웃 버튼 이벤트
  const logoutBtn = $('#logoutBtn');
  if (logoutBtn) {
    logoutBtn.addEventListener('click', () => {
      if (confirm('로그아웃 하시겠습니까?')) {
        handleLogout();
      }
    });
  }
  
  // 중요: Firebase 먼저 초기화, 그 다음 Auth 초기화
  initFirebase();
  
  // Firebase 초기화 대기 후 Auth 초기화
  setTimeout(() => {
    initAuth();
  }, 500);
  
  $$('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      switchType(tab.dataset.type);
    });
  });
  
  // 서브탭 이벤트 바인딩
  $$('.subtab').forEach(subtab => {
    subtab.addEventListener('click', () => {
      switchSubType(subtab.dataset.subtype);
    });
  });
  
  // 초기 로드 시 서브탭은 숨김 상태로 시작
  const placeSubtabs = $('#placeSubtabs');
  if (placeSubtabs) {
    placeSubtabs.classList.remove('show');
  }
  
  const removeBtn = $('#removeSelectedBtn');
  if(removeBtn) {
    removeBtn.addEventListener('click', () => {
      if (!state.selected.size) return alert('선택하세요');
      if (confirm(`${state.selected.size}건 삭제?`)) {
        state.rows[state.currentType] = state.rows[state.currentType].filter(r => {
          if (state.selected.has(r.id)) {
            deleteData(r.id, state.currentType);
            return false;
          }
          return true;
        });
        state.selected.clear();
        render();
      }
    });
  }
  
  const cloneBtn = $('#cloneSelectedBtn');
  if(cloneBtn) {
    cloneBtn.addEventListener('click', cloneSelected);
  }
  
  const bulkBtn = $('#bulkEditBtn');
  if(bulkBtn) {
    bulkBtn.addEventListener('click', () => {
      openBulkEditModal();
    });
  }
  
  const reportBtn = $('#openReportModalBtn');
  if(reportBtn) {
    reportBtn.addEventListener('click', () => {
      openReportModal();
    });
  }
  
  const themeBtn = $('#themeBtn');
  if(themeBtn) {
    themeBtn.addEventListener('click', () => {
      const cur = document.documentElement.getAttribute('data-theme');
      const next = cur === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
    });
  }
  
  const exportBtn = $('#exportExcelBtn');
  if(exportBtn) {
    exportBtn.addEventListener('click', () => {
      if (!state.selected.size) return alert('선택하세요');
      const config = CONFIGS[state.currentType];
      const selected = state.rows[state.currentType].filter(r => state.selected.has(r.id));
      const data = selected.map(row => {
        const obj = {};
        config.fields.forEach(f => obj[f.label] = row[f.key] ?? '');
        return obj;
      });
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, config.name);
      XLSX.writeFile(wb, `${config.name}_${today()}.xlsx`);
    });
  }
  
  const addBtn = $('#openAddModalBtn');
  if(addBtn) {
    addBtn.addEventListener('click', () => {
      openAddModal();
    });
  }
  
  const closeBtn = $('#closeModalBtn');
  if(closeBtn) {
    closeBtn.addEventListener('click', closeAddModal);
  }
   
  const perPageBtn = $('#perPageSelect');
  if(perPageBtn) {
    perPageBtn.addEventListener('change', e => {
      state.pagination.perPage = parseInt(e.target.value);
      state.pagination.currentPage = 1;
      renderTable();
    });
  }
  
  // Finance 탭 이벤트 리스너 초기화
  const finSearchClient = $('#finSearchClient');
  if (finSearchClient) {
    finSearchClient.addEventListener('input', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const finFilterManager = $('#finFilterManager');
  if (finFilterManager) {
    finFilterManager.addEventListener('change', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const finFilterType = $('#finFilterType');
  if (finFilterType) {
    finFilterType.addEventListener('change', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const finFilterYear = $('#finFilterYear');
  if (finFilterYear) {
    finFilterYear.addEventListener('change', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const financeMonth = $('#financeMonth');
  if (financeMonth) {
    financeMonth.addEventListener('change', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const contractStatus = $('#contractStatus');
  if (contractStatus) {
    contractStatus.addEventListener('change', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const finSortOrder = $('#finSortOrder');
  if (finSortOrder) {
    finSortOrder.addEventListener('change', () => {
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const finResetBtn = $('#finResetBtn');
  if (finResetBtn) {
    finResetBtn.addEventListener('click', () => {
      if (finSearchClient) finSearchClient.value = '';
      if (finFilterManager) finFilterManager.value = '';
      if (finFilterType) finFilterType.value = '';
      if (finFilterYear) finFilterYear.value = '';
      if (financeMonth) financeMonth.value = '';
      if (contractStatus) contractStatus.value = '';
      if (finSortOrder) finSortOrder.value = '';
      if (state.currentType === 'finance') renderFinance();
    });
  }
  
  const openFinAddModalBtn = $('#openFinAddModalBtn');
  if (openFinAddModalBtn) {
    openFinAddModalBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      openFinAddModal();
    });
  }
  
  const removeFinSelectedBtn = $('#removeFinSelectedBtn');
  if (removeFinSelectedBtn) {
    removeFinSelectedBtn.addEventListener('click', () => {
      if (!state.finSelected.size) return alert('선택하세요');
      if (confirm(`${state.finSelected.size}건 삭제?`)) {
        state.finSelected.forEach(key => {
          const parts = key.split('_');
          const type = parts[0];
          const id = parts.slice(1).join('_');
          
          state.financeData[type] = state.financeData[type].filter(r => r.id !== id);
          deleteFinanceData(id, type);
        });
        
        state.finSelected.clear();
        renderFinance();
      }
    });
  }
  
  const cloneFinSelectedBtn = $('#cloneFinSelectedBtn');
  if (cloneFinSelectedBtn) {
    cloneFinSelectedBtn.addEventListener('click', () => {
      if (!state.finSelected.size) return alert('복제할 항목을 선택하세요');
      
      if (!confirm(`선택한 ${state.finSelected.size}개 항목을 복제하시겠습니까?`)) return;
      
      let clonedCount = 0;
      state.finSelected.forEach(key => {
        const parts = key.split('_');
        const type = parts[0];
        const id = parts.slice(1).join('_');
        
        const original = state.financeData[type].find(r => r.id === id);
        if (original) {
          const cloned = { ...original, id: Date.now() + '_' + Math.random().toString(36).slice(2) };
          cloned.month = cloned.month || '';
          state.financeData[type].unshift(cloned);
          saveFinanceData(cloned, type);
          clonedCount++;
        }
      });
      
      if (clonedCount > 0) {
        alert(`${clonedCount}건이 복제되었습니다.`);
        state.finSelected.clear();
        renderFinance();
      }
    });
  }
  
  const finBulkEditBtn = $('#finBulkEditBtn');
  if (finBulkEditBtn) {
    finBulkEditBtn.addEventListener('click', () => {
      if (!state.finSelected.size) return alert('선택하세요');
      openFinBulkEditModal();
    });
  }
  
  // 특이사항 버튼 이벤트 리스너
  const openSpecialNoteBtn = $('#openSpecialNoteBtn');
  if (openSpecialNoteBtn) {
    openSpecialNoteBtn.addEventListener('click', () => {
      openSpecialNoteModal();
    });
  }
  
  const closeSpecialNoteModalBtn = $('#closeSpecialNoteModalBtn');
  if (closeSpecialNoteModalBtn) {
    closeSpecialNoteModalBtn.addEventListener('click', () => {
      closeSpecialNoteModal();
    });
  }
  
  const cancelSpecialNoteBtn = $('#cancelSpecialNoteBtn');
  if (cancelSpecialNoteBtn) {
    cancelSpecialNoteBtn.addEventListener('click', () => {
      closeSpecialNoteModal();
    });
  }
  
  const saveSpecialNoteBtn = $('#saveSpecialNoteBtn');
  if (saveSpecialNoteBtn) {
    saveSpecialNoteBtn.addEventListener('click', () => {
      saveCurrentSpecialNote();
    });
  }
  
  render();
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initApp);
} else {
  initApp();
}
</script>
</body>
</html>
