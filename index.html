<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>ì—”í‹°ì œì»´í¼ë‹ˆ Â· ì‘ì—… ëŒ€ì‹œë³´ë“œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<style>
  :root{
    --bg:#0f0f23; --panel:#1a1a2e; --card:#16213e; --card2:#1f2d47;
    --text:#e4e8f0; --muted:#8b94a8; --border:#2a3551; --chip:#2d3a5c;
    --primary:#6366f1; --primary-light:#818cf8; --green:#22c55e; --red:#ef4444; --amber:#f59e0b;
    --shadow:0 20px 60px rgba(0,0,0,0.5);
    --gradient-1:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  [data-theme="light"]{
    --bg:#f5f7fa; --panel:#ffffff; --card:#ffffff; --card2:#f8fafc;
    --text:#1e293b; --muted:#64748b; --border:#e2e8f0; --chip:#e0e7ff;
    --primary:#6366f1; --primary-light:#818cf8; --green:#16a34a; --red:#dc2626; --amber:#d97706;
    --shadow:0 10px 40px rgba(0,0,0,0.08);
  }

  *{box-sizing:border-box; margin:0; padding:0}
  html,body{max-width:100%; overflow-x:hidden; background:var(--bg); color:var(--text)}
  body{font-family:'Pretendard',-apple-system,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif; line-height:1.6}
  img,canvas,svg,video{max-width:100%; height:auto; display:block}

  .wrap{max-width:1600px; margin:0 auto; padding:24px; display:grid; gap:20px}

  .connection-status {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: var(--shadow);
  }
  .connection-status.connected {
    background: var(--green);
    color: white;
  }
  .connection-status.disconnected {
    background: var(--red);
    color: white;
  }
  .connection-status.local {
    background: var(--amber);
    color: white;
  }
  .connection-status .indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: white;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  header{
    background:var(--panel); border:1px solid var(--border); border-radius:20px;
    padding:24px 32px; box-shadow:var(--shadow); display:flex;
    align-items:center; justify-content:space-between; position:relative; overflow:hidden
  }
  header::before{content:''; position:absolute; top:0; left:0; right:0; height:4px; background:var(--gradient-1)}
  .brand{display:flex; align-items:center; gap:16px}
  .brand .icon{font-size:36px; filter:drop-shadow(0 4px 8px rgba(99,102,241,0.4))}
  .brand h1{font-size:24px; font-weight:800; background:var(--gradient-1); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  .chip{background:var(--chip); border:1px solid var(--border); color:var(--primary-light);
    padding:6px 14px; border-radius:999px; font-size:12px; font-weight:600}

  .btn{background:var(--primary); color:#fff; border:none; padding:10px 20px;
    border-radius:12px; cursor:pointer; font-weight:600; font-size:14px;
    transition:all .3s; box-shadow:0 4px 12px rgba(99,102,241,.3)}
  .btn:hover{background:var(--primary-light); transform:translateY(-2px)}
  .btn.outline{background:transparent; color:var(--text); border:2px solid var(--border); box-shadow:none}
  .btn.outline:hover{border-color:var(--primary); color:var(--primary); background:rgba(99,102,241,.08)}
  .btn.danger{background:#ef4444}
  .btn.small{padding:8px 14px; font-size:13px}

  /* íƒ­ ìŠ¤íƒ€ì¼ */
  .tabs{display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap}
  .tab{padding:12px 24px; background:var(--card); border:2px solid var(--border); border-radius:12px;
    cursor:pointer; font-weight:600; font-size:14px; transition:all .3s; color:var(--muted)}
  .tab:hover{border-color:var(--primary-light); background:var(--card2)}
  .tab.active{background:var(--primary); color:#fff; border-color:var(--primary)}
  .subtabs{display:flex; gap:6px; margin-left:12px}
  .subtab{padding:8px 16px; background:var(--card2); border:2px solid var(--border); border-radius:10px;
    cursor:pointer; font-size:13px; font-weight:600; transition:all .3s; color:var(--muted)}
  .subtab:hover{border-color:var(--primary-light)}
  .subtab.active{background:var(--primary-light); color:#fff; border-color:var(--primary-light)}

  .panel{background:var(--panel); border:1px solid var(--border); border-radius:20px; box-shadow:var(--shadow); overflow:hidden}
  .panel .h{padding:20px 28px; border-bottom:1px solid var(--border); display:flex;
    align-items:center; justify-content:space-between; background:linear-gradient(to right, rgba(99,102,241,.05), transparent)}
  .panel .h strong{font-size:18px; font-weight:700}
  .panel .b{padding:24px 28px}

  .filters{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px}
  @media (max-width:1100px){.filters{grid-template-columns:1fr 1fr}}

  .filter-input-wrapper{position:relative}
  input, select{width:100%; padding:12px 16px; border-radius:12px; border:2px solid var(--border);
    background:var(--card); color:var(--text); font-size:14px; font-weight:500; transition:all .3s}
  input:focus, select:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(99,102,241,.1)}

  .date-filter-wrap{display:flex; flex-direction:column; gap:6px}
  .period-btns{display:flex; gap:6px}
  .period-btn{flex:1; padding:6px 10px; font-size:12px; font-weight:600; border-radius:8px;
    border:2px solid var(--border); background:var(--card); color:var(--muted); cursor:pointer; transition:all .3s}
  .period-btn.active{background:var(--primary); color:#fff; border-color:var(--primary)}
  .period-btn:hover:not(.active){background:var(--card2); border-color:var(--primary-light)}

  .filter-reset-all{grid-column:1/-1; display:flex; justify-content:flex-end; margin-top:-4px}
  .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .sep{height:1px; background:var(--border); margin:20px 0}
  .muted{color:var(--muted); font-size:13px}

  .table-wrap{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch}
  table{width:100%; border-collapse:separate; border-spacing:0; min-width:980px}
  thead th{position:sticky; top:0; background:var(--card2); z-index:2; border-bottom:2px solid var(--border);
    padding:14px 12px; font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:var(--muted); white-space:nowrap}
  tbody tr{transition:all .2s; border-bottom:1px solid var(--border)}
  tbody tr:hover{background:var(--card2); transform:scale(1.001)}
  td{padding:14px 12px; font-size:14px; vertical-align:middle}
  .num{text-align:right; font-variant-numeric:tabular-nums; font-weight:600}
  .center{text-align:center}
  .nowrap{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:260px}
  .url a{color:var(--primary-light); text-decoration:none; font-weight:600; transition:color .2s}
  .url a:hover{color:var(--primary); text-decoration:underline}
  .select-row{width:18px; height:18px; cursor:pointer}

  tr.deadline-warning{border-left:4px solid var(--amber); background:rgba(245,158,11,.1)}

  .cell-editor{width:100%; border-radius:8px; padding:8px 12px; border:2px solid var(--primary); background:var(--card); color:var(--text); font-size:14px}
  .badge-yes{color:var(--green); font-weight:700}
  .badge-no{color:var(--amber); font-weight:700}

  .bulk-edit-bar{background:linear-gradient(135deg, rgba(99,102,241,.1), rgba(139,92,246,.1));
    border:2px solid var(--primary); border-radius:16px; padding:16px 20px; margin-bottom:16px;
    display:none; align-items:center; gap:16px; animation:slideDown .3s}
  .bulk-edit-bar.active{display:flex}
  @keyframes slideDown{from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)}}

  .pagination-wrapper{display:flex; align-items:center; justify-content:space-between; padding:20px 0; gap:16px; flex-wrap:wrap}
  .pagination{display:flex; gap:8px; align-items:center}
  .page-btn{min-width:36px; height:36px; padding:0 12px; border:2px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; cursor:pointer; font-weight:600; transition:all .3s}
  .page-btn:hover:not(.active):not(:disabled){border-color:var(--primary); background:var(--card2)}
  .page-btn.active{background:var(--primary); color:#fff; border-color:var(--primary)}
  .page-btn:disabled{opacity:.3; cursor:not-allowed}
  .per-page-selector{display:flex; align-items:center; gap:10px}
  .per-page-selector select{width:auto; padding:8px 12px}

  .modal-back{position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; z-index:1000; padding:16px}
  .modal-back.active{display:flex}
  .modal{background:var(--panel); border:2px solid var(--border); border-radius:24px; box-shadow:0 30px 80px rgba(0,0,0,.6); width:900px; max-width:100%; max-height:90vh; overflow:auto; animation:modalIn .3s}
  @keyframes modalIn{from{opacity:0; transform:scale(.9) translateY(20px)} to{opacity:1; transform:scale(1) translateY(0)}}
  .modal .mh{padding:24px 28px; border-bottom:2px solid var(--border); display:flex; align-items:center; justify-content:space-between; background:linear-gradient(to right, rgba(99,102,241,.05), transparent)}
  .modal .mh strong{font-size:20px; font-weight:800}
  .modal .mb{padding:28px}
  .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  .form-grid .full{grid-column:1/-1}
  .form-grid label{display:block; font-size:13px; font-weight:600; color:var(--muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:.5px}
</style>
</head>
<body>
<div class="connection-status local" id="connectionStatus">
  <span class="indicator"></span>
  <span id="connectionText">ì—°ê²° ì¤‘...</span>
</div>

<div class="wrap" id="app">
  <header>
    <div class="brand">
      <span class="icon" aria-hidden="true">ğŸ’¼</span>
      <div>
        <h1>ì—”í‹°ì œì»´í¼ë‹ˆ</h1>
        <span class="chip" id="modeChip">ì‘ì—… ëŒ€ì‹œë³´ë“œ</span>
      </div>
    </div>
    <div class="toolbar">
      <button class="btn outline" id="exportExcelBtn">ğŸ“Š ì—‘ì…€ ë‚´ë³´ë‚´ê¸°</button>
      <button class="btn" id="themeBtn">ğŸŒ“ í…Œë§ˆ ì „í™˜</button>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-type="place">
      ğŸ“ í”Œë ˆì´ìŠ¤ ì‘ì—…
    </div>
    <div class="subtabs" id="placeSubtabs">
      <div class="subtab active" data-subtype="reward">ë¦¬ì›Œë“œ</div>
      <div class="subtab" data-subtype="distribute">ë°°í¬</div>
    </div>
    <div class="tab" data-type="blog">
      ğŸ“ ë¸”ë¡œê·¸ ì‘ì—…
    </div>
  </div>

  <section class="panel">
    <div class="h">
      <strong id="panelTitle">ğŸ” í•„í„° & ë“±ë¡</strong>
      <div class="toolbar">
        <button class="btn small" id="openAddModalBtn">â• ìƒˆ í•­ëª©</button>
        <button class="btn danger small" id="removeSelectedBtn">ğŸ—‘ï¸ ì„ íƒ ì‚­ì œ</button>
      </div>
    </div>
    <div class="b">
      <div id="filtersContainer"></div>
      <div class="sep"></div>
      <div class="muted" id="modeInfo">ğŸ’¡ í‘œ ì…€ í´ë¦­ ì‹œ ë°”ë¡œ ìˆ˜ì • (Enter=ì €ì¥, Esc=ì·¨ì†Œ)</div>
    </div>
  </section>

  <section class="panel">
    <div class="h">
      <strong id="listTitle">ğŸ“‹ ì‘ì—… ëª©ë¡</strong>
      <span class="muted" id="countInfo">0ê±´</span>
    </div>
    <div class="b">
      <div class="bulk-edit-bar" id="bulkEditBar">
        <span class="muted" id="selectedCount">0ê°œ ì„ íƒ</span>
        <button class="btn small" id="bulkEditBtn">âœï¸ ì¼ê´„ìˆ˜ì •</button>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="pagination-wrapper">
        <div class="per-page-selector">
          <span class="muted">í˜ì´ì§€ë‹¹ í‘œì‹œ:</span>
          <select id="perPageSelect">
            <option value="30" selected>30ê°œ</option>
            <option value="50">50ê°œ</option>
            <option value="100">100ê°œ</option>
          </select>
        </div>
        <div class="pagination" id="pagination"></div>
      </div>
    </div>
  </section>
</div>

<div class="modal-back" id="addModalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mh">
      <strong id="modalTitle">â• ìƒˆ í•­ëª© ë“±ë¡</strong>
      <button class="btn small outline" onclick="closeAddModal()">âœ• ë‹«ê¸°</button>
    </div>
    <div class="mb">
      <form id="addForm" class="form-grid"></form>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const USE_FIREBASE = true;

const firebaseConfig = {
  apiKey: "AIzaSyCV9pjrGzHEoc-s4ppz44lMba5BKE53VAs",
  authDomain: "entjcompany.firebaseapp.com",
  databaseURL: "https://entjcompany.firebaseio.com",
  projectId: "entjcompany",
  storageBucket: "entjcompany.firebasestorage.app",
  messagingSenderId: "567861521069",
  appId: "1:567861521069:web:084f0212f2931e2c9fb424",
  measurementId: "G-0F57YWZJPS"
};

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmtMoney = n => 'â‚©' + Math.round(n||0).toLocaleString('ko-KR');
const parseNum = v => v===''||v==null? null : (isNaN(Number(v))? null : Number(v));
const toISO = d => {if(!d)return''; const z=new Date(d); return new Date(z - z.getTimezoneOffset()*60000).toISOString().slice(0,10)};
const today = () => toISO(new Date());

const storageKey = 'ntz-company-ops-v5';

const state = {
  currentType: 'place',
  currentSubtype: 'reward',
  rows: {},
  prefs: {theme:'auto'},
  filters: {},
  selected: new Set(),
  pagination: {currentPage:1, perPage:30},
  isFirebaseConnected: false,
  useFirebase: USE_FIREBASE
};

let db = null;
let dataRefs = {};

const CONFIGS = {
  place_reward: {
    name: 'í”Œë ˆì´ìŠ¤ ì‘ì—… (ë¦¬ì›Œë“œ)',
    path: 'place_reward',
    fields: [
      {key:'product', label:'ìƒí’ˆ', type:'select', options:['ë©˜í† ìŠ¤','í˜¸ì˜¬ìŠ¤','ë§ì°¨','ì‹ ê·œ','ì—†ìŒ']},
      {key:'category', label:'êµ¬ë¶„', type:'select', options:['íŠ¸ë˜í”½','ì €ì¥','ê¸¸ì°¾ê¸°','ì˜ìˆ˜ì¦']},
      {key:'client', label:'ì—…ì²´ëª…', type:'text'},
      {key:'mid', label:'Mid', type:'url'},
      {key:'keywords', label:'í‚¤ì›Œë“œ', type:'text'},
      {key:'startDate', label:'ì‹œì‘ì¼', type:'date'},
      {key:'endDate', label:'ì¢…ë£Œì¼', type:'date'},
      {key:'units', label:'ì¼íƒ€', type:'number'},
      {key:'days', label:'ì¼ìˆ˜', type:'number'},
      {key:'unitPrice', label:'ë‹¨ê°€', type:'number'},
      {key:'totalQty', label:'ì´ëŸ‰', type:'computed'},
      {key:'cost', label:'ì‘ì—…ë¹„', type:'computed'},
      {key:'tax', label:'ì„¸ê¸ˆ', type:'select', options:['ë°œí–‰','ë¯¸ë°œí–‰']},
      {key:'note', label:'ë¹„ê³ ', type:'text'}
    ]
  },
  place_distribute: {
    name: 'í”Œë ˆì´ìŠ¤ ì‘ì—… (ë°°í¬)',
    path: 'place_distribute',
    fields: [
      {key:'client', label:'ì—…ì²´ëª…', type:'text'},
      {key:'url', label:'URL', type:'url'},
      {key:'category', label:'êµ¬ë¶„', type:'select', options:['ì •ë³´ì„±','í›„ê¸°ì„±']},
      {key:'totalQty', label:'ì´ ìˆ˜ëŸ‰', type:'number'},
      {key:'dailyRelease', label:'ì¼ ë°œí–‰', type:'number'},
      {key:'keywords', label:'í‚¤ì›Œë“œ', type:'text'},
      {key:'startDate', label:'ì‹œì‘ì¼', type:'date'},
      {key:'endDate', label:'ì¢…ë£Œì¼', type:'date'},
      {key:'cost', label:'ì‘ì—…ë¹„', type:'number'},
      {key:'tax', label:'ì„¸ê¸ˆ', type:'select', options:['ë°œí–‰','ë¯¸ë°œí–‰']},
      {key:'note', label:'ë¹„ê³ ', type:'text'}
    ]
  },
  blog: {
    name: 'ë¸”ë¡œê·¸ ì‘ì—…',
    path: 'blog',
    fields: [
      {key:'product', label:'ìƒí’ˆ', type:'select', options:['ë¸”ë¡œê·¸','ì¹´í˜','ì²´í—˜ë‹¨','ì–¸ë¡ ê¸°ì‚¬']},
      {key:'category', label:'êµ¬ë¶„', type:'select', options:['ë¸”ë¡œê·¸ë¦¬ë·°','ë‹¨ìˆœë°°í¬','ê±´ë°”ì´','ì›”ë³´ì¥','ì¼ë°˜í˜•','í”„ë¦¬ë¯¸ì—„í˜•','ë¦´ìŠ¤']},
      {key:'client', label:'ì—…ì²´ëª…', type:'text'},
      {key:'mid', label:'Mid', type:'url'},
      {key:'keywords', label:'í‚¤ì›Œë“œ', type:'text'},
      {key:'dateRange', label:'ì‹œì‘ì¼~ì¢…ë£Œì¼', type:'daterange'},
      {key:'quantity', label:'ìˆ˜ëŸ‰', type:'number'},
      {key:'days', label:'ì¼ìˆ˜', type:'number'},
      {key:'unitPrice', label:'ë‹¨ê°€', type:'number'},
      {key:'totalQty', label:'ì´ëŸ‰', type:'computed'},
      {key:'cost', label:'ì‘ì—…ë¹„', type:'computed'},
      {key:'tax', label:'ì„¸ê¸ˆ', type:'select', options:['ë°œí–‰','ë¯¸ë°œí–‰']},
      {key:'note', label:'ë¹„ê³ ', type:'text'}
    ]
  }
};

function getCurrentConfig() {
  const key = state.currentType === 'place' ? `place_${state.currentSubtype}` : state.currentType;
  return CONFIGS[key];
}

function getCurrentKey() {
  return state.currentType === 'place' ? `place_${state.currentSubtype}` : state.currentType;
}

function initFirebase() {
  if (!USE_FIREBASE) {
    console.log('ğŸ”§ ë¡œì»¬ ëª¨ë“œë¡œ ì‹¤í–‰ ì¤‘');
    updateConnectionStatus('local');
    Object.keys(CONFIGS).forEach(key => {
      state.rows[key] = [];
      state.filters[key] = {};
    });
    render();
    return false;
  }

  try {
    if (typeof firebase !== 'undefined') {
      console.log('âœ… Firebase SDK ë¡œë“œ ì™„ë£Œ');
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      
      Object.keys(CONFIGS).forEach(key => {
        dataRefs[key] = db.ref(CONFIGS[key].path);
        state.rows[key] = [];
        state.filters[key] = {};
        setupFirebaseListeners(key);
        loadFromFirebase(key);
      });
      
      db.ref('.info/connected').on('value', (snapshot) => {
        state.isFirebaseConnected = snapshot.val() === true;
        updateConnectionStatus(state.isFirebaseConnected ? 'connected' : 'disconnected');
      });
      
      return true;
    } else {
      console.error('âŒ Firebase SDKê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
      state.useFirebase = false;
      updateConnectionStatus('local');
      return false;
    }
  } catch(error) {
    console.error('âŒ Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
    state.useFirebase = false;
    updateConnectionStatus('local');
    return false;
  }
}

function updateConnectionStatus(status) {
  const statusEl = $('#connectionStatus');
  const textEl = $('#connectionText');
  const chipEl = $('#modeChip');
  
  statusEl.classList.remove('connected', 'disconnected', 'local');
  
  if (status === 'connected') {
    statusEl.classList.add('connected');
    textEl.textContent = 'ğŸ”¥ ì‹¤ì‹œê°„ ë™ê¸°í™” í™œì„±í™”';
    chipEl.textContent = 'ì‘ì—… ëŒ€ì‹œë³´ë“œ (ì‹¤ì‹œê°„ ë™ê¸°í™”)';
  } else if (status === 'disconnected') {
    statusEl.classList.add('disconnected');
    textEl.textContent = 'âŒ ì˜¤í”„ë¼ì¸';
    chipEl.textContent = 'ì‘ì—… ëŒ€ì‹œë³´ë“œ (ì˜¤í”„ë¼ì¸)';
  } else {
    statusEl.classList.add('local');
    textEl.textContent = 'ğŸ’¾ ë¡œì»¬ ëª¨ë“œ';
    chipEl.textContent = 'ì‘ì—… ëŒ€ì‹œë³´ë“œ (ë¡œì»¬ ì €ì¥)';
  }
}

function mk(p, config) {
  const id = p.id || 'r_'+Math.random().toString(36).slice(2,9);
  const createdAt = p.createdAt || new Date().toISOString();
  const row = {id, createdAt, ...p};
  
  if (config.fields.find(f => f.key === 'totalQty' && f.type === 'computed')) {
    if (row.units !== undefined && row.days !== undefined) {
      row.totalQty = (row.units||0) * (row.days||0);
    } else if (row.quantity !== undefined && row.days !== undefined) {
      row.totalQty = (row.quantity||0) * (row.days||0);
    }
  }
  
  if (config.fields.find(f => f.key === 'cost' && f.type === 'computed')) {
    if (row.cost === undefined || row.cost === null) {
      row.cost = (row.totalQty||0) * (row.unitPrice||0);
    }
  }
  
  return row;
}

function setupFirebaseListeners(key) {
  if (!dataRefs[key]) return;
  
  dataRefs[key].on('child_added', (snapshot) => {
    const data = snapshot.val();
    if (data && !state.rows[key].find(r => r.id === data.id)) {
      state.rows[key].unshift(mk(data, CONFIGS[key]));
      if (getCurrentKey() === key) render();
    }
  });

  dataRefs[key].on('child_changed', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      const index = state.rows[key].findIndex(r => r.id === data.id);
      if (index !== -1) {
        state.rows[key][index] = mk(data, CONFIGS[key]);
        if (getCurrentKey() === key) render();
      }
    }
  });

  dataRefs[key].on('child_removed', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      state.rows[key] = state.rows[key].filter(r => r.id !== data.id);
      state.selected.delete(data.id);
      if (getCurrentKey() === key) render();
    }
  });
}

function saveToFirebase(row, key) {
  if (!state.useFirebase || !dataRefs[key]) return;
  if (!row.id) return;
  
  dataRefs[key].child(row.id).set(row)
    .then(() => console.log('âœ… Firebase ì €ì¥ ì™„ë£Œ:', row.id))
    .catch(error => {
      console.error('âŒ Firebase ì €ì¥ ì‹¤íŒ¨:', error);
      alert('ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
    });
}

function deleteFromFirebase(id, key) {
  if (!state.useFirebase || !dataRefs[key]) return;
  
  dataRefs[key].child(id).remove()
    .catch(error => {
      console.error('âŒ Firebase ì‚­ì œ ì‹¤íŒ¨:', error);
      alert('ë°ì´í„° ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    });
}

function loadFromFirebase(key) {
  if (!dataRefs[key]) return;
  
  dataRefs[key].once('value')
    .then((snapshot) => {
      const data = snapshot.val();
      if (data) {
        state.rows[key] = Object.values(data).map(d => mk(d, CONFIGS[key]));
        console.log(`âœ… ${CONFIGS[key].name} ë°ì´í„° ë¡œë“œ:`, state.rows[key].length, 'ê°œ');
        if (getCurrentKey() === key) render();
      }
    })
    .catch(error => {
      console.error(`âŒ ${CONFIGS[key].name} ë¡œë“œ ì‹¤íŒ¨:`, error);
    });
}

function switchType(type, subtype = null) {
  state.currentType = type;
  if (subtype) state.currentSubtype = subtype;
  
  $$('.tab').forEach(t => t.classList.remove('active'));
  $(`.tab[data-type="${type}"]`).classList.add('active');
  
  if (type === 'place') {
    $('#placeSubtabs').style.display = 'flex';
    $$('.subtab').forEach(t => t.classList.remove('active'));
    $(`.subtab[data-subtype="${state.currentSubtype}"]`).classList.add('active');
  } else {
    $('#placeSubtabs').style.display = 'none';
  }
  
  state.selected.clear();
  render();
}

function renderFilters() {
  const config = getCurrentConfig();
  const container = $('#filtersContainer');
  
  let html = '<div class="filters">';
  html += '<input id="q" placeholder="ğŸ” ê²€ìƒ‰" autocomplete="off">';
  
  config.fields.forEach(field => {
    if (field.type === 'select' && field.key !== 'tax') {
      html += `<select id="f${field.key}">
        <option value="all">${field.label}: ì „ì²´</option>
        ${field.options.map(opt => `<option>${opt}</option>`).join('')}
      </select>`;
    }
  });
  
  html += `<select id="fTax">
    <option value="all">ì„¸ê¸ˆê³„ì‚°ì„œ: ì „ì²´</option>
    <option value="yes">ë°œí–‰</option>
    <option value="no">ë¯¸ë°œí–‰</option>
  </select>`;
  
  html += `<input type="date" id="fDate">`;
  html += `<select id="sortSel">
    <option value="date_desc">ì •ë ¬: ìµœì‹ ì¼ì</option>
    <option value="date_asc">ì •ë ¬: ì˜¤ë˜ëœì¼ì</option>
    <option value="cost_desc">ì •ë ¬: ì‘ì—…ë¹„ â¬‡</option>
    <option value="cost_asc">ì •ë ¬: ì‘ì—…ë¹„ â¬†</option>
  </select>`;
  
  html += '<div class="filter-reset-all"><button class="btn small outline" id="resetFiltersBtn">ğŸ”„ í•„í„° ì´ˆê¸°í™”</button></div>';
  html += '</div>';
  
  container.innerHTML = html;
  bindFilterEvents();
}

function renderTable() {
  const config = getCurrentConfig();
  const key = getCurrentKey();
  const rows = state.rows[key] || [];
  
  $('#listTitle').textContent = `ğŸ“‹ ${config.name}`;
  
  let theadHtml = '<tr><th class="center"><input type="checkbox" id="chkAll" class="select-row"></th>';
  config.fields.forEach(field => {
    const align = field.type === 'number' || field.type === 'computed' ? 'num' : '';
    theadHtml += `<th class="${align}">${field.label}</th>`;
  });
  theadHtml += '<th class="center">âš™ï¸</th></tr>';
  $('#thead').innerHTML = theadHtml;
  
  const tbody = $('#tbody');
  tbody.innerHTML = '';
  
  const {perPage, currentPage} = state.pagination;
  const startIdx = (currentPage - 1) * perPage;
  const pageRows = rows.slice(startIdx, startIdx + perPage);
  
  pageRows.forEach(row => {
    const tr = document.createElement('tr');
    
    const tdSel = document.createElement('td');
    tdSel.className = 'center';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'select-row';
    cb.checked = state.selected.has(row.id);
    cb.onchange = () => {
      if (cb.checked) state.selected.add(row.id);
      else state.selected.delete(row.id);
      updateBulkEditBar();
    };
    tdSel.appendChild(cb);
    tr.appendChild(tdSel);
    
    config.fields.forEach(field => {
      const td = document.createElement('td');
      
      if (field.type === 'computed') {
        if (field.key === 'totalQty') {
          td.textContent = row.totalQty || '';
          td.className = 'num';
        } else if (field.key === 'cost') {
          td.textContent = fmtMoney(row.cost || 0);
          td.className = 'num';
        }
      } else if (field.type === 'url') {
        td.className = 'url nowrap';
        if (row[field.key]) {
          const a = document.createElement('a');
          a.href = row[field.key];
          a.target = '_blank';
          a.textContent = 'ì—´ê¸°';
          td.appendChild(a);
        }
        td.onclick = () => startEdit(td, row, field, key);
      } else if (field.type === 'number') {
        td.textContent = row[field.key] ?? '';
        td.className = 'num';
        td.onclick = () => startEdit(td, row, field, key);
      } else if (field.key === 'tax') {
        td.textContent = row[field.key] || '';
        td.className = 'center ' + (row[field.key] === 'ë°œí–‰' ? 'badge-yes' : 'badge-no');
        td.onclick = () => startEdit(td, row, field, key);
      } else {
        td.textContent = row[field.key] ?? '';
        td.className = 'nowrap';
        td.onclick = () => startEdit(td, row, field, key);
      }
      
      tr.appendChild(td);
    });
    
    const tdAct = document.createElement('td');
    tdAct.className = 'center';
    
    const delBtn = document.createElement('button');
    delBtn.className = 'btn small danger';
    delBtn.textContent = 'ì‚­ì œ';
    delBtn.onclick = () => {
      if (confirm('ì‚­ì œí• ê¹Œìš”?')) {
        state.rows[key] = state.rows[key].filter(r => r.id !== row.id);
        state.selected.delete(row.id);
        deleteFromFirebase(row.id, key);
        render();
      }
    };
    
    tdAct.appendChild(delBtn);
    tr.appendChild(tdAct);
    tbody.appendChild(tr);
  });
  
  $('#countInfo').textContent = `${rows.length}ê±´`;
  updateBulkEditBar();
  
  $('#chkAll').onchange = e => {
    if (e.target.checked) rows.forEach(r => state.selected.add(r.id));
    else rows.forEach(r => state.selected.delete(r.id));
    renderTable();
  };
}

function startEdit(td, row, field, key) {
  const old = row[field.key] ?? '';
  let el;
  
  if (field.type === 'select') {
    el = document.createElement('select');
    el.className = 'cell-editor';
    el.innerHTML = field.options.map(v => `<option>${v}</option>`).join('');
    el.value = old;
  } else {
    el = document.createElement('input');
    el.className = 'cell-editor';
    el.type = field.type === 'number' ? 'number' : field.type === 'url' ? 'url' : 'text';
    el.value = old;
    if (field.type === 'number') el.step = 'any';
  }
  
  td.innerHTML = '';
  td.appendChild(el);
  el.focus();
  if (el.select) el.select();
  
  const commit = () => {
    let v = el.value;
    if (field.type === 'number') v = parseNum(v);
    row[field.key] = v || '';
    
    const config = getCurrentConfig();
    if (config.fields.find(f => f.key === 'totalQty' && f.type === 'computed')) {
      if (row.units !== undefined && row.days !== undefined) {
        row.totalQty = (row.units||0) * (row.days||0);
      } else if (row.quantity !== undefined && row.days !== undefined) {
        row.totalQty = (row.quantity||0) * (row.days||0);
      }
    }
    if (config.fields.find(f => f.key === 'cost' && f.type === 'computed')) {
      row.cost = (row.totalQty||0) * (row.unitPrice||0);
    }
    
    saveToFirebase(row, key);
    render();
  };
  
  el.onkeydown = e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      commit();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      render();
    }
  };
  el.onblur = commit;
}

function updateBulkEditBar() {
  $('#bulkEditBar').classList.toggle('active', state.selected.size > 0);
  $('#selectedCount').textContent = `${state.selected.size}ê°œ ì„ íƒ`;
}

function openAddModal() {
  const config = getCurrentConfig();
  const form = $('#addForm');
  
  let html = '';
  config.fields.forEach(field => {
    if (field.type === 'computed') return;
    
    const divClass = field.key === 'client' || field.key === 'mid' || field.key === 'keywords' || field.key === 'note' || field.key === 'url' ? 'full' : '';
    html += `<div class="${divClass}"><label>${field.label}</label>`;
    
    if (field.type === 'select') {
      html += `<select id="a${field.key}" required>`;
      html += '<option value="">ì„ íƒ</option>';
      field.options.forEach(opt => {
        html += `<option>${opt}</option>`;
      });
      html += '</select>';
    } else if (field.type === 'daterange') {
      html += `<input id="a${field.key}Start" type="date" placeholder="ì‹œì‘ì¼">`;
      html += `<input id="a${field.key}End" type="date" placeholder="ì¢…ë£Œì¼" style="margin-top:8px">`;
    } else {
      const inputType = field.type === 'number' ? 'number' : field.type === 'url' ? 'url' : field.type === 'date' ? 'date' : 'text';
      const req = field.key === 'client' ? 'required' : '';
      html += `<input id="a${field.key}" type="${inputType}" ${req}>`;
    }
    
    html += '</div>';
  });
  
  html += `<div class="full" style="display:flex; gap:12px; justify-content:flex-end; margin-top:8px">
    <button type="button" class="btn outline" onclick="resetAddForm()">ğŸ”„ ì´ˆê¸°í™”</button>
    <button type="submit" class="btn">âœ“ ë“±ë¡</button>
  </div>`;
  
  form.innerHTML = html;
  $('#addModalBack').classList.add('active');
  
  form.onsubmit = e => {
    e.preventDefault();
    const key = getCurrentKey();
    const config = getCurrentConfig();
    const data = {};
    
    config.fields.forEach(field => {
      if (field.type === 'computed') return;
      
      if (field.type === 'daterange') {
        data.startDate = $(`#a${field.key}Start`).value;
        data.endDate = $(`#a${field.key}End`).value;
      } else {
        const el = $(`#a${field.key}`);
        if (el) {
          data[field.key] = field.type === 'number' ? parseNum(el.value) : el.value;
        }
      }
    });
    
    const newRow = mk(data, config);
    state.rows[key].unshift(newRow);
    saveToFirebase(newRow, key);
    render();
    closeAddModal();
  };
}

function closeAddModal() {
  $('#addModalBack').classList.remove('active');
}

function resetAddForm() {
  $('#addForm').reset();
}

function exportExcel() {
  if (!state.selected.size) return alert('í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”');
  
  const key = getCurrentKey();
  const config = getCurrentConfig();
  const selected = state.rows[key].filter(r => state.selected.has(r.id));
  
  const data = selected.map(row => {
    const obj = {ID: row.id};
    config.fields.forEach(field => {
      obj[field.label] = row[field.key] ?? '';
    });
    obj['ìƒì„±ì¼ì‹œ'] = row.createdAt || '';
    return obj;
  });
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, config.name);
  XLSX.writeFile(wb, `${config.name}_${today()}.xlsx`);
  alert(`${selected.length}ê°œ í•­ëª© ë‚´ë³´ë‚´ê¸° ì™„ë£Œ`);
}

function bindFilterEvents() {
  $('#q').oninput = e => render();
  $('#fDate').onchange = e => render();
  $('#sortSel').onchange = e => render();
  
  $$('select[id^="f"]').forEach(sel => {
    if (sel.id !== 'fDate' && sel.id !== 'fTax') {
      sel.onchange = () => render();
    }
  });
  
  $('#fTax').onchange = () => render();
  
  $('#resetFiltersBtn').onclick = () => {
    $('#q').value = '';
    $('#fDate').value = '';
    $$('select[id^="f"]').forEach(s => s.value = 'all');
    $('#sortSel').value = 'date_desc';
    render();
  };
}

function render() {
  renderFilters();
  renderTable();
}

function bindEvents() {
  $$('.tab').forEach(tab => {
    tab.onclick = () => {
      const type = tab.dataset.type;
      switchType(type, type === 'place' ? 'reward' : null);
    };
  });
  
  $$('.subtab').forEach(subtab => {
    subtab.onclick = () => {
      const subtype = subtab.dataset.subtype;
      switchType('place', subtype);
    };
  });
  
  $('#openAddModalBtn').onclick = openAddModal;
  $('#removeSelectedBtn').onclick = () => {
    if (!state.selected.size) return alert('í•­ëª©ì„ ì„ íƒí•˜ì„¸ìš”');
    if (confirm(`${state.selected.size}ê±´ ì‚­ì œ?`)) {
      const key = getCurrentKey();
      state.rows[key] = state.rows[key].filter(r => {
        if (state.selected.has(r.id)) {
          deleteFromFirebase(r.id, key);
          return false;
        }
        return true;
      });
      state.selected.clear();
      render();
    }
  };
  
  $('#themeBtn').onclick = () => {
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    state.prefs.theme = next;
  };
  
  $('#exportExcelBtn').onclick = exportExcel;
  $('#perPageSelect').onchange = e => {
    state.pagination.perPage = parseInt(e.target.value, 10);
    state.pagination.currentPage = 1;
    render();
  };
}

window.addEventListener('DOMContentLoaded', () => {
  const pd = matchMedia && matchMedia('(prefers-color-scheme: dark)').matches;
  document.documentElement.setAttribute('data-theme', pd ? 'dark' : 'light');
  
  initFirebase();
  bindEvents();
  render();
});
</script>
</body>
</html>
