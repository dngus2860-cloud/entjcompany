<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<title>엔티제컴퍼니 · 작업 대시보드</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

<style>
  :root{
    --bg:#0f0f23; --panel:#1a1a2e; --card:#16213e; --card2:#1f2d47;
    --text:#e4e8f0; --muted:#8b94a8; --border:#2a3551; --chip:#2d3a5c;
    --primary:#6366f1; --primary-light:#818cf8; --green:#22c55e; --red:#ef4444; --amber:#f59e0b;
    --shadow:0 20px 60px rgba(0,0,0,0.5);
    --gradient-1:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  [data-theme="light"]{
    --bg:#f5f7fa; --panel:#ffffff; --card:#ffffff; --card2:#f8fafc;
    --text:#1e293b; --muted:#64748b; --border:#e2e8f0; --chip:#e0e7ff;
    --primary:#6366f1; --primary-light:#818cf8; --green:#16a34a; --red:#dc2626; --amber:#d97706;
    --shadow:0 10px 40px rgba(0,0,0,0.08);
  }

  *{box-sizing:border-box; margin:0; padding:0}
  html,body{max-width:100%; overflow-x:hidden; background:var(--bg); color:var(--text)}
  body{font-family:'Pretendard',-apple-system,system-ui,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif; line-height:1.6}
  img,canvas,svg,video{max-width:100%; height:auto; display:block}

  .wrap{max-width:1600px; margin:0 auto; padding:24px; display:grid; gap:20px}

  .connection-status {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    z-index: 1000;
    display: flex;
    align-items: center;
    gap: 8px;
    box-shadow: var(--shadow);
  }
  .connection-status.connected {
    background: var(--green);
    color: white;
  }
  .connection-status.disconnected {
    background: var(--red);
    color: white;
  }
  .connection-status.local {
    background: var(--amber);
    color: white;
  }
  .connection-status .indicator {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: white;
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  header{
    background:var(--panel); border:1px solid var(--border); border-radius:20px;
    padding:24px 32px; box-shadow:var(--shadow); display:flex;
    align-items:center; justify-content:space-between; position:relative; overflow:hidden
  }
  header::before{content:''; position:absolute; top:0; left:0; right:0; height:4px; background:var(--gradient-1)}
  .brand{display:flex; align-items:center; gap:16px}
  .brand .icon{font-size:36px; filter:drop-shadow(0 4px 8px rgba(99,102,241,0.4))}
  .brand h1{font-size:24px; font-weight:800; background:var(--gradient-1); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
  .chip{background:var(--chip); border:1px solid var(--border); color:var(--primary-light);
    padding:6px 14px; border-radius:999px; font-size:12px; font-weight:600}

  .btn{background:var(--primary); color:#fff; border:none; padding:10px 20px;
    border-radius:12px; cursor:pointer; font-weight:600; font-size:14px;
    transition:all .3s; box-shadow:0 4px 12px rgba(99,102,241,.3)}
  .btn:hover{background:var(--primary-light); transform:translateY(-2px)}
  .btn.outline{background:transparent; color:var(--text); border:2px solid var(--border); box-shadow:none}
  .btn.outline:hover{border-color:var(--primary); color:var(--primary); background:rgba(99,102,241,.08)}
  .btn.danger{background:#ef4444}
  .btn.small{padding:8px 14px; font-size:13px}

  .tabs{display:flex; gap:8px; margin-bottom:20px; flex-wrap:wrap; align-items:center}
  .tab{padding:12px 24px; background:var(--card); border:2px solid var(--border); border-radius:12px;
    cursor:pointer; font-weight:600; font-size:14px; transition:all .3s; color:var(--muted)}
  .tab:hover{border-color:var(--primary-light); background:var(--card2)}
  .tab.active{background:var(--primary); color:#fff; border-color:var(--primary)}
  .subtabs{display:none; gap:6px; margin-left:12px}
  .subtabs.show{display:flex}
  .subtab{padding:8px 16px; background:var(--card2); border:2px solid var(--border); border-radius:10px;
    cursor:pointer; font-size:13px; font-weight:600; transition:all .3s; color:var(--muted)}
  .subtab:hover{border-color:var(--primary-light)}
  .subtab.active{background:var(--primary-light); color:#fff; border-color:var(--primary-light)}

  .panel{background:var(--panel); border:1px solid var(--border); border-radius:20px; box-shadow:var(--shadow); overflow:hidden}
  .panel .h{padding:20px 28px; border-bottom:1px solid var(--border); display:flex;
    align-items:center; justify-content:space-between; background:linear-gradient(to right, rgba(99,102,241,.05), transparent)}
  .panel .h strong{font-size:18px; font-weight:700}
  .panel .b{padding:24px 28px}

  .filters{display:grid; grid-template-columns:2fr 1fr 1fr 1fr 1fr 1fr; gap:12px; align-items:center}
  @media (max-width:1100px){.filters{grid-template-columns:1fr 1fr}}

  .filter-input-wrapper{position:relative}
  input, select{width:100%; padding:12px 16px; border-radius:12px; border:2px solid var(--border);
    background:var(--card); color:var(--text); font-size:14px; font-weight:500; transition:all .3s}
  input:focus, select:focus{outline:none; border-color:var(--primary); box-shadow:0 0 0 3px rgba(99,102,241,.1)}

  .period-btns{display:flex; gap:6px}
  .period-btn{padding:8px 16px; font-size:13px; font-weight:600; border-radius:10px;
    border:2px solid var(--border); background:var(--card); color:var(--muted); cursor:pointer; transition:all .3s}
  .period-btn.active{background:var(--primary); color:#fff; border-color:var(--primary)}
  .period-btn:hover:not(.active){background:var(--card2); border-color:var(--primary-light)}

  .toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .sep{height:1px; background:var(--border); margin:20px 0}
  .muted{color:var(--muted); font-size:13px}

  .table-wrap{width:100%; overflow-x:auto; -webkit-overflow-scrolling:touch}
  table{width:100%; border-collapse:separate; border-spacing:0; min-width:980px}
  thead th{position:sticky; top:0; background:var(--card2); z-index:2; border-bottom:2px solid var(--border);
    padding:14px 12px; font-size:13px; font-weight:700; text-transform:uppercase; letter-spacing:.5px; color:var(--muted); white-space:nowrap}
  tbody tr{transition:all .2s; border-bottom:1px solid var(--border)}
  tbody tr:hover{background:var(--card2); transform:scale(1.001)}
  td{padding:14px 12px; font-size:14px; vertical-align:middle}
  .num{text-align:right; font-variant-numeric:tabular-nums; font-weight:600}
  .center{text-align:center}
  .nowrap{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:260px}
  .url a{color:var(--primary-light); text-decoration:none; font-weight:600; transition:color .2s}
  .url a:hover{color:var(--primary); text-decoration:underline}
  .select-row{width:18px; height:18px; cursor:pointer}

  tr.deadline-d0{border-left:4px solid var(--red); background:rgba(239,68,68,.15); animation:blinkRed 2s ease-in-out infinite}
  @keyframes blinkRed{0%,100%{background:rgba(239,68,68,.15)} 50%{background:rgba(239,68,68,.35)}}
  
  tr.deadline-d1{border-left:4px solid var(--amber); background:rgba(245,158,11,.15); animation:blinkYellow 2s ease-in-out infinite}
  @keyframes blinkYellow{0%,100%{background:rgba(245,158,11,.15)} 50%{background:rgba(245,158,11,.35)}}
  
  tr.deadline-d23{border-left:4px solid var(--green); background:rgba(34,197,94,.15); animation:blinkGreen 2s ease-in-out infinite}
  @keyframes blinkGreen{0%,100%{background:rgba(34,197,94,.15)} 50%{background:rgba(34,197,94,.35)}}

  .cell-editor{width:100%; border-radius:8px; padding:8px 12px; border:2px solid var(--primary); background:var(--card); color:var(--text); font-size:14px}
  .badge-yes{color:var(--green); font-weight:700}
  .badge-no{color:var(--amber); font-weight:700}

  .bulk-edit-bar{background:linear-gradient(135deg, rgba(99,102,241,.1), rgba(139,92,246,.1));
    border:2px solid var(--primary); border-radius:16px; padding:16px 20px; margin-bottom:16px;
    display:none; align-items:center; gap:16px; animation:slideDown .3s}
  .bulk-edit-bar.active{display:flex}
  @keyframes slideDown{from{opacity:0; transform:translateY(-10px)} to{opacity:1; transform:translateY(0)}}

  .pagination-wrapper{display:flex; align-items:center; justify-content:space-between; padding:20px 0; gap:16px; flex-wrap:wrap}
  .pagination{display:flex; gap:8px; align-items:center}
  .page-btn{min-width:36px; height:36px; padding:0 12px; border:2px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; cursor:pointer; font-weight:600; transition:all .3s}
  .page-btn:hover:not(.active):not(:disabled){border-color:var(--primary); background:var(--card2)}
  .page-btn.active{background:var(--primary); color:#fff; border-color:var(--primary)}
  .page-btn:disabled{opacity:.3; cursor:not-allowed}
  .per-page-selector{display:flex; align-items:center; gap:10px}
  .per-page-selector select{width:auto; padding:8px 12px}

  .kpis{display:grid; grid-template-columns:repeat(4,1fr); gap:12px}
  @media (max-width:800px){.kpis{grid-template-columns:repeat(2,1fr)}}
  .kpi{padding:18px; background:var(--card2); border:2px solid var(--border); border-radius:16px; transition:all .3s; position:relative; overflow:hidden}
  .kpi::before{content:''; position:absolute; top:0; left:0; right:0; height:3px; background:var(--gradient-1); opacity:0; transition:opacity .3s}
  .kpi:hover{border-color:var(--primary); transform:translateY(-2px)}
  .kpi:hover::before{opacity:1}
  .kpi .v{font-weight:900; font-size:24px; background:var(--gradient-1); -webkit-background-clip:text; -webkit-text-fill-color:transparent}

  .bars{display:flex; align-items:flex-end; gap:10px; height:180px; padding:12px; border:2px solid var(--border); border-radius:16px; background:var(--card2); overflow-x:auto}
  .bars .col{flex:1; display:flex; flex-direction:column; align-items:center; gap:8px; min-width:60px}
  .bars .bar{width:100%; max-width:50px; background:var(--gradient-1); border:2px solid var(--border); border-radius:12px 12px 6px 6px; height:10%; box-shadow:0 4px 12px rgba(99,102,241,.2); transition:all .3s}
  .bars .col:hover .bar{transform:translateY(-4px)}
  .bar-value{font-size:13px; font-weight:700; color:var(--text); margin-bottom:4px}
  .note{font-size:11px; color:var(--muted); font-weight:600}
  .product-멘토스 .bar{background:linear-gradient(180deg,#8B5CF6,#7C3AED)!important}
  .product-호올스 .bar{background:linear-gradient(180deg,#C4B5FD,#A78BFA)!important}
  .product-말차 .bar{background:linear-gradient(180deg,#10B981,#059669)!important}
  .product-블로그 .bar{background:linear-gradient(180deg,#3B82F6,#2563EB)!important}
  .product-카인드 .bar{background:linear-gradient(180deg,#F59E0B,#D97706)!important}

  .monthly-summary{font-size:14px; line-height:1.8}
  .month-item{margin-bottom:8px; padding:8px 12px; background:var(--card2); border-radius:10px; border-left:3px solid var(--primary); transition:all .2s; cursor:pointer; display:flex; justify-content:space-between; align-items:center}
  .month-item:hover{background:var(--card); transform:translateX(4px)}
  .month-item-icon{color:var(--primary); font-size:16px; opacity:.6; transition:opacity .2s}
  .month-item:hover .month-item-icon{opacity:1}

  .modal-back{position:fixed; inset:0; background:rgba(0,0,0,.7); backdrop-filter:blur(4px); display:none; align-items:center; justify-content:center; z-index:1000; padding:16px}
  .modal-back.active{display:flex}
  .modal{background:var(--panel); border:2px solid var(--border); border-radius:24px; box-shadow:0 30px 80px rgba(0,0,0,.6); width:900px; max-width:100%; max-height:90vh; overflow:auto; animation:modalIn .3s}
  @keyframes modalIn{from{opacity:0; transform:scale(.9) translateY(20px)} to{opacity:1; transform:scale(1) translateY(0)}}
  .modal .mh{padding:24px 28px; border-bottom:2px solid var(--border); display:flex; align-items:center; justify-content:space-between; background:linear-gradient(to right, rgba(99,102,241,.05), transparent)}
  .modal .mh strong{font-size:20px; font-weight:800}
  .modal .mb{padding:28px}
  .form-grid{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  .form-grid .full{grid-column:1/-1}
  .form-grid label{display:block; font-size:13px; font-weight:600; color:var(--muted); margin-bottom:6px; text-transform:uppercase; letter-spacing:.5px}
  
  .chart-modal-content{width:600px}
  .chart-modal-close{position:absolute; top:20px; right:20px; width:32px; height:32px; border-radius:50%; background:var(--card2); border:2px solid var(--border); color:var(--text); cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:18px; transition:all .2s}
  .chart-modal-close:hover{background:var(--red); color:#fff; transform:rotate(90deg)}
  .chart-title{font-size:20px; font-weight:800; margin-bottom:24px; text-align:center}
  .pie-chart-container{display:flex; justify-content:center; margin:20px 0}
  .pie-legend{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:24px}
  .pie-legend-item{display:flex; align-items:center; gap:10px; padding:8px 12px; background:var(--card2); border-radius:10px; transition:all .2s}
  .pie-legend-item:hover{background:var(--card); transform:translateX(2px)}
  .pie-legend-color{width:20px; height:20px; border-radius:6px; border:2px solid var(--border)}
  .pie-legend-info{flex:1}
  .pie-legend-label{font-size:13px; font-weight:600}
  .pie-legend-value{font-size:12px; color:var(--muted)}
</style>
</head>
<body>
<div class="connection-status local" id="connectionStatus">
  <span class="indicator"></span>
  <span id="connectionText">연결 중...</span>
</div>

<div class="wrap" id="app">
  <header>
    <div class="brand">
      <span class="icon" aria-hidden="true">💼</span>
      <div>
        <h1>엔티제컴퍼니</h1>
        <span class="chip" id="modeChip">작업 대시보드</span>
      </div>
    </div>
    <div class="toolbar">
      <button class="btn outline" id="exportExcelBtn">📊 엑셀 내보내기</button>
      <button class="btn" id="themeBtn">🌓 테마 전환</button>
    </div>
  </header>

  <div class="tabs">
    <div class="tab active" data-type="place">
      📍 플레이스 작업
    </div>
    <div class="subtabs show" id="placeSubtabs">
      <div class="subtab active" data-subtype="reward">리워드</div>
      <div class="subtab" data-subtype="distribute">배포</div>
    </div>
    <div class="tab" data-type="blog">
      📝 블로그 작업
    </div>
    <div class="tab" data-type="finance">
      💰 매출/매입
    </div>
  </div>

  <section class="panel">
    <div class="h">
      <strong>🔍 필터</strong>
    </div>
    <div class="b">
      <div id="filtersContainer"></div>
    </div>
  </section>

  <section class="panel">
    <div class="h">
      <strong id="listTitle">📋 작업 목록</strong>
      <div class="toolbar">
        <span class="muted" id="countInfo">0건</span>
        <button class="btn small" id="openAddModalBtn">➕ 새 항목</button>
        <button class="btn danger small" id="removeSelectedBtn">🗑️ 선택 삭제</button>
      </div>
    </div>
    <div class="b">
      <div class="bulk-edit-bar" id="bulkEditBar">
        <span class="muted" id="selectedCount">0개 선택</span>
        <button class="btn small" id="bulkEditBtn">✏️ 일괄수정</button>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="pagination-wrapper">
        <div class="per-page-selector">
          <span class="muted">페이지당 표시:</span>
          <select id="perPageSelect">
            <option value="30" selected>30개</option>
            <option value="50">50개</option>
            <option value="100">100개</option>
          </select>
        </div>
        <div class="pagination" id="pagination"></div>
      </div>
    </div>
  </section>

  <section class="panel">
    <div class="h"><strong>📊 데이터 요약</strong></div>
    <div class="b">
      <div class="kpis">
        <div class="kpi"><div class="muted">총 건수</div><div class="v" id="kpiCount">0</div></div>
        <div class="kpi"><div class="muted">총 작업량</div><div class="v" id="kpiQty">0</div></div>
        <div class="kpi"><div class="muted">총 작업비</div><div class="v" id="kpiCost">₩0</div></div>
        <div class="kpi"><div class="muted">평균 단가</div><div class="v" id="kpiAvg">₩0</div></div>
      </div>
      <div class="sep"></div>
      <div class="toolbar"><strong>📈 상품별 총 작업비</strong></div>
      <div class="bars" id="barsByProduct"></div>
      <div class="sep"></div>
      <div class="toolbar"><strong>💰 월 총 작업비</strong><span class="note">(클릭하여 상세 보기)</span></div>
      <div class="monthly-summary" id="monthlyCost"></div>
    </div>
  </section>
</div>

<div class="modal-back" id="chartModal" role="dialog" aria-modal="true" aria-labelledby="chartTitle">
  <div class="modal chart-modal-content">
    <button class="chart-modal-close" id="closeChartModal" aria-label="차트 닫기">✕</button>
    <div class="chart-title" id="chartTitle">월별 상품 분석</div>
    <div class="pie-chart-container">
      <canvas id="pieChart" width="300" height="300"></canvas>
    </div>
    <div class="pie-legend" id="pieLegend"></div>
  </div>
</div>

<div class="modal-back" id="addModalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mh">
      <strong id="modalTitle">➕ 새 항목 등록</strong>
      <button class="btn small outline" onclick="closeAddModal()">✕ 닫기</button>
    </div>
    <div class="mb">
      <form id="addForm" class="form-grid"></form>
    </div>
  </div>
</div>

<div class="modal-back" id="bulkEditModalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="mh">
      <strong>✏️ 일괄수정</strong>
      <button class="btn small outline" onclick="closeBulkEditModal()">✕ 닫기</button>
    </div>
    <div class="mb">
      <div class="muted" style="margin-bottom:16px">선택된 <strong id="bulkCountText">0</strong>개 항목을 일괄 수정합니다.</div>
      <form id="bulkEditForm" class="form-grid"></form>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const USE_FIREBASE = true;

const firebaseConfig = {
  apiKey: "AIzaSyCV9pjrGzHEoc-s4ppz44lMba5BKE53VAs",
  authDomain: "entjcompany.firebaseapp.com",
  databaseURL: "https://entjcompany.firebaseio.com",
  projectId: "entjcompany",
  storageBucket: "entjcompany.firebasestorage.app",
  messagingSenderId: "567861521069",
  appId: "1:567861521069:web:084f0212f2931e2c9fb424",
  measurementId: "G-0F57YWZJPS"
};

const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
const fmtMoney = n => '₩' + Math.round(n||0).toLocaleString('ko-KR');
const parseNum = v => {
  if (v === '' || v == null) return null;
  const num = Number(v);
  return isNaN(num) ? null : num;
};
const toISO = d => {if(!d)return''; const z=new Date(d); return new Date(z - z.getTimezoneOffset()*60000).toISOString().slice(0,10)};
const today = () => toISO(new Date());

function getWeekNumber(d){
  const date=new Date(d); date.setHours(0,0,0,0);
  date.setDate(date.getDate()+4-(date.getDay()||7));
  const yearStart=new Date(date.getFullYear(),0,1);
  return {year:date.getFullYear(), week:Math.ceil((((date-yearStart)/86400000)+1)/7)};
}

function getYearMonth(d){const date=new Date(d); return `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}`}

const state = {
  currentType: 'place',
  currentSubtype: 'reward',
  rows: {},
  prefs: {theme:'auto'},
  filters: {},
  selected: new Set(),
  pagination: {currentPage:1, perPage:30},
  isFirebaseConnected: false,
  useFirebase: USE_FIREBASE
};

let db = null;
let dataRefs = {};

const CONFIGS = {
  place_reward: {
    name: '플레이스 작업 (리워드)',
    path: 'place_reward',
    fields: [
      {key:'product', label:'상품', type:'select', options:['멘토스','호올스','말차','신규','없음']},
      {key:'category', label:'구분', type:'select', options:['트래픽','저장','길찾기','영수증']},
      {key:'client', label:'업체명', type:'text', required:true},
      {key:'mid', label:'Mid', type:'url'},
      {key:'keywords', label:'키워드', type:'text'},
      {key:'startDate', label:'시작일', type:'date', required:true},
      {key:'endDate', label:'종료일', type:'date'},
      {key:'units', label:'일타', type:'number'},
      {key:'days', label:'일수', type:'number'},
      {key:'unitPrice', label:'단가', type:'number'},
      {key:'totalQty', label:'총량', type:'computed'},
      {key:'cost', label:'작업비', type:'computed'},
      {key:'tax', label:'세금', type:'select', options:['발행','미발행']},
      {key:'note', label:'비고', type:'text'}
    ]
  },
  place_distribute: {
    name: '플레이스 작업 (배포)',
    path: 'place_distribute',
    fields: [
      {key:'product', label:'상품', type:'select', options:['카인드','C_2','불금','신규']},
      {key:'client', label:'업체명', type:'text', required:true},
      {key:'url', label:'URL', type:'url'},
      {key:'category', label:'구분', type:'select', options:['정보성','후기성']},
      {key:'totalQty', label:'총 수량', type:'number'},
      {key:'dailyRelease', label:'일 발행', type:'number'},
      {key:'keywords', label:'키워드', type:'text'},
      {key:'startDate', label:'시작일', type:'date', required:true},
      {key:'endDate', label:'종료일', type:'date'},
      {key:'unitPrice', label:'단가', type:'number'},
      {key:'cost', label:'작업비', type:'computed'},
      {key:'tax', label:'세금', type:'select', options:['발행','미발행']},
      {key:'note', label:'비고', type:'text'}
    ]
  },
  blog: {
    name: '블로그 작업',
    path: 'blog',
    fields: [
      {key:'product', label:'상품', type:'select', options:['블로그','카페','체험단','언론기사']},
      {key:'category', label:'구분', type:'select', options:['블로그리뷰','단순배포','건바이','월보장','일반형','프리미엄형','블로그','릴스']},
      {key:'client', label:'업체명', type:'text', required:true},
      {key:'mid', label:'Mid', type:'url'},
      {key:'keywords', label:'키워드', type:'text'},
      {key:'startDate', label:'시작일', type:'date', required:true},
      {key:'endDate', label:'종료일', type:'date'},
      {key:'quantity', label:'수량', type:'number'},
      {key:'days', label:'일수', type:'number'},
      {key:'totalQty', label:'총량', type:'computed'},
      {key:'unitPrice', label:'단가', type:'number'},
      {key:'cost', label:'작업비', type:'computed'},
      {key:'tax', label:'세금', type:'select', options:['발행','미발행']},
      {key:'note', label:'비고', type:'text'}
    ]
  }
};

function getCurrentConfig() {
  const key = state.currentType === 'place' ? `place_${state.currentSubtype}` : state.currentType;
  return CONFIGS[key];
}

function getCurrentKey() {
  if (state.currentType === 'place') {
    return `place_${state.currentSubtype}`;
  }
  return state.currentType;
}

function initFirebase() {
  if (!USE_FIREBASE) {
    console.log('🔧 로컬 모드로 실행 중');
    updateConnectionStatus('local');
    Object.keys(CONFIGS).forEach(key => {
      state.rows[key] = [];
      state.filters[key] = {periodType:'day'};
    });
    render();
    return false;
  }

  try {
    if (typeof firebase !== 'undefined') {
      console.log('✅ Firebase SDK 로드 완료');
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      
      Object.keys(CONFIGS).forEach(key => {
        dataRefs[key] = db.ref(CONFIGS[key].path);
        state.rows[key] = [];
        state.filters[key] = {periodType:'day'};
        setupFirebaseListeners(key);
        loadFromFirebase(key);
      });
      
      db.ref('.info/connected').on('value', (snapshot) => {
        state.isFirebaseConnected = snapshot.val() === true;
        console.log(state.isFirebaseConnected ? '✅ Firebase 연결 성공!' : '❌ Firebase 연결 끊김');
        updateConnectionStatus(state.isFirebaseConnected ? 'connected' : 'disconnected');
      });
      
      return true;
    } else {
      console.error('❌ Firebase SDK가 로드되지 않았습니다');
      state.useFirebase = false;
      updateConnectionStatus('local');
      return false;
    }
  } catch(error) {
    console.error('❌ Firebase 초기화 실패:', error);
    state.useFirebase = false;
    updateConnectionStatus('local');
    return false;
  }
}

function updateConnectionStatus(status) {
  const statusEl = $('#connectionStatus');
  const textEl = $('#connectionText');
  const chipEl = $('#modeChip');
  
  statusEl.classList.remove('connected', 'disconnected', 'local');
  
  if (status === 'connected') {
    statusEl.classList.add('connected');
    textEl.textContent = '🔥 실시간 동기화 활성화';
    chipEl.textContent = '작업 대시보드 (실시간 동기화)';
  } else if (status === 'disconnected') {
    statusEl.classList.add('disconnected');
    textEl.textContent = '❌ 오프라인';
    chipEl.textContent = '작업 대시보드 (오프라인)';
  } else {
    statusEl.classList.add('local');
    textEl.textContent = '💾 로컬 모드';
    chipEl.textContent = '작업 대시보드 (로컬 저장)';
  }
}

function mk(p, config) {
  const id = p.id || 'r_'+Math.random().toString(36).slice(2,9);
  const createdAt = p.createdAt || new Date().toISOString();
  const row = {id, createdAt, ...p};
  
  if (config.fields.find(f => f.key === 'totalQty' && f.type === 'computed')) {
    if (row.units !== undefined && row.days !== undefined) {
      row.totalQty = (row.units||0) * (row.days||0);
    } else if (row.quantity !== undefined && row.days !== undefined) {
      row.totalQty = (row.quantity||0) * (row.days||0);
    }
  }
  
  if (config.fields.find(f => f.key === 'cost' && f.type === 'computed')) {
    if (row.cost === undefined || row.cost === null) {
      if (config.path === 'blog') {
        row.cost = (row.quantity||0) * (row.unitPrice||0);
      } else {
        row.cost = (row.totalQty||0) * (row.unitPrice||0);
      }
    }
  }
  
  return row;
}

function setupFirebaseListeners(key) {
  if (!dataRefs[key]) return;
  
  dataRefs[key].on('child_added', (snapshot) => {
    const data = snapshot.val();
    if (data && !state.rows[key].find(r => r.id === data.id)) {
      state.rows[key].unshift(mk(data, CONFIGS[key]));
      if (getCurrentKey() === key) render();
    }
  });

  dataRefs[key].on('child_changed', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      const index = state.rows[key].findIndex(r => r.id === data.id);
      if (index !== -1) {
        state.rows[key][index] = mk(data, CONFIGS[key]);
        if (getCurrentKey() === key) render();
      }
    }
  });

  dataRefs[key].on('child_removed', (snapshot) => {
    const data = snapshot.val();
    if (data) {
      state.rows[key] = state.rows[key].filter(r => r.id !== data.id);
      state.selected.delete(data.id);
      if (getCurrentKey() === key) render();
    }
  });
}

function saveToFirebase(row, key) {
  if (!state.useFirebase || !dataRefs[key]) {
    console.log('💾 로컬 저장 (Firebase 미사용)');
    return;
  }
  if (!row.id) {
    console.error('❌ 저장 실패: row.id가 없습니다', row);
    return;
  }
  
  console.log('🔥 Firebase에 저장 시도:', key, row.id);
  dataRefs[key].child(row.id).set(row)
    .then(() => {
      console.log('✅ Firebase 저장 성공:', row.id, row.client);
    })
    .catch(error => {
      console.error('❌ Firebase 저장 실패:', error);
      alert('데이터 저장에 실패했습니다: ' + error.message);
    });
}

function deleteFromFirebase(id, key) {
  if (!state.useFirebase || !dataRefs[key]) return;
  
  dataRefs[key].child(id).remove()
    .catch(error => {
      console.error('❌ Firebase 삭제 실패:', error);
      alert('데이터 삭제에 실패했습니다.');
    });
}

function loadFromFirebase(key) {
  if (!dataRefs[key]) return;
  
  console.log('🔥 Firebase에서 데이터 로딩 중:', key);
  dataRefs[key].once('value')
    .then((snapshot) => {
      const data = snapshot.val();
      if (data) {
        state.rows[key] = Object.values(data).map(d => mk(d, CONFIGS[key]));
        console.log(`✅ ${CONFIGS[key].name} 데이터 로드 완료:`, state.rows[key].length, '개');
        if (getCurrentKey() === key) render();
      } else {
        console.log(`ℹ️ ${CONFIGS[key].name}: Firebase에 데이터 없음`);
      }
    })
    .catch(error => {
      console.error(`❌ ${CONFIGS[key].name} 로드 실패:`, error);
    });
}

function switchType(type, subtype = null) {
  state.currentType = type;
  if (subtype) state.currentSubtype = subtype;
  
  $$('.tab').forEach(t => t.classList.remove('active'));
  $(`.tab[data-type="${type}"]`).classList.add('active');
  
  const placeSubtabs = $('#placeSubtabs');
  if (type === 'place') {
    placeSubtabs.classList.add('show');
    $$('.subtab').forEach(t => t.classList.remove('active'));
    $(`.subtab[data-subtype="${state.currentSubtype}"]`).classList.add('active');
  } else {
    placeSubtabs.classList.remove('show');
  }
  
  state.selected.clear();
  state.pagination.currentPage = 1;
  render();
}

function applyFilters(rows) {
  const key = getCurrentKey();
  const f = state.filters[key] || {};
  let arr = rows.slice();
  
  if (f.q) {
    const q = f.q.toLowerCase();
    arr = arr.filter(r => [r.client, r.keywords, r.mid, r.url, r.product, r.category, r.note].join(' ').toLowerCase().includes(q));
  }
  
  if (f.product && f.product !== 'all') arr = arr.filter(r => r.product === f.product);
  if (f.category && f.category !== 'all') arr = arr.filter(r => r.category === f.category);
  if (f.tax && f.tax !== 'all') arr = arr.filter(r => (f.tax === 'yes' ? r.tax === '발행' : r.tax === '미발행'));
  
  if (f.deadline && f.deadline !== 'all') {
    const todayDate = new Date();
    todayDate.setHours(0, 0, 0, 0);
    
    arr = arr.filter(r => {
      if (!r.endDate) return false;
      const ed = new Date(r.endDate);
      ed.setHours(0, 0, 0, 0);
      const daysUntil = Math.ceil((ed - todayDate) / (1000 * 60 * 60 * 24));
      
      if (f.deadline === 'd0') return daysUntil === 0;
      if (f.deadline === 'd1') return daysUntil === 1;
      if (f.deadline === 'd3') return daysUntil >= 0 && daysUntil <= 3;
      if (f.deadline === 'd7') return daysUntil >= 0 && daysUntil <= 7;
      return false;
    });
  }
  
  if (f.date) {
    if (f.periodType === 'day') arr = arr.filter(r => r.startDate === f.date);
    else if (f.periodType === 'week') {
      const tw = getWeekNumber(f.date);
      arr = arr.filter(r => {
        if (!r.startDate) return false;
        const rw = getWeekNumber(r.startDate);
        return rw.year === tw.year && rw.week === tw.week;
      });
    } else if (f.periodType === 'month') {
      const tm = getYearMonth(f.date);
      arr = arr.filter(r => r.startDate && getYearMonth(r.startDate) === tm);
    }
  }
  
  const [sf, dir] = (f.sort || 'date_desc').split('_');
  const mul = dir === 'asc' ? 1 : -1;
  arr.sort((a, b) => {
    if (sf === 'date') return (a.startDate || '').localeCompare(b.startDate || '') * mul;
    if (sf === 'cost') return ((a.cost || 0) - (b.cost || 0)) * mul;
    if (sf === 'client') return (a.client || '').localeCompare(b.client || '', 'ko') * mul;
    return 0;
  });
  
  return arr;
}

function renderFilters() {
  const config = getCurrentConfig();
  const key = getCurrentKey();
  const f = state.filters[key] || {};
  const container = $('#filtersContainer');
  
  let html = '<div class="filters">';
  
  html += '<div class="filter-input-wrapper"><input id="q" placeholder="🔎 검색: 업체명/키워드" autocomplete="off" value="' + (f.q || '').replace(/"/g, '&quot;') + '"></div>';
  
  config.fields.forEach(field => {
    if (field.type === 'select' && field.key !== 'tax' && (field.key === 'product' || field.key === 'category')) {
      html += `<select id="f${field.key}">
        <option value="all">${field.label}: 전체</option>
        ${field.options.map(opt => `<option ${f[field.key]===opt?'selected':''}>${opt}</option>`).join('')}
      </select>`;
    }
  });
  
  html += `<select id="fTax">
    <option value="all" ${!f.tax||f.tax==='all'?'selected':''}>세금: 전체</option>
    <option value="yes" ${f.tax==='yes'?'selected':''}>발행</option>
    <option value="no" ${f.tax==='no'?'selected':''}>미발행</option>
  </select>`;
  
  html += `<select id="fDeadline">
    <option value="all" ${!f.deadline||f.deadline==='all'?'selected':''}>종료: 전체</option>
    <option value="d0" ${f.deadline==='d0'?'selected':''}>🔴 D-0</option>
    <option value="d1" ${f.deadline==='d1'?'selected':''}>⚠️ D-1</option>
    <option value="d3" ${f.deadline==='d3'?'selected':''}>🟡 D-3</option>
    <option value="d7" ${f.deadline==='d7'?'selected':''}>📅 D-7</option>
  </select>`;
  
  html += `<select id="sortSel">
    <option value="date_desc" ${!f.sort||f.sort==='date_desc'?'selected':''}>정렬: 최신순</option>
    <option value="date_asc" ${f.sort==='date_asc'?'selected':''}>정렬: 오래된순</option>
    <option value="cost_desc" ${f.sort==='cost_desc'?'selected':''}>정렬: 작업비↓</option>
    <option value="cost_asc" ${f.sort==='cost_asc'?'selected':''}>정렬: 작업비↑</option>
    <option value="client_asc" ${f.sort==='client_asc'?'selected':''}>정렬: 업체명순</option>
  </select>`;
  
  html += '</div>';
  
  html += '<div style="margin-top:16px; display:flex; justify-content:space-between; align-items:center">';
  html += '<div style="display:flex; gap:8px; align-items:center">';
  html += '<input type="date" id="fDate" value="' + (f.date||'') + '" style="width:auto">';
  html += '<div class="period-btns">';
  html += `<button type="button" class="period-btn ${!f.periodType||f.periodType==='day'?'active':''}" data-period="day">일별</button>`;
  html += `<button type="button" class="period-btn ${f.periodType==='week'?'active':''}" data-period="week">주별</button>`;
  html += `<button type="button" class="period-btn ${f.periodType==='month'?'active':''}" data-period="month">월별</button>`;
  html += '</div></div>';
  html += '<button class="btn small outline" id="resetFiltersBtn">🔄 초기화</button>';
  html += '</div>';
  
  container.innerHTML = html;
  bindFilterEvents();
}

function renderTable() {
  const config = getCurrentConfig();
  const key = getCurrentKey();
  const rows = state.rows[key] || [];
  
  $('#listTitle').textContent = `📋 ${config.name}`;
  
  let theadHtml = '<tr><th class="center"><input type="checkbox" id="chkAll" class="select-row"></th>';
  config.fields.forEach(field => {
    const align = field.type === 'number' || field.type === 'computed' ? 'num' : '';
    theadHtml += `<th class="${align}">${field.label}</th>`;
  });
  theadHtml += '<th class="center">⚙️</th></tr>';
  $('#thead').innerHTML = theadHtml;
  
  const tbody = $('#tbody');
  tbody.innerHTML = '';
  
  const filtered = applyFilters(rows);
  const {perPage, currentPage} = state.pagination;
  const totalPages = Math.ceil(filtered.length / perPage);
  const startIdx = (currentPage - 1) * perPage;
  const pageRows = filtered.slice(startIdx, startIdx + perPage);
  
  const todayDate = new Date();
  todayDate.setHours(0, 0, 0, 0);
  
  pageRows.forEach(row => {
    const tr = document.createElement('tr');
    
    if (row.endDate) {
      const ed = new Date(row.endDate);
      ed.setHours(0, 0, 0, 0);
      const daysUntil = Math.ceil((ed - todayDate) / (1000 * 60 * 60 * 24));
      
      if (daysUntil === 0) {
        tr.classList.add('deadline-d0');
        tr.title = '🔴 종료일 D-0: 오늘 종료됩니다!';
      } else if (daysUntil === 1) {
        tr.classList.add('deadline-d1');
        tr.title = '⚠️ 종료일 D-1: 내일 종료됩니다!';
      } else if (daysUntil === 2 || daysUntil === 3) {
        tr.classList.add('deadline-d23');
        tr.title = `🟡 종료일 D-${daysUntil}: ${daysUntil}일 후 종료됩니다!`;
      }
    }
    
    const tdSel = document.createElement('td');
    tdSel.className = 'center';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.className = 'select-row';
    cb.checked = state.selected.has(row.id);
    cb.onchange = () => {
      if (cb.checked) state.selected.add(row.id);
      else state.selected.delete(row.id);
      updateBulkEditBar();
    };
    tdSel.appendChild(cb);
    tr.appendChild(tdSel);
    
    config.fields.forEach(field => {
      const td = document.createElement('td');
      
      if (field.type === 'computed') {
        if (field.key === 'totalQty') {
          td.textContent = row.totalQty || '';
          td.className = 'num';
        } else if (field.key === 'cost') {
          td.textContent = fmtMoney(row.cost || 0);
          td.className = 'num';
        }
      } else if (field.type === 'url') {
        td.className = 'url nowrap';
        if (row[field.key]) {
          const a = document.createElement('a');
          a.href = row[field.key];
          a.target = '_blank';
          a.textContent = '열기';
          td.appendChild(a);
        }
        td.onclick = () => startEdit(td, row, field, key);
      } else if (field.type === 'number') {
        td.textContent = row[field.key] ?? '';
        td.className = 'num';
        td.onclick = () => startEdit(td, row, field, key);
      } else if (field.key === 'tax') {
        td.textContent = row[field.key] || '';
        td.className = 'center ' + (row[field.key] === '발행' ? 'badge-yes' : 'badge-no');
        td.onclick = () => startEdit(td, row, field, key);
      } else {
        td.textContent = row[field.key] ?? '';
        td.className = 'nowrap';
        td.onclick = () => startEdit(td, row, field, key);
      }
      
      tr.appendChild(td);
    });
    
    const tdAct = document.createElement('td');
    tdAct.className = 'center';
    
    const dupBtn = document.createElement('button');
    dupBtn.className = 'btn small outline';
    dupBtn.textContent = '복제';
    dupBtn.onclick = () => {
      const copy = JSON.parse(JSON.stringify(row));
      copy.id = 'r_' + Math.random().toString(36).slice(2, 9);
      copy.createdAt = new Date().toISOString();
      state.rows[key].unshift(copy);
      saveToFirebase(copy, key);
      render();
    };
    
    const delBtn = document.createElement('button');
    delBtn.className = 'btn small danger';
    delBtn.textContent = '삭제';
    delBtn.onclick = () => {
      if (confirm('삭제할까요?')) {
        state.rows[key] = state.rows[key].filter(r => r.id !== row.id);
        state.selected.delete(row.id);
        deleteFromFirebase(row.id, key);
        render();
      }
    };
    
    tdAct.append(dupBtn, ' ', delBtn);
    tr.appendChild(tdAct);
    tbody.appendChild(tr);
  });
  
  $('#countInfo').textContent = `${filtered.length}건`;
  renderPagination(totalPages);
  updateBulkEditBar();
  
  const chkAll = $('#chkAll');
  if (chkAll) {
    chkAll.onchange = e => {
      if (e.target.checked) pageRows.forEach(r => state.selected.add(r.id));
      else pageRows.forEach(r => state.selected.delete(r.id));
      renderTable();
    };
  }
}

function renderPagination(totalPages) {
  const c = $('#pagination');
  c.innerHTML = '';
  if (totalPages <= 1) return;
  
  const {currentPage} = state.pagination;
  
  const prev = document.createElement('button');
  prev.className = 'page-btn';
  prev.textContent = '‹';
  prev.disabled = currentPage === 1;
  prev.onclick = () => {
    state.pagination.currentPage--;
    renderTableOnly();
  };
  c.appendChild(prev);
  
  let start = Math.max(1, currentPage - 3);
  let end = Math.min(totalPages, start + 6);
  if (end - start < 6) start = Math.max(1, end - 6);
  
  for (let i = start; i <= end; i++) {
    const b = document.createElement('button');
    b.className = 'page-btn' + (i === currentPage ? ' active' : '');
    b.textContent = i;
    b.onclick = () => {
      state.pagination.currentPage = i;
      renderTableOnly();
    };
    c.appendChild(b);
  }
  
  const next = document.createElement('button');
  next.className = 'page-btn';
  next.textContent = '›';
  next.disabled = currentPage === totalPages;
  next.onclick = () => {
    state.pagination.currentPage++;
    renderTableOnly();
  };
  c.appendChild(next);
}

function startEdit(td, row, field, key) {
  const old = row[field.key] ?? '';
  let el;
  
  if (field.type === 'select') {
    el = document.createElement('select');
    el.className = 'cell-editor';
    el.innerHTML = field.options.map(v => `<option>${v}</option>`).join('');
    el.value = old;
  } else {
    el = document.createElement('input');
    el.className = 'cell-editor';
    el.type = field.type === 'number' ? 'number' : field.type === 'url' ? 'url' : field.type === 'date' ? 'date' : 'text';
    el.value = old;
    if (field.type === 'number') el.step = 'any';
  }
  
  td.innerHTML = '';
  td.appendChild(el);
  el.focus();
  if (el.select) el.select();
  
  const commit = () => {
    let v = el.value;
    if (field.type === 'number') v = parseNum(v);
    row[field.key] = v !== null ? v : '';
    
    const config = getCurrentConfig();
    if (config.fields.find(f => f.key === 'totalQty' && f.type === 'computed')) {
      if (row.units !== undefined && row.days !== undefined) {
        row.totalQty = (row.units || 0) * (row.days || 0);
      } else if (row.quantity !== undefined && row.days !== undefined) {
        row.totalQty = (row.quantity || 0) * (row.days || 0);
      }
    }
    if (config.fields.find(f => f.key === 'cost' && f.type === 'computed')) {
      if (config.path === 'blog') {
        row.cost = (row.quantity || 0) * (row.unitPrice || 0);
      } else {
        row.cost = (row.totalQty || 0) * (row.unitPrice || 0);
      }
    }
    
    saveToFirebase(row, key);
    render();
  };
  
  el.onkeydown = e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      commit();
    } else if (e.key === 'Escape') {
      e.preventDefault();
      render();
    }
  };
  el.onblur = commit;
}

function renderKpis() {
  const key = getCurrentKey();
  const rows = applyFilters(state.rows[key] || []);
  const cnt = rows.length;
  const qty = rows.reduce((s, r) => s + (r.totalQty || 0), 0);
  const cost = rows.reduce((s, r) => s + (r.cost || 0), 0);
  
  $('#kpiCount').textContent = cnt.toLocaleString('ko-KR');
  $('#kpiQty').textContent = qty.toLocaleString('ko-KR');
  $('#kpiCost').textContent = fmtMoney(cost);
  $('#kpiAvg').textContent = fmtMoney(qty > 0 ? cost / qty : 0);
  
  const byProduct = {};
  rows.forEach(r => {
    const p = r.product || '미분류';
    byProduct[p] = (byProduct[p] || 0) + (r.cost || 0);
  });
  const pData = Object.entries(byProduct).map(([p, c]) => ({label: p, value: c})).sort((a, b) => b.value - a.value);
  drawBars($('#barsByProduct'), pData, true);
  
  const byMonth = {};
  rows.forEach(r => {
    if (!r.startDate) return;
    const ym = getYearMonth(r.startDate);
    byMonth[ym] = (byMonth[ym] || 0) + (r.cost || 0);
  });
  const mData = Object.entries(byMonth).sort((a, b) => b[0].localeCompare(a[0]));
  const mc = $('#monthlyCost');
  if (!mData.length) {
    mc.innerHTML = '<div class="muted">월별 데이터 없음</div>';
    return;
  }
  mc.innerHTML = mData.map(([ym, c]) => {
    const [y, m] = ym.split('-');
    return `<div class="month-item" data-month="${ym}">
      <span>${y}년 ${m}월: <strong>${fmtMoney(c)}</strong></span>
      <span class="month-item-icon">📊</span>
    </div>`;
  }).join('');
  $$('.month-item').forEach(i => i.onclick = () => showMonthlyChart(i.dataset.month));
}

function drawBars(c, data, money) {
  c.innerHTML = '';
  const max = Math.max(1, ...data.map(d => d.value));
  data.forEach(d => {
    const col = document.createElement('div');
    col.className = 'col';
    if (d.label && d.label !== '미분류') col.classList.add(`product-${d.label}`);
    const bar = document.createElement('div');
    bar.className = 'bar';
    bar.style.height = Math.round(d.value / max * 100) + '%';
    const val = document.createElement('div');
    val.className = 'bar-value';
    val.textContent = money ? fmtMoney(d.value) : d.value.toLocaleString('ko-KR');
    const lab = document.createElement('div');
    lab.className = 'note';
    lab.textContent = d.label || '미분류';
    col.append(bar, val, lab);
    c.appendChild(col);
  });
}

function showMonthlyChart(ym) {
  const key = getCurrentKey();
  const [y, m] = ym.split('-');
  const pc = {};
  state.rows[key].forEach(r => {
    if (!r.startDate || getYearMonth(r.startDate) !== ym) return;
    const p = r.product || '미분류';
    pc[p] = (pc[p] || 0) + (r.cost || 0);
  });
  const data = Object.entries(pc).map(([p, c]) => ({product: p, cost: c, percentage: 0}));
  const total = data.reduce((s, i) => s + i.cost, 0);
  data.forEach(i => i.percentage = total > 0 ? i.cost / total * 100 : 0);
  data.sort((a, b) => b.cost - a.cost);
  $('#chartTitle').textContent = `${y}년 ${m}월 상품별 작업비`;
  drawPieChart(data);
  renderPieLegend(data);
  $('#chartModal').classList.add('active');
}

function drawPieChart(data) {
  const cv = $('#pieChart');
  const ctx = cv.getContext('2d');
  const cx = cv.width / 2;
  const cy = cv.height / 2;
  const r = 120;
  ctx.clearRect(0, 0, cv.width, cv.height);
  
  if (!data.length) {
    ctx.fillStyle = '#8b94a8';
    ctx.font = '16px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('데이터 없음', cx, cy);
    return;
  }
  
  const colors = {멘토스: '#8B5CF6', 호올스: '#A78BFA', 말차: '#10B981', 신규: '#6366f1', 블로그: '#3B82F6', 카인드: '#F59E0B', 미분류: '#64748b'};
  const theme = document.documentElement.getAttribute('data-theme');
  const bc = theme === 'light' ? '#e2e8f0' : '#2a3551';
  let ca = -Math.PI / 2;
  
  data.forEach(i => {
    const sa = i.percentage / 100 * 2 * Math.PI;
    const ea = ca + sa;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, ca, ea);
    ctx.closePath();
    ctx.fillStyle = colors[i.product] || '#64748b';
    ctx.fill();
    ctx.strokeStyle = bc;
    ctx.lineWidth = 2;
    ctx.stroke();
    
    if (i.percentage >= 5) {
      const ta = ca + sa / 2;
      const tx = cx + Math.cos(ta) * (r * 0.7);
      const ty = cy + Math.sin(ta) * (r * 0.7);
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 14px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(`${i.percentage.toFixed(1)}%`, tx, ty);
    }
    ca = ea;
  });
}

function renderPieLegend(data) {
  const colors = {멘토스: '#8B5CF6', 호올스: '#A78BFA', 말차: '#10B981', 신규: '#6366f1', 블로그: '#3B82F6', 카인드: '#F59E0B', 미분류: '#64748b'};
  $('#pieLegend').innerHTML = data.map(i => `<div class="pie-legend-item">
    <div class="pie-legend-color" style="background:${colors[i.product] || '#64748b'}"></div>
    <div class="pie-legend-info">
      <div class="pie-legend-label">${i.product}</div>
      <div class="pie-legend-value">${fmtMoney(i.cost)} (${i.percentage.toFixed(1)}%)</div>
    </div>
  </div>`).join('');
}

function updateBulkEditBar() {
  $('#bulkEditBar').classList.toggle('active', state.selected.size > 0);
  $('#selectedCount').textContent = `${state.selected.size}개 선택`;
}

function openBulkEditModal() {
  if (!state.selected.size) return alert('항목을 선택하세요');
  
  const key = getCurrentKey();
  const config = getCurrentConfig();
  const selected = state.rows[key].filter(r => state.selected.has(r.id));
  
  $('#bulkCountText').textContent = state.selected.size;
  
  const form = $('#bulkEditForm');
  let html = '';
  
  config.fields.forEach(field => {
    if (field.type === 'computed') return;
    
    const divClass = ['client', 'mid', 'url', 'keywords', 'note'].includes(field.key) ? 'full' : '';
    
    const values = selected.map(r => r[field.key]);
    const uniqueValues = [...new Set(values.filter(v => v !== null && v !== undefined && v !== ''))];
    const commonValue = uniqueValues.length === 1 ? uniqueValues[0] : '';
    
    html += `<div class="${divClass}"><label>${field.label}</label>`;
    
    if (field.type === 'select') {
      html += `<select id="b${field.key}">`;
      html += '<option value="">변경 안함</option>';
      field.options.forEach(opt => {
        const sel = commonValue === opt ? 'selected' : '';
        html += `<option ${sel}>${opt}</option>`;
      });
      html += '</select>';
    } else {
      const inputType = field.type === 'number' ? 'number' : field.type === 'url' ? 'url' : field.type === 'date' ? 'date' : 'text';
      const valueAttr = commonValue ? `value="${String(commonValue).replace(/"/g, '&quot;')}"` : '';
      const placeholder = uniqueValues.length > 1 ? 'placeholder="여러 값"' : '';
      html += `<input id="b${field.key}" type="${inputType}"${field.type === 'number' ? ' step="any"' : ''} ${valueAttr} ${placeholder}>`;
    }
    
    html += '</div>';
  });
  
  html += `<div class="full" style="display:flex; gap:12px; justify-content:flex-end; margin-top:8px">
    <button type="button" class="btn outline" onclick="resetBulkForm()">🔄 초기화</button>
    <button type="submit" class="btn">✓ 일괄 적용</button>
  </div>`;
  
  form.innerHTML = html;
  $('#bulkEditModalBack').classList.add('active');
  
  form.onsubmit = e => {
    e.preventDefault();
    applyBulkEdit();
  };
}

function closeBulkEditModal() {
  $('#bulkEditModalBack').classList.remove('active');
}

function resetBulkForm() {
  $('#bulkEditForm').reset();
}

function applyBulkEdit() {
  const key = getCurrentKey();
  const config = getCurrentConfig();
  const updates = {};
  
  config.fields.forEach(field => {
    if (field.type === 'computed') return;
    const el = $(`#b${field.key}`);
    if (el && el.value) {
      updates[field.key] = field.type === 'number' ? parseNum(el.value) : el.value;
    }
  });
  
  if (!Object.keys(updates).length) return alert('변경할 내용을 입력하세요');
  
  state.rows[key].forEach(r => {
    if (state.selected.has(r.id)) {
      Object.assign(r, updates);
      
      if (config.fields.find(f => f.key === 'totalQty' && f.type === 'computed')) {
        if (r.units !== undefined && r.days !== undefined) {
          r.totalQty = (r.units || 0) * (r.days || 0);
        } else if (r.quantity !== undefined && r.days !== undefined) {
          r.totalQty = (r.quantity || 0) * (r.days || 0);
        }
      }
      if (config.fields.find(f => f.key === 'cost' && f.type === 'computed')) {
        if (config.path === 'blog') {
          r.cost = (r.quantity || 0) * (r.unitPrice || 0);
        } else {
          r.cost = (r.totalQty || 0) * (r.unitPrice || 0);
        }
      }
      
      saveToFirebase(r, key);
    }
  });
  
  render();
  closeBulkEditModal();
  alert(`${state.selected.size}개 수정 완료`);
}

function openAddModal() {
  const config = getCurrentConfig();
  const form = $('#addForm');
  $('#modalTitle').textContent = `➕ ${config.name} 등록`;
  
  let html = '';
  config.fields.forEach(field => {
    if (field.type === 'computed') return;
    
    const divClass = ['client', 'mid', 'url', 'keywords', 'note'].includes(field.key) ? 'full' : '';
    const req = field.required ? 'required' : '';
    
    html += `<div class="${divClass}"><label>${field.label}${field.required ? ' *' : ''}</label>`;
    
    if (field.type === 'select') {
      html += `<select id="a${field.key}" ${req}>`;
      html += '<option value="">선택</option>';
      field.options.forEach(opt => {
        const selected = (field.key === 'tax' && opt === '미발행') ? 'selected' : '';
        html += `<option ${selected}>${opt}</option>`;
      });
      html += '</select>';
    } else {
      const inputType = field.type === 'number' ? 'number' : field.type === 'url' ? 'url' : field.type === 'date' ? 'date' : 'text';
      const defValue = field.type === 'date' && field.key === 'startDate' ? `value="${today()}"` : '';
      const step = field.type === 'number' ? ' step="any"' : '';
      html += `<input id="a${field.key}" type="${inputType}" ${req} ${defValue}${step}>`;
    }
    
    html += '</div>';
  });
  
  html += `<div class="full" style="display:flex; gap:12px; justify-content:flex-end; margin-top:8px">
    <button type="button" class="btn outline" onclick="resetAddForm()">🔄 초기화</button>
    <button type="submit" class="btn">✓ 등록</button>
  </div>`;
  
  form.innerHTML = html;
  $('#addModalBack').classList.add('active');
  
  form.onsubmit = e => {
    e.preventDefault();
    const key = getCurrentKey();
    const config = getCurrentConfig();
    const data = {};
    
    config.fields.forEach(field => {
      if (field.type === 'computed') return;
      const el = $(`#a${field.key}`);
      if (el) {
        data[field.key] = field.type === 'number' ? parseNum(el.value) : el.value;
      }
    });
    
    const newRow = mk(data, config);
    state.rows[key].unshift(newRow);
    saveToFirebase(newRow, key);
    render();
    closeAddModal();
    alert('등록되었습니다!');
  };
}

function closeAddModal() {
  $('#addModalBack').classList.remove('active');
}

function resetAddForm() {
  $('#addForm').reset();
  const startDateInputs = $$('[id^="astart"]');
  startDateInputs.forEach(el => {
    if (el.type === 'date') el.value = today();
  });
}

function exportExcel() {
  if (!state.selected.size) return alert('항목을 선택하세요');
  
  const key = getCurrentKey();
  const config = getCurrentConfig();
  const selected = state.rows[key].filter(r => state.selected.has(r.id));
  
  const data = selected.map(row => {
    const obj = {ID: row.id};
    config.fields.forEach(field => {
      obj[field.label] = row[field.key] ?? '';
    });
    obj['생성일시'] = row.createdAt || '';
    return obj;
  });
  
  const ws = XLSX.utils.json_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, config.name);
  XLSX.writeFile(wb, `${config.name}_${today()}.xlsx`);
  alert(`${selected.length}개 항목 내보내기 완료`);
}

function bindFilterEvents() {
  const key = getCurrentKey();
  
  const qInput = $('#q');
  if (qInput) {
    let isComposing = false;
    let searchTimeout = null;
    
    qInput.addEventListener('compositionstart', () => {
      isComposing = true;
    });
    
    qInput.addEventListener('compositionend', (e) => {
      isComposing = false;
      state.filters[key].q = e.target.value;
      state.pagination.currentPage = 1;
      
      if (searchTimeout) clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        renderTableOnly();
      }, 100);
    });
    
    qInput.addEventListener('input', (e) => {
      if (!isComposing) {
        state.filters[key].q = e.target.value;
        state.pagination.currentPage = 1;
        
        if (searchTimeout) clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          renderTableOnly();
        }, 200);
      }
    });
  }
  
  const fDate = $('#fDate');
  if (fDate) {
    fDate.onchange = e => {
      state.filters[key].date = e.target.value;
      state.pagination.currentPage = 1;
      renderTableOnly();
    };
  }
  
  const sortSel = $('#sortSel');
  if (sortSel) {
    sortSel.onchange = e => {
      state.filters[key].sort = e.target.value;
      state.pagination.currentPage = 1;
      renderTableOnly();
    };
  }
  
  const fprod = $('#fproduct');
  if (fprod) {
    fprod.onchange = () => {
      state.filters[key].product = fprod.value;
      state.pagination.currentPage = 1;
      renderTableOnly();
    };
  }
  
  const fcat = $('#fcategory');
  if (fcat) {
    fcat.onchange = () => {
      state.filters[key].category = fcat.value;
      state.pagination.currentPage = 1;
      renderTableOnly();
    };
  }
  
  const fTax = $('#fTax');
  if (fTax) {
    fTax.onchange = e => {
      state.filters[key].tax = e.target.value;
      state.pagination.currentPage = 1;
      renderTableOnly();
    };
  }
  
  const fDeadline = $('#fDeadline');
  if (fDeadline) {
    fDeadline.onchange = e => {
      state.filters[key].deadline = e.target.value;
      state.pagination.currentPage = 1;
      renderTableOnly();
    };
  }
  
  $$('.period-btn').forEach(b => {
    b.onclick = () => {
      $$('.period-btn').forEach(x => x.classList.remove('active'));
      b.classList.add('active');
      state.filters[key].periodType = b.dataset.period;
      state.pagination.currentPage = 1;
      renderTableOnly();
    };
  });
  
  const resetBtn = $('#resetFiltersBtn');
  if (resetBtn) {
    resetBtn.onclick = () => {
      state.filters[key] = {periodType: 'day'};
      state.pagination.currentPage = 1;
      render();
    };
  }
}

function render() {
  renderFilters();
  renderTable();
  renderKpis();
}

function renderTableOnly() {
  renderTable();
  renderKpis();
}

function bindEvents() {
  $$('.tab').forEach(tab => {
    tab.onclick = () => {
      const type = tab.dataset.type;
      if (type === 'finance') {
        alert('💰 매출/매입 기능은 준비 중입니다!');
        return;
      }
      switchType(type, type === 'place' ? 'reward' : null);
    };
  });
  
  $$('.subtab').forEach(subtab => {
    subtab.onclick = () => {
      const subtype = subtab.dataset.subtype;
      switchType('place', subtype);
    };
  });
  
  $('#openAddModalBtn').onclick = openAddModal;
  $('#bulkEditBtn').onclick = openBulkEditModal;
  
  $('#removeSelectedBtn').onclick = () => {
    if (!state.selected.size) return alert('항목을 선택하세요');
    if (confirm(`${state.selected.size}건 삭제?`)) {
      const key = getCurrentKey();
      state.rows[key] = state.rows[key].filter(r => {
        if (state.selected.has(r.id)) {
          deleteFromFirebase(r.id, key);
          return false;
        }
        return true;
      });
      state.selected.clear();
      render();
    }
  };
  
  $('#themeBtn').onclick = () => {
    const cur = document.documentElement.getAttribute('data-theme');
    const next = cur === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    state.prefs.theme = next;
  };
  
  $('#exportExcelBtn').onclick = exportExcel;
  
  $('#perPageSelect').onchange = e => {
    state.pagination.perPage = parseInt(e.target.value, 10);
    state.pagination.currentPage = 1;
    renderTableOnly();
  };
  
  $('#closeChartModal').onclick = () => $('#chartModal').classList.remove('active');
  $('#chartModal').onclick = e => {
    if (e.target === $('#chartModal')) $('#chartModal').classList.remove('active');
  };
  
  document.onkeydown = e => {
    if (e.key === 'Escape') {
      closeAddModal();
      closeBulkEditModal();
      $('#chartModal').classList.remove('active');
    }
  };
}

window.addEventListener('DOMContentLoaded', () => {
  const pd = matchMedia && matchMedia('(prefers-color-scheme: dark)').matches;
  document.documentElement.setAttribute('data-theme', pd ? 'dark' : 'light');
  
  initFirebase();
  bindEvents();
  render();
});
</script>
</body>
</html>
